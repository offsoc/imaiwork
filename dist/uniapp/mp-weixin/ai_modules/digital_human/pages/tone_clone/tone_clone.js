"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),u=require("../../../../api/app.js"),a=require("../../../../api/digital_human.js"),o=require("../../../../hooks/useAudio.js"),i=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),d=require("../../enums/index.js"),p=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("data-select")+e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const m=e.defineComponent({__name:"tone_clone",setup(m){const f=s.useAppStore(),v=l.useUserStore(),{userTokens:_}=e.toRefs(v),g=e.ref(),h=e.computed((()=>{var e;return(null==(e=f.getDigitalHumanConfig)?void 0:e.channel)||[]})),y=e.computed((()=>h.value.map((e=>({text:e.name,value:e.id}))))),j=e.computed((()=>{var e,r,n,u;return{[d.DigitalHumanModelVersionEnum.STANDARD]:null==(e=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[d.DigitalHumanModelVersionEnum.SUPER]:null==(r=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_PRO))?void 0:r.score,[d.DigitalHumanModelVersionEnum.ADVANCED]:null==(n=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ADVANCED))?void 0:n.score,[d.DigitalHumanModelVersionEnum.ELITE]:null==(u=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ELITE))?void 0:u.score}[q.model_version]})),q=e.reactive({url:"",name:"",gender:"male",model_version:""}),x=[{name:"男声",value:"male"},{name:"女声",value:"female"}],E=e.ref(!1),w=async e=>{"record"==e?(await k(),H.value=3,E.value=!0,P(q.url)):"transcribe"==e&&(H.value=1,E.value=!0)},k=async()=>{const e=await n.chooseFile({type:"file",extension:["mp3","wav","m4a"]});await b(e)},$=r=>!(r>20971520)||(e.index.$u.toast("音频文件大小不能超过20M"),!1),b=async e=>{const{tempFiles:r}=e,{size:n}=r[0];$(n)&&await C(r[0].path)},C=async r=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:e}=await u.uploadFile("audio",{filePath:r});q.url=e}catch(n){e.index.showToast({title:n||"上传失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},T=e.ref(0),A=e.ref(null),B=e.ref(0),{authorize:D,isRecording:S,start:V,stop:M,close:F}=i.useRecorder({onstart:()=>{R()},onstop:async e=>{const{tempFilePath:r,fileSize:n}=e;$(n)&&(clearInterval(A.value),await C(r),P(r),H.value=3)},onerror:e=>{U()}}),H=e.ref(1),I=async r=>{if(2!=H.value||q.url||1!=r){if(S.value){if(!(await e.index.showModal({title:"提示",content:"当前录制中，是否继续录制？"})).confirm)return;S.value=!1,F(),U()}H.value+=r,0==H.value?(T.value=0,E.value=!1):H.value}else e.index.$u.toast("请先上传音频")},R=()=>{U(),A.value=setInterval((()=>{B.value+=1}),1e3)},U=()=>{B.value=0,clearInterval(A.value)},N=async r=>{switch(r){case"play":await D(),S.value?M():V();break;case"cancel":S.value=!1,F(),U();break;case"done":if(B.value<15)return void e.index.$u.toast("录制时间不能少于15秒");M(),H.value=2}},{setUrl:P,isPlaying:L,play:O,pause:z,destroy:G}=o.useAudio(),J=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"redirect"})};return e.watch((()=>f.getDigitalHumanConfig),(e=>{e&&e.length>0&&(q.model_version=e[0].id)}),{immediate:!0}),(n,u)=>e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((r=>e.unref(q).name=r)),c:e.p({placeholder:"请输入音色名称",modelValue:e.unref(q).name}),d:e.f(x,((n,u,a)=>e.e({a:e.t(n.name),b:e.unref(q).gender===n.value},e.unref(q).gender===n.value?{c:r._imports_0$9}:{d:r._imports_1$6},{e:e.unref(q).gender===n.value?"#0065FB":"#e5e5e5",f:e.unref(q).gender===n.value?"#0065FB":"#6a6a6a",g:u,h:e.o((r=>e.unref(q).gender=n.value),u)}))),e:e.o((r=>e.unref(q).model_version=r)),f:e.p({placeholder:"请选择模型",localdata:e.unref(y),modelValue:e.unref(q).model_version}),g:e.unref(E)},e.unref(E)?e.e({h:1==e.unref(H)},1==e.unref(H)?{i:e.f(e.unref(p.cratedVoiceCopywriter),((r,n,u)=>({a:e.t(r),b:n,c:e.unref(T)===n?"#0065FB":"#EBEBEB",d:e.unref(T)===n?"#0065FB":"#D9D9D9",e:e.o((e=>T.value=n),n)})))}:{},{j:2==e.unref(H)},2==e.unref(H)?e.e({k:e.t(e.unref(p.cratedVoiceCopywriter)[e.unref(T)]),l:e.t(e.unref(t.formatAudioTime)(e.unref(B))),m:r._imports_2$2,n:e.unref(S)?"#808080":"#BFBFBF",o:e.o((e=>N("cancel"))),p:!e.unref(S)},e.unref(S)?{r:r._imports_4$2}:{q:r._imports_3$1},{s:e.o((e=>N("play"))),t:r._imports_5$1,v:e.unref(S)?1:"",w:e.o((e=>N("done")))}):{},{x:3==e.unref(H)},3==e.unref(H)?e.e({y:r._imports_6$1,z:e.o((e=>(H.value=1,E.value=!1,S.value=!1,q.url="",G(),void U()))),A:e.unref(L)},e.unref(L)?{B:r._imports_1$5}:{C:r._imports_0$8},{D:e.o((e=>(async()=>{L.value?z():O(q.url)})()))}):{}):{},{E:!e.unref(E)},e.unref(E)?{}:{F:r._imports_9,G:e.o((e=>w("transcribe"))),H:r._imports_10,I:e.o((e=>w("record"))),J:e.t(20)},{K:e.unref(E)&&3!=e.unref(H)},e.unref(E)&&3!=e.unref(H)?e.e({L:e.unref(H)>=1&&e.unref(H)<3},e.unref(H)>=1&&e.unref(H)<3?{M:e.o((e=>I(-1))),N:e.p({shape:"circle",type:"primary"})}:{},{O:e.unref(H)>=1&&e.unref(H)<3},e.unref(H)>=1&&e.unref(H)<3?{P:e.o((e=>I(1))),Q:e.p({shape:"circle",type:"primary"})}:{}):{},{R:e.unref(q).url},e.unref(q).url?e.e({S:e.unref(j)},e.unref(j)?{T:e.t(e.unref(j))}:{},{U:e.o((r=>(async()=>{var r;if(q.name)if(q.model_version)if(q.url){if(_.value<j.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(r=g.value)||r.open());try{e.index.showLoading({title:"克隆中",mask:!0}),await a.voiceClone(q),v.getUser(),setTimeout((()=>{e.index.$u.toast("克隆成功，请在我的音色中查看"),J()}),300)}catch(n){e.index.$u.toast(n||"克隆失败")}finally{e.index.hideLoading()}}else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请选择模型");else e.index.$u.toast("请输入音色名称")})())),V:e.p({shape:"circle",type:"primary"})}):{},{W:e.sr(g,"d8f78104-6",{k:"rechargePopupRef"})})}}),f=e._export_sfc(m,[["__scopeId","data-v-d8f78104"]]);wx.createPage(f);
