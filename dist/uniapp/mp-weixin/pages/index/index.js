"use strict";const e=require("../../common/vendor.js"),n=require("../../stores/user.js"),o=require("../../stores/app.js"),t=require("../../api/chat.js"),s=require("../../enums/appEnums.js"),r=require("../../utils/util.js");if(require("../../api/user.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../hooks/useShareMessage.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("tabbar")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../components/tabbar/tabbar.js")+(()=>"../../components/empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/popup-bottom/popup-bottom.js")+(()=>"../../components/recharge-popup/recharge-popup.js"))();const a=e.defineComponent({__name:"index",setup(a){var i;const u=e.ref(50),l=o.useAppStore(),c=n.useUserStore(),{chatConfig:p}=e.toRefs(l),g=e.computed((()=>l.getWebsiteConfig)),{userTokens:v,isLogin:d}=e.toRefs(c),m=null==(i=c.getTokenByScene(s.TokensSceneEnum.CHAT))?void 0:i.score,f=e.ref();e.computed((()=>{const{windowHeight:n,statusBarHeight:o}=e.index.$u.sys();let t={height:0,top:0};t=e.index.getMenuButtonBoundingClientRect();return n-o-(t.height+(t.top-o))-40+"px"}));const h=e.ref(!1),_=e.ref(!1),k=e.ref(!1),j=e=>{h.value=e},b=e=>{_.value=e},q=e.ref([]),y=e.shallowRef(),x=e=>{E.indexid=e.index_id,E.rerank_min_score=e.rerank_min_score},w=async(e,n)=>{var o;try{const{lists:s}=await t.getCreativeRecord({page_no:e,page_size:n,scene_id:0,type:1});null==(o=y.value)||o.complete(s)}catch(s){console.log(s)}},C=e.shallowRef(),T=e.ref(!1),R=e.ref(!1),B=e.ref([]);e.computed((()=>1-B.value.filter((e=>r.isImageUrl(e.url))).length));const S=e.ref([]),$=e.ref("");let z=null;const A=e.reactive({page_no:1,page_size:1500,assistant_id:0}),E=e.reactive({indexid:"",rerank_min_score:""}),F=async()=>{try{const n=await t.getChatLog({...A,task_id:$.value}),o=null==n?void 0:n.map((e=>1==e.type?{...e}:{...e,is_reasoning_finished:!0,consume_tokens:e.tokens_info}));S.value=o,await e.nextTick$1(),C.value.scrollToBottom()}catch(n){}},M=async(n,o=!1)=>{var s;if(!d.value)return void e.index.$u.route({url:"/pages/login/login"});if(v.value<=0)return e.index.$u.toast("算力不足，请充值！"),void(null==(s=f.value)||s.open());if(T.value)return;o||S.value.push({type:1,message:n});const r=e.reactive({type:2,loading:!0,reply:"",reasoning_content:"",is_reasoning_finished:h.value,consume_tokens:{}});S.value.push(r),T.value=!0;try{await t.chatSendTextStream({message:n,task_id:$.value,open_reasoning:h.value?1:0,...E},{onstart(e){z=e,R.value=!0},onmessage(e){e.trim().split("data:").forEach(((e,n)=>{if(""!==e)try{const n=JSON.parse(e),{object:o,content:t,task_id:s,usage:a,reasoning_content:i}=n;if((t||i)&&"loading"===o&&(i?(r.is_reasoning_finished=!1,r.reasoning_content+=i):(r.is_reasoning_finished=!0,r.reply+=t)),"finished"===o)return r.loading=!1,r.consume_tokens={...a},void($.value||($.value=s));C.value.scrollToBottom()}catch(o){}}))},onclose(){r.loading=!1,L(),c.getUser(),setTimeout((async()=>{C.value.scrollToBottom()}),600)}})}catch(a){600004==a.errno?r.reply="用户已停止内容生成":(r.reply=a||"发生错误",e.index.$u.toast(a)),r.loading=!1,L()}e.nextTick$1((()=>{C.value.scrollToBottom()}))},H=()=>{$.value?($.value="",S.value=[],L(),M(p.value.new_chat_prompt,!0)):e.index.$u.toast("当前会话已经是最新的了")},L=()=>{B.value=[],T.value=!1,R.value=!1},U=()=>{S.value=[],L(),P()},P=()=>{null==z||z.abort(),T.value=!1,R.value=!1};return e.onMounted((()=>{e.index.$on("chooseFile",(e=>{B.value=e,M()}));const{safeArea:n}=e.index.$u.sys();u.value=n.top})),e.onLoad((e=>{e.task_id&&($.value=e.task_id,F())})),e.onShow((()=>{l.getChatConfig()})),(n,o)=>e.e({a:e.p({name:"arrow-left",size:32}),b:0==e.unref(S).length?1:"",c:e.p({"border-bottom":!1,"is-fixed":!1,"is-back":e.unref(S).length>0,background:{background:"transparent"},"is-custom-back-icon":!0,"custom-back":U}),d:0==e.unref(S).length},0==e.unref(S).length?{e:e.unref(g).shop_logo}:{},{f:e.sr(C,"66e90c04-2",{k:"chattingRef"}),g:e.o(P),h:e.o(H),i:e.o(j),j:e.o(b),k:e.o(M),l:e.o(x),m:e.p({"is-stop":e.unref(R),"content-list":e.unref(S),"send-disabled":e.unref(T),tokens:e.unref(m),"is-deep":!0}),n:0==e.unref(S).length},0==e.unref(S).length?{o:e.o((e=>k.value=!0))}:{},{p:0===e.unref(S).length},(e.unref(S).length,{}),{q:e.f(e.unref(q),((n,o,t)=>({a:e.t(n.create_time),b:e.t(n.message),c:o,d:e.o((e=>(async e=>{$.value=e,await F(),k.value=!1})(n.task_id)),o)}))),r:e.sr(y,"66e90c04-5,66e90c04-4",{k:"pagingRef"}),s:e.o(w),t:e.o((n=>e.isRef(q)?q.value=n:null)),v:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(q)}),w:e.o((n=>e.isRef(k)?k.value=n:null)),x:e.p({title:"历史记录","is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(k)}),y:e.sr(f,"66e90c04-7",{k:"rechargePopupRef"})})}});wx.createPage(a);
