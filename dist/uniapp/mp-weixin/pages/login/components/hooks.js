"use strict";const e=require("../../../common/vendor.js"),n=require("../../../stores/app.js"),t=require("../../../hooks/useLockFn.js"),o=require("../../../api/account.js"),i=require("../../../stores/user.js"),a=require("../../../utils/cache.js"),s=require("../../../enums/constantEnums.js"),c=require("../../../utils/util.js");require("../../../utils/client.js");var r=(e=>(e.WEIXIN="1",e.MOBILE="2",e.PC="4",e))(r||{});exports.LoginWayEnum=r,exports.useLoginWay=function(){const r=n.useAppStore(),u=i.useUserStore(),l=e.useRouter(),d=e.useRoute(),g=e.ref(!1),h=e.ref(!1),p=e.ref("1");e.computed((()=>"1"==p.value)),e.computed((()=>"2"==p.value)),e.computed((()=>r.getLoginConfig.login_way.includes("1"))),e.computed((()=>r.getLoginConfig.login_way.includes("2")));const L=e.computed((()=>{var e;return(null==(e=r.getLoginConfig.login_way)?void 0:e.length)>1})),w=e.ref(!0),y=e.computed((()=>r.getWebsiteConfig)),v=e.computed((()=>r.getLoginConfig)),m=e.ref({}),x=async()=>{f()},f=async()=>{const{token:e}=m.value;u.login(e),u.getUser(),r.getChatConfig();const n=getCurrentPages();if(n.length>1){const e=n[n.length-1];await l.navigateBack();const{onLoad:t,options:o}=e;t&&t(o)}else if(a.cache.get(s.BACK_URL))try{l.redirectTo(a.cache.get(s.BACK_URL))}finally{l.switchTab(a.cache.get(s.BACK_URL))}else l.reLaunch("/pages/index/index");a.cache.remove(s.BACK_URL)},k=c.series((async()=>{if(m.value.is_new_user&&!g.value)try{await o.updateUser({avatar:m.value.avatar,nickname:m.value.nickname},{token:m.value.token})}catch(e){}else if(g.value)return Promise.reject()}),x),{lockFn:C,isLock:_}=t.useLockFn((async n=>{let t=null;try{t=await(async n=>{try{const{code:t}=await e.index.login({provider:"weixin"}),i=await o.mnpLogin({code:t,...n});return i.is_new_user&&(g.value=!0),i}catch(t){return e.index.$u.toast(t),Promise.reject()}})(n),t&&(m.value=t,w.value&&k())}catch(i){e.index.showToast({title:i||"登录失败",icon:"none",duration:3e3})}})),{lockFn:j}=t.useLockFn((async n=>{e.index.showLoading({title:"请稍后..."});try{const t=await o.login(n);m.value=t,(async()=>{const{code:n}=await e.index.login({provider:"weixin"});await o.mnpAuthBind({code:n})})(),await k(),e.index.hideLoading()}catch(t){e.index.hideLoading(),e.index.$u.toast(t)}}));return e.watch((()=>r.getLoginConfig),(e=>{}),{immediate:!0}),e.onLoad((async()=>{})),{loginConfig:v,websiteConfig:y,loginData:m,showLoginPopup:g,showBindMobilePopup:h,showOtherWayBtn:L,loginWay:p,wxIsLock:_,isLoginAfter:w,bindMobileSuccess:()=>{h.value=!1,f()},mobileLoginLock:j,wxLoginLock:C,pcLogin:async n=>{e.index.showLoading({title:"正在登录中，请稍后...",mask:!0});try{const{phoneNumber:t,authKey:i}=n;await o.pcLogin({account:t,scene:4,terminal:"4",token:m.value.token,auth_key:i}),e.index.showToast({icon:"none",title:"扫码成功，请在PC页面查看",duration:3e3}),setTimeout((()=>{e.index.$u.route({url:"/pages/index/index",type:"redirect"})}),3e3)}catch(t){e.index.showToast({title:t||"登录失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},removeWxQuery:()=>{const e=d.query;e.code&&e.state&&(delete e.code,delete e.state,l.redirectTo({path:d.path,query:e}))},handleUpdateUser:async e=>{await o.updateUser(e,{token:m.value.token}),g.value=!1,x()}}};
