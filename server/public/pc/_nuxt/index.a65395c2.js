import{E as ue}from"./index.395ccff8.js";import{_ as pe}from"./index.vue.05ad31fd.js";import{_ as me}from"./chatting.6f3b345e.js";import{d as fe,z as _e,aG as ve,dt as ge,bM as he,aF as R,A as xe,r as x,D as ye,o as ke,b as be,k as y,l as b,m as p,q as B,s as N,Z as r,I as we,ak as Ce,t as P,J as G,K as Te,L as D,G as O,ew as Se,bQ as M,aH as I,bO as Ee,ex as Le,_ as Re}from"./entry.d9d53b29.js";/* empty css                 */import{C as Ie}from"./ChatArea.5f15f9fe.js";import{KnTypeEnum as H}from"./index.5bd136e1.js";import qe from"./sidebar.1e570700.js";import"./index.vue.287e2e78.js";import"./debounce.39f38609.js";import"./index.3864ff87.js";import"./katex.0065138a.js";import"./el-image.239907bf.js";import"./el-image-viewer.291603f7.js";import"./throttle.cbb177ea.js";import"./position.0f08d59c.js";import"./index.cce223cb.js";/* empty css                    */import"./index.79f7263c.js";import"./index.050c9b6b.js";import"./index.8a3302e5.js";import"./strings.fbd015b4.js";import"./_baseIteratee.73cb21ab.js";import"./index.4538c991.js";/* empty css                  *//* empty css               *//* empty css                     */import"./useCopy.6d9f93e9.js";import"./cloneDeep.abc20796.js";import"./el-slider.48c81ee5.js";import"./el-input-number.3a2d39dc.js";import"./index.3c330aca.js";import"./el-switch.d7a8c51d.js";import"./index.890e9d1e.js";/* empty css                   */import"./index.86ff85f4.js";const Ae={class:"flex h-full w-full flex-col"},Be={class:"grow flex min-h-0 gap-4"},Ne={class:"h-full relative"},Pe={class:"grow h-full relative rounded-xl py-4"},De={class:"pt-5 h-full mr-4 px-4"},Oe={key:0,class:"flex items-center justify-center flex-col h-full w-full md:max-w-3xl lg:max-w-[42rem] xl:max-w-[48rem] 2xl:max-w-[52rem] mx-auto text-center"},Ve={class:"mb-3"},Fe=["src"],Ue={key:1,class:"w-12 h-12"},je={class:"text-center text-2xl font-semibold"},Je={class:"text-base"},Ke={class:"mx-3 mt-12 flex md:max-w-3xl lg:max-w-[42rem] xl:max-w-[48rem] 2xl:max-w-[52rem] flex-wrap items-stretch justify-center gap-4"},$e=["onClick"],ze={class:"line-clamp-3 text-balance text-gray-600 break-all"},Ge=fe({__name:"index",setup(Me){var J;const C=_e(),{userTokens:W,userInfo:V,isLogin:Q}=ve(C),Z=(J=C.getTokenByScene(ge.SCENE_CHAT))==null?void 0:J.score,h=he(),l=R({id:"",name:"",logo:"",form_info:"",description:"",template_info:{},preliminary_ask:[],assistants_id:""}),T=xe(),S=x(!1),X=()=>{d.value=[]},d=x([]);let F=null;const _=x(!1),m=x(null),E=x(!1),L=x([]),f=x(""),Y=R({page_no:1,page_size:1500}),k=R({indexid:"",rerank_min_score:"",kb_id:""}),ee=e=>{const{type:o,data:n}=e;o==H.RAG?(k.indexid=n.index_id,k.rerank_min_score=n.rerank_min_score,k.kb_id=void 0):o==H.VECTOR&&(k.kb_id=n.id,k.indexid=void 0,k.rerank_min_score=void 0)},te=e=>{L.value=T.value.fileLists||[],w("",!1,!0)},se=async()=>{try{const e=await Ee({...Y,assistant_id:h.query.id,task_id:f.value}),o=e==null?void 0:e.map(n=>n.type==1?{...n,form_avatar:V.value.avatar}:{...n,consume_tokens:n.tokens_info||{},form_avatar:l.logo});d.value=o}catch{}},ae=e=>{L.value=e};let i;const U=x(null),oe=()=>{var n;const{template_info:e}=l,o=(n=e==null?void 0:e.form)==null?void 0:n.filter(t=>t.name=="WidgetSelect").map(t=>({dialogTitle:t.props.title,key:t.props.field,options:t.props.options.map((v,a)=>({id:a+1,name:v}))}));i=new Ie({elm:U.value,placeholder:"请输入你要的内容",needCallEvery:!1,selectList:o}),i.addEventListener("enterSend",()=>{w(i.getText())}),i.addEventListener("operate",t=>{_.value=i.isEmpty(),m.value.setInput(i.getText())}),i.addEventListener("defaultAction",t=>{switch(t){case"CUT":m.value.setInput("");break}}),e!=null&&e.form&&!f.value&&ne(l.form_info,e.form),m.value.setInput(i.getText())},ne=(e,o,n,t)=>{ie(e,o).forEach(a=>{if(a.type==="text")i.insertText(a.content);else if(a.type==="variable"){const s=a.content;if(s.name=="WidgetSelect"){const u=s.props.options.map((c,g)=>({id:g+1,name:c}));u.length&&i.setSelectTag({id:u[0].id,name:u[0].name},s.props.field)}else i.setInputTag(s.props.field,s.props.title,s.props.default)}})},ie=(e,o)=>{const n={};o.forEach(c=>{n[c.props.field]=c});const t=[],v=/\$\{(\w+)\}/g;let a;for(;(a=v.exec(e))!==null;){const c=a[1],g=n[c];g&&t.push({name:c,variable:g,start:a.index,end:a.index+a[0].length})}t.sort((c,g)=>c.start-g.start);const s=[];let u=0;return t.forEach(c=>{u<c.start&&s.push({type:"text",content:e.substring(u,c.start)}),s.push({type:"variable",content:c.variable}),u=c.end}),u<e.length&&s.push({type:"text",content:e.substring(u)}),s},w=async(e,o=!1,n=!1)=>{var v,a;if(!Q.value){C.toggleShowLogin();return}if(await((v=T.value)==null?void 0:v.formValidate()),W.value<=0){O.msgPowerInsufficient();return}if(_.value)return;_.value=!0,!o&&!n&&d.value.push({type:1,message:i.getText()||e,from_avatar:V.value.avatar,fileLists:L.value});const t=R({type:2,loading:!0,reply:"",is_reasoning_finished:!1,reasoning_content:"",error:"",from_avatar:l.logo,consume_tokens:{}});d.value.push(t),i.clear(),m.value.setInput("");try{await Se({message:i.getText()||e||"",message_ext:JSON.stringify((a=T.value)==null?void 0:a.formData),assistant_id:h.query.id,task_id:f.value,...k},{onstart(s){F=s,E.value=!0},onmessage(s){s.trim().split("data:").forEach((u,c)=>{if(u!=="")try{const g=JSON.parse(u),{object:K,content:$,task_id:z,reasoning_content:A,usage:de}=g;if(($||A)&&K==="loading"&&(A?(t.is_reasoning_finished=!1,t.reasoning_content+=A):(t.is_reasoning_finished=!0,t.reply+=$)),K==="finished"){t.loading=!1,t.consume_tokens={...de},f.value||(f.value=z),M({task_id:z||""});return}}catch{}})},async onclose(){t.loading=!1,q(),setTimeout(async()=>{await I(),m.value.scrollToBottom()},600),C.getUser()}})}catch(s){if(s&&s.type=="cancel")return;t.loading=!1,t.error=s||"发生错误",q(),O.msgError(s||"发生错误")}I(()=>{var s;(s=m==null?void 0:m.value)==null||s.scrollToBottom()})},re=()=>{if(!f.value){O.msgError("当前会话已经是最新的了");return}f.value="",d.value=[],q(),M({ppid:h.query.ppid,pid:h.query.pid,id:h.query.id,task_id:""}),w("你好",!0)},q=()=>{L.value=[],_.value=!1,E.value=!1},le=e=>{var o;F.cancel(),d.value[d.value.length-1].loading=!1,_.value=!1,E.value=!1,d.value[e]&&!((o=d.value[e])!=null&&o.reply)&&(d.value[e].reply="用户已停止内容生成")},ce=async()=>{const e=await Le({assistant_id:h.query.id});Object.keys(l).forEach(o=>{l[o]=e[o]})},j=async()=>{try{f.value=h.query.task_id,_.value||(S.value=!0,await ce(),S.value=!1,f.value&&f.value!=="undefined"&&(await se(),await I(),m.value.scrollToBottom()),await I(),oe())}catch{S.value=!1}};return ye(()=>h.params,()=>{$request.cancelRequest(),_.value=!1,j()}),ke(()=>{j()}),be(()=>{i&&(i.dispose(),i=null)}),(e,o)=>{const n=ue,t=pe,v=me;return y(),b("div",Ae,[p("div",Be,[B(n,{width:"220px"},{default:N(()=>{var a;return[p("div",Ne,[B(qe,{ref_key:"sidebarConfigRef",ref:T,"form-list":(a=r(l).template_info)==null?void 0:a.form,detail:{logo:r(l).logo,name:r(l).name,description:r(l).description},"is-lock":r(_),onChangeScene:X,onSuccess:te},null,8,["form-list","detail","is-lock"])])]}),_:1}),p("div",Pe,[p("div",De,[r(S)?D("",!0):(y(),we(v,{key:0,ref_key:"chattingRef",ref:m,"is-stop":r(E),"content-list":r(d),"send-disabled":r(_),tokens:r(Z),onClose:le,onContentPost:w,"onUpdate:fileLists":ae,onNewChat:re,onConfirmKnb:ee},Ce({input:N(()=>[p("div",{ref_key:"chatAreaRef",ref:U,class:"min-h-[30px] max-h-[200px] overflow-y-auto dynamic-scroller"},null,512)]),_:2},[r(d).length?void 0:{name:"content",fn:N(()=>[r(d).length?D("",!0):(y(),b("div",Oe,[p("div",Ve,[r(l).logo?(y(),b("img",{key:0,src:r(l).logo,class:"w-12 h-12"},null,8,Fe)):(y(),b("div",Ue,[B(t,{"icon-size":28})]))]),p("div",je,P(r(l).name),1),p("div",Je,P(r(l).description),1),p("div",null,[p("div",Ke,[(y(!0),b(G,null,Te(r(l).preliminary_ask,(a,s)=>(y(),b(G,null,[a.value?(y(),b("button",{key:0,class:"relative flex w-40 flex-col gap-2 rounded-2xl border border-token-border-light px-3 pb-4 pt-3 text-start align-top text-[15px] shadow-[0_0_2px_0_rgba(0,0,0,0.05),0_4px_6px_0_rgba(0,0,0,0.02)] transition hover:bg-token-main-surface-secondary",onClick:u=>w(a.value)},[p("div",ze,P(a.value),1)],8,$e)):D("",!0)],64))),256))])])]))]),key:"0"}]),1032,["is-stop","content-list","send-disabled","tokens"]))])])])])}}});const It=Re(Ge,[["__scopeId","data-v-3d225bc3"]]);export{It as default};
