import{bP as B,z as H,at as O,bQ as b,A as F,aH as j,bR as q,G as h,bS as D,bO as z}from"./entry.ca4d3d61.js";import{useChatStore as G}from"./chat.620091d1.js";function Y(){const A=B(),a=G(),S=H(),E=O(),{taskId:n,agentValue:p,chatContentList:l,isReceiving:m,isStopChat:N,isDeep:y,isNetwork:M,fileLists:c,extraParams:P}=b(a),{userTokens:x,userInfo:C}=b(S),{chatConfig:L}=E,u=F(null),w=F(null),o=()=>{j(()=>{var e;return(e=u.value)==null?void 0:e.scrollToBottom()})},R=()=>{z({task_id:void 0,agent_name:void 0,agent_id:void 0})},U=e=>{e.trim().split("data:").forEach(t=>{var s,_;if(t){try{const{object:i,content:r,task_id:g,usage:f,reasoning_content:d}=JSON.parse(t);n.value||(a.setTaskId(g),z({task_id:g,agent_name:(s=p.value)==null?void 0:s.name,agent_id:(_=p.value)==null?void 0:_.id}));const I=l.value[l.value.length-1];if(i==="loading"){const v={};d?(v.is_reasoning_finished=!1,v.reasoning_content=(I.reasoning_content||"")+d):r&&(v.is_reasoning_finished=!0,v.reply=(I.reply||"")+r),a.updateLastMessage(v)}else i==="finished"&&a.updateLastMessage({consume_tokens:f})}catch{}o()}})},T=async()=>{if(!(!n.value||n.value==="undefined")){a.isLoading=!0;try{const e=await q({page_no:1,page_size:9999,task_id:n.value,assistant_id:0}),t=(e==null?void 0:e.map(s=>s.type===1?{...s,form_avatar:C.value.avatar,fileList:s!=null&&s.file_info?Array.isArray(s.file_info)?s.file_info:[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:a.detail.logo,consume_tokens:s.tokens_info}))??[];a.chatContentList=t,o()}catch{h.msgError("获取聊天记录失败")}finally{a.isLoading=!1}}},k=async(e,t=!1,s)=>{var i,r,g;if(x.value<=1)return h.msgPowerInsufficient();if(m.value||!e.trim()&&c.value.length===0)return;t||a.addMessage({type:1,message:e,form_avatar:C.value.avatar,fileList:c.value});const _={type:2,loading:!0,form_avatar:a.detail.logo,is_reasoning_finished:y.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};a.addMessage(_),a.startReceiving(),o();try{await D({message:e,task_id:n.value,robot_id:(i=p.value)==null?void 0:i.id,open_reasoning:y.value?1:0,is_network_search:M.value?1:0,file_info:c.value.length?c.value[0]:void 0,...((g=(r=u.value)==null?void 0:r.getChatConfig)==null?void 0:g.call(r))||{},...P.value},{onstart:f=>{w.value=f},onmessage:U,onclose:()=>{a.updateLastMessage({loading:!1}),a.stopReceiving(),a.clearFiles(),S.getUser(),o(),s==null||s()}})}catch(f){const d=f||"消息发送失败";a.updateLastMessage({error:d,loading:!1}),h.msgError(d),a.stopReceiving()}finally{o()}};return{chattingRef:u,isDeep:y,isNetwork:M,fileLists:c,taskId:n,chatContentList:l,isReceiving:m,isStopChat:N,initialize:async()=>{a.clearChat();const{content:e,task_id:t}=A.query;e?(await k(e),R()):t&&t!=="undefined"&&(a.setTaskId(t),await T()),o()},sendMessage:k,startNewChat:()=>{var e,t,s;if(!n.value)return h.msgError("当前已是新会话");a.clearChat(),R(),(t=(e=u.value)==null?void 0:e.cleanInput)==null||t.call(e),(s=L.value)!=null&&s.new_chat_prompt&&k(L.value.new_chat_prompt,!0)},stopStream:()=>{var e;if((e=w.value)==null||e.cancel(),m.value){const t=l.value[l.value.length-1];a.updateLastMessage({loading:!1,reply:t.reply||"用户已停止内容生成"}),a.stopReceiving()}},chatScrollToBottom:o,resetScroll:()=>{var e;return(e=u.value)==null?void 0:e.resetScroll()},fetchChatHistory:T,setFiles:a.setFiles,clearFiles:a.clearFiles}}export{Y as useChatManager};
