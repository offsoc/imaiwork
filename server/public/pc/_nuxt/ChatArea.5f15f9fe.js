var ht=Object.defineProperty,dt=(d,t,e)=>t in d?ht(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e,f=(d,t,e)=>dt(d,typeof t!="symbol"?t+"":t,e);function pt(){const d=navigator.userAgent,t=/(?:Windows Phone)/.test(d),e=/(?:SymbianOS)/.test(d)||t,i=/(?:Android)/.test(d),n=/(?:Firefox)/.test(d),s=/(?:iPad|PlayBook)/.test(d)||i&&!/(?:Mobile)/.test(d)||n&&/(?:Tablet)/.test(d),a=/(?:iPhone)/.test(d)&&!s;return{isTablet:s,isPhone:a,isAndroid:i,isPc:!a&&!i&&!e}}function m(d,t=!1,e="block"){d&&(d.className=d.className.replace(/ chat-view-show| chat-view-hidden/g,""),t?(d.style.display=e,d.className+=" chat-view-show"):(d.className+=" chat-view-hidden",d.style.display="none"))}function $(d){return d&&d.classList.contains("chat-view-show")}function E(d,t,e){d.classList[e?"add":"remove"](t)}const ct="richWrap",S="richGrid",y="richMark",P="richInput",k="richTag",V="application/chatarea-custom-format",J="data-set-component",gt='<svg class="check-empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',ut='<svg class="empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',mt='<svg class="icon-search" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z" fill="#9B9B9B"></path></svg>',Q='<div class="ant-spin ant-spin-spinning" aria-live="polite" aria-busy="true"><span class="ant-spin-dot ant-spin-dot-spin"><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i><i class="ant-spin-dot-item"></i></span></div>',Et='<svg class="match-empty-svg" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#f5f5f5" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#d9d9d9"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#fafafa"></path></g></g></svg>',ft='<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M9.218 17.41 19.83 6.796a.99.99 0 1 1 1.389 1.415c-3.545 3.425-4.251 4.105-11.419 11.074a.997.997 0 0 1-1.375.018c-1.924-1.801-3.709-3.568-5.573-5.43a.999.999 0 0 1 1.414-1.413z"></path></svg>',B='<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="m20.23 8.653-7.795 9.685a1.2 1.2 0 0 1-1.87 0L2.771 8.652C2.14 7.867 2.698 6.7 3.706 6.7h15.588c1.008 0 1.567 1.167.935 1.952"></path></svg>',xt='<svg focusable="false" data-icon="close-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true" fill-rule="evenodd" viewBox="64 64 896 896"><path d="M512 64c247.4 0 448 200.6 448 448S759.4 960 512 960 64 759.4 64 512 264.6 64 512 64zm127.98 274.82h-.04l-.08.06L512 466.75 384.14 338.88c-.04-.05-.06-.06-.08-.06a.12.12 0 00-.07 0c-.03 0-.05.01-.09.05l-45.02 45.02a.2.2 0 00-.05.09.12.12 0 000 .07v.02a.27.27 0 00.06.06L466.75 512 338.88 639.86c-.05.04-.06.06-.06.08a.12.12 0 000 .07c0 .03.01.05.05.09l45.02 45.02a.2.2 0 00.09.05.12.12 0 00.07 0c.02 0 .04-.01.08-.05L512 557.25l127.86 127.87c.04.04.06.05.08.05a.12.12 0 00.07 0c.03 0 .05-.01.09-.05l45.02-45.02a.2.2 0 00.05-.09.12.12 0 000-.07v-.02a.27.27 0 00-.05-.06L557.25 512l127.87-127.86c.04-.04.05-.06.05-.08a.12.12 0 000-.07c0-.03-.01-.05-.05-.09l-45.02-45.02a.2.2 0 00-.09-.05.12.12 0 00-.07 0z"></path></svg>',W=(d=50)=>new Promise(t=>{setTimeout(t,d)}),tt=d=>String(d)!=="false"&&String(d)!=="null"&&String(d)!=="0",G=(d,t,e=!1)=>{let i;return function(...n){const s=this,a=e&&!i;clearTimeout(i),i=setTimeout(()=>{i=null,e||d.apply(s,n)},t),a&&d.apply(s,n)}},et=(d,t)=>{let e;return function(...i){const n=this;e||(d.apply(n,i),e=!0,setTimeout(function(){e=!1},t))}},K=(d,t)=>{const e=d.getAttribute("data-set-richType");return e===S?null:e===y||e===k?d:d.parentElement&&t>0?K(d.parentElement,t-1):null},q=(d,t,e)=>d&&d[t]?d[t]:e,Tt=d=>d.replace(/\n+/g,"").replace(/\s+/g," ").replace(/>\s+</g,"><").trim(),Ct=(d,t)=>{const e=document.createElement("div");e.innerHTML=d,e.querySelectorAll("div, p, h1, h2, h3, h4, h5, h6, section, article, header, footer, aside, nav").forEach(n=>{const s=document.createElement("span");for(s.style.display="block",Array.from(n.attributes).forEach(a=>{s.setAttribute(a.name,a.value)});n.firstChild;)s.appendChild(n.firstChild);n.parentNode.replaceChild(s,n)});const i=e.children[0];if(i&&i.style.display==="block"&&(i.style.display="inline-block"),i){for(const n in t)i.dataset[n]="{{"+n+"}}";i.setAttribute("data-set-component","{{data-set-component}}")}return e.innerHTML};function it(d,t){let e=d;for(const[i,n]of Object.entries(t)){const s=`{{${i}}}`;e=e.replace(new RegExp(s,"g"),String(n))}return e}function N(d){let t=d.replace(/\r\n/g,`
`).replace(/\r/g,`
`);return t=t.replace(/[&<>"']/g,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return e}}),t=t.replace(/ /g,"&nbsp;"),t}function F(d){let t=d.replace(/&nbsp;/g," ");return t=t.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,e=>{switch(e){case"&amp;":return"&";case"&lt;":return"<";case"&gt;":return">";case"&quot;":return'"';case"&#039;":return"'";default:return e}}),t}function yt(d){return vt(d).map(t=>It(t)).map(t=>t.map(e=>{let i="",n="",s="",a="",o="",l="";switch(nt(e)){case"chat-grid-input":s=U(e,"span",1),a=bt(s,"data-set-empty"),n=U(s,"span",1),i=String(a)==="false"?j(e,n):e;break;case"chat-tag":switch(o=U(e,"span",1),l=nt(o),l){case"at-user":case"at-tag":n=U(o,"span",1),i=j(e,n);break;case"at-select":n=U(o.replace(B,""),"span",1),i=j(e,n+B,N(n)+B);break;case"at-input":i=Dt(e);break;default:i=e}}return i})).map(t=>t.join("")).map(t=>'<p class="chat-grid-wrap" data-set-richtype="richGrid">'+t+"</p>").join("")}function vt(d){const t=[];let e=[],i=0;const n=d.split(/(<\/?p[^>]*>)/gi);for(const s of n)s&&(s.startsWith("<p")&&!s.startsWith("</p")?(i++,e.push(s),i===1&&e.length>1&&(e=[s])):s.startsWith("</p")?(e.push(s),i--,i===0&&(t.push(e.join("").trim()),e=[])):i>0&&e.push(s));return t}function It(d){const t=[];let e=[],i=0;const n=d.replace(/^<p[^>]*>/,"").replace(/<\/p>\s*$/,"").split(/(<\/?[^>]+\/?>)/g);for(const s of n){const a=s.trim();a&&(a.startsWith("<")&&a.endsWith("/>")?i===0?t.push(s):e.push(s):!a.startsWith("<")||a.startsWith("</")||a.startsWith("<!")?a.startsWith("</")?(i--,e.push(s),i===0&&(t.push(e.join("").trim()),e=[])):i>0&&e.push(s):(i++,e.push(s)))}if(e.length>0){const s=e.join("").trim();s&&t.push(s)}return t}function nt(d){const t=d.match(/<span[^>]*?class="([^"]*)"/i);return t?t[1]:null}function bt(d,t){const e=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`${e}=("([^"]*)"|'([^']*)'|([^\\s>]+))`),n=d.match(i);return n&&(n[2]||n[3]||n[4])||null}function U(d,t,e=1){const i=d.indexOf(">")+1,n=d.lastIndexOf(`</${t}`),s=d.substring(i,n);return e<=1?s:U(s,t,e-1)}function j(d,t,e){return d.replace(t,e||N(t))}function Dt(d){let t=d.replace(/(<span class="input-write" contenteditable="true">)(.*?)(<\/span>)/,(e,i,n,s)=>`${i}${N(n)}${s}`);return t=t.replace(/(<span class="[^"]*input-tip[^"]*"[^>]*>)(.*?)(<\/span>)/,(e,i,n,s)=>`${i}${N(n)}${s}`),t}function _(d,t){switch(t){case"text-delete":return d.key==="Backspace"||d.code==="Backspace";case"text-move":return d.key==="ArrowLeft"||d.key==="ArrowRight"||d.code==="ArrowLeft"||d.code==="ArrowRight";case"text-select-all":return(d.ctrlKey||d.metaKey)&&(d.key==="A"||d.key==="a"||d.code==="KeyA");case"text-undo":return(d.ctrlKey||d.metaKey)&&(d.key==="Z"||d.key==="z"||d.code==="KeyZ");case"text-redo":return(d.ctrlKey||d.metaKey)&&(d.key==="Y"||d.key==="y"||d.code==="KeyY");case"text-write":return d.isComposing||!d.ctrlKey&&!d.altKey&&!d.metaKey&&!["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"].includes(d.key);case"dialog-options":return d.key==="ArrowUp"||d.key==="ArrowDown"||d.key==="Enter"||d.code==="ArrowUp"||d.code==="ArrowDown"||d.code==="Enter"||d.code==="NumpadEnter";case"IME":return d.key==="Unidentified"||d.keyCode===229;default:return!1}}function Z(d,t,e){const i=t.split(/\s+/),n=d.split("").map((h,r)=>{let c=i[r]||"";return t===""&&c===""&&(c=h),{char:h,pinyin:c.toLowerCase(),initial:c?c[0].toLowerCase():""}}),s=(h=>{const r=[];let c="";for(const p of h)/[a-zA-Z]/.test(p)?c+=p.toLowerCase():(c&&(r.push({type:"pinyin",value:c}),c=""),r.push({type:"char",value:p}));return c&&r.push({type:"pinyin",value:c}),r})(e),a=n.length,o=s.length,l=Array.from({length:a+1},()=>Array(o+1).fill(!1));l[0][0]=!0;for(let h=0;h<=a;h++)for(let r=0;r<=o;r++)if(l[h][r]&&r<o){const c=s[r];for(let p=h;p<a;p++){const g=n[p];if(c.type==="char")g.char===c.value&&(l[p+1][r+1]=!0);else{const u=g.pinyin.toLowerCase(),T=g.initial,x=c.value;if(x===T)l[p+1][r+1]=!0;else if(x===u)l[p+1][r+1]=!0;else if(st(x,u))l[p+1][r+1]=!0;else for(let C=2;C<=a-p;C++){const D=n.slice(p,p+C),v=D.map(b=>b.pinyin.toLowerCase()).join(""),I=D.map(b=>b.initial).join("");if(x===v||x===I||st(x,v)){l[p+C][r+1]=!0;break}}}}}for(let h=0;h<=a;h++)if(l[h][o])return!0;return!1}function st(d,t){let e=0,i=0;for(;e<d.length&&i<t.length;)d[e]===t[i]&&e++,i++;return e===d.length}class At{constructor(t){f(this,"target"),f(this,"richText",document.createElement("div")),f(this,"placeholderElm",document.createElement("div")),f(this,"tipElm",null),f(this,"isExternalCallPopup",!1),f(this,"isPointSearchMode",!1),f(this,"checkboxRows",[]),f(this,"customTags",{}),f(this,"selectTags",{}),f(this,"rects",{}),f(this,"pcElms",{containerDialogElm:null,pointDialogElm:null,pointDialogCheckElm:null,pointDialogMainElm:null,pointDialogUsersElm:[],pointDialogActiveElm:null,pointDialogLoadingElm:null,pointDialogEmptyElm:null,checkDialogElm:null,checkDialogSearchResultElm:null,checkDialogUsersElm:null,checkDialogSearchInputElm:null,checkDialogTagsElm:null,customTagDialogElms:{},customTagDialogTagKey:"",customTagDialogActiveElm:null,selectDialogElms:{},selectDialogKey:"",selectDialogAim:null,tipContainerPopoverElm:null,tipPopoverElm:null}),f(this,"h5Elms",{dialogElm:null,dialogMainElm:null,dialogCheckElm:null,dialogShowElm:null,dialogSearchElm:null,dialogEmptyElm:null,dialogLoadingElm:null}),this.target=t,this.createRichText(),this.createPlaceholder(),t.deviceInfo.isPc?this.createPCDialog():this.createH5Dialog()}createRichText(){const{options:t,deviceInfo:e}=this.target,{elm:i}=t;E(i,"chat-area-"+(e.isPc?"pc":"h5"),!0),E(this.richText,"chat-rich-text",!0),this.richText.setAttribute("data-set-richType",ct),this.richText.setAttribute("contenteditable","true"),i.appendChild(this.richText)}createPlaceholder(){const{options:t}=this.target,{elm:e}=t;E(this.placeholderElm,"chat-placeholder-wrap",!0),m(this.placeholderElm,!0),e.appendChild(this.placeholderElm),this.rects.plaRect=this.placeholderElm.getBoundingClientRect()}createPCDialog(){const{options:t}=this.target,{needDialog:e,elm:i,asyncMatch:n}=t;if(!e)return;const{pcElms:s}=this;s.containerDialogElm=document.createElement("div"),E(this.pcElms.containerDialogElm,"chat-dialog",!0),i.nextElementSibling?i.parentElement.insertBefore(s.containerDialogElm,i.nextElementSibling):i.parentElement.appendChild(s.containerDialogElm),n||this.createPCCheckDialog(),this.createPCPointDialog()}createPCCheckDialog(){const{options:t}=this.target,e=this.target.options.dialogLabels.pcPCheckDialog,{pcElms:i}=this;i.checkDialogElm=document.createElement("div"),E(i.checkDialogElm,"checkbox-dialog",!0),m(i.checkDialogElm),i.checkDialogElm.innerHTML=`
          <div class="checkbox-dialog-container">
            <div class="checkbox-dialog-container-header">
                <span>${e.title}</span>
                <span class="checkbox-dialog-container-header-close">⛌</span>
            </div>
            <div class="checkbox-dialog-container-body">
                <div class="checkbox-dialog-left-box">
                    <div class="checkbox-dialog-search">
                        <input class="checkbox-dialog-search-input" placeholder="${e.searchPlaceholder}" type="text">
                        <div class="checkbox-dialog-search-group"></div>
                    </div>
                    <div class="checkbox-dialog-tags"></div>
                    <div class="checkbox-dialog-option">
                        <button class="checkbox-dialog-option-btn btn-submit disabled">${e.confirmLabel}</button>
                        <button class="checkbox-dialog-option-btn btn-close">${e.cancelLabel}</button>
                    </div>
                </div>
                <div class="checkbox-dialog-right-box">
                    <div class="checkbox-dialog-right-box-title">${e.userTagTitle}</div>
                    <div class="checkbox-dialog-check-group"></div>
                </div>
            </div>
          </div>
        `,i.containerDialogElm.appendChild(i.checkDialogElm),i.checkDialogUsersElm=i.checkDialogElm.querySelector(".checkbox-dialog-check-group"),i.checkDialogSearchResultElm=i.checkDialogElm.querySelector(".checkbox-dialog-search-group"),i.checkDialogSearchInputElm=i.checkDialogElm.querySelector(".checkbox-dialog-search-input"),i.checkDialogTagsElm=i.checkDialogElm.querySelector(".checkbox-dialog-tags");const n=()=>{m(i.checkDialogElm),E(document.body,"disable-scroll")};i.checkDialogElm.querySelector(".checkbox-dialog-container-header-close").onclick=n,i.checkDialogElm.querySelector(".btn-close").onclick=n;const s=i.checkDialogElm.querySelector(".btn-submit");s.onclick=async()=>{if(s.classList.contains("disabled"))return;const o=this.checkboxRows.map(l=>{const h=Object.create(null);return h[t.userProps.id]=l.id,h[t.userProps.name]=l.name,h});await this.target.batchSetTag(o),n()},m(i.checkDialogSearchResultElm),i.checkDialogSearchResultElm.onclick=o=>{o.stopPropagation()},i.checkDialogSearchInputElm.onclick=o=>{o.stopPropagation()};const a=G(o=>{const l=String(o.target.value||"").replace(/'/g,"").trim();if(!l)return void m(i.checkDialogSearchResultElm);const h=this.target.searchUserList(l).map(r=>r.id);Array.from(i.checkDialogSearchResultElm.children,(r,c)=>{if(c===i.checkDialogSearchResultElm.children.length-1)m(r,h.length===0);else{const p=r.getAttribute("data-set-id");m(r,h.indexOf(p)!==-1,"flex")}}),m(i.checkDialogSearchResultElm,!0)},200);i.checkDialogSearchInputElm.oninput=a,i.checkDialogSearchInputElm.onfocus=a}createPCPointDialog(){const{pcElms:t,target:e}=this;t.pointDialogElm=document.createElement("div"),E(t.pointDialogElm,"call-user-dialog",!0),m(t.pointDialogElm);const i=document.createElement("div");E(i,"call-user-dialog-header",!0),i.innerHTML=`<span class="call-user-dialog-header-title">${e.options.dialogLabels.pcPointDialog.title}</span>`,t.pointDialogCheckElm=document.createElement("span"),E(t.pointDialogCheckElm,"call-user-dialog-header-check",!0),t.pointDialogCheckElm.innerText=e.options.dialogLabels.pcPointDialog.checkLabel,t.pointDialogCheckElm.onclick=()=>{this.target.showPCCheckDialog(),this.isExternalCallPopup=!1},i.appendChild(t.pointDialogCheckElm),t.pointDialogElm.appendChild(i),t.pointDialogMainElm=document.createElement("div"),E(t.pointDialogMainElm,"call-user-dialog-main",!0),t.pointDialogElm.appendChild(t.pointDialogMainElm),e.options.asyncMatch&&(t.pointDialogLoadingElm=document.createElement("div"),E(t.pointDialogLoadingElm,"call-user-dialog-loading",!0),t.pointDialogLoadingElm.innerHTML=Q,t.pointDialogElm.appendChild(t.pointDialogLoadingElm),m(t.pointDialogLoadingElm),t.pointDialogEmptyElm=document.createElement("div"),E(t.pointDialogEmptyElm,"call-user-dialog-empty",!0),t.pointDialogEmptyElm.innerHTML=`
                ${Et}
                <span class="empty-label">${e.options.dialogLabels.pcPointDialog.emptyLabel}</span>
            `,t.pointDialogElm.appendChild(t.pointDialogEmptyElm),m(t.pointDialogEmptyElm)),t.containerDialogElm.appendChild(t.pointDialogElm)}createH5Dialog(){const{options:t,chatEvent:e}=this.target,{needDialog:i,dialogLabels:n}=t;if(!i)return;const{h5Elms:s}=this;s.dialogElm=document.createElement("div"),E(s.dialogElm,"call-user-popup",!0),s.dialogElm.innerHTML=`
          <div class="call-user-popup-main">
            <div class="call-user-popup-header">
                <span class="popup-show">${n.h5Dialog.cancelLabel}</span>
                <span class="popup-title">${n.h5Dialog.title}</span>
                <span class="popup-check">${n.h5Dialog.confirmLabel}</span>
            </div>
            <div class="call-user-popup-search">
                ${mt}
                <input class="call-user-popup-search-input"
                       placeholder="${n.h5Dialog.searchPlaceholder}"
                       type="text">
            </div>
            <div class="call-user-popup-body"></div>
          </div>
        `;const a=async()=>{s.dialogElm.className=s.dialogElm.className.replace(/ chat-view-show/g," chat-view-hidden"),s.dialogSearchElm.value="",await W(260),m(s.dialogElm),E(document.body,"disable-scroll"),t.asyncMatch&&this.target.updateUserList([]),this.target.chatInput.restCursorPos(this.target.chatInput.vnode,this.target.chatInput.cursorIndex),this.target.chatInput.viewIntoPoint()};s.dialogElm.onclick=a;const o=s.dialogElm.querySelector(".call-user-popup-main");o.onclick=l=>{l.stopPropagation()},s.dialogShowElm=s.dialogElm.querySelector(".popup-show"),s.dialogShowElm.onclick=a,s.dialogCheckElm=s.dialogElm.querySelector(".popup-check"),s.dialogCheckElm.onclick=async()=>{if(s.dialogCheckElm.classList.contains("disabled"))return;const l=s.dialogElm.querySelectorAll(".user-popup-check-item-check")||[];if(l.length===0)return void await a();if(Array.prototype.some.call(l,c=>c.getAttribute("data-set-id")==="isALL"))return await this.target.onceSetTag({[t.userProps.id]:"isALL",[t.userProps.name]:t.dialogLabels.h5Dialog.callEveryLabel}),void await a();const h=Array.from(l,c=>c.getAttribute("data-set-id")),r=t.userList.filter(c=>h.indexOf(String(c[t.userProps.id]))!==-1);await this.target.batchSetTag(r),await a()},s.dialogMainElm=s.dialogElm.querySelector(".call-user-popup-body"),s.dialogEmptyElm=document.createElement("div"),E(s.dialogEmptyElm,"call-user-popup-empty",!0),this.h5Elms.dialogEmptyElm.innerHTML=`
            ${ut}
            <span class="empty-label">${t.dialogLabels.h5Dialog.searchEmptyLabel}</span>
        `,m(s.dialogEmptyElm),o.appendChild(s.dialogEmptyElm),t.asyncMatch&&(s.dialogLoadingElm=document.createElement("div"),E(s.dialogLoadingElm,"call-user-popup-loading",!0),s.dialogLoadingElm.innerHTML=Q,m(s.dialogLoadingElm),o.appendChild(s.dialogLoadingElm)),s.dialogSearchElm=s.dialogElm.querySelector(".call-user-popup-search-input"),s.dialogSearchElm.oninput=G(l=>{const h=String(l.target.value||"").replace(/'/g,"").trim();if(t.asyncMatch){e.matchKey++;const c=e.matchKey;this.target.updateUserList([]),m(s.dialogLoadingElm,!0),m(s.dialogEmptyElm);const p=e.triggerChatEvent("atMatch",h).find(g=>g&&g instanceof Promise);return void(p&&p.then(g=>{c===e.matchKey&&(m(s.dialogLoadingElm),!g||g.length<=0?m(s.dialogEmptyElm,!0,"flex"):this.target.updateUserList(g))}))}const r=[];Array.from(this.h5Elms.dialogMainElm.children,c=>{if(!h)return m(c,!0,"flex"),void r.push(c);Z(c.getAttribute("data-set-name")||"",c.getAttribute("data-set-pinyin")||"",h)?(m(c,!0,"flex"),r.push(c)):m(c)}),m(this.h5Elms.dialogEmptyElm,!r.length,"flex")},200),m(s.dialogElm),document.body.appendChild(s.dialogElm)}updatePCUser(){const{pcElms:t,target:e}=this;t.pointDialogMainElm.innerHTML="",t.pointDialogActiveElm=void 0;const i=document.createDocumentFragment();if(this.target.options.needCallEvery){const o=document.createElement("div");E(o,"call-user-dialog-item",!0),o.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(o,{id:"isALL",name:e.options.dialogLabels.pcPointDialog.callEveryLabel}),o.innerHTML=`
                <span class="call-user-dialog-item-sculpture">
                  <span style="transform: scale(0.75)">@</span>
                </span>
                <span class="call-user-dialog-item-name">${e.options.dialogLabels.pcPointDialog.callEveryLabel}(${e.options.reformList.length})</span>
            `,i.appendChild(o)}if(e.options.reformList.forEach(o=>{const l=document.createElement("div");E(l,"call-user-dialog-item",!0),l.setAttribute("data-set-id",o.id),this.userSelectStyleAndEvent(l,o),this.getUserHtmlTemplate(l,o),i.appendChild(l)}),t.pointDialogMainElm.appendChild(i),t.pointDialogUsersElm=[],Array.from(t.pointDialogMainElm.children||[],(o,l)=>{t.pointDialogUsersElm.push({index:l,elm:o})}),e.options.asyncMatch)return;t.checkDialogUsersElm.innerHTML=`
            <div class="checkbox-dialog-check-item" data-set-value="ALL">
                <input type="checkbox" value>
                <span class="checkbox-dialog-check-item-inner"></span>
                <div class="checkbox-dialog-check-item-label">${e.options.dialogLabels.pcPCheckDialog.checkAllLabel}</div>
            </div>
        `;const n=document.createDocumentFragment();e.options.reformList.forEach(o=>{const l=document.createElement("div");E(l,"checkbox-dialog-check-item",!0),l.setAttribute("data-set-value",o.id),l.innerHTML=`
                <input type="checkbox" value>
                <span class="checkbox-dialog-check-item-inner"></span>
            `,this.getUserHtmlTemplate(l,o),n.appendChild(l)}),t.checkDialogUsersElm.appendChild(n),t.checkDialogUsersElm&&t.checkDialogUsersElm.children.length&&Array.from(t.checkDialogUsersElm.children,o=>{o.onclick=()=>{const l=o.getAttribute("data-set-value")||"",h=e.options.reformList.find(c=>c.id===l),r=o.className.indexOf("checkbox-dialog-check-item-check")===-1;l==="ALL"?this.checkboxRows=r?e.options.reformList.map(c=>c):[]:r?this.checkboxRows.push(h):this.checkboxRows=this.checkboxRows.filter(c=>c.id!==l),this.updateCheckDialogTags()}}),t.checkDialogSearchResultElm.innerHTML="";const s=document.createDocumentFragment();e.options.reformList.forEach(o=>{const l=document.createElement("div");E(l,"checkbox-dialog-check-item",!0),l.setAttribute("data-set-id",o.id);const h=document.createElement("div");E(h,"checkbox-dialog-check-item-label",!0),this.getUserHtmlTemplate(h,o),l.appendChild(h),l.onclick=()=>{m(this.pcElms.checkDialogSearchResultElm);const r=l.getAttribute("data-set-id")||"";if(this.pcElms.checkDialogSearchInputElm.value="",this.pcElms.checkDialogSearchInputElm.focus(),this.checkboxRows.some(p=>p.id===r))return;const c=e.options.reformList.find(p=>p.id===r);c&&this.checkboxRows.push(c),this.updateCheckDialogTags()},s.appendChild(l)});const a=document.createElement("div");E(a,"checkbox-dialog-search-empty",!0),a.innerText=e.options.dialogLabels.pcPCheckDialog.searchEmptyLabel,s.appendChild(a),t.checkDialogSearchResultElm.appendChild(s)}updateH5User(){const{h5Elms:t,target:e}=this;t.dialogMainElm.innerHTML="";const i=e.options.reformList&&e.options.reformList.length>0,n=document.createDocumentFragment(),s=document.createElement("span");if(s.innerHTML=`
            <input type="checkbox" value>
            <span class="user-popup-check-item-inner"></span>
        `,i){const a=document.createElement("div");e.options.needCallEvery&&(E(a,"call-user-popup-item",!0),a.setAttribute("data-set-id","isALL"),a.innerHTML=`
                    <span class="call-user-dialog-item-sculpture">
                        <span style="transform: scale(0.75)">@</span>
                    </span>
                    <span class="call-user-dialog-item-name">${e.options.dialogLabels.h5Dialog.callEveryLabel}(${e.options.reformList.length})</span>
                `,a.appendChild(s.cloneNode(!0)),a.onclick=()=>{const o=!a.classList.contains("user-popup-check-item-check");Array.from(this.h5Elms.dialogMainElm.children,l=>{E(l,"user-popup-check-item-check",o)}),E(this.h5Elms.dialogCheckElm,"disabled",!o)},n.appendChild(a)),e.options.reformList.forEach((o,l)=>{const h=document.createElement("div");E(h,"call-user-popup-item",!0),h.setAttribute("data-set-id",o.id),h.setAttribute("data-set-name",o.name),h.setAttribute("data-set-pinyin",o.pinyin||""),this.getUserHtmlTemplate(h,o),h.appendChild(s.cloneNode(!0)),n.appendChild(h),h.onclick=r=>{const c=!h.classList.contains("user-popup-check-item-check");E(h,"user-popup-check-item-check",c);const p=Array.prototype.every.call(this.h5Elms.dialogMainElm.children,u=>u.classList.contains("user-popup-check-item-check")||u.getAttribute("data-set-id")==="isALL");E(a,"user-popup-check-item-check",p);const g=Array.prototype.some.call(this.h5Elms.dialogMainElm.children,u=>u.classList.contains("user-popup-check-item-check"));E(this.h5Elms.dialogCheckElm,"disabled",!g)}})}t.dialogMainElm.appendChild(n)}updateCheckDialogTags(){const t=this.checkboxRows.map(o=>o.id),e=[],i=[],n=document.createElement("div");n.className="check-empty",n.innerHTML=`
            ${gt}
            <span class="check-empty-label">${this.target.options.dialogLabels.pcPCheckDialog.checkEmptyLabel}</span>
        `,Array.from(this.pcElms.checkDialogTagsElm.children,o=>{const l=o.getAttribute("data-set-value");t.indexOf(l)===-1?i.push(o):e.push(l)}),Array.from(this.pcElms.checkDialogUsersElm.children,(o,l)=>{if(l===0)return void E(o,"checkbox-dialog-check-item-check",t.length===this.target.options.reformList.length);const h=o.getAttribute("data-set-value");E(o,"checkbox-dialog-check-item-check",t.indexOf(h)!==-1)}),i.forEach(o=>{this.pcElms.checkDialogTagsElm.removeChild(o)}),E(this.pcElms.checkDialogElm.querySelector(".btn-submit"),"disabled",t.length<=0),t.length||this.pcElms.checkDialogTagsElm.appendChild(n);const s=this.checkboxRows.filter(o=>e.indexOf(o.id)===-1);if(!s.length)return;const a=document.createDocumentFragment();s.forEach(o=>{const l=document.createElement("div");l.setAttribute("class","checkbox-dialog-tag-item"),l.setAttribute("data-set-value",o.id),l.innerHTML=`
        <span>${o.name}</span>
      `;const h=document.createElement("span");h.setAttribute("class","checkbox-dialog-tag-item-close"),h.innerHTML="⛌",h.onclick=()=>{const r=l.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(c=>c.id!==r),this.updateCheckDialogTags()},l.appendChild(h),a.appendChild(l)}),this.pcElms.checkDialogTagsElm.appendChild(a)}userSelectStyleAndEvent(t,e){t.addEventListener("click",async i=>{const{options:n}=this.target;if(i.stopPropagation(),this.updatePointActiveUserElm(t),this.isPointSearchMode||n.asyncMatch)await this.target.matchSetTag(e);else{const s=n.userList.find(a=>String(a[n.userProps.id])===e.id);await this.target.onceSetTag(s)}this.exitPointDialog()})}bindCustomTrigger(){Object.values(this.pcElms.customTagDialogElms).forEach(t=>{this.pcElms.containerDialogElm.removeChild(t)}),this.pcElms.customTagDialogElms={},this.customTags={},this.target.options.customTrigger.forEach(t=>{t.tagList&&t.tagList.length>0&&(this.customTags[t.prefix]=t.tagList.map(e=>({id:String(e.id),name:String(e.name),pinyin:String(e.pinyin||"")})),this.createCustomTagDialog(t))})}createCustomTagDialog(t){const e=document.createElement("div");e.setAttribute("class","call-tag-dialog"),m(e);const i=document.createElement("div");i.setAttribute("class","call-tag-dialog-header"),i.innerHTML=`<span class="call-tag-dialog-header-title">${t.dialogTitle||t.prefix}</span>`,e.appendChild(i);const n=document.createElement("div");n.setAttribute("class","call-tag-dialog-main"),t.tagList.forEach(s=>{const a=document.createElement("div");a.setAttribute("class","call-tag-dialog-item"),a.setAttribute("data-set-id",s.id);const o=document.createElement("span");o.setAttribute("class","call-tag-dialog-item-name"),o.innerHTML=s.name,a.appendChild(o),a.addEventListener("click",async l=>{l.stopPropagation(),this.updateActiveCustomTagElm(a),this.isPointSearchMode?await this.target.matchSetCustomTag(s):await this.target.onceSetCustomTag(s),this.exitCustomTagDialog()}),n.appendChild(a)}),e.appendChild(n),this.pcElms.containerDialogElm.appendChild(e),this.pcElms.customTagDialogElms[t.prefix]=e}getUserHtmlTemplate(t,e){const i=document.createElement("span");if(i.setAttribute("class","call-user-dialog-item-sculpture "+(e.avatar?"is-avatar":"")),e.avatar){const s=new Image;s.alt="",s.src=String(e.avatar),i.appendChild(s)}else i.innerHTML=`<span style="transform: scale(0.75)">${e.name.slice(-2)}</span>`;t.appendChild(i);const n=document.createElement("span");n.setAttribute("class","call-user-dialog-item-name"),n.innerHTML=e.name,t.appendChild(n)}updatePointActiveUserElm(t,e=!1){if(this.pcElms.pointDialogActiveElm&&E(this.pcElms.pointDialogActiveElm,"call-user-dialog-item-active"),this.pcElms.pointDialogActiveElm=t,t&&(E(t,"call-user-dialog-item-active",!0),e)){const i=Array.prototype.filter.call(this.pcElms.pointDialogMainElm.children,a=>a.className.indexOf("user-no-match")===-1),n=t.clientHeight,s=Array.prototype.indexOf.call(i,t)+1-Math.ceil(Math.floor(this.pcElms.pointDialogMainElm.clientHeight/n)/2);this.pcElms.pointDialogMainElm.scrollTop=s>0?s*n:0}}updateActiveCustomTagElm(t,e=!1){if(this.pcElms.customTagDialogActiveElm&&E(this.pcElms.customTagDialogActiveElm,"call-tag-dialog-item-active"),this.pcElms.customTagDialogActiveElm=t,t&&(E(t,"call-tag-dialog-item-active",!0),e)){const i=this.pcElms.customTagDialogElms[this.pcElms.customTagDialogTagKey].children[1],n=Array.prototype.filter.call(i.children,o=>o.className.indexOf("tag-no-match")===-1),s=t.clientHeight,a=Array.prototype.indexOf.call(n,t)+1-Math.ceil(Math.floor(i.clientHeight/s)/2);i.scrollTop=a>0?a*s:0}}showPointDialog(t){this.exitSelectDialog(),this.exitCustomTagDialog(),this.exitPointDialog(),this.isPointSearchMode=!!t;let e=null;this.pcElms.pointDialogUsersElm.forEach(i=>{const n=i.elm,s=n.getAttribute("data-set-id"),a=t&&t.every(o=>o.id!==s);e||a||(e=n),E(n,"user-no-match",a)}),e!==null&&this.updatePointActiveUserElm(e),m(this.pcElms.pointDialogCheckElm,!this.target.options.asyncMatch&&!this.isPointSearchMode),m(this.pcElms.pointDialogElm,!0),this.target.chatEvent.debounceEvents.dialogMoveToRange(this.pcElms.pointDialogElm),this.pcElms.pointDialogMainElm.scrollTop=0}showCustomTagDialog(t,e){this.exitSelectDialog(),this.exitCustomTagDialog(),this.exitPointDialog(),this.isPointSearchMode=!!e,this.pcElms.customTagDialogTagKey=t;const i=this.pcElms.customTagDialogElms[t],n=i.children[1];let s=null;Array.from(n.children,a=>{const o=a.getAttribute("data-set-id"),l=e&&e.every(h=>h.id!==o);s||l||(s=a),E(a,"tag-no-match",l)}),s!==null&&this.updateActiveCustomTagElm(s),m(i,!0),this.target.chatEvent.debounceEvents.dialogMoveToRange(i),i.children[1].scrollTop=0}exitPointDialog(){this.updatePointActiveUserElm(),this.target.options.asyncMatch&&this.target.updateUserList([]),m(this.pcElms.pointDialogElm)}exitCustomTagDialog(){this.updateActiveCustomTagElm();for(const t in this.pcElms.customTagDialogElms)m(this.pcElms.customTagDialogElms[t])}ruleShowPointDialog(){const{options:t}=this.target;t.needDialog&&t.reformList.length>0&&(this.isExternalCallPopup=!1,this.showPointDialog())}showPlaceholder(){m(this.placeholderElm,this.target.isEmpty()),this.offsetTipElm()}bindSelectList(){Object.values(this.pcElms.selectDialogElms).forEach(t=>{this.pcElms.containerDialogElm.removeChild(t)}),this.pcElms.selectDialogElms={},this.selectTags={},this.target.options.selectList.forEach(t=>{t.options&&t.options.length>0&&(this.selectTags[t.key]=t.options.map(e=>({id:String(e.id),name:String(e.name),preview:String(e.preview||"")})),this.createSelectDialog(t))})}createSelectDialog(t){const e=document.createElement("div");e.setAttribute("class","chat-select-dialog"),m(e);const i=document.createElement("div");i.setAttribute("class","chat-select-dialog-header"),i.innerHTML=`<span class="chat-select-dialog-header-title">${t.dialogTitle||t.key}</span>`,e.appendChild(i);const n=document.createElement("div");n.setAttribute("class","chat-select-dialog-main"),t.options.forEach(a=>{const o=document.createElement("div");if(o.setAttribute("class","chat-select-dialog-item"),o.setAttribute("data-set-id",a.id),a.preview){const r=document.createElement("img");r.setAttribute("class","chat-select-dialog-preview"),r.src=String(a.preview),o.appendChild(r)}const l=document.createElement("span");l.setAttribute("class","chat-select-dialog-name"),l.textContent=a.name;const h=document.createElement("span");h.setAttribute("class","chat-select-dialog-check"),h.innerHTML=ft,m(h),l.appendChild(h),o.appendChild(l),o.onclick=async()=>{await this.target.setSelectTag(a)},n.appendChild(o)}),e.appendChild(n);const s=document.createElement("div");s.setAttribute("class","chat-select-arrow"),e.appendChild(s),this.pcElms.containerDialogElm.appendChild(e),this.pcElms.selectDialogElms[t.key]=e}exitSelectDialog(){for(const t in this.pcElms.selectDialogElms)m(this.pcElms.selectDialogElms[t]);this.pcElms.selectDialogKey="",this.pcElms.selectDialogAim&&(E(this.pcElms.selectDialogAim,"aim"),this.pcElms.selectDialogAim=null)}createTipElm(t){this.tipElm||(this.tipElm=document.createElement("div")),E(this.tipElm,"chat-tip-wrap",!0),this.tipElm.innerHTML=`
            <div class="chat-tip-tag">
                <span class="chat-tip-tag-txt">${t.tagLabel||"--"}</span>
                <span class="chat-tip-tag-close">
                    ${this.target.deviceInfo.isPc?xt:""}
                </span>
            </div>
        `,this.target.options.elm.appendChild(this.tipElm);const e=this.tipElm.children[0],i=(e.clientHeight-this.target.chatInput.NODE_HEIGHT)/2;if(this.tipElm.style.top=`-${i}px`,e.onclick=()=>{this.target.deviceInfo.isPc&&this.target.closeTipTag()},e.onmouseenter=()=>{if(this.pcElms.tipContainerPopoverElm&&this.pcElms.tipPopoverElm){m(this.pcElms.tipPopoverElm,!0);const n=this.pcElms.tipContainerPopoverElm.getBoundingClientRect();this.rects.tipRect=this.tipElm.getBoundingClientRect();const s=(this.pcElms.tipPopoverElm.clientWidth-(this.tipElm.clientWidth+(this.tipElm.clientWidth-e.clientWidth)))/2;this.pcElms.tipPopoverElm.style.left=-s+"px",this.pcElms.tipPopoverElm.style.bottom=n.y-this.rects.tipRect.y+"px",this.pcElms.tipPopoverElm.style.transform=e.style.transform}},e.onmouseleave=()=>{this.pcElms.tipPopoverElm&&m(this.pcElms.tipPopoverElm)},this.offsetApplyElm(),this.target.deviceInfo.isPc){this.pcElms.tipContainerPopoverElm||(this.pcElms.tipContainerPopoverElm=document.createElement("div"),E(this.pcElms.tipContainerPopoverElm,"chat-tip-dialog",!0)),this.pcElms.tipPopoverElm||(this.pcElms.tipPopoverElm=document.createElement("div")),E(this.pcElms.tipPopoverElm,"chat-tip-popover",!0),this.pcElms.tipPopoverElm.innerHTML=`
                <div class="chat-tip-popover-main">
                    <span class="chat-tip-popover-txt">${t.popoverLabel||"--"}</span>
                    <span class="chat-tip-popover-code ${t.codeLabel?"":"chat-view-show"}">${t.codeLabel||"--"}</span>
                </div>
                <div class="chat-tip-popover-arrow"></div>
            `,this.pcElms.tipContainerPopoverElm.appendChild(this.pcElms.tipPopoverElm),m(this.pcElms.tipPopoverElm);const{elm:n}=this.target.options;n.parentElement&&(n.nextElementSibling?n.parentElement.insertBefore(this.pcElms.tipContainerPopoverElm,n.nextElementSibling):n.parentElement.appendChild(this.pcElms.tipContainerPopoverElm))}this.target.chatEvent.triggerChatEvent("tipTagState",!0)}createCustomTipElm(t){this.tipElm||(this.tipElm=document.createElement("div")),E(this.tipElm,"chat-tip-wrap",!0),this.tipElm.innerHTML=`<div class="chat-custom-tip">${t}</div>`,this.target.options.elm.appendChild(this.tipElm);const e=this.tipElm.children[0],i=(e.clientHeight-this.target.chatInput.NODE_HEIGHT)/2;return this.tipElm.style.top=`-${i}px`,this.offsetApplyElm(),this.target.chatEvent.triggerChatEvent("tipTagState",!0),e.children[0]}offsetApplyElm(){if(!this.tipElm)return;const t=this.richText.children[0].children[0];this.rects.tipRect=this.tipElm.getBoundingClientRect();const e=this.rects.tipRect;this.placeholderElm.style.paddingLeft=e.width+"px",t.style.paddingLeft=e.width-t.offsetLeft+"px",this.offsetTipElm()}offsetTipElm(){if(this.tipElm){const t=this.richText.children[0].children[0];t.style.paddingLeft=this.rects.tipRect.width-t.offsetLeft+"px",this.target.nextTick(()=>{if(this.tipElm){const e=this.tipElm.children[0],i=this.richText.children[0].children[0];e.style.transform=`translateY(${i.offsetTop-this.target.chatInput.NODE_PADDING_DIFF}px)`}})}}removeTipElm(){this.tipElm&&(this.target.options.elm.removeChild(this.tipElm),this.tipElm=null),this.pcElms.tipContainerPopoverElm&&(this.pcElms.tipContainerPopoverElm.removeChild(this.pcElms.tipPopoverElm),this.target.options.elm.parentElement.removeChild(this.pcElms.tipContainerPopoverElm),this.pcElms.tipContainerPopoverElm=null,this.pcElms.tipPopoverElm=null);const t=this.richText.children[0].children[0];this.placeholderElm.style.removeProperty("padding-left"),t.style.removeProperty("padding-left"),this.target.chatInput.setRangeLastRecord(),this.target.chatEvent.triggerChatEvent("tipTagState",!1)}}class kt{constructor(t){f(this,"target"),f(this,"richText"),f(this,"vnode"),f(this,"cursorIndex"),f(this,"inputTag_vnode"),f(this,"inputTag_cursorIndex"),f(this,"lastCursorType","gridInput"),f(this,"needCallSpace",!1),f(this,"VOID_KEY","\uFEFF"),f(this,"ZERO_WIDTH_KEY","​"),f(this,"INPUT_TAG_WRAP_KEY",`​
​`),f(this,"NODE_HEIGHT",24),f(this,"NODE_PADDING_DIFF",10),this.target=t,this.richText=t.chatElement.richText,this.initEditor()}initEditor(t=!1,e){if(t||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const i=this.getGridElm();this.richText.appendChild(i);const n=i.children[0].children[0];e&&(n.textContent=e,n.setAttribute("data-set-empty","false"));const s=n.childNodes[0];t||this.target.options.autoFocus?this.restCursorPos(s,s.textContent===this.VOID_KEY?1:s.textContent.length):this.updateGridInputCursor(s,s.textContent.length),this.target.nextTick(()=>{const a=i.getBoundingClientRect();this.NODE_HEIGHT=a.height,this.NODE_PADDING_DIFF=a.top-this.target.options.elm.getBoundingClientRect().top})}}onceCall(t){return new Promise(e=>{const i=this.createChatTagElm(t,"@","at-user","user-id");this.replaceRegContent(i),e()})}onceSearchCall(t,e){return new Promise(i=>{const n=this.createChatTagElm(t,"@","at-user","user-id");this.replaceRegContent(n,e),i()})}onceCustomCall(t,e,i){return new Promise(n=>{const s=this.createChatTagElm(t,i,"at-tag","tag-id");s.children[0].setAttribute("data-set-prefix",i),this.replaceRegContent(s,e),n()})}getCurrentCursorKey(){return this.updateNodeCursor(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE?"":(this.vnode.textContent||"")[this.cursorIndex-1]}getRangeRect(){let t=0,e=0;const i=getSelection();if(i.focusNode.nodeType!==Node.TEXT_NODE)return null;const n=i.getRangeAt(0).getClientRects()[0];return n&&(t=n.x,e=n.y),{x:t,y:e}}createChatTagElm(t,e,i,n){const s=document.createElement("span");return s.className=i,s.setAttribute(`data-${n}`,String(t.id)),s.textContent=`${e}${t.name}${this.needCallSpace?" ":""}`,this.createNewDom(s)}createNewDom(t){const e=document.createElement("span");return e.className="chat-tag",e.setAttribute("contenteditable","false"),e.setAttribute("data-set-richType",k),e.appendChild(t),e}replaceRegContent(t,e=!0){const i=this.vnode.textContent;let n;n=typeof e=="boolean"?i.slice(0,e?this.cursorIndex-1:this.cursorIndex):i.slice(0,e-1),n.length===0?(this.vnode.parentElement.setAttribute("data-set-empty","true"),this.vnode.textContent=this.VOID_KEY):this.vnode.textContent=n;let s=i.slice(this.cursorIndex);const a=this.vnode.parentNode.parentNode,o=a.nextSibling;o?a.parentNode.insertBefore(t,o):a.parentNode.appendChild(t);const l=t.previousSibling.childNodes[0],h=l.childNodes[1];h&&l.removeChild(h);const r=this.getGridElm(!0),c=r.childNodes[0];s&&s!==this.VOID_KEY&&(c.setAttribute("data-set-empty","false"),c.innerHTML=s);const p=c.childNodes[1];t.nextSibling?(p&&c.removeChild(p),a.parentNode.insertBefore(r,t.nextSibling)):a.parentNode.appendChild(r),this.restCursorPos(c.childNodes[0])}batchReplaceRegContent(t=[],e=!0){return new Promise(i=>{let n=`<span data-set-richType="${y}"><span class="chat-grid-input" data-set-richType="${P}" data-set-empty="true">${this.VOID_KEY}</span></span>`;t.forEach(a=>{n+=`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="at-user" data-user-id="${a.id}" contentEditable="false">@${a.name}${this.needCallSpace?" ":""}</span></span><span data-set-richType="${y}"><span class="chat-grid-input" data-set-richType="${P}" data-set-empty="true">${this.VOID_KEY}</span></span>`});const s=document.createElement("div");s.innerHTML=n,this.insetRangeGrid(s,e?1:0),i()})}switchRange(t){var e,i;let{focusNode:n,focusOffset:s}=getSelection();n.getAttribute&&n.getAttribute("data-set-richType")===P&&(n=n.childNodes[0]);let a,o,l=!1;if(n.nodeType===Node.TEXT_NODE){const h=n.textContent.length,r=n.parentNode.parentNode;switch(t){case"ArrowLeft":if(s>0&&n.textContent!==this.VOID_KEY){o=s-1,a=n;break}const c=r.previousSibling;if(c&&c.children[0].classList.contains("at-input")){a=c.children[0].children[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:a.textContent.length,l=!0;break}const p=(e=r==null?void 0:r.previousSibling)==null?void 0:e.previousSibling;if(p)a=p.childNodes[0].childNodes[0],o=a.textContent.length;else{const T=r.parentNode.previousSibling;T&&(a=T.lastChild.childNodes[0].childNodes[0],o=a.textContent.length)}break;case"ArrowRight":if(s<h&&n.textContent!==this.VOID_KEY){o=s+1,a=n;break}const g=r.nextSibling;if(g&&g.children[0].classList.contains("at-input")){a=g.children[0].children[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:0,l=!0;break}const u=(i=r==null?void 0:r.nextSibling)==null?void 0:i.nextSibling;if(u)a=u.childNodes[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:0;else{const T=r.parentNode.nextSibling;T&&(a=T.childNodes[0].childNodes[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:0)}}}(o||o===0)&&(l?this.setInputTagRange(a,o):this.restCursorPos(a,o))}getGridElm(t=!1){const e=document.createElement("span");if(e.setAttribute("data-set-richType",y),e.innerHTML=`<span class="chat-grid-input" data-set-richType="${P}" data-set-empty="true">${this.VOID_KEY}<br></span>`,t)return e;const i=document.createElement("p");return i.className="chat-grid-wrap",i.setAttribute("data-set-richType",S),i.appendChild(e),i}updateGrid(){const t=getSelection(),e=t.focusNode;if(!e)return;const i=e.parentNode;let n,s,a,o;switch(i.getAttribute("data-set-richType")){case ct:if(!e.getAttribute||e.getAttribute("data-set-richType")!==S)break;if(n=e.childNodes[t.focusOffset],!n||n.getAttribute("data-set-richType")===k){const p=this.getGridElm(!0),g=p.children[0];n?(g.removeChild(g.childNodes[1]),e.insertBefore(p,n)):e.appendChild(p),this.restCursorPos(g.childNodes[0]);break}if(n.tagName&&n.tagName.toLocaleUpperCase()==="BR"){const p=this.getGridElm(!0),g=p.children[0];e.insertBefore(p,n),e.removeChild(n),p.nextElementSibling&&p.children[0].removeChild(p.children[0].childNodes[1]),this.restCursorPos(g.childNodes[0],g.childNodes[0].textContent.length)}break;case y:const l=i.parentNode,h=Array.prototype.indexOf.call(l.childNodes,i);if(h===-1)break;if(h===0){const p=t.focusNode;p.setAttribute("data-set-empty","true"),p.innerHTML=`${this.VOID_KEY}<br>`,n=p.childNodes[0],this.restCursorPos(n,n.textContent.length);break}let r,c=i.previousSibling;c.getAttribute("data-set-richType")===k?(r=c.previousSibling,l.removeChild(c),l.removeChild(i)):(r=i.previousSibling,l.removeChild(i)),n=r.childNodes[0].childNodes[0],n.textContent===this.VOID_KEY&&n.parentNode.appendChild(document.createElement("br")),this.restCursorPos(n,n.textContent.length);break;case P:if(o=i.parentNode,a=o.parentNode,this.getNodeEmpty(i)){i.setAttribute("data-set-empty","true"),a.childNodes[a.childNodes.length-1]===o&&(i.innerHTML=`${this.VOID_KEY}<br>`),n=i.childNodes[0],this.restCursorPos(n,n.textContent.length);break}if(String(i.getAttribute("data-set-empty"))==="true"){i.setAttribute("data-set-empty","false"),n=i.childNodes[0],this.target.chatEvent.isIMEModel?(i.childNodes[1]&&i.removeChild(i.childNodes[1]),n.textContent===this.VOID_KEY&&i.setAttribute("data-set-empty","true")):i.textContent=n.textContent.replace(new RegExp(this.VOID_KEY,"g"),"");const p=i.childNodes[0];this.restCursorPos(p,p.textContent.length)}if(s=i.parentNode.nextSibling,s&&s.nodeType===Node.TEXT_NODE){let p=s.textContent,g=this.getGridElm(!0);g.childNodes[0].textContent=p,g.childNodes[0].setAttribute("data-set-empty","false"),s.parentNode.insertBefore(g,s),s.parentNode.removeChild(s),s=g}s&&s.getAttribute("data-set-richType")===y&&this.markMerge(i.parentNode,s)}}getNodeEmpty(t){const e=new RegExp(`^(${this.ZERO_WIDTH_KEY}|<br>|${this.VOID_KEY})+$`);return!t.innerHTML||e.test(t.innerHTML)}setWrap(t=!0){const e=getSelection();let{focusNode:i,focusOffset:n}=e;if(i.nodeType!==Node.TEXT_NODE){if(!i.getAttribute||i.getAttribute("data-set-richType")!==P)return;i=i.childNodes[0]}const s=i.textContent.slice(n),a=i.parentNode.parentNode,o=a.parentNode,l=Array.prototype.indexOf.call(o.childNodes,a),h=Array.prototype.slice.call(o.childNodes,l+1),r=this.getGridElm();let c=r.children[0].children[0].childNodes[0];(s||h.length>0)&&c.parentNode.removeChild(c.parentNode.childNodes[1]),s&&s!==this.VOID_KEY&&(i.textContent=i.textContent.slice(0,n),c.textContent=s,c.parentElement.setAttribute("data-set-empty","false")),h.forEach(u=>{o.removeChild(u),r.appendChild(u)});const p=o.lastChild.childNodes[0],g=r.lastChild.childNodes[0];if(p.childNodes.length<=1){const u=p.childNodes[0];u.textContent&&u.textContent!==this.VOID_KEY||(p.innerHTML=`${this.VOID_KEY}<br>`,p.setAttribute("data-set-empty","true"))}if(g.parentElement.getAttribute("data-set-richType")!==y)r.appendChild(this.getGridElm(!0));else if(g.childNodes.length<=1){const u=g.childNodes[0];u.textContent&&u.textContent!==this.VOID_KEY||(g.innerHTML=`${this.VOID_KEY}<br>`,g.setAttribute("data-set-empty","true"),c=r.children[0].children[0].childNodes[0])}o.nextSibling?this.richText.insertBefore(r,o.nextSibling):this.richText.appendChild(r),t&&this.restCursorPos(c,c.textContent===this.VOID_KEY?1:0)}selectAll(){const t=document.createRange(),e=this.richText.children[0].children[0].childNodes[0].childNodes[0],i=this.richText.lastElementChild.lastElementChild.childNodes[0].childNodes[0];t.setStart(e,0),t.setEnd(i,i.textContent.length);const n=getSelection();n.removeAllRanges(),n.addRange(t)}selectRegionMerge(){const t=getSelection();if(t.isCollapsed||t.rangeCount<=0)return;const e=t.getRangeAt(0);if(e.startContainer.nodeType===Node.TEXT_NODE&&e.startContainer===e.endContainer){const i=e.startContainer;if(i.length===e.endOffset-e.startOffset){const n=i.parentNode,s=n.parentNode===n.parentNode.parentNode.lastChild;n.setAttribute("data-set-empty","true"),n.innerHTML="\uFEFF"+(s?"<br>":""),this.restCursorPos(n.childNodes[0])}else e.deleteContents()}else if(e.commonAncestorContainer&&e.commonAncestorContainer.getAttribute("data-set-richType")===S){const i=e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.parentNode.parentNode:e.startContainer,n=e.endContainer.nodeType===Node.TEXT_NODE?e.endContainer.parentNode.parentNode:e.endContainer;e.deleteContents(),i.getAttribute("data-set-richType")===n.getAttribute("data-set-richType")&&this.markMerge(i,n)}else if(e.commonAncestorContainer===e.startContainer&&e.startContainer===e.endContainer)this.initEditor(!0);else{const i=a=>{if(a.nodeType===Node.TEXT_NODE)return a.parentNode.parentNode.parentNode;switch(a.getAttribute("data-set-richType")){case P:return a.parentNode.parentNode;case y:return a.parentNode;case S:return a;default:return null}},n=i(e.startContainer),s=i(e.endContainer);if(!n||!s)return;e.deleteContents(),this.gridMerge(n,s)}return!0}gridElmMerge(){const t=getSelection(),{focusNode:e,focusOffset:i,isCollapsed:n}=t;if(!e)return this.restCursorPos(this.vnode,this.cursorIndex),!1;if(i>1||!n)return!1;const s=(l,h)=>(l.parentNode===this.richText||l===l.parentNode.childNodes[0])&&(Array.prototype.indexOf.call(this.richText.childNodes,l)!==-1?l:!(h>=6)&&s(l.parentNode,h+1)),a=s(e,0);if(!a||a===this.richText.childNodes[0]||i===1&&a.children[0].children[0].getAttribute("data-set-empty")==="false")return!1;const o=a.previousSibling;return this.gridMerge(o,a),!0}delMarkRule(){const t=getSelection(),e=t.focusNode;if(!e)return this.restCursorPos(this.vnode,this.cursorIndex),!1;const i=e.textContent,n=e.parentNode,s=n.parentNode,a=s.parentNode;if(!t.isCollapsed||n.getAttribute("data-set-richType")!==P)return!1;if(i&&i.length===1&&s!==a.childNodes[0]&&(t.focusOffset!==0||i===this.VOID_KEY)){if(i===this.VOID_KEY){const o=s.previousSibling;if(o.children[0].classList.contains("at-input")&&o.children[0].children[0].textContent!==this.VOID_KEY)return this.rangeToInputTag(o.children[0]),!0;const l=o.previousSibling;a.removeChild(o),a.removeChild(s);const h=l.childNodes[0],r=h.childNodes[0];r.textContent===this.VOID_KEY&&l===a.lastChild&&h.appendChild(document.createElement("br")),this.restCursorPos(r,r.textContent.length)}else{n.innerHTML=s===a.lastChild?`${this.VOID_KEY}<br>`:this.VOID_KEY,n.setAttribute("data-set-empty","true");const o=n.childNodes[0];this.restCursorPos(o,1)}return!0}if(t.focusOffset===0){const o=n.parentNode,l=o==null?void 0:o.previousSibling;return!(!l||l.getAttribute("data-set-richType")!==k)&&(l.children[0].classList.contains("at-input")&&l.children[0].children[0].textContent!==this.VOID_KEY?(this.rangeToInputTag(l.children[0]),!0):(this.delTag(l),!0))}}delTag(t){const e=t.previousSibling,i=t.nextSibling;t.parentNode.removeChild(t),this.markMerge(e,i)}gridMerge(t,e,i=!0){t.lastChild.getAttribute("data-set-richType")!==y&&t.appendChild(this.getGridElm(!0)),e.childNodes[0].getAttribute("data-set-richType")!==y&&e.insertBefore(this.getGridElm(!0),e.childNodes[0]);const n=t.lastChild.childNodes[0],s=n.childNodes[0];let a=s.textContent.length;Array.from(e.childNodes,l=>{t.appendChild(l.cloneNode(!0))}),e.childNodes.length>1&&n.childNodes[1]&&n.removeChild(n.childNodes[1]);const o=n.parentNode.nextSibling;if(o){const l=o.children[0].childNodes[0];l&&l.textContent!==this.VOID_KEY&&(n.childNodes[1]&&n.removeChild(n.childNodes[1]),s.textContent=(s.textContent+l.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(a--,"")),s.parentElement.setAttribute("data-set-empty","false")),t.removeChild(o)}s.textContent===""&&(s.textContent=this.VOID_KEY,s.parentNode.setAttribute("data-set-empty","true"),a=1),this.richText.removeChild(e),i&&this.restCursorPos(s,a)}markMerge(t,e){const i=t.children[0].childNodes[0];let n=i.textContent.length;if(e){const a=e.children[0].childNodes[0];a&&a.textContent!==this.VOID_KEY&&(i.textContent=(i.textContent+a.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(n--,"")),i.parentElement.setAttribute("data-set-empty","false")),e.parentNode.removeChild(e)}i.textContent===""&&(i.textContent=this.VOID_KEY,i.parentNode.setAttribute("data-set-empty","true"),n=1);const s=t.parentNode;i.textContent===this.VOID_KEY&&t===s.lastChild&&(i.parentNode.appendChild(document.createElement("br")),i.parentNode.setAttribute("data-set-empty","true"),n=1),this.restCursorPos(i,n)}setCallSpace(t){this.needCallSpace=t}getWrapNode(t,e=!1){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode.parentNode;const i=t.getAttribute("data-set-richType");if(e&&i===k)return t.parentNode;switch(i){case P:return t.parentNode.parentNode;case y:return t.parentNode;case S:return t}}getMarkNode(t,e=!1){if(t.nodeType===Node.TEXT_NODE)return t.parentNode?t.parentNode.parentNode:null;const i=t.getAttribute("data-set-richType");if(e&&i===k)return t;switch(i){case P:return t.parentNode;case y:return t}}getRichTextNodeIndex(){let t,e,i,n=null,s=null,a=null;switch(this.lastCursorType){case"inputTag":if(!this.inputTag_vnode||(e=K(this.inputTag_vnode.parentElement,5),!e))break;i=e.parentElement,n=Array.prototype.indexOf.call(this.richText.children,i),a=Array.prototype.indexOf.call(i.children,e);break;case"gridInput":if(!this.vnode||(t=K(this.vnode.parentElement,5),!t))break;i=t.parentElement,n=Array.prototype.indexOf.call(this.richText.children,i),s=Array.prototype.indexOf.call(i.children,t)}return{gridIndex:n,markIndex:s,tagIndex:a}}setWrapNodeByMark(t){const e=document.createElement("p");return e.className="chat-grid-wrap",e.setAttribute("data-set-richType",S),Array.from(t,i=>{e.appendChild(i)}),e}insetRangeGrid(t,e=0){const i=this.vnode.textContent,n=i.slice(0,this.cursorIndex-e);n.length===0?(this.vnode.parentElement.setAttribute("data-set-empty","true"),this.vnode.textContent=this.VOID_KEY):this.vnode.textContent=n;let s=i.slice(this.cursorIndex);const a=[],o=document.createDocumentFragment();Array.from(t.children).forEach((u,T)=>{a.push(u),T!==0&&o.appendChild(u)});const l=a[a.length-1].children[0];s&&s.length>0&&s!==this.VOID_KEY?(l.setAttribute("data-set-empty","false"),l.textContent=l.textContent+s):l.setAttribute("data-set-empty","true");const h=this.getMarkNode(this.vnode),r=h.parentElement,c=h.children[0],p=a[0].textContent;p&&p.length>0&&p!==this.VOID_KEY&&(c.setAttribute("data-set-empty","false"),c.textContent=(c.textContent+p).replace(new RegExp(this.VOID_KEY,"g"),"")),c.childNodes[1]&&c.removeChild(c.childNodes[1]),h.nextElementSibling?(l.childNodes[1]&&l.removeChild(l.childNodes[1]),r.insertBefore(o,h.nextElementSibling)):r.appendChild(o);const g=s&&s!==this.VOID_KEY?s.length:0;if(a.length>1){const u=l.childNodes[0];this.restCursorPos(u,u.textContent===this.VOID_KEY?1:u.textContent.length-g)}else{const u=c.childNodes[0];this.restCursorPos(u,u.textContent===this.VOID_KEY?1:u.textContent.length-g)}}insetRangeGrids(t){const e=document.createDocumentFragment();Array.from(t).forEach(s=>{e.appendChild(s)});const i=this.getWrapNode(this.vnode);this.restCursorPos(this.vnode,this.cursorIndex),this.setWrap(!1);const n=i.nextElementSibling;n&&this.richText.insertBefore(e,n),n&&n.previousElementSibling?(this.gridMerge(i,i.nextElementSibling,!1),this.gridMerge(n.previousElementSibling,n,!0)):this.gridMerge(i,i.nextElementSibling,!0)}getOffsetRange(t,e,i=!1){const n=e.children[0].childNodes[0],s=n.textContent;if(t===0)return{rangeNode:n,rangeIndex:i?s.length:s===this.VOID_KEY?1:0};if(s!==this.VOID_KEY&&s.length>=t)return{rangeNode:n,rangeIndex:i?s.length-t:t};let a,o;if(i?(a=!!(e.previousElementSibling&&e.previousElementSibling.previousElementSibling),o=!!e.parentElement.previousElementSibling):(a=!!(e.nextElementSibling&&e.nextElementSibling.nextElementSibling),o=!!e.parentElement.nextElementSibling),!a&&!o)return{rangeNode:n,rangeIndex:i?s.length===this.VOID_KEY?1:0:s.length===this.VOID_KEY?1:s.length};const l=t-s.length,h=i?a?e.previousElementSibling.previousElementSibling:e.parentElement.previousElementSibling.lastElementChild:a?e.nextElementSibling.nextElementSibling:e.parentElement.nextElementSibling.children[0];return this.getOffsetRange(l,h,i)}isInInputTag(){const t=getSelection().focusNode;return!!t&&(t.classList&&t.classList.contains("input-write")?t:t.nodeType===Node.TEXT_NODE&&!!(t.parentElement&&t.parentElement.classList&&t.parentElement.classList.contains("input-write"))&&t.parentElement)}rangeToInputTag(t){const e=t.children[0].childNodes[0];this.setInputTagRange(e,e.textContent===this.VOID_KEY?1:e.textContent.length)}watchInputTag(t){if(t.childNodes.length===0||t.textContent.length===0)t.textContent=this.VOID_KEY,this.rangeToInputTag(t.parentElement);else{const e=t.childNodes[0];this.target.nextTick(()=>{if(!this.target.chatEvent.isComposition){const i=getSelection().focusOffset,n=t.textContent===this.VOID_KEY||t.textContent.indexOf(this.VOID_KEY)===-1?0:1;let s=!1;n===1&&(e.textContent=e.textContent.replace(this.VOID_KEY,""),s=!0),t.textContent.indexOf(this.INPUT_TAG_WRAP_KEY[1])!==-1&&(t.textContent=t.textContent.replace(new RegExp(this.INPUT_TAG_WRAP_KEY[0],"g"),"").replace(new RegExp(this.INPUT_TAG_WRAP_KEY[1],"g"),this.INPUT_TAG_WRAP_KEY),s=!0),s&&this.setInputTagRange(t.childNodes[0],i-n)}})}m(t.nextElementSibling,t.textContent===this.VOID_KEY,"inline")}backRuleInputTag(t){if(t.textContent===this.VOID_KEY)return this.delTag(t.parentElement.parentElement),!0;const e=getSelection();if(e.focusOffset===0&&e.isCollapsed){const i=t.parentElement.parentElement.previousElementSibling.children[0].childNodes[0];return this.restCursorPos(i,i.textContent===this.VOID_KEY?1:i.textContent.length),!0}if(e.focusNode.textContent.indexOf(this.INPUT_TAG_WRAP_KEY[1])!==-1){const i=this.getDiffInputTagOffset(e.focusNode,e.focusOffset,"left");if(i>0){const n=e.focusNode.textContent.slice(0,e.focusOffset-1-i),s=e.focusNode.textContent.slice(e.focusOffset);return e.focusNode.textContent=n+s,e.focusNode.textContent?this.setInputTagRange(e.focusNode,n.length):(e.focusNode.textContent=this.VOID_KEY,this.watchInputTag(e.focusNode.parentElement),this.setInputTagRange(e.focusNode,1)),!0}}return!1}mergeRuleInputTag(t){this.target.nextTick(()=>{t.childNodes.length>1&&(t.removeChild(t.childNodes[1]),this.watchInputTag(t))})}inputTagSwitchRange(t){const{focusNode:e,focusOffset:i}=getSelection(),n=e.textContent.length,s=e.parentElement.parentElement.parentElement;let a,o,l,h=!1;switch(t){case"ArrowLeft":i>0&&e.textContent!==this.VOID_KEY?(l=this.getDiffInputTagOffset(e,i,"left"),o=i-1-l,a=e):(a=s.previousElementSibling.children[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:a.textContent.length,h=!0);break;case"ArrowRight":i<n&&e.textContent!==this.VOID_KEY?(l=this.getDiffInputTagOffset(e,i,"right"),o=i+1+l,a=e):(a=s.nextElementSibling.children[0].childNodes[0],o=a.textContent===this.VOID_KEY?1:0,h=!0)}h?this.restCursorPos(a,o):this.setInputTagRange(a,o)}pasteInputTag(t){t=t.replace(new RegExp(this.INPUT_TAG_WRAP_KEY[0],"g"),"").replace(new RegExp(this.INPUT_TAG_WRAP_KEY[1],"g"),this.INPUT_TAG_WRAP_KEY);const e=getSelection(),{focusNode:i,focusOffset:n,anchorOffset:s}=e;let a="",o="";e.isCollapsed?(a=i.textContent.slice(0,n)||"",o=i.textContent.slice(n)||""):(a=i.textContent.slice(0,s<n?s:n)||"",o=i.textContent.slice(n>s?n:s)||""),i.textContent=a+t+o,this.setInputTagRange(i,(s<n?s:n)+t.length);const l=i.parentElement;this.watchInputTag(l)}setInputTagWrap(t){const e=getSelection(),{focusOffset:i}=e,n=t.textContent,s=n.slice(0,i),a=n.slice(i);t.textContent=s+this.INPUT_TAG_WRAP_KEY+a,this.setInputTagRange(t.childNodes[0],i+this.INPUT_TAG_WRAP_KEY.length),this.watchInputTag(t)}getDiffInputTagOffset(t,e,i){const n=i==="left"?t.textContent[e-1]:t.textContent[e];if(this.INPUT_TAG_WRAP_KEY.indexOf(n)===-1)return 0;switch(i){case"left":return t.textContent[e-2]===this.INPUT_TAG_WRAP_KEY[1]?2:t.textContent[e-2]===this.INPUT_TAG_WRAP_KEY[0]?3:1;case"right":return t.textContent[e+1]===this.INPUT_TAG_WRAP_KEY[1]?2:t.textContent[e+1]===this.INPUT_TAG_WRAP_KEY[0]?3:1}}updateNodeCursor(){const{focusNode:t,focusOffset:e}=getSelection();if(!t||t.nodeType!==Node.TEXT_NODE)return;const i=K(t.parentElement,5);if(!i)return;const n=i.getAttribute("data-set-richType");if(n&&i.parentElement.parentElement===this.richText)switch(n){case y:this.updateGridInputCursor(t,e);break;case k:i.children[0].classList.contains("at-input")&&this.updateInputTagCursor(t,e)}}updateGridInputCursor(t,e){this.lastCursorType="gridInput",this.vnode=t,this.cursorIndex=t.textContent===this.VOID_KEY?1:e}updateInputTagCursor(t,e){this.lastCursorType="inputTag",this.inputTag_vnode=t,this.inputTag_cursorIndex=t.textContent===this.VOID_KEY?1:e}restCursorPos(t,e){e==null?e=t.textContent===this.VOID_KEY?1:0:e>t.textContent.length&&(e=t.textContent.length);const i=new Range;i.setStart(t,e),i.setEnd(t,e);const n=getSelection();n.removeAllRanges(),n.addRange(i),this.updateGridInputCursor(t,e)}setInputTagRange(t,e){e==null?e=t.textContent===this.VOID_KEY?1:0:e>t.textContent.length&&(e=t.textContent.length);const i=new Range;i.setStart(t,e),i.setEnd(t,e);const n=getSelection();n.removeAllRanges(),n.addRange(i),this.updateInputTagCursor(t,e)}setRangeLastRecord(){switch(this.lastCursorType){case"gridInput":this.restCursorPos(this.vnode,this.cursorIndex);break;case"inputTag":this.setInputTagRange(this.inputTag_vnode,this.inputTag_cursorIndex)}}setRangeLastText(){const t=this.richText.childNodes[this.richText.childNodes.length-1],e=t.childNodes[t.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(e,e.textContent===this.VOID_KEY?1:e.textContent.length),this.viewIntoPoint()}viewIntoPoint(){let t,e;const i=getSelection(),{focusNode:n,focusOffset:s}=i;if(n&&n.parentElement&&n.parentElement.classList.contains("input-write"))t=n.parentElement.parentElement,e=s;else{if(!this.vnode)return;t=this.getMarkNode(this.vnode),e=this.cursorIndex}if(!t)return;const a=t.getBoundingClientRect(),o=Math.ceil(a.height/this.NODE_HEIGHT),l=Math.floor(t.textContent.length/o)||1,h=(Math.floor(e/l)||1)*this.NODE_HEIGHT,r=a.top+(h-this.NODE_HEIGHT),c=this.richText.parentElement,p=c.getBoundingClientRect(),g=p.top,u=p.top+p.height;if(r<g+this.NODE_PADDING_DIFF){const T=g-r;c.scrollTo(0,c.scrollTop-T)}else if(r>u-this.NODE_HEIGHT){const T=r-u+this.NODE_HEIGHT;c.scrollTo(0,c.scrollTop+T)}}}class Nt{constructor(t){f(this,"target"),f(this,"outerApply",!1),f(this,"isComposition",!1),f(this,"matchKey",0),f(this,"startOpenIndex",0),f(this,"textLength",0),f(this,"isIMEModel",!1),f(this,"takeIMEModel",!1),f(this,"undoHistory",[]),f(this,"redoHistory",[]),f(this,"doOverHistory",!0),f(this,"chatEventModule",{enterSend:[],operate:[],defaultAction:[],atMatch:[],atCheck:[],tagCheck:[],selectCheck:[],tipTagState:[],afterAtCheck:[],afterTagCheck:[],afterSelectCheck:[],showAtDialog:[],showTagDialog:[],showSelectDialog:[],elementClicked:[]}),f(this,"debounceEvents",{recordHistory:()=>{},dialogMoveToRange:e=>{},selectDialogToAim:()=>{},matchPointDialog:()=>{},movePointActiveUserElm:e=>{},moveCustomActiveTagElm:e=>{}}),this.target=t,this.registerEvent(),this.otherEvent()}registerEvent(){const{chatElement:t,options:e,chatInput:i}=this.target;t.richText.addEventListener("keyup",this.onKeyUp.bind(this)),t.richText.addEventListener("keydown",this.onKeyDown.bind(this)),t.richText.addEventListener("beforeinput",this.onBeforeinput.bind(this)),t.richText.addEventListener("input",this.onInput.bind(this)),t.richText.addEventListener("copy",n=>{n.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(n)},"defaultAction","COPY")}),t.richText.addEventListener("cut",n=>{n.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(n),this.removeRange(),n.target.classList.contains("input-write")&&this.target.chatInput.watchInputTag(n.target)},"defaultAction","CUT")}),t.richText.addEventListener("paste",n=>{n.preventDefault();const{options:s,chatInput:a}=this.target;this.ruleChatEvent(()=>{const o=n.clipboardData.getData("text/plain");if(typeof o=="string"&&o!==""){if(s.copyType.indexOf("text")===-1)return;if(this.removeRange(),n.target.classList.contains("input-write"))return a.pasteInputTag(o),void this.richTextInput();const l=n.clipboardData.getData(V)||"";if(l&&l.indexOf(S)!==-1)return void this.insertInsideHtml(yt(l));this.target.insertText(o)}else{if(s.copyType.indexOf("image")===-1)return;this.removeRange();const l=(n.clipboardData||n.originalEvent.clipboardData).items||[];Array.from(l,async h=>{if(h.type.indexOf("image")===-1)return;const r=h.getAsFile();if(s.uploadImage){const c=await s.uploadImage(r);this.target.insertHtml(`<img class="chat-img" src="${c}" alt="" />`)}else{const c=new FileReader;c.onload=p=>{this.target.insertHtml(`<img class="chat-img" src="${p.target.result}" alt="" />`)},c.readAsDataURL(r)}})}},"defaultAction","PASTE")}),t.richText.addEventListener("blur",()=>{i.updateNodeCursor()}),t.richText.addEventListener("focus",()=>{i.updateNodeCursor()}),t.richText.addEventListener("click",n=>{i.updateNodeCursor();const s=K(n.target,10);if(s){const a=s.children[0];if(a.classList.contains("chat-grid-input"))return void this.triggerChatEvent("elementClicked","gridInput",a);if(a.classList.contains("at-input"))return a.children[0].textContent===i.VOID_KEY&&i.rangeToInputTag(a),void this.triggerChatEvent("elementClicked","inputTag",a);if(a.classList.contains("at-select")){const o=a.getAttribute("data-select-key");return this.triggerChatEvent("showSelectDialog",o,a),e.needDialog&&this.target.showPCSelectDialog(o,a),void this.triggerChatEvent("elementClicked","selectTag",a)}if(a.classList.contains("at-user"))return void this.triggerChatEvent("elementClicked","userTag",a);if(a.classList.contains("at-tag"))return void this.triggerChatEvent("elementClicked","customTag",a);if(a.classList.contains("chat-set-html"))return void this.triggerChatEvent("elementClicked","htmlTag",a.children[0])}}),t.richText.addEventListener("dragstart",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("dragover",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("drop",n=>{n.stopPropagation(),n.preventDefault()}),t.richText.addEventListener("compositionstart",()=>{this.isComposition=!0}),t.richText.addEventListener("compositionend",()=>{this.isComposition=!1}),window.addEventListener("click",this.winClick.bind(this)),window.addEventListener("keydown",this.winKeydown.bind(this))}onKeyUp(t){if(this.target.chatInput.isInInputTag())return;t.stopPropagation();const e=this.target.chatInput.getCurrentCursorKey();this.target.deviceInfo.isPc?t.key!=="@"&&String(t.key)!=="2"||e!=="@"?this.target.options.customTrigger.filter(i=>i.keyMap.includes(String(t.key))).map(i=>i.prefix).forEach(i=>{e===i&&(this.triggerChatEvent("showTagDialog",i),this.target.options.needDialog&&this.target.chatElement.showCustomTagDialog(i))}):(this.triggerChatEvent("showAtDialog"),this.target.options.needDialog&&this.target.chatElement.ruleShowPointDialog()):(this.target.options.reformList.length>0||this.target.options.asyncMatch)&&e==="@"?(this.triggerChatEvent("showAtDialog"),this.target.options.needDialog&&this.target.showH5Dialog(),this.target.chatElement.isExternalCallPopup=!1):this.target.options.customTrigger.map(i=>i.prefix).forEach(i=>{e===i&&this.triggerChatEvent("showTagDialog",i)})}onKeyDown(t){const e=this.target.chatInput.isInInputTag();if(!this.target.deviceInfo.isPc&&_(t,"IME"))return e&&this.target.chatInput.mergeRuleInputTag(e),void(this.isIMEModel=!0);this.isIMEModel||($(this.target.chatElement.pcElms.pointDialogElm)?_(t,"dialog-options")?t.preventDefault():_(t,"text-move")&&this.target.chatElement.exitPointDialog():this.target.chatElement.pcElms.customTagDialogTagKey&&$(this.target.chatElement.pcElms.customTagDialogElms[this.target.chatElement.pcElms.customTagDialogTagKey])?_(t,"dialog-options")?t.preventDefault():_(t,"text-move")&&this.target.chatElement.exitCustomTagDialog():(!this.isComposition&&_(t,"text-delete")?e?(this.target.chatInput.backRuleInputTag(e)&&(t.preventDefault(),this.richTextInput()),this.target.chatInput.mergeRuleInputTag(e)):this.target.chatInput.selectRegionMerge()||this.target.chatInput.gridElmMerge()||this.target.chatInput.delMarkRule()?(t.preventDefault(),this.richTextInput()):this.target.chatElement.tipElm&&this.target.isEmpty()&&this.target.chatElement.removeTipElm():this.target.options.wrapKeyFun(t)||!this.target.deviceInfo.isPc&&t.key==="Enter"?(t.preventDefault(),this.isComposition||(e?this.target.chatInput.setInputTagWrap(e):this.target.chatInput.setWrap(),this.richTextInput())):this.target.options.sendKeyFun(t)?(t.preventDefault(),this.isComposition||this.triggerChatEvent("enterSend")):_(t,"text-move")?(t.preventDefault(),this.isComposition||(e?this.target.chatInput.inputTagSwitchRange(t.code):this.target.chatInput.switchRange(t.code))):_(t,"text-select-all")?(t.preventDefault(),this.isComposition||this.target.isEmpty()||this.target.chatInput.selectAll()):_(t,"text-undo")?(t.preventDefault(),this.isComposition||this.ruleChatEvent(()=>{this.target.undo()},"defaultAction","UNDO")):_(t,"text-redo")&&(t.preventDefault(),this.isComposition||this.ruleChatEvent(()=>{this.target.redo()},"defaultAction","REDO")),this.target.deviceInfo.isPc&&!getSelection().isCollapsed&&_(t,"text-write")&&this.target.chatInput.selectRegionMerge()))}onBeforeinput(t){const e=this.target.chatInput.isInInputTag();if(this.isIMEModel){if(t.inputType==="insertParagraph")return t.preventDefault(),e?this.target.chatInput.setInputTagWrap(e):this.target.chatInput.setWrap(),void this.richTextInput();if(t.inputType==="deleteContentBackward"){this.takeIMEModel=!0,t.preventDefault();const i=this.target.chatElement.richText.innerHTML,n=getSelection(),s=n.focusNode,a=n.focusOffset;let o=-1,l=-1;if(s.nodeType!==Node.TEXT_NODE){const h=s;if(!h||!h.getAttribute||h.getAttribute("data-set-richType")!==S)return;o=Array.prototype.indexOf.call(this.target.chatElement.richText.children,h),l=0}else{const h=e?s.parentElement.parentElement.parentElement:s.parentElement.parentElement,r=h.parentElement;o=Array.prototype.indexOf.call(this.target.chatElement.richText.children,r),l=Array.prototype.indexOf.call(r.children,h)}this.target.nextTick(()=>{if(this.target.chatElement.richText.innerHTML=i,o===-1||l===-1)return this.takeIMEModel=!1,void(this.isIMEModel=!1);const h=this.target.chatElement.richText.children[o].children[l],r=e?h.children[0].children[0].childNodes[0]:h.children[0].childNodes[0];e?(this.target.chatInput.setInputTagRange(r,a),this.target.chatInput.backRuleInputTag(r.parentElement)||(r.textContent=r.textContent.slice(0,a-1)+r.textContent.slice(a),this.target.chatInput.setInputTagRange(r,a-1)),this.target.chatInput.watchInputTag(r.parentElement)):(this.target.chatInput.restCursorPos(r,a),this.target.chatInput.selectRegionMerge()||this.target.chatInput.gridElmMerge()||this.target.chatInput.delMarkRule()||(r.textContent=r.textContent.slice(0,a-1)+r.textContent.slice(a),this.target.chatInput.restCursorPos(r,a-1))),this.target.nextTick(async()=>{await this.richTextInput(),this.takeIMEModel=!1,this.isIMEModel=!1})})}}}onInput(){const t=this.target.chatInput.isInInputTag();if(this.isIMEModel){if(this.takeIMEModel)return;this.target.nextTick(()=>{t&&this.target.chatInput.watchInputTag(t),this.richTextInput()})}else{if(t)return this.target.chatInput.watchInputTag(t),void this.richTextInput();this.richTextInput().then(()=>{this.target.deviceInfo.isPc&&!this.isComposition&&this.debounceEvents.matchPointDialog()})}}winClick(){if(!this.target||this.outerApply)return;const{chatElement:t}=this.target;$(t.pcElms.pointDialogElm)&&t.exitPointDialog(),t.pcElms.checkDialogSearchResultElm&&m(t.pcElms.checkDialogSearchResultElm),t.pcElms.customTagDialogTagKey&&$(t.pcElms.customTagDialogElms[t.pcElms.customTagDialogTagKey])&&t.exitCustomTagDialog(),t.pcElms.selectDialogKey&&$(t.pcElms.selectDialogElms[t.pcElms.selectDialogKey])&&t.exitSelectDialog()}async winKeydown(t){if(!this.target)return;const{chatElement:e,options:i}=this.target;if((t.ctrlKey||t.metaKey)&&t.code==="KeyZ"&&t.preventDefault(),!this.isComposition){if($(e.pcElms.pointDialogElm)){if(t.code==="ArrowDown")return t.preventDefault(),void this.debounceEvents.movePointActiveUserElm("down");if(t.code==="ArrowUp")return t.preventDefault(),void this.debounceEvents.movePointActiveUserElm("up");if((t.code==="Enter"||t.code==="NumpadEnter")&&e.pcElms.pointDialogActiveElm){t.preventDefault();const n=e.pcElms.pointDialogActiveElm.getAttribute("data-set-id");if(await W(100),e.isPointSearchMode||i.asyncMatch)await this.target.matchSetTag(i.reformList.find(s=>s.id===n));else{const s=i.userList.find(a=>String(a[i.userProps.id])===n);await this.target.onceSetTag(s)}e.exitPointDialog()}}else if(e.pcElms.customTagDialogTagKey&&$(e.pcElms.customTagDialogElms[e.pcElms.customTagDialogTagKey])){if(t.code==="ArrowDown")return t.preventDefault(),void this.debounceEvents.moveCustomActiveTagElm("down");if(t.code==="ArrowUp")return t.preventDefault(),void this.debounceEvents.moveCustomActiveTagElm("up");if((t.code==="Enter"||t.code==="NumpadEnter")&&e.pcElms.customTagDialogActiveElm){t.preventDefault();const n=e.pcElms.customTagDialogActiveElm.getAttribute("data-set-id");await W(100);const s=e.customTags[e.pcElms.customTagDialogTagKey].find(a=>a.id===n);e.isPointSearchMode?await this.target.matchSetCustomTag(s):await this.target.onceSetCustomTag(s),e.exitCustomTagDialog()}}}}otherEvent(){const{options:t,chatInput:e,chatElement:i}=this.target,{needDebounce:n}=t,s=()=>{const{gridIndex:r,markIndex:c,tagIndex:p}=e.getRichTextNodeIndex();c!==null?this.undoHistory.push({html:i.richText.innerHTML,gridIndex:r,markIndex:c,tagIndex:p,cursorIndex:e.cursorIndex,inputTag_cursorIndex:e.inputTag_cursorIndex,type:"gridInput"}):p!==null&&this.undoHistory.push({html:i.richText.innerHTML,gridIndex:r,markIndex:c,tagIndex:p,cursorIndex:e.cursorIndex,inputTag_cursorIndex:e.inputTag_cursorIndex,type:"inputTag"}),this.undoHistory.length>50&&this.undoHistory.shift()};this.debounceEvents.recordHistory=n?G(s,200):s;const a=r=>{let c="0",p="100%";const g=e.getRangeRect();if(!g)return;const u=i.pcElms.containerDialogElm.getBoundingClientRect();let T=g.x-u.x,x=u.y-g.y;const{clientWidth:C,clientHeight:D}=r;g.x>window.innerWidth-C-30&&(T=g.x-C-u.x-16,c="100%"),g.y<D&&(x-=D,p="0"),r.style.transform="translate(0, 0)",r.style.transformOrigin=`${c} ${p}`,r.style.left=T+6+"px",r.style.bottom=`${x}px`,r.style.opacity="1"};this.debounceEvents.dialogMoveToRange=n?G(a,120,!0):a;const o=()=>{if(!t.needDialog||!t.asyncMatch&&t.reformList.length===0&&t.customTrigger.length===0)return;const r=e.getCurrentCursorKey();if(!t.asyncMatch&&r==="@")return void i.ruleShowPointDialog();if(t.customTrigger.some(I=>{if(r===I.prefix)return i.showCustomTagDialog(I.prefix),!0}))return;const c=e.vnode.textContent||"",p=e.cursorIndex,g=c.slice(0,p);let u=-1,T=-1,x="userTag";if(g.lastIndexOf("@")!==-1&&(u=g.lastIndexOf("@")),i.pcElms.customTagDialogTagKey&&g.lastIndexOf(i.pcElms.customTagDialogTagKey)!==-1&&(T=g.lastIndexOf(i.pcElms.customTagDialogTagKey)),T>u&&(x="customTag"),x==="userTag"&&t.asyncMatch){if(u<0)return void i.exitPointDialog();this.matchKey++;const I=this.matchKey;this.startOpenIndex=u+1;const b=g.slice(this.startOpenIndex)||"";if(/\s/gi.test(b))return void i.exitPointDialog();this.target.updateUserList([]),m(i.pcElms.pointDialogLoadingElm,!0,"flex"),m(i.pcElms.pointDialogEmptyElm),i.showPointDialog();const O=this.triggerChatEvent("atMatch",b).find(A=>A&&A instanceof Promise);return void(O&&O.then(A=>{I===this.matchKey&&(m(i.pcElms.pointDialogLoadingElm),!A||A.length<=0?m(i.pcElms.pointDialogEmptyElm,!0,"flex"):(this.target.updateUserList(A),i.pcElms.pointDialogUsersElm&&i.pcElms.pointDialogUsersElm.length>0&&i.updatePointActiveUserElm(i.pcElms.pointDialogUsersElm[0].elm)))}))}if(x==="userTag"&&t.reformList.length<=0)return void i.exitCustomTagDialog();if(x==="customTag"&&i.customTags[i.pcElms.customTagDialogTagKey].length<=0)return;const C=()=>{x==="userTag"?i.exitPointDialog():i.exitCustomTagDialog()};if(u<0&&T<0)return i.exitPointDialog(),void i.exitCustomTagDialog();this.startOpenIndex=x==="userTag"?u+1:T+1;const D=new RegExp(`^([${e.ZERO_WIDTH_KEY}${e.VOID_KEY}])+$`);if(!g||D.test(g)||p<this.startOpenIndex)return void C();const v=g.slice(this.startOpenIndex)||"";if(/\s/gi.test(v))C();else if(v)if(x==="userTag"){i.isExternalCallPopup=!1;const I=this.target.searchUserList(v);I.length>0?i.showPointDialog(I):C()}else{const I=i.customTags[i.pcElms.customTagDialogTagKey].filter(b=>Z(b.name,b.pinyin||"",v));I.length>0?i.showCustomTagDialog(i.pcElms.customTagDialogTagKey,I):C()}else x==="userTag"?i.ruleShowPointDialog():i.showCustomTagDialog(i.pcElms.customTagDialogTagKey)};this.debounceEvents.matchPointDialog=n?G(o,200):o,this.debounceEvents.movePointActiveUserElm=et(r=>{if(!i.pcElms.pointDialogActiveElm)return;let c=0;const p=i.pcElms.pointDialogActiveElm.getAttribute("data-set-id");i.pcElms.pointDialogUsersElm.some(x=>{const C=x.elm.getAttribute("data-set-id");return c=x.index,p===C});const g=i.pcElms.pointDialogUsersElm.filter(x=>!x.elm.classList.contains("user-no-match")),u=g.map(x=>x.index);let T;r==="down"?T=c===g[g.length-1].index?g[0]:g[u.indexOf(c)+1]:r==="up"&&(T=c===g[0].index?g[g.length-1]:g[u.indexOf(c)-1]),T&&i.updatePointActiveUserElm(T.elm,!0)},80),this.debounceEvents.moveCustomActiveTagElm=et(r=>{if(!i.pcElms.customTagDialogActiveElm)return;const c=i.customTags[i.pcElms.customTagDialogTagKey].map(C=>C.id),p=i.pcElms.customTagDialogActiveElm.getAttribute("data-set-id"),g=c.indexOf(p),u=Array.from(i.pcElms.customTagDialogElms[i.pcElms.customTagDialogTagKey].children[1].children,(C,D)=>({elm:C,index:D})).filter(C=>!C.elm.classList.contains("tag-no-match")),T=u.map(C=>C.index);let x;r==="down"?x=g===u[u.length-1].index?u[0]:u[T.indexOf(g)+1]:r==="up"&&(x=g===u[0].index?u[u.length-1]:u[T.indexOf(g)-1]),x&&i.updateActiveCustomTagElm(x.elm,!0)},80);const l=()=>{const r=i.pcElms.selectDialogAim.getClientRects()[0],c=i.pcElms.selectDialogElms[i.pcElms.selectDialogKey];m(c,!0);const p=c.querySelector(".chat-select-arrow");let g=c.clientHeight+16;if(g>r.y?(g=-(r.height+16),p.style.top="-16px",p.style.bottom="auto",p.style.transform="rotate(0deg)"):(p.style.transform="rotate(180deg)",p.style.bottom="-16px",p.style.top="auto"),window.innerWidth-r.x<c.clientWidth){const v=c.clientWidth-(window.innerWidth-r.x)-10;c.style.left="auto",c.style.right="10px",p.style.left="auto",p.style.right=v-p.clientWidth/2+r.width/2+"px"}else c.style.left=r.x+"px",c.style.right="auto",p.style.left=r.width/2-p.clientWidth/2+"px",p.style.right="auto";c.style.top=r.y+"px",c.style.transform=`translateY(${-g}px)`;const u=c.children[1],T=u.children;let x=0,C=!1,D=0;if(i.pcElms.selectDialogAim.classList.contains("at-select")){const v=i.pcElms.selectDialogAim.getAttribute("data-select-id");E(i.pcElms.selectDialogAim,"aim",!0),Array.from(T,b=>{const O=b.lastChild.lastChild,A=v===b.getAttribute("data-set-id");A&&(D=b.clientHeight,C=!0),A||C||(x+=b.clientHeight),m(O,A,"inline-block")});const I=x-u.clientHeight/2+D/2;u.scrollTop=I>0?I:0}else Array.from(T,v=>{m(v.lastChild.lastChild,!1,"inline-block")})};this.debounceEvents.selectDialogToAim=n?G(l,120):l;const h={html:i.richText.innerHTML,gridIndex:0,markIndex:0,tagIndex:0,type:e.lastCursorType,cursorIndex:e.cursorIndex,inputTag_cursorIndex:e.inputTag_cursorIndex};this.undoHistory=[h]}async richTextInput(t=!0){const{chatInput:e,deviceInfo:i,chatElement:n,options:s}=this.target;return e.updateNodeCursor(),i.isPc&&e.selectRegionMerge(),await this.target.nextTick(()=>{this.isComposition||e.updateGrid(),this.fixEditor()||(s.maxLength!==-1&&this.ruleMaxLength(),n.showPlaceholder(),this.triggerChatEvent("operate"),i.isPc&&t&&this.doOverHistory&&!this.isComposition&&this.debounceEvents.recordHistory(),e.viewIntoPoint())}),!0}ruleMaxLength(){const{options:t,chatElement:e}=this.target;if(this.target.isEmpty()||t.maxLength===-1)return void(this.textLength=0);let i=0,n=0;const s=[];Array.prototype.some.call(e.richText.children,(o,l)=>{const{nodeInfos:h,nodeTextLength:r}=this.getGirdNodeTextInfo(o);if(i+=r,s.push(h),n=l,i>=t.maxLength)return!0});const a=[];Array.from(e.richText.children,(o,l)=>{l>n&&a.push(o)}),a.forEach(o=>e.richText.removeChild(o)),this.deepDelGirdText(s,i)}getGirdNodeTextInfo(t){const{chatInput:e}=this.target,i=[];let n=0;if(t.children.length===1&&t!==t.parentElement.children[0]){const s=t.children[0],a=(s.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");n+=a.length||1,i[0]={node:s,textLength:a.length||1,type:y}}else Array.from(t.children,(s,a)=>{if(s.getAttribute("data-set-richType")===y){const o=(s.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");n+=o.length,i[a]={node:s,textLength:o.length,type:y}}else{const o=(s.textContent||"").replace(new RegExp(e.VOID_KEY,"g"),"");n+=o.length||1,i[a]={node:s,textLength:o.length||1,type:k}}});return{nodeInfos:i,nodeTextLength:n}}deepDelGirdText(t,e){if(e>this.target.options.maxLength){const i=t[t.length-1];t.pop(),this.deepDelNode(i,t,e)}else this.textLength=e}deepDelNode(t,e,i){const n=t[0].node.parentElement;if(i>this.target.options.maxLength){let s=i-this.target.options.maxLength,a=t[t.length-1];if(a.type===y)if(a.textLength===0||s>=a.textLength)n.removeChild(a.node),t.pop(),s-=a.textLength,a=t[t.length-1],n.removeChild(a.node),t.pop(),s-=a.textLength;else{const o=a.node.childNodes[0];o.textContent=o.textContent.slice(0,a.textLength-s),o.textContent===0&&(o.setAttribute("data-set-empty","true"),o.innerHTML=`${this.target.chatInput.VOID_KEY}<br>`),s=0}else n.removeChild(a.node),t.pop(),s-=a.textLength;s>0?t.length>0?this.deepDelNode(t,e,s+this.target.options.maxLength):(this.target.chatElement.richText.appendChild(n),this.deepDelGirdText(e,s+this.target.options.maxLength)):(this.textLength=this.target.options.maxLength+s,this.target.chatInput.setRangeLastText())}}copyRange(t){const e=getSelection();if(e.isCollapsed||e.rangeCount<=0)return t.clipboardData.setData(V,""),void t.clipboardData.setData("text/plain","");const{chatElement:i,chatInput:n}=this.target,s=e.toString()||"";let a=document.createElement("div");a.innerHTML=N(s);const o=a.textContent.replace(/\n\n/g,`
`);a=null,t.clipboardData.setData("text/plain",o);const l=e.anchorNode,h=e.focusNode;if(l===h&&l.nodeType===Node.TEXT_NODE)return void t.clipboardData.setData(V,o);if(l===i.richText&&h===i.richText)return void t.clipboardData.setData(V,i.richText.innerHTML);const r=n.getWrapNode(l,!0),c=n.getWrapNode(h,!0),p=n.getMarkNode(l,!0),g=n.getMarkNode(h,!0),u=p.getAttribute("data-set-richType")===y,T=g.getAttribute("data-set-richType")===y,x=Array.prototype.indexOf.call(r.childNodes,p),C=Array.prototype.indexOf.call(c.childNodes,g);if(r===c&&r.parentNode===i.richText){const D=x>C,v=Array.prototype.filter.call(r.childNodes,(H,R)=>D?R<x&&R>C:R>x&&R<C).map(H=>H.cloneNode(!0)),I=u?D?l.textContent.slice(0,e.anchorOffset):l.textContent.slice(e.anchorOffset):"",b=T?D?h.textContent.slice(e.focusOffset):h.textContent.slice(0,e.focusOffset):"",O=n.getGridElm(!0),A=n.getGridElm(!0);I&&(O.childNodes[0].innerHTML=I,O.childNodes[0].setAttribute("data-set-empty","false")),b&&(A.childNodes[0].innerHTML=b,A.childNodes[0].setAttribute("data-set-empty","false")),D?(v[0].getAttribute("data-set-richType")!==y&&v.unshift(A),v[v.length-1].getAttribute("data-set-richType")!==y&&v.push(O)):(v[0].getAttribute("data-set-richType")!==y&&v.unshift(O),v[v.length-1].getAttribute("data-set-richType")!==y&&v.push(A));let M=document.createElement("div");const Y=n.setWrapNodeByMark(v);return M.appendChild(Y),t.clipboardData.setData(V,M.innerHTML),void(M=null)}if(r.parentNode===i.richText&&c.parentNode===i.richText){const D=Array.prototype.indexOf.call(i.richText.childNodes,r),v=Array.prototype.indexOf.call(i.richText.childNodes,c),I=D>v,b=Array.prototype.filter.call(i.richText.childNodes,(L,w)=>I?w<D&&w>v:w>D&&w<v).map(L=>L.cloneNode(!0)),O=u?I?l.textContent.slice(0,e.anchorOffset):l.textContent.slice(e.anchorOffset):"",A=T?I?h.textContent.slice(e.focusOffset):h.textContent.slice(0,e.focusOffset):"",M=n.getGridElm(!0),Y=n.getGridElm(!0);O&&(M.childNodes[0].innerHTML=O,M.childNodes[0].setAttribute("data-set-empty","false")),A&&(Y.childNodes[0].innerHTML=A,Y.childNodes[0].setAttribute("data-set-empty","false"));const H=Array.prototype.filter.call(r.childNodes,(L,w)=>I?w<x:w>x).map(L=>L.cloneNode(!0)),R=Array.prototype.filter.call(c.childNodes,(L,w)=>I?w>C:w<C).map(L=>L.cloneNode(!0));if(I){H.push(M),R.unshift(Y);const L=n.setWrapNodeByMark(H),w=n.setWrapNodeByMark(R);b.push(L),b.unshift(w)}else{H.unshift(M),R.push(Y);const L=n.setWrapNodeByMark(H),w=n.setWrapNodeByMark(R);b.unshift(L),b.push(w)}let z=document.createElement("div");return Array.from(b,L=>{z.appendChild(L)}),t.clipboardData.setData(V,z.innerHTML),void(z=null)}}async removeRange(){const t=getSelection().getRangeAt(0);t&&!t.collapsed&&(this.target.chatInput.selectRegionMerge(),await this.richTextInput())}async setChatHistory(t){const{chatElement:e,chatInput:i}=this.target;this.doOverHistory=!1;const{html:n,gridIndex:s,markIndex:a,tagIndex:o,cursorIndex:l,inputTag_cursorIndex:h,type:r}=t;if(e.richText.innerHTML=n,r==="inputTag"){const c=e.richText.children[s].children[o].children[0].children[0].childNodes[0];i.setInputTagRange(c,h)}else{const c=e.richText.children[s].children[a].children[0].childNodes[0];i.restCursorPos(c,l)}await this.richTextInput(),this.doOverHistory=!0}async insertInsideHtml(t,e=!0){const{chatInput:i}=this.target;i.updateNodeCursor();let n=document.createElement("div");n.innerHTML=t,n.children.length&&(e&&Array.from(n.children,s=>{Array.from(s.children,(a,o)=>{const l=a.getAttribute("data-set-richType");if(l===y){const h=a.children[0];h.textContent&&h.textContent!==i.VOID_KEY?h.textContent=F(h.textContent):(h.setAttribute("data-set-empty","true"),h.innerHTML=o===s.children.length-1?`${i.VOID_KEY}<br>`:i.VOID_KEY)}else if(l===k){const h=a.children[0];h.classList.contains("at-input")?(h.children[1].textContent=F(h.children[1].textContent),h.children[0].textContent&&h.children[0].textContent!==i.VOID_KEY?h.children[0].textContent=F(h.children[0].textContent):(h.children[0].textContent=i.VOID_KEY,m(h.children[1],!0,"inline"))):h.classList.contains("at-user")||h.classList.contains("at-tag")?h.textContent=F(h.textContent):h.classList.contains("at-select")&&(h.childNodes[0].textContent=F(h.childNodes[0].textContent))}})}),n.children.length===1?i.insetRangeGrid(n.children[0]):i.insetRangeGrids(n.children),n=null,await this.richTextInput())}triggerChatEvent(t,...e){const i=[];return this.chatEventModule[t].forEach(n=>{n&&i.push(n(...e))}),i}ruleChatEvent(t,e,...i){this.triggerChatEvent(e,...i).some(n=>n&&n==="PREVENT")||(t&&t.bind(this)(),t=null)}fixEditor(){const t=()=>{this.target.chatInput.initEditor(!0),this.target.chatElement.showPlaceholder(),this.textLength=0,this.triggerChatEvent("operate")};if(this.target.chatElement.richText.childNodes.length===0)return t(),!0;const e=this.target.chatElement.richText.childNodes[0];if(!e.getAttribute||e.getAttribute("data-set-richType")!==S||e.childNodes.length===0)return t(),!0;const i=e.childNodes[0];if(!i.getAttribute||i.getAttribute("data-set-richType")!==y||i.childNodes.length===0)return t(),!0;const n=i.childNodes[0];return!n.getAttribute||n.getAttribute("data-set-richType")!==P||n.childNodes.length===0||n.childNodes[0].textContent.length===0?(t(),!0):void 0}}class Lt{constructor(t){f(this,"target"),f(this,"rankLen",4),this.target=t}getCurrentNodes(){const t=[];return Array.from(this.target.chatElement.richText.children,(e,i)=>{t.push(this.analyzeGrid(e,i))}),t}getRank(t){let e=t+1+"";const i=this.rankLen-e.length;for(let n=0;n<i;n++)e="0"+e;return e}analyzeGrid(t,e){const i={type:"gridBox",rank:this.getRank(e),children:[]};return Array.from(t.children,(n,s)=>{switch(n.getAttribute("data-set-richType")){case y:i.children.push(this.analyzeMark(n,s,i.rank));break;case k:i.children.push(this.analyzeTag(n,s,i.rank))}}),i}analyzeMark(t,e,i){return{type:"gridInput",rank:i+this.getRank(e),text:t.textContent.replace(new RegExp(this.target.chatInput.VOID_KEY,"g"),"")}}analyzeTag(t,e,i){const n=t.children[0],s={type:"htmlTag",rank:i+this.getRank(e)};return n.classList.contains("at-user")?(s.type="userTag",s.dataset={[this.target.options.userProps.id]:n.getAttribute("data-user-id"),[this.target.options.userProps.name]:n.textContent.slice(1)}):n.classList.contains("at-tag")?(s.type="customTag",s.dataset={id:n.getAttribute("data-tag-id"),name:n.textContent.slice(1),prefix:n.getAttribute("data-set-prefix")}):n.classList.contains("at-select")?(s.type="selectTag",s.dataset={id:n.getAttribute("data-select-id"),name:n.textContent,key:n.getAttribute("data-select-key")}):n.classList.contains("at-input")?(s.type="inputTag",s.dataset={key:n.getAttribute("data-input-key"),placeholder:n.children[1].textContent,value:n.children[0].textContent===this.target.chatInput.VOID_KEY?"":n.children[0].textContent.replace(new RegExp(this.target.chatInput.INPUT_TAG_WRAP_KEY[0],"g"),"")}):(s.type="htmlTag",s.html=t.children[0].innerHTML),s}analyzeGridNodes(t){t.children=t.children||[];const e=t.children;if(e.length===0)return void e.push({type:"gridInput",rank:t.rank+this.getRank(0),text:""});const i=[];e.forEach((s,a)=>{if(a===e.length-1)return;const o=a+1;if(s.type==="gridInput"&&e[o].type==="gridInput"){let l=o-i.length;i.push(l)}}),i.forEach(s=>{const a=e[s];e[s-1].text+=a.text,e.splice(s,1)});const n=[];e.forEach((s,a)=>{if(a===e.length-1)return;const o=a+1;if(s.type!=="gridInput"&&e[o].type!=="gridInput"){let l=o+n.length;n.push(l)}}),n.forEach(s=>{e.splice(s,0,{type:"gridInput",rank:"",text:""})}),e[0].type!=="gridInput"&&e.unshift({type:"gridInput",rank:"",text:""}),e[e.length-1].type!=="gridInput"&&e.push({type:"gridInput",rank:"",text:""}),e.forEach((s,a)=>{s.rank=t.rank+this.getRank(a)})}analyzeNode(t,e=!1){switch(t.type){case"gridInput":return`<span data-set-richType="${y}"><span class="chat-grid-input" data-set-richType="${P}" data-set-empty="${String(t.text==="")}">${t.text===""?this.target.chatInput.VOID_KEY:N(t.text)}${e&&t.text===""?"<br>":""}</span></span>`;case"userTag":return`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="at-user" data-user-id="${t.dataset[this.target.options.userProps.id]}">@${N(t.dataset[this.target.options.userProps.name])}</span></span>`;case"customTag":return`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="at-tag" data-tag-id="${t.dataset.id}" data-set-prefix="${t.dataset.prefix}">${t.dataset.prefix}${N(t.dataset.name)}</span></span>`;case"selectTag":return`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="at-select" data-select-id="${t.dataset.id}" data-select-key="${t.dataset.key}">${N(t.dataset.name)}${B}</span></span>`;case"htmlTag":return`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="chat-set-html">${t.html}</span></span>`;case"inputTag":const i=!t.dataset.value,n=N(t.dataset.placeholder),s=N((t.dataset.value||"").replace(new RegExp(this.target.chatInput.INPUT_TAG_WRAP_KEY[1],"g"),this.target.chatInput.INPUT_TAG_WRAP_KEY)),a=i?`<span class="input-tip">${n}</span>`:`<span class="input-tip chat-view-show" style="display: none">${n}</span>`;return`<span class="chat-tag" contenteditable="false" data-set-richType="${k}"><span class="at-input" contenteditable="false" data-input-key="${t.dataset.key}"><span class="input-write" contenteditable="true">${i?this.target.chatInput.VOID_KEY:s}</span>${a}</span></span>`;case"gridBox":let o="";return this.analyzeGridNodes(t),t.children.forEach((l,h)=>{o+=this.analyzeNode(l,h===t.children.length-1)}),`<p class="chat-grid-wrap" data-set-richType="${S}">${o}</p>`;default:return""}}async insertNode(t){if(t.type==="gridBox"){const e=this.analyzeNode(t);let i=document.createElement("div");i.innerHTML=e;const n=i.children[0],s=parseFloat(t.rank)-1;if(s===-1||s>this.target.chatElement.richText.children.length-1)this.target.chatElement.richText.appendChild(n);else{const o=this.target.chatElement.richText.children[s];if(!o)return;this.target.chatElement.richText.insertBefore(n,o)}const a=n.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(a,a.textContent===this.target.chatInput.VOID_KEY?1:a.textContent.length),i=null,await this.target.chatEvent.richTextInput()}else{const e=(t.text||"").length,i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),n=this.getNodeByRank(i[0]);if(!n)return;const s=parseFloat(i[1])-1;s==-1?n.children.push(t):n.children.splice(s,0,t),await this.updateNode(n,()=>{if(t.type==="gridInput"){const a=s===-1||s>n.children.length-1,o=!a&&s%2==0,l=a?n.children[n.children.length-1]:n.children[o?s:s-1];this.setCursorNode(l,o?e:-1)}else if(t.type==="inputTag"){const a=this.getElmByRank(t.rank).nextElementSibling;this.target.chatInput.updateGridInputCursor(a.children[0].childNodes[0],0),this.setCursorNode(t,-1)}else{const a=n.children.indexOf(t);this.setCursorNode(n.children[a+1],0)}})}}async updateNode(t,e){const i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),n=parseFloat(i[0])-1,s=this.target.chatElement.richText.children[n];if(t.type==="gridBox"){if(!s)return;this.analyzeGridNodes(t);let c="";if(t.children.forEach((p,g)=>{c+=this.analyzeNode(p,g===t.children.length-1)}),s.innerHTML=c,e)e();else{const p=s.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(p,p.textContent===this.target.chatInput.VOID_KEY?1:p.textContent.length)}return void await this.target.chatEvent.richTextInput()}const a=parseFloat(i[1])-1,o=s.children[a],l=this.getNodeByRank(t.rank);if(!l||t.type!==l.type)return;let h,r;if(t.type==="gridInput"){const c=o.children[0];c.innerHTML=N(t.text);const p=c.textContent!=="";c.setAttribute("data-set-empty",String(!p)),p||(c.innerHTML=o.nextElementSibling?this.target.chatInput.VOID_KEY:`${this.target.chatInput.VOID_KEY}<br>`),h=c.childNodes[0],r=h.textContent.length}else if(t.type==="userTag"){const c=o.children[0];c.setAttribute("data-user-id",t.dataset[this.target.options.userProps.id]),c.textContent=`@${t.dataset[this.target.options.userProps.name]}`,h=o.nextElementSibling.children[0].childNodes[0]}else if(t.type==="customTag"){const c=o.children[0];c.setAttribute("data-tag-id",t.dataset.id),c.setAttribute("data-set-prefix",t.dataset.prefix),c.textContent=`${t.dataset.prefix}${t.dataset.name}`,h=o.nextElementSibling.children[0].childNodes[0]}else if(t.type==="selectTag"){const c=o.children[0];c.setAttribute("data-select-id",t.dataset.id),c.setAttribute("data-select-key",t.dataset.key),c.childNodes[0].textContent=t.dataset.name,h=o.nextElementSibling.children[0].childNodes[0]}else if(t.type==="inputTag"){const c=o.children[0];c.setAttribute("data-input-key",t.dataset.key),c.children[0].textContent=t.dataset.value===""?this.target.chatInput.VOID_KEY:t.dataset.value,c.children[1].textContent=t.dataset.placeholder,m(c.children[1],t.dataset.value==="","inline-block"),e=()=>{this.target.chatInput.rangeToInputTag(c)}}else t.type==="htmlTag"&&(o.children[0].innerHTML=t.html,h=o.nextElementSibling.children[0].childNodes[0]);e?e():this.target.chatInput.restCursorPos(h,r),await this.target.chatEvent.richTextInput()}getNodeByRank(t){if(!t)return null;const e=t.match(new RegExp(`.{1,${this.rankLen}}`,"g"));if(e.length===0)return null;const i=parseFloat(e[0])-1,n=i===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[i];if(!n)return null;if(e.length===1)return this.analyzeGrid(n,i===-1?this.target.chatElement.richText.children.length-1:i);i===-1&&(e[0]=this.getRank(this.target.chatElement.richText.children.length-1));const s=parseFloat(e[1])-1,a=s===-1?n.lastElementChild:n.children[s];return a?a.getAttribute("data-set-richType")===y?this.analyzeMark(a,s===-1?n.children.length-1:s,e[0]):this.analyzeTag(a,s===-1?n.children.length-1:s,e[0]):null}async delNodeByRank(t){const e=this.getNodeByRank(t);if(e)if(e.type==="gridBox"){const i=parseFloat(t)-1,n=this.target.chatElement.richText.children[i],s=n.nextElementSibling||n.previousElementSibling;if(s){const a=s.lastElementChild.children[0].childNodes[0];this.target.chatInput.restCursorPos(a,a.textContent===this.target.chatInput.VOID_KEY?1:a.textContent.length)}this.target.chatElement.richText.removeChild(n),this.target.chatElement.richText.children.length===0&&this.target.chatInput.initEditor(!0),await this.target.chatEvent.richTextInput()}else if(e.type==="gridInput")e.text="",await this.updateNode(e);else{const i=e.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),n=this.getNodeByRank(i[0]),s=n.children[parseFloat(i[1])-1-1],a=s.text.length;n.children=n.children.filter(o=>o.rank!==t),await this.updateNode(n,()=>{this.setCursorNode(s,a)})}}async coverNodes(t){if(t.length<0)return;let e="";t.forEach(i=>{e+=this.analyzeNode(i)}),this.target.chatElement.richText.innerHTML=e,this.target.chatInput.setRangeLastText(),await this.target.chatEvent.richTextInput()}setCursorNode(t,e=-1){const i=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),n=parseFloat(i[0])-1,s=n===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[n];let a=null;if(t.type==="gridInput"){const o=parseFloat(i[1])-1;a=o===-1?s.lastElementChild:s.children[o]}else if(t.type==="gridBox")a=e===-1?s.lastElementChild:s.children[0];else if(t.type==="inputTag"){const o=parseFloat(i[1])-1,l=s.children[o].children[0].children[0].childNodes[0],h=l.textContent===this.target.chatInput.VOID_KEY?1:e===-1?l.textContent.length:e;this.target.chatInput.setInputTagRange(l,h)}else{const o=parseFloat(i[1])-1,l=s.children[o];a=e===-1?l.nextElementSibling:l.previousElementSibling,e=e===-1?0:-1}if(a){const o=a.children[0].childNodes[0];e===-1&&(e=o.textContent.length),this.target.chatInput.restCursorPos(o,o.textContent===this.target.chatInput.VOID_KEY?1:e)}}getCursorNode(){const t=getSelection(),e=t.focusNode;if(e&&e.parentElement&&e.parentElement.classList.contains("input-write")){const n=e.parentElement.parentElement.parentElement;return{node:this.analyzeTag(n,Array.prototype.indexOf.call(n.parentElement.children,n),this.getRank(Array.prototype.indexOf.call(this.target.chatElement.richText.children,n.parentElement))),offset:e.textContent===this.target.chatInput.VOID_KEY?0:t.focusOffset}}const i=this.target.chatInput.vnode.parentElement.parentElement;return{node:this.analyzeMark(i,Array.prototype.indexOf.call(i.parentElement.children,i),this.getRank(Array.prototype.indexOf.call(this.target.chatElement.richText.children,i.parentElement))),offset:this.target.chatInput.vnode.textContent===this.target.chatInput.VOID_KEY?0:this.target.chatInput.cursorIndex}}setSelectNodes(t,e,i=0,n=-1){let s,a;const o=t.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),l=e.rank.match(new RegExp(`.{1,${this.rankLen}}`,"g")),h=this.target.chatElement.richText.children[parseFloat(o[0])-1],r=this.target.chatElement.richText.children[parseFloat(l[0])-1];if(t.type==="gridInput")s=h.children[parseFloat(o[1])-1];else if(t.type==="gridBox")s=i===-1?h.lastElementChild:h.children[0];else{const x=parseFloat(o[1])-1,C=h.children[x];s=i===-1?C.nextElementSibling:C.previousElementSibling,i=i===-1?0:-1}if(e.type==="gridInput")a=r.children[parseFloat(l[1])-1];else if(t.type==="gridBox")a=n===-1?r.lastElementChild:r.children[0];else{const x=parseFloat(l[1])-1,C=r.children[x];a=n===-1?C.nextElementSibling:C.previousElementSibling,n=n===-1?0:-1}const c=s.children[0].childNodes[0],p=a.children[0].childNodes[0],g=document.createRange(),u=parseFloat(t.rank)>parseFloat(e.rank);g[u?"setEnd":"setStart"](c,c.textContent===this.target.chatInput.VOID_KEY?1:i===-1?c.textContent.length:i),g[u?"setStart":"setEnd"](p,p.textContent===this.target.chatInput.VOID_KEY?1:n===-1?p.textContent.length:n);const T=getSelection();T.removeAllRanges(),T.addRange(g)}getElmByRank(t){const e=t.match(new RegExp(`.{1,${this.rankLen}}`,"g")),i=parseFloat(e[0])-1,n=i===-1?this.target.chatElement.richText.lastElementChild:this.target.chatElement.richText.children[i];if(e.length===1)return n;const s=parseFloat(e[1])-1;return s===-1?n.lastElementChild:n.children[s]}getRankByElm(t){const e=this.target.chatElement.richText.children;let i=null,n=null;return Array.prototype.find.call(e,(s,a)=>t===s?(i=a,!0):Array.prototype.find.call(s.children,(o,l)=>o===t&&(i=a,n=l,!0))),(i!==null?this.getRank(i):"")+(n!==null?this.getRank(n):"")}}class wt{constructor(t){f(this,"target"),f(this,"components",{}),f(this,"eventTypes",[]),this.target=t}useComponent(t){t.props=t.props||{},t.template=Tt(t.template||""),t.template=Ct(t.template||"",t.props),this.components[t.name]=t;const e=/bind-([a-zA-Z]+)="([^"]*)"/g,i=[];let n;for(;(n=e.exec(t.template))!==null;)i.push({eventType:n[1],handlerName:n[2]});i.forEach(s=>{this.useComponentEvent(s.eventType)})}useComponentEvent(t){this.eventTypes.includes(t)||(this.eventTypes.push(t),this.target.chatElement.richText.addEventListener(t,e=>{this.componentEventRecognizer(e,t)}))}componentEventRecognizer(t,e){const i=t.target,n=K(i,20);if(!n||!n.classList.contains("chat-tag")||!n.children[0].classList.contains("chat-set-html"))return;const s=n.children[0].children[0],a=s.getAttribute("data-set-component");if(!a)return;const o=this.components[a];if(!o)return;const l=o.methods,h=this.deppComponentEvent(s,e).reverse();let r=!1,c=0;const p=()=>{if(r)return;const g=h[c];if(i===g||g.contains(i)){const u=g.getAttribute("bind-"+e),T=Object.create(null);for(const C in s.dataset)C in o.props&&(T[C]=s.dataset[C]);const x={componentElm:s,targetElm:g,data:T,eventType:e,eventName:u,stopPropagation:()=>{r=!0}};l[u]&&l[u](x,t)}c<h.length-1&&(c++,p())};p()}deppComponentEvent(t,e){const i=[];return t.getAttribute("bind-"+e)&&i.push(t),t.children&&t.children.length>0&&Array.from(t.children).forEach(n=>{i.push(...this.deppComponentEvent(n,e))}),i}async insertComponent(t,e){const i=this.components[t];if(!i)return;const n=Object.assign({},i.props,e),s=it(i.template,{...n,[J]:i.name}),a=await this.target.insertHtml(s);return await this.target.chatEvent.richTextInput(),a}async removeComponentElm(t){const e=K(t,20);e&&(this.target.chatInput.delTag(e),await this.target.chatEvent.richTextInput())}async updateComponentElm(t,e){var i,n;const s=K(t,20);if(!s)return;const a=(n=(i=s==null?void 0:s.children[0])==null?void 0:i.children[0])==null?void 0:n.getAttribute("data-set-component");if(!a)return;const o=this.components[a];if(!o)return;const l=Object.assign({},o.props,e);s.children[0].innerHTML=it(o.template,{...l,[J]:o.name}),await this.target.chatEvent.richTextInput()}getComponentElms(t){const e=[],i=this.target.chatElement.richText.querySelectorAll(".chat-tag");return Array.from(i,n=>{this.isComponentElm(n,t)&&e.push(n)}),e}isComponentElm(t,e){return!!(t&&t.children[0]&&t.children[0].children[0])&&t.children[0].children[0].getAttribute("data-set-component")===e}}const Pt={device:"auto",autoFocus:!0,needDialog:!0,needDebounce:!0,asyncMatch:!1,userList:[],reformList:[],placeholder:"",maxLength:-1,copyType:["text"],uploadImage:void 0,needCallEvery:!0,needCallSpace:!1,userProps:{},customTrigger:[],dialogLabels:{pcPointDialog:{},pcPCheckDialog:{},h5Dialog:{}},wrapKeyFun:d=>d.ctrlKey&&["Enter"].includes(d.key),sendKeyFun:d=>!d.ctrlKey&&["Enter"].includes(d.key)},at={id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},ot={title:"群成员",callEveryLabel:"所有人",checkLabel:"多选",emptyLabel:"暂无数据"},lt={title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",checkEmptyLabel:"请选择需要@的成员",confirmLabel:"确定",cancelLabel:"取消"},rt={title:"选择提醒的人",callEveryLabel:"所有人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",confirmLabel:"确定",cancelLabel:"收起"},St={saveTagData:!1,needUserId:!1,needTagId:!1,needSelectId:!1,needTipKey:!1,wrapClassName:void 0,rowClassName:void 0,imgToText:!1,identifyLink:!1},Ot={"`":["`","~"],"~":["`","~"],1:["1","!"],"!":["1","!"],3:["3","#"],"#":["3","#"],4:["4","$"],$:["4","$"],5:["5","%"],"%":["5","%"],6:["6","^"],"^":["6","^"],7:["7","&"],"&":["7","&"],8:["8","*"],"*":["8","*"],";":[";",":"],":":[";",":"],"/":["/","?"],"?":["/","?"],"\\":["\\","|"],"|":["\\","|"]},X=function(d,t,e){return d.forEach(i=>{if(e in i){const n=t.indexOf(String(i[e]));n!==-1&&(t[n]=i)}}),t.filter(i=>i[e])};let _t=class{constructor(t){switch(f(this,"options"),f(this,"deviceInfo",pt()),f(this,"chatElement"),f(this,"chatInput"),f(this,"chatEvent"),this.options=Object.assign({},Pt,t),this.options.device=this.options.device.toLocaleLowerCase(),this.deviceInfo.isTablet&&(this.deviceInfo.isPc=!1),this.options.device){case"pc":this.deviceInfo.isPc=!0;break;case"h5":this.deviceInfo.isPc=!1}this.options.userProps=Object.assign({},at,t.userProps||{}),this.options.dialogLabels.pcPointDialog=Object.assign({},ot,q(t.dialogLabels,"pcPointDialog",{})),this.options.dialogLabels.pcPCheckDialog=Object.assign({},lt,q(t.dialogLabels,"pcPCheckDialog",{})),this.options.dialogLabels.h5Dialog=Object.assign({},rt,q(t.dialogLabels,"h5Dialog",{})),this.chatElement=new At(this),this.chatInput=new kt(this),this.chatEvent=new Nt(this),this.updateConfig(t);const e=this;Object.defineProperty(this,"richText",{get:()=>e.chatElement.richText}),Object.defineProperty(this,"textLength",{get:()=>e.chatEvent.textLength}),this.options.autoFocus&&this.nextTick(()=>{this.chatElement.richText.focus()})}updateConfig(t){t.copyType!==void 0&&(this.options.copyType=t.copyType),t.userProps&&(this.options.userProps=Object.assign({},at,t.userProps)),t.uploadImage!==void 0&&(this.options.uploadImage=t.uploadImage),t.placeholder!==void 0&&(this.chatElement.placeholderElm.textContent=t.placeholder),t.maxLength!==void 0&&(this.options.maxLength=t.maxLength<=0?-1:t.maxLength,this.chatEvent.ruleMaxLength()),this.options.asyncMatch?(this.options.needCallEvery=!1,this.updateUserList([])):(t.needCallEvery!==void 0||t.userList)&&(this.options.needCallEvery=tt(t.needCallEvery===void 0?this.options.needCallEvery:t.needCallEvery),this.updateUserList(t.userList)),t.needCallSpace!==void 0&&this.chatInput.setCallSpace(tt(t.needCallSpace)),t.wrapKeyFun!==void 0&&(this.options.wrapKeyFun=t.wrapKeyFun),t.sendKeyFun!==void 0&&(this.options.sendKeyFun=t.sendKeyFun),t.customTrigger&&(this.options.customTrigger=t.customTrigger.map(e=>(e.keyMap||(e.keyMap=Ot[e.prefix]||[]),e)),this.options.needDialog&&this.deviceInfo.isPc&&this.chatElement.bindCustomTrigger()),t.selectList&&(this.options.selectList=t.selectList,this.options.needDialog&&this.deviceInfo.isPc&&this.chatElement.bindSelectList())}updateUserList(t=void 0){const{options:e,chatElement:i}=this;if(t){e.userList=JSON.parse(JSON.stringify(t));const s={[e.userProps.id]:"isALL",[e.userProps.name]:""};e.userList.unshift(s),e.reformList=t.map(a=>({id:String(a[e.userProps.id]),name:String(a[e.userProps.name]||""),avatar:String(a[e.userProps.avatar]||""),pinyin:String(a[e.userProps.pinyin]||"")}))}const n=e.userList[0];n&&n[e.userProps.id]==="isALL"&&(n[e.userProps.name]=this.deviceInfo.isPc?e.dialogLabels.pcPointDialog.callEveryLabel:e.dialogLabels.h5Dialog.callEveryLabel),e.needDialog&&(this.deviceInfo.isPc?i.updatePCUser():i.updateH5User())}searchUserList(t){return this.options.reformList.filter(e=>Z(e.name,e.pinyin||"",t))}getReduceNode(t){const e=Object.assign({},St,t||{});e.saveTagData&&(e.needUserId=!0,e.needTagId=!0,e.needSelectId=!0,e.needTipKey=!0);const i=/(https?|http|ftp|file):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]/g,n=this.chatElement.richText.cloneNode(!0).children||[],s=document.createElement("div");return e.wrapClassName&&(s.className=e.wrapClassName),Array.from(n,(a,o)=>{const l=document.createElement("p");Array.from(a.children,h=>{const r=h.children[0];this.chatInput.getNodeEmpty(r)||(r.removeAttribute("data-set-richType"),r.removeAttribute("contenteditable"),r.removeAttribute("data-set-empty"),e.needUserId||r.removeAttribute("data-user-id"),e.needTagId||(r.removeAttribute("data-set-prefix"),r.removeAttribute("data-tag-id")),e.needSelectId||(r.removeAttribute("data-select-id"),r.removeAttribute("data-select-key")),e.imgToText&&r.firstChild&&r.firstChild.tagName==="IMG"&&(r.classList.add("img-to-text"),r.innerHTML=`[${r.firstChild.getAttribute("data-img-text")||"you need set data-img-text"}]`),e.identifyLink&&r.classList.contains("chat-grid-input")&&(r.innerHTML=r.innerHTML.replace(i,c=>`<a class="chat-grid-link" href="${c}" target="_blank">${c}</a>`)),r.classList.contains("at-select")&&(r.classList.remove("aim"),r.removeChild(r.lastChild)),r.classList.contains("at-input")&&(e.needTipKey?r.setAttribute("data-input-tip",r.children[1].textContent):r.removeAttribute("data-input-key"),r.textContent=r.children[0].textContent!==this.chatInput.VOID_KEY?r.children[0].textContent:r.children[1].textContent,r.textContent=r.textContent.replace(new RegExp(this.chatInput.INPUT_TAG_WRAP_KEY[0],"g"),"")),l.appendChild(r))}),e.rowClassName&&(l.className=e.rowClassName),l.innerHTML||(l.innerHTML="<br>"),s.appendChild(l)}),s}getText(t){let e="";const i=this.getReduceNode(t);return Array.from(i.children,(n,s)=>{e=e+(s>0?`
`:"")+n.textContent}),e}getHtml(t){return this.getReduceNode(t).innerHTML}async reverseAnalysis(t,e){if(!t)return;const i=document.createElement("div");i.innerHTML=t;const n=i.children;Array.from(n,s=>{s.className="chat-grid-wrap",s.setAttribute("data-set-richType",S);const a=s.children,o={},l=[];Array.from(a,(c,p)=>{if(c.className.indexOf("chat-grid-input")!==-1){const T=c.textContent||"";return c.hasAttribute("class")&&c.removeAttribute("class"),c.setAttribute("data-set-richType",y),void(c.innerHTML=`<span class="chat-grid-input" data-set-richType="${P}" data-set-empty="false">${N(T)}</span>`)}if(c.tagName&&c.tagName.toLocaleUpperCase()==="BR"){const T=this.chatInput.getGridElm(!0);return s.removeChild(c),void s.appendChild(T)}const g=c.cloneNode(!0);g.setAttribute("contenteditable","false");const u=document.createElement("span");u.className="chat-tag",u.setAttribute("contenteditable","false"),u.setAttribute("data-set-richType",k),u.appendChild(g),o[p]=u,p!==a.length-1?a[p+1].className.indexOf("chat-grid-input")===-1&&l.push(p):l.push(p),p===0&&l.push(-1)});for(const c in o){const p=Number(c),g=o[c].lastChild;if(g.classList.contains("at-select"))g.innerHTML=`${N(g.textContent)}${B}`;else if(g.classList.contains("at-input")){const u=N(g.getAttribute("data-input-tip")),T=N((g.textContent||"").replace(new RegExp(this.chatInput.INPUT_TAG_WRAP_KEY[1],"g"),this.chatInput.INPUT_TAG_WRAP_KEY)),x=g.textContent==="",C=x?`<span class="input-tip">${u}</span>`:`<span class="input-tip chat-view-hidden" style="display: none">${u}</span>`;g.innerHTML=`<span class="input-write" contenteditable="true">${x?this.chatInput.VOID_KEY:T}</span>${C}`,g.removeAttribute("data-input-tip")}p===a.length-1?(s.removeChild(a[p]),s.appendChild(o[c])):(s.insertBefore(o[c],a[p+1]),s.removeChild(a[p]))}const h=[],r=s.children;l.forEach(c=>{c===r.length-1?h.push("isEnd"):h.push(r[c+1])}),h.forEach(c=>{const p=this.chatInput.getGridElm(!0);if(c==="isEnd")s.appendChild(p);else{const g=p.children[0];g.childNodes.length>1&&g.removeChild(g.childNodes[1]),s.insertBefore(p,c)}})}),e?(this.chatInput.setRangeLastText(),await this.chatEvent.insertInsideHtml(i.innerHTML,!1)):(this.chatElement.richText.innerHTML=i.innerHTML,this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput())}async insertHtml(t){if(!t)return;const e=document.createElement("span");e.innerHTML=t,e.className="chat-set-html";const i=this.chatInput.createNewDom(e);return this.chatInput.replaceRegContent(i,!1),await this.chatEvent.richTextInput(),i}async insertText(t){if(!t)return;t=N(t);const e=new RegExp(`[${this.chatInput.ZERO_WIDTH_KEY}|${this.chatInput.VOID_KEY}]`,"ig"),i=t.replace(e,"");if(!i)return;const n=i.split(`
`);let s="";n.forEach(a=>{const o=a!=="";s+=`<p class="chat-grid-wrap" data-set-richType="${S}"><span data-set-richType="${y}"><span class="chat-grid-input" data-set-richType="${P}" data-set-empty="${o?"false":"true"}">${o?a:this.chatInput.VOID_KEY+"<br>"}</span></span></p>`}),await this.chatEvent.insertInsideHtml(s)}getCallUserList(){const t=this.chatElement.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=Array.from(t,i=>i.dataset.userId);return X(this.options.userList,e,this.options.userProps.id)}return[]}getCallUserTagList(){const t=this.chatElement.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=[];return Array.from(t,i=>{e.some(n=>n[this.options.userProps.id]===i.dataset.userId)||e.push({[this.options.userProps.id]:i.dataset.userId,[this.options.userProps.name]:i.textContent.slice(1)})}),e}return[]}getCustomTagList(){const t=Object.keys(this.chatElement.customTags),e={},i=this.chatElement.richText.querySelectorAll(".at-tag");return t.forEach(n=>{let s=Array.prototype.filter.call(i,a=>a.getAttribute("data-set-prefix")===String(n)).map(a=>a.getAttribute("data-tag-id"));s=s.filter((a,o)=>s.indexOf(a)===o),e[n]=X(this.chatElement.customTags[n],s,"id")}),e}getSelectTagList(){const t=Object.keys(this.chatElement.selectTags),e={},i=this.chatElement.richText.querySelectorAll(".at-select");return t.forEach(n=>{let s=Array.prototype.filter.call(i,a=>a.getAttribute("data-select-key")===String(n)).map(a=>a.getAttribute("data-select-id"));s=s.filter((a,o)=>s.indexOf(a)===o),e[n]=X(this.chatElement.selectTags[n],s,"id")}),e}getInputTagList(){const t={},e=this.chatElement.richText.querySelectorAll(".at-input");return Array.from(e,i=>{const n=i.getAttribute("data-input-key"),s=i.children[0].textContent===this.chatInput.VOID_KEY?null:i.children[0].textContent;t[n]||(t[n]=[]),t[n].push(s)}),t}async clear(t){this.chatInput.initEditor(!0,t),this.clearHistory(),await this.chatEvent.richTextInput(!1)}lineBreak(){this.cursorToLastRecord(),this.chatInput.lastCursorType==="inputTag"?this.chatInput.setInputTagWrap(this.chatInput.inputTag_vnode.parentElement):this.chatInput.setWrap(!0)}isEmpty(t=!1){if(this.chatElement.richText.children.length===0)return!0;if(this.chatElement.richText.innerHTML.indexOf("chat-tag")!==-1)return!1;if(this.chatElement.richText.children.length===1){const e=this.chatElement.richText.children[0],i=e.children[0].children[0];if(e.children.length===1&&(i.textContent.length===0||i.textContent===this.chatInput.VOID_KEY))return!0}return!!t&&this.chatElement.richText.textContent.trim()===""}dispose(){if(this.options.elm.removeChild(this.chatElement.richText),this.options.elm.removeChild(this.chatElement.placeholderElm),this.options.needDialog)if(this.deviceInfo.isPc){const t=this.chatElement.pcElms.containerDialogElm.parentElement;t&&t.removeChild(this.chatElement.pcElms.containerDialogElm)}else document.body.removeChild(this.chatElement.h5Elms.dialogElm)}showPCPointDialog(){this.options.needDialog&&(this.insertText("@"),this.options.asyncMatch&&m(this.chatElement.pcElms.pointDialogEmptyElm,!0,"flex"),this.chatEvent.outerApply=!0,this.chatElement.showPointDialog(),W(50).then(()=>{this.chatEvent.outerApply=!1}))}showPCCheckDialog(){this.options.needDialog&&!this.options.asyncMatch&&(this.chatEvent.winClick(),this.chatElement.checkboxRows=[],m(this.chatElement.pcElms.checkDialogElm,!0),E(document.body,"disable-scroll",!0),this.chatElement.pcElms.checkDialogTagsElm.scrollTop=0,this.chatElement.pcElms.checkDialogUsersElm.scrollTop=0,this.chatElement.pcElms.checkDialogSearchInputElm.value="",this.chatElement.updateCheckDialogTags(),this.chatElement.isExternalCallPopup=!0)}showPCCustomTagDialog(t){this.options.needDialog&&!this.options.asyncMatch&&(this.insertText(t),this.chatEvent.outerApply=!0,this.chatElement.showCustomTagDialog(t),W(50).then(()=>{this.chatEvent.outerApply=!1}))}showPCSelectDialog(t,e){this.chatElement.exitCustomTagDialog(),this.chatElement.exitPointDialog(),this.chatEvent.outerApply=!0,e&&(this.chatElement.exitSelectDialog(),this.chatElement.pcElms.selectDialogAim=e),this.chatElement.pcElms.selectDialogKey=t,this.chatEvent.debounceEvents.selectDialogToAim(),W(50).then(()=>{this.chatEvent.outerApply=!1})}showH5Dialog(){this.chatElement.richText&&this.chatElement.richText.blur(),Array.from(this.chatElement.h5Elms.dialogMainElm.children,t=>{t.style.display="",E(t,"user-popup-check-item-check")}),E(this.chatElement.h5Elms.dialogCheckElm,"disabled",!0),m(this.chatElement.h5Elms.dialogElm,!0),E(document.body,"disable-scroll",!0),this.options.asyncMatch&&m(this.chatElement.h5Elms.dialogEmptyElm,!0,"flex"),this.chatElement.h5Elms.dialogMainElm.scrollTop=0,this.chatElement.isExternalCallPopup=!0}disabled(){this.chatElement.richText.setAttribute("contenteditable","false"),E(this.chatElement.richText,"chat-rich-text-disabled",!0)}enable(){this.chatElement.richText.setAttribute("contenteditable","true"),E(this.chatElement.richText,"chat-rich-text-disabled"),this.chatInput.setRangeLastText()}async setUserTag(t){this.chatInput.updateNodeCursor(),this.chatEvent.triggerChatEvent("atCheck",[t]);const e=this.chatInput.createChatTagElm({id:t[this.options.userProps.id],name:t[this.options.userProps.name]},"@","at-user","user-id");this.chatInput.replaceRegContent(e,!1),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async setCustomTag(t,e){this.chatInput.updateNodeCursor(),this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,!1,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",t,e)}async setSelectTag(t,e){if(this.chatInput.updateNodeCursor(),e||(e=this.chatElement.pcElms.selectDialogKey),this.chatEvent.triggerChatEvent("selectCheck",t,e),this.chatElement.pcElms.selectDialogAim&&this.chatElement.pcElms.selectDialogAim.classList.contains("at-select")){const i=this.chatElement.pcElms.selectDialogAim.getAttribute("data-select-id"),n=this.chatElement.pcElms.selectDialogAim.parentElement.nextElementSibling.childNodes[0].childNodes[0];if(this.chatInput.restCursorPos(n),i===t.id)return;this.chatElement.pcElms.selectDialogAim.setAttribute("data-select-id",t.id),this.chatElement.pcElms.selectDialogAim.childNodes[0].textContent=t.name}else{const i=document.createElement("span");i.setAttribute("class","at-select"),i.setAttribute("data-select-key",e),i.setAttribute("data-select-id",t.id),i.innerHTML=`${N(t.name)}${B}`;const n=this.chatInput.createNewDom(i);this.chatInput.replaceRegContent(n,!1)}await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterSelectCheck",t,e)}async setInputTag(t,e,i=""){this.chatInput.updateNodeCursor();const n=document.createElement("span");n.setAttribute("class","at-input"),n.setAttribute("contenteditable","false"),n.setAttribute("data-input-key",t);const s=document.createElement("span");s.setAttribute("class","input-write"),s.setAttribute("contenteditable","true"),s.textContent=i||this.chatInput.VOID_KEY;const a=document.createElement("span");a.setAttribute("class","input-tip"),a.textContent="["+(e||"Please input")+"]",n.appendChild(s),n.appendChild(a);const o=this.chatInput.createNewDom(n);this.chatInput.replaceRegContent(o,!1),i&&this.chatInput.watchInputTag(s),this.chatInput.rangeToInputTag(n),await this.chatEvent.richTextInput()}async matchSetTag(t){this.chatInput.updateNodeCursor(),this.chatEvent.triggerChatEvent("atCheck",[t]),await this.chatInput.onceSearchCall(t,this.chatEvent.startOpenIndex),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async onceSetTag(t){this.chatInput.updateNodeCursor(),this.chatEvent.triggerChatEvent("atCheck",[t]),await this.chatInput.onceCall({id:t[this.options.userProps.id],name:t[this.options.userProps.name]}),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",[t])}async batchSetTag(t){this.chatInput.updateNodeCursor(),this.chatEvent.triggerChatEvent("atCheck",t);const e=[];for(let i=0;i<=t.length-1;)e.push({id:t[i][this.options.userProps.id],name:t[i][this.options.userProps.name]}),i++;await this.chatInput.batchReplaceRegContent(e,!this.chatElement.isExternalCallPopup),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterAtCheck",t)}async onceSetCustomTag(t,e){this.chatInput.updateNodeCursor(),e||(e=this.chatElement.pcElms.customTagDialogTagKey),this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,!0,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",t,e)}async matchSetCustomTag(t,e){this.chatInput.updateNodeCursor(),e||(e=this.chatElement.pcElms.customTagDialogTagKey),this.chatEvent.triggerChatEvent("tagCheck",t,e),await this.chatInput.onceCustomCall(t,this.chatEvent.startOpenIndex,e),await this.chatEvent.richTextInput(),this.chatEvent.triggerChatEvent("afterTagCheck",e)}async undo(){const{chatEvent:t}=this;if(!t.doOverHistory||!t.undoHistory||t.undoHistory.length<=1)return;const e=t.undoHistory[t.undoHistory.length-2],i=t.undoHistory[t.undoHistory.length-1];t.redoHistory.push(i),t.undoHistory.pop(),await t.setChatHistory(e)}async redo(){const{chatEvent:t}=this;if(!t.doOverHistory||!t.redoHistory||t.redoHistory.length<1)return;const e=t.redoHistory[t.redoHistory.length-1];t.redoHistory.pop(),t.undoHistory.push(e),await t.setChatHistory(e)}clearHistory(){const{gridIndex:t,markIndex:e,tagIndex:i}=this.chatInput.getRichTextNodeIndex();this.chatEvent.undoHistory=[{html:this.chatElement.richText.innerHTML,gridIndex:t||0,markIndex:e||0,tagIndex:i||0,type:this.chatInput.lastCursorType,cursorIndex:this.chatInput.cursorIndex,inputTag_cursorIndex:this.chatInput.inputTag_cursorIndex}],this.chatEvent.redoHistory=[]}cursorMove(t){if(t===0)return void this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);const e=new RegExp(`[${this.chatInput.ZERO_WIDTH_KEY}|${this.chatInput.VOID_KEY}]`,"ig");if(t>0){const i=this.chatInput.vnode.textContent.replace(e,"").slice(this.chatInput.cursorIndex);if(i.length>=t)return this.chatInput.cursorIndex+=t,void this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);const n=this.chatInput.vnode.parentElement.parentElement,s=n.parentElement;let a=!!(n.nextElementSibling&&n.nextElementSibling.nextElementSibling);const o=!!s.nextElementSibling;if(!a&&!o)return this.chatInput.cursorIndex+=i.length,this.chatInput.cursorIndex===0&&(this.chatInput.cursorIndex=1),void this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);const l=t-i.length-1,h=a?n.nextElementSibling.nextElementSibling:s.nextElementSibling.children[0],{rangeNode:r,rangeIndex:c}=this.chatInput.getOffsetRange(l,h);this.chatInput.restCursorPos(r,c)}else if(t<0){let i=Math.abs(t);const n=this.chatInput.vnode.textContent.replace(e,"").slice(0,this.chatInput.cursorIndex);if(n.length>=i)return this.chatInput.cursorIndex-=i,void this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);const s=this.chatInput.vnode.parentElement.parentElement,a=s.parentElement,o=!!(s.previousElementSibling&&s.previousElementSibling.previousElementSibling),l=!!a.previousElementSibling;if(!o&&!l)return void this.chatInput.restCursorPos(this.chatInput.vnode);i=i-n.length-1;const h=o?s.previousElementSibling.previousElementSibling:a.previousElementSibling.lastElementChild,{rangeNode:r,rangeIndex:c}=this.chatInput.getOffsetRange(i,h,!0);this.chatInput.restCursorPos(r,c)}}async cursorDel(t){if(t===0)return void this.chatInput.restCursorPos(this.chatInput.vnode,this.chatInput.cursorIndex);const e=this.chatInput.vnode,i=this.chatInput.cursorIndex;this.cursorMove(t);const n=this.chatInput.vnode,s=this.chatInput.cursorIndex,a=document.createRange();t<0?(a.setStart(n,s),a.setEnd(e,i)):(a.setStart(e,i),a.setEnd(n,s));const o=getSelection();o.removeAllRanges(),o.addRange(a),await this.chatEvent.removeRange()}cursorToLastRecord(){this.chatInput.setRangeLastRecord()}async delUserTags(t){const e=t||this.options.userList.map(s=>s[this.options.userProps.id]),i=this.chatElement.richText.querySelectorAll(".at-user"),n=[];Array.from(i,s=>{const a=s.getAttribute("data-user-id");e.some(o=>String(o)===a)&&n.push(s.parentElement)});for(let s=0;s<n.length;){const a=n[s];this.chatInput.delTag(a),s++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delCustomTags(t,e){const i=this.options.customTrigger.find(o=>o.prefix===t);if(!i||i.tagList.length===0)return;const n=e||i.tagList.map(o=>o.id),s=this.chatElement.richText.querySelectorAll(".at-tag"),a=[];Array.from(s,o=>{const l=o.getAttribute("data-set-prefix"),h=o.getAttribute("data-tag-id");l===t&&n.some(r=>String(r)===h)&&a.push(o.parentElement)});for(let o=0;o<a.length;){const l=a[o];this.chatInput.delTag(l),o++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delSelectTags(t,e){const i=this.options.selectList.find(o=>o.key===t);if(!i||i.options.length===0)return;const n=e||i.options.map(o=>o.id),s=this.chatElement.richText.querySelectorAll(".at-select"),a=[];Array.from(s,o=>{const l=o.getAttribute("data-select-key"),h=o.getAttribute("data-select-id");l===t&&n.some(r=>String(r)===h)&&a.push(o.parentElement)});for(let o=0;o<a.length;){const l=a[o];this.chatInput.delTag(l),o++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}async delInputTags(t){const e=this.chatElement.richText.querySelectorAll(".at-input"),i=[];Array.from(e,n=>{if(t){const s=n.getAttribute("data-input-key");t.some(a=>String(a)===s)&&i.push(n.parentElement)}else i.push(n.parentElement)});for(let n=0;n<i.length;){const s=i[n];this.chatInput.delTag(s),n++}this.chatInput.setRangeLastText(),await this.chatEvent.richTextInput()}openTipTag(t){this.chatElement.createTipElm(t),this.cursorToLastRecord()}openCustomTipTag(t){const e=this.chatElement.createCustomTipElm(t);return this.cursorToLastRecord(),e}closeTipTag(){this.chatElement.tipElm&&this.chatElement.removeTipElm()}addEventListener(t,e){this.chatEvent.chatEventModule[t].push(e)}removeEventListener(t,e){const i=this.chatEvent.chatEventModule[t],n=i.indexOf(e);n!==-1&&i.splice(n,1)}revisePCPointDialogLabel(t){this.options.needDialog&&(this.options.dialogLabels.pcPointDialog=Object.assign({},ot,t||{}),this.chatElement.pcElms.pointDialogElm.querySelector(".call-user-dialog-header-title").textContent=this.options.dialogLabels.pcPointDialog.title,this.chatElement.pcElms.pointDialogCheckElm.textContent=this.options.dialogLabels.pcPointDialog.checkLabel,this.chatElement.pcElms.pointDialogEmptyElm&&(this.chatElement.pcElms.pointDialogEmptyElm.children[1].textContent=this.options.dialogLabels.pcPointDialog.emptyLabel),this.options.asyncMatch||this.updateUserList())}revisePCCheckDialogLabel(t){this.options.needDialog&&!this.options.asyncMatch&&(this.options.dialogLabels.pcPCheckDialog=Object.assign({},lt,t||{}),this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-container-header").children[0].textContent=this.options.dialogLabels.pcPCheckDialog.title,this.chatElement.pcElms.checkDialogSearchInputElm.setAttribute("placeholder",this.options.dialogLabels.pcPCheckDialog.searchPlaceholder),this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-search-empty").textContent=this.options.dialogLabels.pcPCheckDialog.searchEmptyLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".checkbox-dialog-right-box-title").textContent=this.options.dialogLabels.pcPCheckDialog.userTagTitle,this.chatElement.pcElms.checkDialogUsersElm.children[0].children[2].textContent=this.options.dialogLabels.pcPCheckDialog.checkAllLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".btn-submit").textContent=this.options.dialogLabels.pcPCheckDialog.confirmLabel,this.chatElement.pcElms.checkDialogElm.querySelector(".btn-close").textContent=this.options.dialogLabels.pcPCheckDialog.cancelLabel)}reviseH5DialogLabel(t){this.options.needDialog&&(this.options.dialogLabels.h5Dialog=Object.assign({},rt,t||{}),this.chatElement.h5Elms.dialogElm.querySelector(".popup-title").textContent=this.options.dialogLabels.h5Dialog.title,this.chatElement.h5Elms.dialogSearchElm.setAttribute("placeholder",this.options.dialogLabels.h5Dialog.searchPlaceholder),this.chatElement.h5Elms.dialogEmptyElm.children[1].textContent=this.options.dialogLabels.h5Dialog.searchEmptyLabel,this.chatElement.h5Elms.dialogCheckElm.textContent=this.options.dialogLabels.h5Dialog.confirmLabel,this.chatElement.h5Elms.dialogShowElm.textContent=this.options.dialogLabels.h5Dialog.cancelLabel,this.options.asyncMatch||this.updateUserList())}async nextTick(t){return new Promise(e=>{requestAnimationFrame(()=>{const i=t();i instanceof Promise?i.then(()=>{e()}):e()})})}createOperateNode(){return new Lt(this)}createChatComponent(){return new wt(this)}};f(_t,"version","6.0.3");export{_t as C};
