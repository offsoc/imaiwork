import{a as Y,L as j}from"./person_wechat.8bcf26fc.js";import{TalkActionTypeEnum as I,ContentTypeEnum as a,EnumTalkType as p}from"./index.cf59f1a8.js";import q from"./useHandle.2b5b26f8.js";import{r as $,aF as D}from"./entry.d7219633.js";const z=2*60*1e3,Q=new Map,{wechatLists:B,wechatAiInfo:U,replyStrategyInfo:F,getWeChatAiInfo:ne,addFriend:X}=q();function ae(){const O=$({}),E=D({}),g=D({}),S=$({}),N=c=>{const{accessToken:t,wechat_id:n}=B.value.find(T=>T.wechat_id===c)||{};return{accessToken:t,wechat_id:n}},C=async(c,t)=>{const{multiple_type:n}=F.value||{};try{await j(c)}finally{n==p.Single&&delete E[t],(n==p.Merge||n==p.Number)&&delete g[t]}},G=async c=>{const{WeChatId:t,DeviceId:n,FriendId:T,NickName:M,Content:r,ContentType:m,MsgSvrId:v,MsgId:R,IsSend:V}=c,{multiple_type:f,number_chat_rounds:b,voice_enable:P,image_enable:w,image_reply:x,stop_enable:A,stop_keywords:L}=F.value||{},{open_ai:H,takeover_mode:e}=U.value[t]||{},o=async()=>new Promise(async l=>{try{const k=await Y({wechat_id:t,friend_id:T});l(k)}catch{const y=await X({wechat_id:t,friend_id:T,nickname:M,open_ai:1,takeover_mode:1});l(y)}}),{open_ai:s,takeover_mode:u}=await o();if(H==1&&e==1&&s==1&&u==1){const{accessToken:l}=N(t),y={taskId:`${Date.now()}`,accessToken:l,wechatId:t,deviceId:n,friendId:T,content:r,talkType:f},d={...y,type:I.PostHistory,count:b+1,messageId:v,firstMessageId:v};if([a.Text,a.Voice,a.QuoteMsg].includes(m)){if(f==p.Single){if(m===a.Text||m===a.QuoteMsg){if(L===r)return;if(m===a.QuoteMsg){const _=JSON.parse(r);d.content=_.title}h("post",d)}m===a.Voice&&(P==1&&h("post",{type:I.VoiceToText,...y,messageId:v}),h("post",d))}(f==p.Merge||f==p.Number)&&(()=>{const i=`${t}${T}`;if(S.value[i]&&clearTimeout(S.value[i]),m===a.Text&&!V){if(g[i]||(g[i]={wechat_id:t,friend_id:T,message_logs:[],message_id:"",message_type:0,message:""}),g[i].message_id=v,g[i].message=r,f==1){const K=g[i].message_logs.length+1;g[i].message_logs.push({content:r,role:"user",id:K})}f==2&&(g[i].message_logs[0]={content:r,role:"user"}),S.value[i]=setTimeout(()=>{C(g[i],i)},z)}})()}else if(m===a.Picture){if(!w)return;h("post",{type:I.PostPicture,...y,content:x})}}},J=()=>{O.value=null,g.value=null,S.value=null},h=(c,t)=>{const n=Q.get(c);n&&n(t)},W=(c,t)=>{Q.set(c,t)};return W("get",c=>{const{type:t,taskId:n,data:T}=c,{friendId:M,wechatId:r,deviceId:m,messageId:v,content:R,firstMessageId:V,historyMsgLists:f}=E[n]||{},{accessToken:b}=N(r),{voice_enable:P,multiple_type:w}=F.value||{},x=()=>{f.forEach((e,o)=>{const s=e.ContentType===a.Voice;e.loading=s,s&&(e.historyTaskId=o+1,h("post",{type:I.VoiceToText,talkType:w,wechatId:r,deviceId:m,friendId:M,messageId:e.MsgSvrId,accessToken:b,taskId:`${n}${e.historyTaskId}`,historyTaskId:e.historyTaskId}))})},A=e=>e.map(o=>{var _;const{IsSend:s,ContentType:u,Content:l,content:k}=o,y=s?"assistant":"user";let d=l;return u===a.QuoteMsg?d=(_=JSON.parse(l))==null?void 0:_.title:u===a.Voice&&(d=k),{role:y,content:d}}).reverse(),L=e=>{const o=A(e);C({wechat_id:r,friend_id:M,message_type:0,message_id:V,message:R,message_logs:o},n)},H=e=>{if(e==null?void 0:e.every(s=>!s.loading)){const s=A(e);C({wechat_id:r,friend_id:M,message_type:0,message_id:V,message:R,message_logs:s},n)}};switch(t){case I.GetHistory:{const e=P===1?f:f.filter(s=>s.ContentType!==a.Voice);e.some(s=>s.ContentType===a.Voice)?x():L(e);break}case I.VoiceToTextResult:if(w==p.Single){const{TaskId:e,ErrMsg:o}=T,s=e.length===14,u=s?e.slice(0,-1):e,l=E[u];if(l&&(s||(l.content=o),s)){const k=e.slice(-1),{historyMsgLists:y}=l,d=y.find(_=>_.historyTaskId==k);d&&(d.loading=!1,d.content=o),H(y)}}else if(w==p.Merge){const{TaskId:e,ErrMsg:o,WeChatId:s}=T;e.length===14&&e.slice(0,-1)}break}}),{talkReplyTaskData:E,createTalkReplyTask:G,deleteAllTalkReplyTask:J,triggerTalkEvent:h,onTalkEvent:W}}export{ae as default};
