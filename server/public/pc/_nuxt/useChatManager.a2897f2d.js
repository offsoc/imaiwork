import{bO as H,z as O,at as j,bP as b,A as F,aH as q,bQ as D,G as h,bR as G,bS as z}from"./entry.2beb4577.js";import{useChatStore as J}from"./chat.a6df5aaa.js";function Y(){const A=H(),a=J(),S=O(),E=j(),{taskId:i,agentValue:p,chatContentList:l,isReceiving:m,isStopChat:N,isLoading:P,isDeep:y,isNetwork:L,fileLists:c,extraParams:U}=b(a),{userTokens:x,userInfo:M}=b(S),{chatConfig:C}=E,v=F(null),w=F(null),n=()=>{q(()=>{var e;return(e=v.value)==null?void 0:e.scrollToBottom()})},R=()=>{z({task_id:void 0,agent_name:void 0,agent_id:void 0})},B=e=>{e.trim().split("data:").forEach(t=>{var s,_;if(t)try{const{object:o,content:r,task_id:u,usage:g,reasoning_content:f}=JSON.parse(t),I=l.value[l.value.length-1];if(o==="loading"){const d={};f?(d.is_reasoning_finished=!1,d.reasoning_content=(I.reasoning_content||"")+f):r&&(d.is_reasoning_finished=!0,d.reply=(I.reply||"")+r),a.updateLastMessage(d)}else o==="finished"&&(a.updateLastMessage({consume_tokens:g}),a.setTaskId(u),z({task_id:u,agent_name:(s=p.value)==null?void 0:s.name,agent_id:(_=p.value)==null?void 0:_.id}));n()}catch(o){console.error("解析流式消息失败:",o,"原始文本:",t)}})},T=async()=>{if(!(!i.value||i.value==="undefined")){a.isLoading=!0;try{const e=await D({page_no:1,page_size:9999,task_id:i.value,assistant_id:0}),t=(e==null?void 0:e.map(s=>s.type===1?{...s,form_avatar:M.value.avatar,fileList:s!=null&&s.file_info?Array.isArray(s.file_info)?s.file_info:[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:a.detail.logo,consume_tokens:s.tokens_info}))??[];a.chatContentList=t,n()}catch(e){console.error("获取聊天记录失败:",e),h.msgError("获取聊天记录失败")}finally{a.isLoading=!1}}},k=async(e,t=!1,s)=>{var o,r,u;if(x.value<=1)return h.msgPowerInsufficient();if(m.value||!e.trim()&&c.value.length===0)return;t||a.addMessage({type:1,message:e,form_avatar:M.value.avatar,fileList:c.value});const _={type:2,loading:!0,form_avatar:a.detail.logo,is_reasoning_finished:y.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};a.addMessage(_),a.startReceiving(),n();try{await G({message:e,task_id:i.value,robot_id:(o=p.value)==null?void 0:o.id,open_reasoning:y.value?1:0,is_network_search:L.value?1:0,file_info:c.value.length?c.value[0]:void 0,...((u=(r=v.value)==null?void 0:r.getChatConfig)==null?void 0:u.call(r))||{},...U.value},{onstart:g=>{w.value=g},onmessage:B,onclose:()=>{a.updateLastMessage({loading:!1}),a.stopReceiving(),a.clearFiles(),S.getUser(),n(),s==null||s()}})}catch(g){const f=g||"消息发送失败";a.updateLastMessage({error:f,loading:!1}),h.msgError(f),a.stopReceiving()}finally{n()}};return{chattingRef:v,isLoading:P,isDeep:y,isNetwork:L,fileLists:c,taskId:i,chatContentList:l,isReceiving:m,isStopChat:N,initialize:async()=>{a.clearChat();const{content:e,task_id:t}=A.query;e?(await k(e),R()):t&&t!=="undefined"&&(a.setTaskId(t),await T()),n()},sendMessage:k,startNewChat:()=>{var e,t,s;if(!i.value)return h.msgError("当前已是新会话");a.clearChat(),R(),(t=(e=v.value)==null?void 0:e.cleanInput)==null||t.call(e),(s=C.value)!=null&&s.new_chat_prompt&&k(C.value.new_chat_prompt,!0)},stopStream:()=>{var e;if((e=w.value)==null||e.cancel(),m.value){const t=l.value[l.value.length-1];a.updateLastMessage({loading:!1,reply:t.reply||"用户已停止内容生成"}),a.stopReceiving()}},chatScrollToBottom:n,fetchChatHistory:T,setFiles:a.setFiles,clearFiles:a.clearFiles}}export{Y as useChatManager};
