import{u as q}from"./useSocialPlatform.c7b710e3.js";import{r as n,eg as o,dY as I,G as x}from"./entry.d7219633.js";import{o as G,p as z}from"./service.12abd78a.js";import{a as V}from"./device.317521e4.js";const W=e=>{q();const{send:g,onEvent:w}=e,D=n(!1),d=n(!1),m=n(null),l=n(0),r=n(null),_=n([]),u=n(null),P=(a,c)=>{g({type:o.GET_USER_INFO,content:{deviceId:a},deviceId:a,appType:c})};w("success",async a=>{var S,i,k,O,C,M,T,b;const{type:c,content:t,deviceId:h,appType:y}=a;let R="";switch(c){case o.ADD_DEVICE:m.value={status:1,device_code:t.deviceId,device_model:t.deviceModel,sdk_version:t.sdkVersion};try{x.loading("添加中..."),await V(m.value),(S=e.onSuccess)==null||S.call(e,{msg:"添加成功",type:c,data:a})}catch(s){(i=e.onError)==null||i.call(e,{error:s,type:c,code:I.API_ERROR})}finally{d.value=!1,D.value=!1,x.closeLoading()}break;case o.GET_USER_INFO:try{const{account:s,account_no:L,extra:J,avatar:Y,nickname:j}=t,f={account:s,account_no:L,avatar:Y,device_code:h,type:y,nickname:j,extra:JSON.stringify(J)};if(u.value=="addAccount"){m.value&&await V(m.value);try{await G(f),D.value=!1,u.value=null,l.value=100,(k=e.onSuccess)==null||k.call(e,{msg:"添加账号成功",type:c,data:a})}catch(E){(O=e.onError)==null||O.call(e,{error:E,type:c,code:I.API_ERROR})}}if(u.value=="updateAccount"){const E=_.value.filter(v=>v.type==f.type).find(v=>v.account==f.account);try{E?await z({id:E.id,...f}):await G(f),u.value=null,l.value=100,(C=e.onSuccess)==null||C.call(e,{msg:"更新成功",type:c,data:a})}catch(v){console.log(v),(M=e.onError)==null||M.call(e,{error:v,type:c,code:I.API_ERROR})}}}catch(s){(T=e.onError)==null||T.call(e,{error:s,type:c,code:I.API_ERROR})}_.value=null,d.value=!1,clearInterval(r.value);break;default:(b=e.onSuccess)==null||b.call(e,{msg:R,type:c,data:a});break}}),w("error",a=>{var c;d.value=!1,(c=e.onError)==null||c.call(e,a),r.value&&clearInterval(r.value)});const N=a=>{A(),d.value=!0,g({type:o.ADD_DEVICE,content:{deviceId:a},deviceId:a})},U=(a,c)=>{u.value="updateAccount",A(),P(a,c)},F=a=>{u.value="addAccount",A(),P(a.device_code,a.type)},A=()=>{r.value&&(clearInterval(r.value),r.value=null);const a=Date.now(),c=10*1e3,t=300,h=2;l.value=0,r.value=setInterval(()=>{const y=Date.now()-a,R=Math.min(h,Math.random()*(99-l.value)*.1);l.value=Math.floor(Math.min(99,l.value+R)),(l.value>=99||y>=c)&&(r.value&&(clearInterval(r.value),r.value=null),l.value=99)},t)};return{showAddDevice:D,addDeviceLoading:d,progressValue:l,eventAction:u,refreshAccount:_,handleAddDeviceConfirm:N,handleAddAccount:F,handleRefreshAccount:U,completeProgress:A}};export{W as u};
