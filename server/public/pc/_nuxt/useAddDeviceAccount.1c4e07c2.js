import{u as z}from"./useSocialPlatform.694640c2.js";import{r as t,em as o,G as f,ea as D}from"./entry.2beb4577.js";import{o as G,p as B}from"./service.595be035.js";import{i as V}from"./device.b7e58507.js";const X=e=>{z();const{send:S,onEvent:w}=e,_=t(!1),v=t(!1),A=t(null),l=t(0),r=t(null),g=t([]),u=t(null),i=(a,c)=>{S({type:o.GET_USER_INFO,content:{deviceId:a},deviceId:a,appType:c})};w("success",async a=>{var P,k,O,C,M,T,b,x;const{type:c,content:n,deviceId:h,appType:y}=a,R=n.msg||"";switch(c){case o.ADD_DEVICE:A.value={status:1,device_code:n.deviceId,device_model:n.deviceModel,sdk_version:n.sdkVersion};try{f.loading("添加中..."),await V(A.value),f.msgSuccess("添加设备成功"),(P=e.onSuccess)==null||P.call(e,{msg:"添加成功",type:c,data:a})}catch(d){(k=e.onError)==null||k.call(e,{error:d,type:c,code:D.API_ERROR})}finally{v.value=!1,_.value=!1,f.closeLoading()}break;case o.GET_USER_INFO:try{const{account:d,account_no:L,extra:J,avatar:j,nickname:q}=n,s={account:d,account_no:L,avatar:j,device_code:h,type:y,nickname:q,extra:JSON.stringify(J)};if(u.value=="addAccount"){A.value&&await V(A.value);try{await G(s),_.value=!1,u.value=null,l.value=100,f.msgSuccess("添加账号成功"),(O=e.onSuccess)==null||O.call(e,{msg:"添加账号成功",type:c,data:a})}catch(I){(C=e.onError)==null||C.call(e,{error:I,type:c,code:D.API_ERROR})}}if(u.value=="updateAccount"){const I=g.value.filter(m=>m.type==s.type).find(m=>m.account==s.account);try{I?await B({id:I.id,...s}):await G(s),u.value=null,l.value=100,f.msgSuccess("更新成功"),(M=e.onSuccess)==null||M.call(e,{msg:"更新成功",type:c,data:a})}catch(m){(T=e.onError)==null||T.call(e,{error:m,type:c,code:D.API_ERROR})}}}catch(d){(b=e.onError)==null||b.call(e,{error:d,type:c,code:D.API_ERROR})}g.value=null,v.value=!1,clearInterval(r.value);break;default:(x=e.onSuccess)==null||x.call(e,{msg:R,type:c,data:a});break}}),w("error",a=>{var c;v.value=!1,(c=e.onError)==null||c.call(e,a),r.value&&clearInterval(r.value)});const N=a=>{E(),v.value=!0,S({type:o.ADD_DEVICE,content:{deviceId:a},deviceId:a})},U=(a,c)=>{u.value="updateAccount",E(),i(a,c)},F=a=>{u.value="addAccount",E(),i(a.device_code,a.type)},E=()=>{r.value&&(clearInterval(r.value),r.value=null);const a=Date.now(),c=15*1e3,n=300,h=2;l.value=0,r.value=setInterval(()=>{const y=Date.now()-a,R=Math.min(h,Math.random()*(99-l.value)*.1);l.value=Math.floor(Math.min(99,l.value+R)),(l.value>=99||y>=c)&&(r.value&&(clearInterval(r.value),r.value=null),l.value=99)},n)};return{showAddDevice:_,addDeviceLoading:v,progressValue:l,eventAction:u,refreshAccount:g,handleAddDeviceConfirm:N,handleAddAccount:F,handleRefreshAccount:U,completeProgress:E}};export{X as u};
