const D="-----CUSTOM_SPLIT_SIGN-----",G=h=>h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),K=h=>{if(!h.includes("|"))return!1;const s=h.split(`
`);if(s.length<2)return!1;const e=s[0].trim();if(!e.startsWith("|")||!e.endsWith("|"))return!1;const T=s[1].trim();if(!/^(\|[\s:]*-+[\s:]*)+\|$/.test(T))return!1;for(let m=2;m<s.length;m++){const d=s[m].trim();if(d&&(!d.startsWith("|")||!d.endsWith("|")))return!1}return!0},j=h=>{const{text:s="",chunkLen:e}=h,T=s.split(`
`),p=T[0],m=p.split("|").length-2,d=`| ${new Array(m>0?m:1).fill(0).map(()=>"---").join(" | ")} |`,f=[];let $=`${p}
                ${d}
                `;for(let u=2;u<T.length;u++)$.length+T[u].length>e*1.2&&(f.push($),$=`${p}
                    ${d}
                    `),$+=`${T[u]}
`;return $&&f.push($),{chunks:f,chars:f.reduce((u,S)=>u+S.length,0)}},B={codeBlock:/(```[\s\S]*?```|~~~[\s\S]*?~~~)/g,multipleNewlines:/(\r?\n|\r){3,}/g},F=h=>{let{text:s="",chunkLen:e,overlapRatio:T=.2,customReg:p=[]}=h;const m="SPLIT_HERE_SPLIT_HERE",d="CODE_BLOCK_LINE_MARKER",f=Math.round(e*T),$=50;s=s.replace(B.codeBlock,function(n){return n.replace(/\n/g,d)}),s=s.replace(B.multipleNewlines,`


`);const u=[...p.map(n=>({reg:new RegExp(`(${G(n)})`,"g"),maxLen:e*1.4})),{reg:/^(#\s[^\n]+)\n/gm,maxLen:e*1.2},{reg:/^(##\s[^\n]+)\n/gm,maxLen:e*1.2},{reg:/^(###\s[^\n]+)\n/gm,maxLen:e*1.2},{reg:/^(####\s[^\n]+)\n/gm,maxLen:e*1.2},{reg:/([\n]([`~]))/g,maxLen:e*4},{reg:/([\n](?!\s*[\*\-|>0-9]))/g,maxLen:e*2},{reg:/([\n])/g,maxLen:e*1.2},{reg:/([。]|([a-zA-Z])\.\s)/g,maxLen:e*1.2},{reg:/([！]|!\s)/g,maxLen:e*1.2},{reg:/([？]|\?\s)/g,maxLen:e*1.4},{reg:/([；]|;\s)/g,maxLen:e*1.6},{reg:/([，]|,\s)/g,maxLen:e*2}],S=p.length,v=n=>n<S,H=n=>n>=S&&n<=3+S,W=n=>n>=S&&n<=4+S,U=n=>n<=6+S,A=({text:n,step:t})=>{if(t>=u.length)return[{text:n,title:""}];const l=v(t),L=H(t),i=W(t),{reg:g}=u[t];return n.replace(g,(()=>l?m:i?`${m}$1`:`$1${m}`)()).split(`${m}`).filter(x=>x.trim()).map(x=>{var C;const k=L&&((C=x.match(g))==null?void 0:C[0])||"";return{text:L?x.replace(k,""):x,title:k}}).filter(x=>x.text.trim())},_=({text:n,step:t})=>{const l=U(t),L=e*.4;if(l||f===0||t>=u.length)return"";const i=A({text:n,step:t});let g="";for(let w=i.length-1;w>=0;w--){const k=i[w].text+g,C=k.length;if(C>f)return C>L?_({text:k,step:t+1})||g:k;g=k}return g},N=({text:n="",step:t,lastText:l,mdTitle:L="",depth:i=0})=>{if(i>$){const o=`${L}${l}${n}`;if(o.length<=e*3)return[o];const R=[];for(let a=0;a<o.length;a+=e-f){const I=o.slice(a,a+e);I.length>0&&R.push(I)}return R}const g=W(t),w=v(t);if(t>=u.length){const o=`${L}${l}${n}`;if(o.length<e*3)return[o];const R=[];for(let a=0;a<o.length;a+=e-f)R.push(o.slice(a,a+e));return R}const x=A({text:n,step:t}),k=x.length>1?u[t].maxLen:e,C=e*.7,b=30,c=[];let r=l;for(let o=0;o<x.length;o++){const R=x[o],a=`${L}${R.title}`,I=R.text,z=I.length,y=r.length,P=r+I,M=y+z;if(M>k){if(y>C){c.push(`${a}${r}`),r=_({text:r,step:t}),o--;continue}const E=N({text:P,step:t+1,lastText:"",mdTitle:a,depth:i+1}),O=E[E.length-1];!g&&O.length<C?(c.push(...E.slice(0,-1)),r=O):(c.push(...E),r=_({text:O,step:t}));continue}r=P,(w||g&&M>b||M>=e)&&(c.push(`${a}${r}`),r=_({text:r,step:t}))}return r&&c.length>0&&!c[c.length-1].endsWith(r)?r.length<e*.4?c[c.length-1]=c[c.length-1]+r:c.push(`${L}${r}`):r&&c.length===0&&c.push(r),c};try{const n=performance.now(),t=N({text:s,step:0,lastText:"",mdTitle:"",depth:0}).map(i=>(i==null?void 0:i.replaceAll(d,`
`))||""),l=t.reduce((i,g)=>i+g.length,0),L=performance.now();return{chunks:t,chars:l}}catch(n){console.error("文本分割错误:",n);const t=[];for(let l=0;l<s.length;l+=e-f)t.push(s.slice(l,l+e));return{chunks:t,chars:s.length}}},X=h=>{const{text:s=""}=h;return s.split(D).map(p=>K(p)?j(h):F(h)).map(p=>p.chunks).flat()};export{X as s};
