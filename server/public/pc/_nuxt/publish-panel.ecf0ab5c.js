import{d as Je,bO as Ke,a as Qe,aG as Ze,dI as Xe,c as I,r as _,aF as me,bC as de,A as et,cx as tt,l as d,m as t,q as f,s as g,Z as s,J as k,K as P,t as v,L as h,I as T,bS as st,G as C,dx as ot,cY as it,aH as X,ax as lt,u as at,k as r,v as R,Y as S,y as nt,_ as rt}from"./entry.2beb4577.js";import{_ as ut}from"./index.vue.478e85a5.js";import{E as ct,a as pt}from"./index.4d719c96.js";import{E as mt}from"./el-alert.6b601755.js";import{E as dt}from"./el-time-picker.6b0df02f.js";import{_ as ft}from"./index.vue.8d512c7f.js";/* empty css                  *//* empty css               *//* empty css                     */import{u as vt}from"./useSocialPlatform.694640c2.js";import{g as _t,a as xt,p as gt}from"./device.b7e58507.js";import{PublishTaskTypeEnum as y,MaterialTypeEnum as fe,SidebarTypeEnum as ht,MaterialActionType as yt}from"./index.db2ee73f.js";import bt from"./content-copywriting-material.b7489ef3.js";import{_ as ve}from"./copywriting-card.vue.2c0b1e4e.js";import _e from"./material-picker.55a3fc40.js";import wt from"./material-popup.1e08fa46.js";import kt from"./useMaterial.5513a09e.js";import{validateSchedule as Ct}from"./utils.82b5f057.js";import{E as ee}from"./index.47b30189.js";import"./index.dcd97a19.js";import"./strings.a9740cf6.js";import"./_baseIteratee.70cb6d8d.js";import"./toNumber.c824a4a2.js";import"./clamp.a46ea567.js";import"./index.9d200730.js";import"./customParseFormat.7d9a8b8e.js";import"./panel-time-pick.d62e59d0.js";import"./index.ed72cac8.js";import"./debounce.dd7f88c1.js";import"./el-empty.bc763313.js";import"./redbook.418b34fe.js";import"./index.3d6ad44d.js";import"./index.e8be04c0.js";import"./index.a9d48d33.js";import"./cloneDeep.a23e4277.js";/* empty css                  *//* empty css                    *//* empty css                  */import"./index.e6c47712.js";import"./el-image.a83bf837.js";import"./el-image-viewer.d11cc27b.js";import"./throttle.403d4771.js";/* empty css                   */import"./useTemplate.afda57ca.js";import"./el-tabs.8b676a95.js";import"./raf.c0777355.js";import"./index.772967a0.js";import"./index.vue.4c207597.js";import"./usePaging.85211d66.js";import"./digital_human.b276942f.js";import"./index.abba0b88.js";const Mt={class:"h-full bg-app-bg-2 rounded-[20px] overflow-x-auto dynamic-scroller"},Et={class:"h-full flex flex-col min-w-[1000px]"},It={class:"flex-shrink-0 flex items-center justify-between px-[14px] h-[88px] border-b border-[#ffffff1a]"},Vt={class:"flex items-center gap-1"},Pt={class:"px-5"},Tt={class:"flex-shrink-0 flex items-center justify-center h-[100px] border-b border-[#ffffff1a] gap-x-[150px]"},St=["onClick"],$t={class:"grow min-h-0 flex flex-col p-5"},At={key:0,class:"grow min-h-0 flex flex-col w-[456px] mx-auto"},Lt={class:"flex items-center justify-between flex-shrink-0"},Dt={class:"text-white font-bold text-[20px]"},Rt={class:"grow min-h-0 mt-5 flex gap-x-[18px]"},Ft={class:"content-item material-content"},Ht={class:"flex items-center justify-between flex-shrink-0 px-[14px]"},Gt={class:"text-[11px] text-white"},Ut={class:"text-[11px] text-white"},Ot={class:"grow min-h-0"},Bt={class:"px-[14px]"},jt={key:0,class:"mt-[14px] border border-app-border-2 rounded-xl p-2"},Wt=["onClick"],zt={key:1,class:"grow min-h-0 flex flex-col"},Nt={class:"flex items-center justify-between flex-shrink-0"},Yt={class:"grow min-h-0 mt-5 flex gap-x-[18px]"},qt={class:"content-item title-content"},Jt={class:"content-item desc-content"},Kt={class:"w-[456px] mx-auto"},Qt={class:"mt-[23px] flex flex-col gap-y-4"},Zt={class:"flex items-center gap-x-2"},Xt=["src"],es={class:"flex flex-wrap gap-2 mt-4"},ts=["onClick"],ss={class:"mt-4"},os={class:"rounded-xl bg-app-bg-3 border border-app-border-2 py-3"},is={class:"px-3"},ls={class:"text-[#ffffff80] mb-[13px] text-xs"},as={key:0,class:"mt-2"},ns={class:"text-[#FF2442] mt-1 text-xs"},F=99,xe=100,rs=".mp4,.mov",us=50,H=9,G=30,cs=Je({__name:"publish-panel",props:{type:{default:y.VIDEO}},emits:["back"],setup(ge,{emit:he}){const ye=ge,be=he,we=Ke(),ke=Qe(),te=at(),{updateCopywritingMaterial:M}=kt(),{getPlatform:Ce}=vt(),$={[y.VIDEO]:"视频",[y.IMAGE]:"图文"},Me={[y.VIDEO]:fe.VIDEO,[y.IMAGE]:fe.IMAGE},U=[{step:1,title:"选择素材"},{step:2,title:"填写文案"},{step:3,title:"设定时间"}],se=[1,60],{type:m}=Ze(ye),Ee=Xe(),Ie=I(()=>Ee.material_id),p=_(1),n=me({name:`${$[m.value]}矩阵任务${de().format("YYYYMMDDHHmmss")}`,accounts:[],media_type:m.value,time_config:[],publish_frep:2}),i=me({id:Ie.value,name:n.name,media_type:m.value,media_url:[],title:[],subtitle:[]}),O=_(!1),B=_(!1),j=_(!1),oe=_(),ie=et(),W=_(),Ve=_(),Pe=_(),z=_([]),N=_([]),Y=_(""),le=I(()=>p.value===U.length),V=I(()=>m.value===y.VIDEO),A=I(()=>m.value===y.IMAGE),Te=()=>{p.value===1?ne():p.value--},Se=o=>{o>p.value?ae():p.value=o},ae=async()=>{let o=!1;if(p.value===1)o=await Ae();else if(p.value===2)o=await Le();else if(le.value){await We();return}o&&(p.value++,st({...we.query,step:p.value}))},$e=()=>{te.$confirm({message:"确定要取消创建吗？",theme:"dark",onConfirm:ne})},ne=()=>{be("back"),p.value=1},Ae=async()=>i.media_url.length===0?(C.msgWarning("请选择素材"),!1):m.value===y.IMAGE&&i.media_url.some(o=>!Array.isArray(o.url)||o.url.length===0||o.url.some(e=>!e))?(C.msgWarning("请为每个图片组添加有效的图片，或删除空的图片组"),!1):!0,Le=async()=>i.title.length===0||i.title.every(o=>!o.content)?(C.msgWarning("请填写标题"),!1):i.subtitle.length===0||i.subtitle.every(o=>!o.content)?(C.msgWarning("请填写描述"),!1):(Ne(),!0),q=_(0),E=_(-1),De=I(()=>{if(V.value)return E.value===-1?F:F-i.media_url.length;if(A.value){const o=i.media_url[q.value];return E.value===-1?H:H-((o==null?void 0:o.url.length)||0)}return 0}),J=I(()=>E.value===-1),re=async(o,e)=>{var u;q.value=e,E.value=o.index>-1?o.index:-1,B.value=!0,await X(),(u=ie.value)==null||u.open()},Re=async o=>{if(V.value)if(J.value)for(const e of o){const u={url:e.url,pic:e.pic};if(!e.pic)try{const{file:x}=await ot(e.url),a=await it({file:x});u.pic=a.uri}catch{}i.media_url.push(u),K(e)}else i.media_url[E.value]=o[0];else if(A.value){const e=i.media_url[q.value];J.value?e.url.push(...o):e.url[E.value]=o[0]}M(i)},ue=()=>M(i),ce=o=>{o.type===yt.ADD&&V.value&&K()},Fe=()=>{i.media_url.push({url:[],date:""}),K()},He=o=>{te.$confirm({message:"确定要删除该素材组吗？",theme:"dark",onConfirm:()=>{i.media_url.splice(o,1),M(i)}})},Ge=async()=>{O.value=!0,await X(),oe.value.open()},Ue=o=>{const{titleList:e,contentList:u}=o;e.length>0&&i.title.push(...e),u.length>0&&i.subtitle.push(...u),(e.length>0||u.length>0)&&M(i)},K=(o=!0)=>{i.title.push({content:""}),setTimeout(()=>i.subtitle.push({content:"",topic:[]}),100),o&&M(i)},Oe=()=>Be()?n.accounts.length===0?(C.msgWarning("请选择发布账号"),!1):!0:!1,Be=()=>{const{valid:o,errorIndexes:e}=Ct(n.time_config);return o?(N.value=[],!0):(N.value=e,C.msgWarning("时间配置存在冲突"),!1)},je=o=>{o!=n.publish_frep&&(n.publish_frep=o,n.time_config=Array.from({length:o},(e,u)=>{const x=de().hour(9).minute(0),a=x.add(u*G,"minutes").format("HH:mm"),b=x.add(u*G+G,"minutes").format("HH:mm");return[a,b]}))},{lockFn:We,isLock:pe}=tt(async()=>{if(Oe())try{const o=i.title.filter(a=>a).map((a,b)=>{var L,D;const Q=(L=i.subtitle[b])==null?void 0:L.content,Z=(D=i.subtitle[b])==null?void 0:D.topic;return{title:a.content,content:Q,topic:Z}});let e=[];m.value===y.VIDEO?e=i.media_url.map(a=>({url:[a.pic,a.url]})):e=i.media_url.map(a=>({url:a.url.map(b=>b.url)}));const{id:u}=await xt({name:n.name,media_url:e,copywriting:o,media_type:m.value}),x=z.value.filter(a=>n.accounts.includes(a.account)).map(a=>({account:a.account,id:a.id,type:a.type}));await gt({name:n.name,matrix_media_setting_id:u,time_config:n.time_config.map(a=>`${a[0]}-${a[1]}`),accounts:x,publish_frep:n.publish_frep,media_type:m.value,task_type:3,scene:2,data_type:0}),C.msgSuccess("发布成功"),ke.push(`/app/matrix?type=${ht.ME_PUBLISH}`),setTimeout(()=>{window.location.reload()},500)}catch(o){Y.value=o,C.msgError(o)}}),ze=()=>{n.time_config.length===0&&(n.time_config.push(["09:00","09:30"]),n.time_config.push(["09:30","10:00"]))},Ne=()=>{Ye(),ze()},Ye=async()=>{const{lists:o}=await _t({page_size:999});z.value=o},qe=async o=>{var e,u;j.value=!0,await X(),(e=W.value)==null||e.open(),(u=W.value)==null||u.setUrl(o)};return(o,e)=>{const u=nt,x=lt,a=ut,b=ct,Q=pt,Z=mt,L=dt,D=ft;return r(),d(k,null,[t("div",Mt,[t("div",Et,[t("div",It,[t("div",{class:"flex items-center gap-2 cursor-pointer",onClick:Te},[f(u,{name:"el-icon-ArrowLeft",color:"#ffffff"}),e[10]||(e[10]=t("div",{class:"text-white"},"返回上一步",-1))]),t("div",Vt,[f(x,{class:"!rounded-full !h-10 w-[98px] !border-app-border-2",color:"#181818",disabled:s(pe),onClick:$e},{default:g(()=>[...e[11]||(e[11]=[R("取消",-1)])]),_:1},8,["disabled"]),f(x,{type:"primary",class:"!rounded-full !h-10 w-[98px]",loading:s(pe),onClick:ae},{default:g(()=>[R(v(s(le)?"提交":"下一步"),1)]),_:1},8,["loading"])])]),t("div",Pt,[t("div",Tt,[(r(),d(k,null,P(U,(l,c)=>t("div",{key:c,class:"relative"},[t("div",{class:"flex flex-col items-center gap-2 cursor-pointer",onClick:w=>Se(l.step)},[t("div",{class:S(["w-6 h-6 rounded-full flex items-center justify-center text-white",[s(p)>=l.step?"bg-primary":"bg-[#ffffff0d]"]])},v(c+1),3),t("div",{class:S([s(p)>=l.step?"text-white":"text-[#ffffff80]"])},v(l.title),3)],8,St),c!=U.length-1?(r(),d("div",{key:0,class:S(["absolute w-[120px] h-[1px] left-[calc(100%+15px)] top-[10px]",[s(p)>l.step?"bg-primary":"bg-[#ffffff1a]"]])},null,2)):h("",!0)])),64))])]),t("div",$t,[s(p)==1?(r(),d("div",At,[t("div",Lt,[t("div",Dt,"选择"+v($[s(m)]),1)]),t("div",Rt,[t("div",Ft,[t("div",Ht,[s(V)?(r(),d(k,{key:0},[t("div",Gt," 视频（共"+v(s(i).media_url.length)+"个视频） ",1),t("div",{class:"text-[11px] text-[#ffffff80] mt-2"}," 最多可选"+v(F)+"个，视频"+v(xe)+"m以下 ")],64)):h("",!0),s(A)?(r(),d(k,{key:1},[t("div",null,[t("div",Ut," 图文（共"+v(s(i).media_url.length)+"组） ",1),t("div",{class:"text-[11px] text-[#ffffff80] mt-2"}," 每组图片不超过"+v(H)+"张 ")]),f(x,{class:"!h-10 w-[106px] !border-[#ffffff1a]",color:"#262626",onClick:Fe},{default:g(()=>[...e[12]||(e[12]=[R("添加图片组",-1)])]),_:1})],64)):h("",!0)]),t("div",Ot,[f(s(ee),null,{default:g(()=>[t("div",Bt,[s(V)?(r(),d("div",jt,[f(_e,{"material-list":s(i).media_url,"onUpdate:materialList":[e[0]||(e[0]=l=>s(i).media_url=l),ue],type:s(m),accept:rs,"max-video-count":F,"max-size":xe,"video-min-duration":se[0],"video-max-duration":se[1],onPreviewVideo:qe,onImportMaterial:e[1]||(e[1]=l=>re(l,0)),onChangeMaterial:ce},null,8,["material-list","type","video-min-duration","video-max-duration"])])):h("",!0),s(A)?(r(!0),d(k,{key:1},P(s(i).media_url,(l,c)=>(r(),d("div",{class:"mt-[14px] border border-app-border-2 rounded-xl p-2 relative",key:c},[f(_e,{"material-list":l.url,"onUpdate:materialList":[w=>l.url=w,ue],type:s(m),"max-size":us,"max-image-count":H,onImportMaterial:w=>re(w,c),onChangeMaterial:ce},null,8,["material-list","onUpdate:materialList","type","onImportMaterial"]),t("div",{class:"absolute -top-2 -right-2 w-5 h-5",onClick:w=>He(c)},[f(a,{"icon-size":14})],8,Wt)]))),128)):h("",!0)])]),_:1})])])])])):s(p)==2?(r(),d("div",zt,[t("div",Nt,[e[14]||(e[14]=t("div",{class:"text-white font-bold text-[20px]"},"填写文案",-1)),t("div",null,[f(x,{type:"primary",class:"!rounded-full !h-10 w-[106px]",onClick:Ge},{default:g(()=>[...e[13]||(e[13]=[R("智能文案",-1)])]),_:1})])]),t("div",Yt,[t("div",qt,[f(ve,{"model-value":s(i).title,"onUpdate:modelValue":[e[2]||(e[2]=l=>s(i).title=l),e[3]||(e[3]=l=>s(M)(s(i)))],type:1,"publish-type-name":$[s(m)]},null,8,["model-value","publish-type-name"])]),t("div",Jt,[f(ve,{"model-value":s(i).subtitle,"onUpdate:modelValue":[e[4]||(e[4]=l=>s(i).subtitle=l),e[5]||(e[5]=l=>s(M)(s(i)))],type:2,"publish-type-name":$[s(m)]},null,8,["model-value","publish-type-name"])])])])):s(p)==3?(r(),T(s(ee),{key:2},{default:g(()=>[t("div",Kt,[e[20]||(e[20]=t("div",{class:"font-bold text-white text-[20px]"},"发布设置",-1)),t("div",Qt,[t("div",null,[e[15]||(e[15]=t("div",{class:"text-[#ffffff80] mb-3"},"账号选择",-1)),f(Q,{modelValue:s(n).accounts,"onUpdate:modelValue":e[6]||(e[6]=l=>s(n).accounts=l),placeholder:"请选择发布的账号",class:"!w-full !h-11 account-select","popper-class":"dark-select-popper",multiple:"","collapse-tags":"","show-arrow":!1},{default:g(()=>[(r(!0),d(k,null,P(s(z),l=>(r(),T(b,{key:l.account,label:`${l.nickname}（${l.account}）`,value:l.account},{default:g(()=>{var c;return[t("div",Zt,[t("img",{src:(c=s(Ce)(l.type))==null?void 0:c.icon,class:"w-4 h-4"},null,8,Xt),t("div",null,v(l.nickname)+"（"+v(l.account)+"）",1)])]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",null,[e[16]||(e[16]=t("div",{class:"text-[#ffffff80]"},"发布频率（每日）",-1)),t("div",es,[(r(),d(k,null,P([1,2,3,5,10],(l,c)=>t("div",{key:c,class:S(["cursor-pointer rounded-md px-4 py-2 border border-app-border-2 text-white hover:bg-app-bg-1",[s(n).publish_frep==l?"bg-primary hover:bg-primary":""]]),onClick:w=>je(l)},v(l)+"条 ",11,ts)),64))])]),t("div",null,[e[19]||(e[19]=t("div",{class:"text-[#ffffff80] mb-3"},"选择时间",-1)),t("div",ss,[t("div",os,[t("div",is,[f(Z,{type:"warning",effect:"dark"},{default:g(()=>[t("span",{class:"text-xs"},"设置的时间必须为n+1组的时间大于n组的时间，时间间隔"+v(G)+"分钟")]),_:1}),e[17]||(e[17]=t("div",{class:"text-white mt-4"},"任务发布设置",-1))]),f(s(ee),{ref_key:"timeConfigScrollbarRef",ref:Ve},{default:g(()=>[t("div",{class:"flex flex-col gap-3 mt-[5px] max-h-[300px] p-3",ref_key:"timeConfigWrapperRef",ref:Pe},[(r(!0),d(k,null,P(s(n).time_config,(l,c)=>(r(),d("div",null,[t("div",ls," 每天第"+v(c+1)+"个任务发布时间 ",1),f(L,{class:S(["w-full",{"time-error":s(N).includes(c)}]),modelValue:s(n).time_config[c],"onUpdate:modelValue":w=>s(n).time_config[c]=w,"is-range":"","range-separator":"至","prefix-icon":"",format:"HH:mm","value-format":"HH:mm","popper-class":"dark-select-popper","show-arrow":!1},null,8,["class","modelValue","onUpdate:modelValue"])]))),256))],512)]),_:1},512)]),s(Y)?(r(),d("div",as,[e[18]||(e[18]=t("div",null,"任务冲突",-1)),t("view",ns,v(s(Y)),1)])):h("",!0)])])])])]),_:1})):h("",!0)])])]),s(O)?(r(),T(bt,{key:0,ref_key:"copywritingMaterialRef",ref:oe,onClose:e[7]||(e[7]=l=>O.value=!1),onConfirm:Ue},null,512)):h("",!0),s(B)?(r(),T(wt,{key:1,ref_key:"materialPopRef",ref:ie,type:Me[s(m)],limit:s(De),multiple:s(J),onClose:e[8]||(e[8]=l=>B.value=!1),onConfirm:Re},null,8,["type","limit","multiple"])):h("",!0),s(j)?(r(),T(D,{key:2,ref_key:"previewVideoRef",ref:W,onClose:e[9]||(e[9]=l=>j.value=!1)},null,512)):h("",!0)],64)}}});const ro=rt(cs,[["__scopeId","data-v-458d021c"]]);export{ro as default};
