import{Q as gt,S as Q,O as ft,d as lt,c as _,A as rt,r as $,o as pt,D as ht,b as _t,b8 as xt,k as Y,l as K,H as bt,a3 as yt,aa as wt,aS as kt,am as Ct,at as St,z as It,bO as At,eo as tt,m as T,q as X,s as G,Z as k,ak as Mt,t as et,a8 as $t,v as Et,J as ct,K as Rt,L as zt,bM as Bt,ep as Tt,u as Wt,G as ut,eq as nt,ax as Nt}from"./entry.2beb4577.js";import{E as Pt}from"./index.47b30189.js";import{_ as Ft}from"./chatting.70e44c5d.js";/* empty css                     */import{H as Ht,I as Lt,J as Ot,K as Ut}from"./agent.a3fcedc5.js";import{_ as jt}from"./pwd-check.vue.dec6f158.js";import"./index.vue.0a368a30.js";import"./debounce.dd7f88c1.js";import"./toNumber.c824a4a2.js";import"./index.3864ff87.js";import"./el-image.a83bf837.js";import"./el-image-viewer.d11cc27b.js";import"./throttle.403d4771.js";import"./index.a9d48d33.js";/* empty css                    */import"./index.4d719c96.js";import"./index.dcd97a19.js";import"./strings.a9740cf6.js";import"./_baseIteratee.70cb6d8d.js";import"./clamp.a46ea567.js";import"./index.9d200730.js";/* empty css                  *//* empty css               */import"./useCopy.3342ae20.js";import"./cloneDeep.697b65df.js";import"./el-slider.bc047fea.js";import"./el-input-number.7f732a46.js";import"./index.ed72cac8.js";import"./el-switch.be9dc874.js";import"./index.e6c47712.js";/* empty css                   */const Dt=gt({zIndex:{type:Number,default:9},rotate:{type:Number,default:-22},width:Number,height:Number,image:String,content:{type:Q([String,Array]),default:"Element Plus"},font:{type:Q(Object)},gap:{type:Q(Array),default:()=>[100,100]},offset:{type:Q(Array)}});function Gt(f){return f.replace(/([A-Z])/g,"-$1").toLowerCase()}function qt(f){return Object.keys(f).map(a=>`${Gt(a)}: ${f[a]};`).join(" ")}function Xt(){return window.devicePixelRatio||1}const Yt=(f,a)=>{let r=!1;return f.removedNodes.length&&a&&(r=Array.from(f.removedNodes).includes(a)),f.type==="attributes"&&f.target===a&&(r=!0),r},Kt={left:[0,.5],start:[0,.5],center:[.5,0],right:[1,-.5],end:[1,-.5]};function st(f,a,r=1){const c=document.createElement("canvas"),u=c.getContext("2d"),l=f*r,v=a*r;return c.setAttribute("width",`${l}px`),c.setAttribute("height",`${v}px`),u.save(),[u,c,l,v]}function Vt(){function f(a,r,c,u,l,v,W,O,U){const[x,j,b,E]=st(u,l,c);if(a instanceof HTMLImageElement)x.drawImage(a,0,0,b,E);else{const{color:h,fontSize:S,fontStyle:L,fontWeight:B,fontFamily:V,textAlign:J,textBaseline:ot}=v,Z=Number(S)*c;x.font=`${L} normal ${B} ${Z}px/${l}px ${V}`,x.fillStyle=h,x.textAlign=J,x.textBaseline=ot;const q=ft(a)?a:[a];q==null||q.forEach((it,dt)=>{const[mt,vt]=Kt[J];x.fillText(it??"",b*mt+U*vt,dt*(Z+v.fontGap*c))})}const I=Math.PI/180*Number(r),N=Math.max(u,l),[g,D,p]=st(N,N,c);g.translate(p/2,p/2),g.rotate(I),b>0&&E>0&&g.drawImage(j,-b/2,-E/2);function s(h,S){const L=h*Math.cos(I)-S*Math.sin(I),B=h*Math.sin(I)+S*Math.cos(I);return[L,B]}let C=0,P=0,F=0,R=0;const H=b/2,M=E/2;[[0-H,0-M],[0+H,0-M],[0+H,0+M],[0-H,0+M]].forEach(([h,S])=>{const[L,B]=s(h,S);C=Math.min(C,L),P=Math.max(P,L),F=Math.min(F,B),R=Math.max(R,B)});const t=C+p/2,e=F+p/2,o=P-C,n=R-F,y=W*c,d=O*c,i=(o+y)*2,w=n+d,[A,z]=st(i,w);function m(h=0,S=0){A.drawImage(D,t,e,o,n,h,S,o,n)}return m(),m(o+y,-n/2-d/2),m(o+y,+n/2+d/2),[z.toDataURL(),i/c,w/c]}return f}const Jt=lt({name:"ElWatermark"}),Zt=lt({...Jt,props:Dt,setup(f){const a=f,r={position:"relative"},c=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontGap)!=null?e:3}),u=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.color)!=null?e:"rgba(0,0,0,.15)"}),l=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontSize)!=null?e:16}),v=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontWeight)!=null?e:"normal"}),W=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontStyle)!=null?e:"normal"}),O=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.fontFamily)!=null?e:"sans-serif"}),U=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.textAlign)!=null?e:"center"}),x=_(()=>{var t,e;return(e=(t=a.font)==null?void 0:t.textBaseline)!=null?e:"hanging"}),j=_(()=>a.gap[0]),b=_(()=>a.gap[1]),E=_(()=>j.value/2),I=_(()=>b.value/2),N=_(()=>{var t,e;return(e=(t=a.offset)==null?void 0:t[0])!=null?e:E.value}),g=_(()=>{var t,e;return(e=(t=a.offset)==null?void 0:t[1])!=null?e:I.value}),D=()=>{const t={zIndex:a.zIndex,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let e=N.value-E.value,o=g.value-I.value;return e>0&&(t.left=`${e}px`,t.width=`calc(100% - ${e}px)`,e=0),o>0&&(t.top=`${o}px`,t.height=`calc(100% - ${o}px)`,o=0),t.backgroundPosition=`${e}px ${o}px`,t},p=rt(null),s=rt(),C=$(!1),P=()=>{s.value&&(s.value.remove(),s.value=void 0)},F=(t,e)=>{var o;p.value&&s.value&&(C.value=!0,s.value.setAttribute("style",qt({...D(),backgroundImage:`url('${t}')`,backgroundSize:`${Math.floor(e)}px`})),(o=p.value)==null||o.append(s.value),setTimeout(()=>{C.value=!1}))},R=t=>{let e=120,o=64,n=0;const{image:y,content:d,width:i,height:w,rotate:A}=a;if(!y&&t.measureText){t.font=`${Number(l.value)}px ${O.value}`;const z=ft(d)?d:[d];let m=0,h=0;z.forEach(L=>{const{width:B,fontBoundingBoxAscent:V,fontBoundingBoxDescent:J,actualBoundingBoxAscent:ot,actualBoundingBoxDescent:Z}=t.measureText(L),q=kt(V)?ot+Z:V+J;B>m&&(m=Math.ceil(B)),q>h&&(h=Math.ceil(q))}),e=m,o=h*z.length+(z.length-1)*c.value;const S=Math.PI/180*Number(A);n=Math.ceil(Math.abs(Math.sin(S)*o)/2),e+=n}return[i??e,w??o,n]},H=Vt(),M=()=>{const e=document.createElement("canvas").getContext("2d"),o=a.image,n=a.content,y=a.rotate;if(e){s.value||(s.value=document.createElement("div"));const d=Xt(),[i,w,A]=R(e),z=m=>{const[h,S]=H(m||"",y,d,i,w,{color:u.value,fontSize:l.value,fontStyle:W.value,fontWeight:v.value,fontFamily:O.value,fontGap:c.value,textAlign:U.value,textBaseline:x.value},j.value,b.value,A);F(h,S)};if(o){const m=new Image;m.onload=()=>{z(m)},m.onerror=()=>{z(n)},m.crossOrigin="anonymous",m.referrerPolicy="no-referrer",m.src=o}else z(n)}};return pt(()=>{M()}),ht(()=>a,()=>{M()},{deep:!0,flush:"post"}),_t(()=>{P()}),xt(p,t=>{C.value||t.forEach(e=>{Yt(e,s.value)&&(P(),M())})},{attributes:!0,subtree:!0,childList:!0}),(t,e)=>(Y(),K("div",{ref_key:"containerRef",ref:p,style:yt([r])},[bt(t.$slots,"default")],4))}});var Qt=wt(Zt,[["__file","watermark.vue"]]);const te=Ct(Qt),ee={class:"h-screen"},ae={class:"px-4 h-full"},oe={class:"h-full flex flex-col items-center justify-center"},ne=["src"],se={class:"text-[32px] font-bold mt-4"},re={class:"text-[#7b7b7b] mt-[10px] text-xs w-[383px] mx-auto text-center"},le={class:"flex items-center gap-3"},ie={key:0},ce={class:"flex pb-3 gap-3"},ue=["onClick"],fe={class:"text-xs text-[#7b7b7b] text-center mt-2 line-clamp-1"},je=lt({__name:"[key]",setup(f){const a=St(),r=It(),u=At().params.key,l=$([]),v=$(!1),W=$(!1),O=rt(),U=async()=>{try{const{lists:t}=await Lt({share_apikey:u,identity:r.visitorId,page_size:25e3},{password:s.value,authorization:u,identity:r.visitorId});l.value=t.map(e=>e.type==1?{...e,message:e.content}:{...e,reply:e.content,form_avatar:g.value.image}),b()}catch(t){return t=="访问密码错误!"&&(F(),await C()),Promise.reject()}};let x=null;const j=async t=>{await r.getFingerprint(),await C();const e=Date.now();l.value.push({type:1,message:t,reasoning:""}),l.value.push({type:2,reply:"",reasoning:"",loading:!0,key:e,form_avatar:g.value.image});const o=l.value.find(n=>n.key===e);v.value=!0,b();try{await Tt({question:t,unique_id:R.value,stream:!0},{password:s.value,authorization:u,identity:r.visitorId},{onstart:n=>{x=n,W.value=!0},onmessage:n=>{n.trim().split("data:").forEach(y=>{if(y)try{const{object:d,content:i,task_id:w,usage:A}=JSON.parse(y);d==="loading"?o.reply+=i:d==="finished"&&(o.loading=!1,o.consume_tokens=A),b()}catch(d){console.error("解析流式消息失败:",d,"原始文本:",y)}})},onclose:()=>{o.loading=!1,v.value=!1,W.value=!1,b()}})}catch{o.loading=!1,v.value=!1,o.reply="请求失败，请重试"}},b=()=>{setTimeout(()=>{O.value.scrollToBottom()},100)},E=()=>{Wt().$confirm({title:"提示",message:"确定要清空聊天记录吗？",onConfirm:async()=>{if(v.value&&I(),l.value.length==0){ut.msgError("没有聊天记录");return}try{await Ht({},{password:s.value,authorization:u,identity:r.visitorId}),await U()}catch(t){ut.msgError(t)}}})},I=()=>{if(x==null||x.cancel(),v.value){const t=l.value[l.value.length-1];t.loading=!1,v.value=!1,W.value=!1}},N=$({}),g=$({}),D=$([]),p=$(!1);$();const s=$(""),C=()=>{const t=tt(nt,{});if(s.value=t.value[u]||"",N.value.pwd&&!s.value)return p.value=!0,Promise.reject()},P=async t=>{const e=tt(nt,{});s.value=t.password,e.value=Object.assign(e.value,{[u]:t.password}),p.value=!1,await U()},F=()=>{const t=tt(nt,{});t.value=Object.assign(t.value,{[u]:""})},R=tt("SHARE_CHAT_UNIQUE_ID",""),H=async()=>{if(R.value)return;const t=await Ut({robot_id:N.value.robot.id},{password:s.value,authorization:u,identity:r.visitorId});R.value=t[0]},M=async()=>{const t=await Ot({apikey:u});N.value=t,g.value=t.robot,D.value=t.menus,C(),H()},at=async()=>{await M(),await U()};return pt(async()=>{await r.getFingerprint(),at()}),(t,e)=>{const o=Nt,n=Pt,y=Ft,d=te;return Y(),K(ct,null,[T("div",ee,[X(d,{class:"h-full",content:k(a).getWebsiteConfig.shop_name,"z-index":-1,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:G(()=>[T("div",ae,[X(y,{ref_key:"chattingRef",ref:O,"is-stop":k(W),"content-list":k(l),"send-disabled":k(v),"is-disabled-humanize":!0,"is-new-chat":!1,"is-auth-login":!1,onClose:I,onContentPost:j},Mt({content:G(()=>{var i,w,A;return[T("div",oe,[T("img",{src:(i=k(g))==null?void 0:i.image,class:"w-[112px] h-[112px] rounded-full"},null,8,ne),T("div",se,et((w=k(g))==null?void 0:w.name),1),T("div",re,et((A=k(g))==null?void 0:A.welcome_introducer),1)])]}),"chat-area-top":G(()=>[T("div",le,[X(o,{round:"",icon:k($t),onClick:E,class:"mb-3"},{default:G(()=>[...e[2]||(e[2]=[Et("清空",-1)])]),_:1},8,["icon"]),k(D).length>0?(Y(),K("div",ie,[X(n,null,{default:G(()=>[T("div",ce,[(Y(!0),K(ct,null,Rt(k(D),(i,w)=>(Y(),K("div",{class:"whitespace-nowrap rounded-[24px] py-2 px-4 bg-white border border-[#F1F1F2] text-xs cursor-pointer hover:bg-[#F1F1F2]",key:w,onClick:A=>j(i)},et(i),9,ue))),128))])]),_:1})])):zt("",!0)])]),_:2},[k(g).copyright?{name:"chat-area-bottom",fn:G(()=>[T("div",fe,et(k(g).copyright),1)]),key:"0"}:void 0]),1032,["is-stop","content-list","send-disabled"])])]),_:1},8,["content"])]),X(jt,{show:k(p),"onUpdate:show":e[0]||(e[0]=i=>Bt(p)?p.value=i:null),ref:"pwdCheckRef",onClose:e[1]||(e[1]=i=>p.value=!1),onConfirm:P},null,8,["show"])],64)}}});export{je as default};
