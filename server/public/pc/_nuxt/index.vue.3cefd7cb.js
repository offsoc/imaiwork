import{E as se}from"./el-alert.7a5c1271.js";import{d as ae,r as u,aF as H,bC as F,A as ne,G as h,aH as ie,bA as oe,k as y,l as N,m as d,q as k,Z as f,s as U,L as D,bM as ce,I as j,J as re,y as ue,ax as de}from"./entry.f4f46cb5.js";import{_ as fe}from"./index.2589bc04.js";import{E as ve}from"./el-image-viewer.c352c3bd.js";import{_ as me}from"./index.vue.b711ba9e.js";import{z as Ce}from"./person_wechat.703f63bb.js";import he from"./circle-lists.2e553d9e.js";import we from"./circle-send.a8d42238.js";import{_ as _e}from"./sidebar-panel.vue.139498c6.js";import ke from"./useWeChatWs.5d851e78.js";import Ie from"./useHandle.560e2f4a.js";import{MsgTypeEnum as s,HandleEventEnum as v,MsgErrorCodeEnum as ge}from"./index.cf59f1a8.js";const Te={class:"w-full h-full"},pe={class:"h-full flex gap-x-4"},xe={class:"w-[94px] flex-shrink-0"},ye={class:"flex-1 flex flex-col"},be={class:"flex justify-between gap-x-4 h-[48px] items-center bg-[#EDEDED] px-4 flex-shrink-0"},De={class:"grow min-h-0 bg-white relative"},Ee={key:0,class:"absolute w-full h-full z-[888] bg-white flex justify-center items-center"},Re={key:1,class:"absolute w-full h-full flex items-center justify-center z-[999] bg-black/5"},Le={class:"flex flex-col items-center"},Ne={key:2,class:"absolute bottom-0 h-[50px] bg-white z-30 w-full flex justify-center items-center"},Pe={class:"w-[462px] rounded-xl overflow-hidden"},Ge=ae({__name:"index",setup(Se){const z=u(null),G=u(null),T=u(null),b=H({content:"",task_type:0,attachment_type:-1,attachment_content:null,comment:"",send_time:F().add(30,"minute").format("YYYY-MM-DD HH:mm:ss"),wechat_ids:[]}),o=u([]),E=H({RefSnsId:0,Count:10}),I=u(!1),R=u(!1),p=u(!1),m=u(null),P=u(!1),A=u([]),M=u(0),S=u(!1),W=ne(null),$=u(!1),{wechatLists:C,currentWechat:c,actionType:x,onHandleEvent:O}=Ie(),{on:V,send:q}=ke();V("open",()=>{le()});const J=a=>{const e=F(a*1e3),t=F(),n=t.diff(e,"second"),l=t.diff(e,"minute"),i=t.diff(e,"hour");return e.isSame(t,"day")?n<60?`${n}秒前`:l<60?`${l}分钟前`:`${i}小时前`:e.format("YYYY/MM/DD")},w=(a,e)=>{var n,l,i;let t={DeviceId:(e==null?void 0:e.deviceId)||((n=c.value)==null?void 0:n.device_code),AccessToken:(e==null?void 0:e.accessToken)||((l=c.value)==null?void 0:l.accessToken),WeChatId:(e==null?void 0:e.wechatId)||((i=c.value)==null?void 0:i.wechat_id),TaskId:(e==null?void 0:e.taskId)||`${Date.now()}`};switch(a){case s.Auth:break;case s.PullFriendCircleTask:t={...t,RefSnsId:E.RefSnsId};break;case s.CircleCommentReplyTask:case s.PullCircleDetailTask:case s.CircleLikeTask:case s.DeleteSNSNewsTask:case s.CircleCommentDeleteTask:t={...t,...e};break}q({MsgType:a,Content:t})};function L(a){const{DeviceId:e,AccessToken:t,WeChatId:n}=a||{};w(s.PullFriendCircleTask,{accessToken:t,wechatId:n,deviceId:e})}function Z(a){var l;const{DeviceId:e,WeChatId:t,Status:n}=a;C.value.forEach(i=>{i.device_code===e&&i.wechat_id===t&&(i.wechat_status=n=="offline"?2:1)}),(l=c.value)!=null&&l.device_code&&n=="offline"&&h.msgError("设备离线，请重新登录")}function K(a){const{Circles:e}=a;e&&e.length?(o.value.length&&o.value[o.value.length-1].CircleId==e[0].CircleId&&e.shift(),o.value=o.value.concat(e.map(t=>({...t,publishTime:J(t.PublishTime)})))):R.value=!0,I.value=!1,p.value=!1}function Q(a){const{DeviceId:e,AccessToken:t,WeChatId:n}=a;I.value=!0,C.value.forEach(l=>{l.device_code===e&&l.wechat_id===n&&(l.accessToken=t,l.loading=!1)}),c.value.wechat_id==n&&L({DeviceId:e,AccessToken:t,WeChatId:n})}V("message",async a=>{h.closeLoading();const{MsgType:e,Content:t}=a,n={[s.Auth]:Q,[s.CirclePushNotice]:K,[s.WeChatOnlineNotice]:Z,[s.CircleNewPublishNotice]:async()=>{o.value.unshift(t.Circle)},[s.CircleDetailNotice]:async()=>{const{CircleId:l}=t;if(l.Content&&x.value==v.PreviewImage){const{Images:i}=l.Content;A.value=i.map(r=>r.Url),P.value=!0}if(l.Content&&x.value==v.PreviewVideo){const{Video:i}=l.Content;Y(i.Url)}if(l.Content&&x.value==v.PullCircleDetail){const{Comments:i}=l;o.value.forEach(r=>{r.CircleId==l.CircleId&&(r.Comments=i)})}x.value=null},[s.DeleteSNSNewsTask]:()=>{o.value=o.value.filter(l=>l.CircleId!=m.value),m.value=null},[s.CircleLikeTask]:()=>{o.value.forEach(l=>{var i,r;l.CircleId==m.value&&($.value?l.Likes=l.Likes.filter(_=>_.FriendId!=t.WeChatId):l.Likes.push({CircleId:"0",FriendId:(i=c.value)==null?void 0:i.wechat_id,NickName:(r=c.value)==null?void 0:r.wechat_nickname}))}),m.value=null},[s.CircleCommentReplyTaskResultNotice]:()=>{h.loading("获取详情中...",T.value),w(s.PullCircleDetailTask,{CircleId:m.value}),x.value=v.PullCircleDetail},[s.CircleCommentDeleteTaskResultNotice]:()=>{o.value.forEach(l=>{l.CircleId==m.value&&(l.Comments=l.Comments.filter(i=>i.CommentId!=t.CommentId))})},[s.CircleDelNotice]:()=>{o.value=o.value.filter(l=>l.CircleId!=m.value),m.value=null},[s.CircleCommentNotice]:()=>{o.value.forEach(l=>{l.CircleId==m.value&&l.Comments.push(t.Comment)})}};n[e]&&await n[e](t)}),V("error",async a=>{const{Code:e,MsgType:t,Message:n,Content:l}=a;if([s.CircleCommentReplyTaskResultNotice,s.CircleLikeTask,s.DeleteSNSNewsTask,s.PullFriendCircleTask].includes(t)?(I.value=!1,h.msgError(n)):e==ge.DeviceOffline&&C.value.forEach(i=>{i.device_code==l.DeviceId&&(i.wechat_status=0,i.loading=!1)}),t==s.CircleCommentReplyTaskResultNotice||t==s.CircleCommentReplyTask){const{CircleId:i}=l;o.value.forEach(r=>{r.CircleId==i&&(r.Comments=r.Comments.filter(_=>_.SendType!="web"))})}h.closeLoading()}),O("action",async a=>{const{data:e,type:t}=a||{},n=`${e==null?void 0:e.CircleId}`;switch(m.value=n,t){case v.PreviewImage:case v.PreviewVideo:x.value==v.PreviewImage&&(M.value=e.imageIdx),h.loading("获取详情中...",T.value),w(s.PullCircleDetailTask,{CircleId:n,GetBigMap:!0});break;case v.SendComment:const{reply:l}=e;h.loading("发送中...",T.value),o.value.forEach(r=>{var _,g;r.CircleId==n&&r.Comments.push({Content:e.msg,FromName:(_=c.value)==null?void 0:_.wechat_nickname,FromWeChatId:(g=c.value)==null?void 0:g.wechat_id,ToWeChatId:l==null?void 0:l.FromWeChatId,CommentId:`${new Date().getTime()}`,SendType:"web"})}),w(s.CircleCommentReplyTask,{CircleId:n,ToWeChatId:(l==null?void 0:l.FromWeChatId)||e.WeChatId,Content:e.msg,IsResend:!1,ReplyCommentId:l==null?void 0:l.CommentId});break;case v.Like:h.loading("点赞中..."),$.value=e.isLike,w(s.CircleLikeTask,{CircleId:n,IsCancel:e.isLike});break;case v.DeleteCircle:h.loading("删除中...",T.value),w(s.DeleteSNSNewsTask,{CircleId:n,WeChatId:e.WeChatId});break;case v.DeleteComment:const{deleteComment:i}=e;h.loading("删除中...",T.value),w(s.CircleCommentDeleteTask,{CircleId:n,CommentId:i.CommentId,PublishTime:i.PublishTime});break}});const X=a=>{var e;((e=c.value)==null?void 0:e.device_code)!==a.device_code&&(c.value=a,o.value=[],E.RefSnsId=0,R.value=!1,I.value=!0,p.value=!0,b.wechat_ids=[a.wechat_id],L())},B=()=>{o.value=[],E.RefSnsId=0,R.value=!1,I.value=!0,p.value=!0,L()},ee=()=>{R.value||p.value||(p.value=!0,E.RefSnsId=o.value[o.value.length-1].CircleId,L())},Y=async a=>{var e;S.value=!0,await ie(),(e=W.value)==null||e.open(),W.value.setUrl(a)},le=async()=>{const{lists:a}=await Ce({page_type:0});C.value=a,te()},te=async()=>{var a;C.value&&C.value.length>0&&(c.value=C.value.find(e=>e.wechat_status==1),c.value&&(b.wechat_ids=[(a=c.value)==null?void 0:a.wechat_id]),C.value.forEach(e=>{e.loading=!0,e.wechat_status==1?w(s.Auth,{deviceId:e.device_code}):e.loading=!1}))};return oe(()=>{C.value=[],c.value={}}),(a,e)=>{const t=se,n=ue,l=de,i=fe,r=ve,_=me;return y(),N(re,null,[d("div",Te,[d("div",pe,[d("div",{class:"flex-1 flex rounded-xl overflow-hidden",ref_key:"containerRef",ref:T},[d("div",xe,[k(_e,{ref_key:"sidebarPanelRef",ref:z,"current-wechat":f(c),showAddWeChat:!1,"wechat-list":f(C),"onUpdate:currentWechat":X},null,8,["current-wechat","wechat-list"])]),d("div",ye,[d("div",be,[k(t,{type:"warning",closable:!1},{default:U(()=>[...e[4]||(e[4]=[d("div",null,"朋友圈更新存在一定延迟，如有数据不同步，请多刷新",-1)])]),_:1}),k(l,{link:"",class:"!p-2",color:"#878787",loading:f(I),onClick:B},{default:U(()=>[k(n,{name:"el-icon-Refresh"}),e[5]||(e[5]=d("span",{class:"ml-2"},"刷新",-1))]),_:1},8,["loading"])]),d("div",De,[f(I)?(y(),N("div",Ee,[k(i)])):D("",!0),f(c)&&f(c).wechat_status==2?(y(),N("div",Re,[d("div",Le,[k(n,{name:"local-icon-wifi_off",size:50,color:"#ffffff"}),e[6]||(e[6]=d("span",{class:"text-white text-2xl mt-2"},"设备离线",-1))])])):D("",!0),k(he,{ref_key:"circleListsRef",ref:G,"circle-list":f(o),onBottom:ee,onPreviewVideo:Y},null,8,["circle-list"]),f(p)?(y(),N("div",Ne,[...e[7]||(e[7]=[d("div",{class:"chat-loader"},null,-1)])])):D("",!0)])])],512),d("div",Pe,[k(we,{modelValue:f(b),"onUpdate:modelValue":e[0]||(e[0]=g=>ce(b)?b.value=g:null),"is-show-we-chat":!1,onSuccess:e[1]||(e[1]=g=>B())},null,8,["modelValue"])])])]),f(P)?(y(),j(r,{key:0,"url-list":f(A),"initial-index":f(M),onClose:e[2]||(e[2]=g=>P.value=!1)},null,8,["url-list","initial-index"])):D("",!0),f(S)?(y(),j(_,{key:1,ref_key:"previewVideoRef",ref:W,onClose:e[3]||(e[3]=g=>S.value=!1)},null,512)):D("",!0)],64)}}});export{Ge as _};
