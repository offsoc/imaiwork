import{r as v,em as o,G as m,ea as E}from"./entry.f4f46cb5.js";import{n as x,o as z}from"./service.9c966dd0.js";import{i as G}from"./device.b7e58507.js";const Q=e=>{const{send:N,onEvent:S}=e,g=v(!1),f=v(!1),A=v(null),l=v(0),r=v(null),h=v([]),u=v(null),w=(c,a)=>{N({type:o.GET_USER_INFO,content:{deviceId:c},deviceId:c,appType:a})};S("success",async c=>{var i,k,O,P,C,M,T,b;const{type:a,content:n,deviceId:_,appType:y}=c,D=n.msg||"";switch(a){case o.ADD_DEVICE:A.value={status:1,device_code:n.deviceId,device_model:n.deviceModel,sdk_version:n.sdkVersion};try{m.loading("添加中..."),await G(A.value),m.msgSuccess("添加设备成功"),(i=e.onSuccess)==null||i.call(e,{msg:"添加成功",type:a,data:c})}catch(d){(k=e.onError)==null||k.call(e,{error:d,type:a,code:E.API_ERROR})}finally{f.value=!1,g.value=!1,m.closeLoading()}break;case o.GET_USER_INFO:try{const{account:d,account_no:L,extra:J,avatar:j,nickname:q}=n,t={account:d,account_no:L,avatar:j,device_code:_,type:y,nickname:q,extra:JSON.stringify(J)};if(u.value=="addAccount"){A.value&&await G(A.value);try{await x(t),g.value=!1,u.value=null,l.value=100,m.msgSuccess("添加账号成功"),(O=e.onSuccess)==null||O.call(e,{msg:"添加账号成功",type:a,data:c})}catch(I){(P=e.onError)==null||P.call(e,{error:I,type:a,code:E.API_ERROR})}}if(u.value=="updateAccount"){const I=h.value.filter(s=>s.type==t.type).find(s=>s.account==t.account);try{I?await z({id:I.id,...t}):await x(t),u.value=null,l.value=100,m.msgSuccess("更新成功"),(C=e.onSuccess)==null||C.call(e,{msg:"更新成功",type:a,data:c})}catch(s){(M=e.onError)==null||M.call(e,{error:s,type:a,code:E.API_ERROR})}}}catch(d){(T=e.onError)==null||T.call(e,{error:d,type:a,code:E.API_ERROR})}h.value=null,f.value=!1,clearInterval(r.value);break;default:(b=e.onSuccess)==null||b.call(e,{msg:D,type:a,data:c});break}}),S("error",c=>{var a;f.value=!1,(a=e.onError)==null||a.call(e,c),r.value&&clearInterval(r.value)});const U=()=>{},V=(c,a)=>{u.value="updateAccount",R(),w(c,a)},F=c=>{u.value="addAccount",R(),w(c.device_code,c.type)},R=()=>{r.value&&(clearInterval(r.value),r.value=null);const c=Date.now(),a=15*1e3,n=300,_=2;l.value=0,r.value=setInterval(()=>{const y=Date.now()-c,D=Math.min(_,Math.random()*(99-l.value)*.1);l.value=Math.floor(Math.min(99,l.value+D)),(l.value>=99||y>=a)&&(r.value&&(clearInterval(r.value),r.value=null),l.value=99)},n)};return{showAddDevice:g,addDeviceLoading:f,progressValue:l,eventAction:u,refreshAccount:h,handleAddDeviceConfirm:U,handleAddAccount:F,handleRefreshAccount:V,completeProgress:R}};export{Q as u};
