import{E as le}from"./el-alert.ec09dd2d.js";import{d as te,r as u,aF as H,bz as V,A as se,G as C,aH as ne,bx as ie,k as y,l as N,m as d,q as w,Z as f,s as U,L as D,bK as ae,I as z,J as oe,y as ce,ax as re}from"./entry.46557796.js";import{_ as ue}from"./index.b85a23a9.js";import{E as de}from"./el-image-viewer.4c392e93.js";import{_ as fe}from"./index.vue.7b7084b3.js";import{z as ve}from"./person_wechat.8bcf26fc.js";import me from"./circle-lists.cbc2f0fc.js";import Ce from"./circle-send.e7e35993.js";import{_ as he}from"./sidebar-panel.vue.0316bc71.js";import _e from"./useWeChatWs.da425a49.js";import we from"./useHandle.beb30b0b.js";import{MsgTypeEnum as s,HandleEventEnum as v,MsgErrorCodeEnum as ke}from"./index.cf59f1a8.js";const Ie={class:"w-full h-full"},ge={class:"h-full flex gap-x-4"},Te={class:"w-[94px] flex-shrink-0"},pe={class:"flex-1 flex flex-col"},xe={class:"flex justify-between gap-x-4 h-[48px] items-center bg-[#EDEDED] px-4 flex-shrink-0"},ye={class:"grow min-h-0 bg-white relative"},be={key:0,class:"absolute w-full h-full z-[888] bg-white flex justify-center items-center"},De={key:1,class:"absolute w-full h-full flex items-center justify-center z-[999] bg-black/5"},Ee={class:"flex flex-col items-center"},Re={key:2,class:"absolute bottom-0 h-[50px] bg-white z-30 w-full flex justify-center items-center"},Le={class:"w-[462px] rounded-xl overflow-hidden"},je=te({__name:"index",setup(Ne){const j=u(null),G=u(null),g=u(null),b=H({content:"",task_type:0,attachment_type:-1,attachment_content:null,comment:"",send_time:V().add(30,"minute").format("YYYY-MM-DD HH:mm:ss"),wechat_ids:[]}),o=u([]),E=H({RefSnsId:0,Count:10}),k=u(!1),R=u(!1),T=u(!1),m=u(null),P=u(!1),F=u([]),M=u(0),S=u(!1),W=se(null),$=u(!1),{wechatLists:p,currentWechat:c,actionType:x,onHandleEvent:O}=we(),{on:A,send:q}=_e(),J=n=>{const e=V(n*1e3),t=V(),i=t.diff(e,"second"),l=t.diff(e,"minute"),a=t.diff(e,"hour");return e.isSame(t,"day")?i<60?`${i}秒前`:l<60?`${l}分钟前`:`${a}小时前`:e.format("YYYY/MM/DD")},h=(n,e)=>{var i,l,a;let t={DeviceId:(e==null?void 0:e.deviceId)||((i=c.value)==null?void 0:i.device_code),AccessToken:(e==null?void 0:e.accessToken)||((l=c.value)==null?void 0:l.accessToken),WeChatId:(e==null?void 0:e.wechatId)||((a=c.value)==null?void 0:a.wechat_id),TaskId:(e==null?void 0:e.taskId)||`${Date.now()}`};switch(n){case s.Auth:break;case s.PullFriendCircleTask:t={...t,RefSnsId:E.RefSnsId};break;case s.CircleCommentReplyTask:case s.PullCircleDetailTask:case s.CircleLikeTask:case s.DeleteSNSNewsTask:case s.CircleCommentDeleteTask:t={...t,...e};break}q({MsgType:n,Content:t})};function L(n){const{DeviceId:e,AccessToken:t,WeChatId:i}=n||{};h(s.PullFriendCircleTask,{accessToken:t,wechatId:i,deviceId:e})}function K(n){var l;const{DeviceId:e,WeChatId:t,Status:i}=n;p.value.forEach(a=>{a.device_code===e&&a.wechat_id===t&&(a.wechat_status=i=="offline"?2:1)}),(l=c.value)!=null&&l.device_code&&i=="offline"&&C.msgError("设备离线，请重新登录")}function Z(n){const{Circles:e}=n;e&&e.length?(o.value.length&&o.value[o.value.length-1].CircleId==e[0].CircleId&&e.shift(),o.value=o.value.concat(e.map(t=>({...t,publishTime:J(t.PublishTime)})))):R.value=!0,k.value=!1,T.value=!1}function Q(n){const{DeviceId:e,AccessToken:t,WeChatId:i}=n;k.value=!0,p.value.forEach(l=>{l.device_code===e&&l.wechat_id===i&&(l.accessToken=t,l.loading=!1,c.value=l)}),c.value.wechat_id==i&&L({DeviceId:e,AccessToken:t,WeChatId:i})}A("message",async n=>{C.closeLoading();const{MsgType:e,Content:t}=n,i={[s.Auth]:Q,[s.CirclePushNotice]:Z,[s.WeChatOnlineNotice]:K,[s.CircleNewPublishNotice]:async()=>{o.value.unshift(t.Circle)},[s.CircleDetailNotice]:async()=>{const{CircleId:l}=t;if(l.Content&&x.value==v.PreviewImage){const{Images:a}=l.Content;F.value=a.map(r=>r.Url),P.value=!0}if(l.Content&&x.value==v.PreviewVideo){const{Video:a}=l.Content;Y(a.Url)}if(l.Content&&x.value==v.PullCircleDetail){const{Comments:a}=l;o.value.forEach(r=>{r.CircleId==l.CircleId&&(r.Comments=a)})}x.value=null},[s.DeleteSNSNewsTask]:()=>{o.value=o.value.filter(l=>l.CircleId!=m.value),m.value=null},[s.CircleLikeTask]:()=>{o.value.forEach(l=>{var a,r;l.CircleId==m.value&&($.value?l.Likes=l.Likes.filter(_=>_.FriendId!=t.WeChatId):l.Likes.push({CircleId:"0",FriendId:(a=c.value)==null?void 0:a.wechat_id,NickName:(r=c.value)==null?void 0:r.wechat_nickname}))}),m.value=null},[s.CircleCommentReplyTaskResultNotice]:()=>{C.loading("获取详情中...",g.value),h(s.PullCircleDetailTask,{CircleId:m.value}),x.value=v.PullCircleDetail},[s.CircleCommentDeleteTaskResultNotice]:()=>{o.value.forEach(l=>{l.CircleId==m.value&&(l.Comments=l.Comments.filter(a=>a.CommentId!=t.CommentId))})},[s.CircleDelNotice]:()=>{o.value=o.value.filter(l=>l.CircleId!=m.value),m.value=null},[s.CircleCommentNotice]:()=>{o.value.forEach(l=>{l.CircleId==m.value&&l.Comments.push(t.Comment)})}};i[e]&&await i[e](t)}),A("error",async n=>{const{Code:e,MsgType:t,Message:i,Content:l}=n;if([s.CircleCommentReplyTaskResultNotice,s.CircleLikeTask,s.DeleteSNSNewsTask,s.PullFriendCircleTask].includes(t)?(k.value=!1,C.msgError(i)):e==ke.DeviceOffline&&p.value.forEach(a=>{a.device_code==l.DeviceId&&(a.wechat_status=0,a.loading=!1)}),t==s.CircleCommentReplyTaskResultNotice||t==s.CircleCommentReplyTask){const{CircleId:a}=l;o.value.forEach(r=>{r.CircleId==a&&(r.Comments=r.Comments.filter(_=>_.SendType!="web"))})}C.closeLoading()}),O("action",async n=>{const{data:e,type:t}=n||{},i=`${e==null?void 0:e.CircleId}`;switch(m.value=i,t){case v.PreviewImage:case v.PreviewVideo:x.value==v.PreviewImage&&(M.value=e.imageIdx),C.loading("获取详情中...",g.value),h(s.PullCircleDetailTask,{CircleId:i,GetBigMap:!0});break;case v.SendComment:const{reply:l}=e;C.loading("发送中...",g.value),o.value.forEach(r=>{var _,I;r.CircleId==i&&r.Comments.push({Content:e.msg,FromName:(_=c.value)==null?void 0:_.wechat_nickname,FromWeChatId:(I=c.value)==null?void 0:I.wechat_id,ToWeChatId:l==null?void 0:l.FromWeChatId,CommentId:`${new Date().getTime()}`,SendType:"web"})}),h(s.CircleCommentReplyTask,{CircleId:i,ToWeChatId:(l==null?void 0:l.FromWeChatId)||e.WeChatId,Content:e.msg,IsResend:!1,ReplyCommentId:l==null?void 0:l.CommentId});break;case v.Like:C.loading("点赞中..."),$.value=e.isLike,h(s.CircleLikeTask,{CircleId:i,IsCancel:e.isLike});break;case v.DeleteCircle:C.loading("删除中...",g.value),h(s.DeleteSNSNewsTask,{CircleId:i,WeChatId:e.WeChatId});break;case v.DeleteComment:const{deleteComment:a}=e;C.loading("删除中...",g.value),h(s.CircleCommentDeleteTask,{CircleId:i,CommentId:a.CommentId,PublishTime:a.PublishTime});break}});const X=n=>{var e;((e=c.value)==null?void 0:e.device_code)!==n.device_code&&(c.value=n,o.value=[],E.RefSnsId=0,R.value=!1,k.value=!0,T.value=!0,b.wechat_ids=[n.wechat_id],L())},B=()=>{o.value=[],E.RefSnsId=0,R.value=!1,k.value=!0,T.value=!0,L()},ee=()=>{R.value||T.value||(T.value=!0,E.RefSnsId=o.value[o.value.length-1].CircleId,L())},Y=async n=>{var e;S.value=!0,await ne(),(e=W.value)==null||e.open(),W.value.setUrl(n)};return(async()=>{var e;const{lists:n}=await ve({page_type:0});p.value=n,n&&n.length>0&&(c.value=n.find(t=>t.wechat_status==1),c.value&&(b.wechat_ids=[(e=c.value)==null?void 0:e.wechat_id]),n.forEach((t,i)=>{t.loading=!0,t.wechat_status==1?h(s.Auth,{deviceId:t.device_code}):t.loading=!1}))})(),ie(()=>{p.value=[],c.value={}}),(n,e)=>{const t=le,i=ce,l=re,a=ue,r=de,_=fe;return y(),N(oe,null,[d("div",Ie,[d("div",ge,[d("div",{class:"flex-1 flex rounded-xl overflow-hidden",ref_key:"containerRef",ref:g},[d("div",Te,[w(he,{ref_key:"sidebarPanelRef",ref:j,"current-wechat":f(c),showAddWeChat:!1,"wechat-list":f(p),"onUpdate:currentWechat":X},null,8,["current-wechat","wechat-list"])]),d("div",pe,[d("div",xe,[w(t,{type:"warning",closable:!1},{default:U(()=>e[4]||(e[4]=[d("div",null,"朋友圈更新存在一定延迟，如有数据不同步，请多刷新",-1)])),_:1,__:[4]}),w(l,{link:"",class:"!p-2",color:"#878787",loading:f(k),onClick:B},{default:U(()=>[w(i,{name:"el-icon-Refresh"}),e[5]||(e[5]=d("span",{class:"ml-2"},"刷新",-1))]),_:1,__:[5]},8,["loading"])]),d("div",ye,[f(k)?(y(),N("div",be,[w(a)])):D("",!0),f(c)&&f(c).wechat_status==2?(y(),N("div",De,[d("div",Ee,[w(i,{name:"local-icon-wifi_off",size:50,color:"#ffffff"}),e[6]||(e[6]=d("span",{class:"text-white text-2xl mt-2"},"设备离线",-1))])])):D("",!0),w(me,{ref_key:"circleListsRef",ref:G,"circle-list":f(o),onBottom:ee,onPreviewVideo:Y},null,8,["circle-list"]),f(T)?(y(),N("div",Re,e[7]||(e[7]=[d("div",{class:"chat-loader"},null,-1)]))):D("",!0)])])],512),d("div",Le,[w(Ce,{modelValue:f(b),"onUpdate:modelValue":e[0]||(e[0]=I=>ae(b)?b.value=I:null),"is-show-we-chat":!1,onSuccess:e[1]||(e[1]=I=>B())},null,8,["modelValue"])])])]),f(P)?(y(),z(r,{key:0,"url-list":f(F),"initial-index":f(M),onClose:e[2]||(e[2]=I=>P.value=!1)},null,8,["url-list","initial-index"])):D("",!0),f(S)?(y(),z(_,{key:1,ref_key:"previewVideoRef",ref:W,onClose:e[3]||(e[3]=I=>S.value=!1)},null,512)):D("",!0)],64)}}});export{je as _};
