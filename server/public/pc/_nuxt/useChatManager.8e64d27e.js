import{bP as B,z as H,at as O,bQ as b,A as F,aH as j,bR as q,G as h,bS as D,bO as z}from"./entry.ee599c70.js";import{useChatStore as G}from"./chat.9f80db84.js";function X(){const A=B(),e=G(),S=H(),E=O(),{taskId:i,agentValue:p,chatContentList:l,isReceiving:m,isStopChat:N,isDeep:y,isNetwork:M,fileLists:c,extraParams:P}=b(e),{userTokens:U,userInfo:C}=b(S),{chatConfig:L}=E,v=F(null),w=F(null),n=()=>{j(()=>{var a;return(a=v.value)==null?void 0:a.scrollToBottom()})},R=()=>{z({task_id:void 0,agent_name:void 0,agent_id:void 0})},x=a=>{a.trim().split("data:").forEach(t=>{var s,_;if(t)try{const{object:o,content:r,task_id:u,usage:g,reasoning_content:f}=JSON.parse(t),I=l.value[l.value.length-1];if(o==="loading"){const d={};f?(d.is_reasoning_finished=!1,d.reasoning_content=(I.reasoning_content||"")+f):r&&(d.is_reasoning_finished=!0,d.reply=(I.reply||"")+r),e.updateLastMessage(d)}else o==="finished"&&(e.updateLastMessage({consume_tokens:g}),e.setTaskId(u),z({task_id:u,agent_name:(s=p.value)==null?void 0:s.name,agent_id:(_=p.value)==null?void 0:_.id}));n()}catch(o){console.error("解析流式消息失败:",o,"原始文本:",t)}})},T=async()=>{if(!(!i.value||i.value==="undefined")){e.isLoading=!0;try{const a=await q({page_no:1,page_size:9999,task_id:i.value,assistant_id:0}),t=(a==null?void 0:a.map(s=>s.type===1?{...s,form_avatar:C.value.avatar,fileList:s!=null&&s.file_info?Array.isArray(s.file_info)?s.file_info:[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:e.detail.logo,consume_tokens:s.tokens_info}))??[];e.chatContentList=t,n()}catch{h.msgError("获取聊天记录失败")}finally{e.isLoading=!1}}},k=async(a,t=!1,s)=>{var o,r,u;if(U.value<=1)return h.msgPowerInsufficient();if(m.value||!a.trim()&&c.value.length===0)return;t||e.addMessage({type:1,message:a,form_avatar:C.value.avatar,fileList:c.value});const _={type:2,loading:!0,form_avatar:e.detail.logo,is_reasoning_finished:y.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};e.addMessage(_),e.startReceiving(),n();try{await D({message:a,task_id:i.value,robot_id:(o=p.value)==null?void 0:o.id,open_reasoning:y.value?1:0,is_network_search:M.value?1:0,file_info:c.value.length?c.value[0]:void 0,...((u=(r=v.value)==null?void 0:r.getChatConfig)==null?void 0:u.call(r))||{},...P.value},{onstart:g=>{w.value=g},onmessage:x,onclose:()=>{e.updateLastMessage({loading:!1}),e.stopReceiving(),e.clearFiles(),S.getUser(),n(),s==null||s()}})}catch(g){const f=g||"消息发送失败";e.updateLastMessage({error:f,loading:!1}),h.msgError(f),e.stopReceiving()}finally{n()}};return{chattingRef:v,isDeep:y,isNetwork:M,fileLists:c,taskId:i,chatContentList:l,isReceiving:m,isStopChat:N,initialize:async()=>{e.clearChat();const{content:a,task_id:t}=A.query;a?(await k(a),R()):t&&t!=="undefined"&&(e.setTaskId(t),await T()),n()},sendMessage:k,startNewChat:()=>{var a,t,s;if(!i.value)return h.msgError("当前已是新会话");e.clearChat(),R(),(t=(a=v.value)==null?void 0:a.cleanInput)==null||t.call(a),(s=L.value)!=null&&s.new_chat_prompt&&k(L.value.new_chat_prompt,!0)},stopStream:()=>{var a;if((a=w.value)==null||a.cancel(),m.value){const t=l.value[l.value.length-1];e.updateLastMessage({loading:!1,reply:t.reply||"用户已停止内容生成"}),e.stopReceiving()}},chatScrollToBottom:n,fetchChatHistory:T,setFiles:e.setFiles,clearFiles:e.clearFiles}}export{X as useChatManager};
