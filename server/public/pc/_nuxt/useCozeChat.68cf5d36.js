import{u as P}from"./usePolling.a210b06f.js";import{b as G,d as L,e as M,f as U}from"./agent.a3fcedc5.js";import{z as j,aG as D,r as v,A as F,c as J,aF as N,G as h}from"./entry.2beb4577.js";function B(m,g){const p=j(),{userInfo:k}=D(p),f=v([]),l=v(!1),r=v(!1),y=F(null),s=v(""),_=J(()=>{var e;return((e=m.value)==null?void 0:e.stream)==1}),A=async(e,w,z)=>{var S;f.value.push({type:1,message:e,form_avatar:k.value.avatar});const t=N({type:2,loading:!0,form_avatar:(S=m.value)==null?void 0:S.avatar,reply:"",consume_tokens:{}});f.value.push(t),l.value=!0;const E={id:g,content:e,conversation_id:s.value},I=!s.value;if(_.value)try{await G(E,{onstart:a=>{y.value=a,r.value=!0},onmessage:a=>{a.trim().split("data:").forEach(c=>{if(c)try{const{object:n,content:u,usage:i,conversation_id:o}=JSON.parse(c);u&&n==="loading"&&(t.reply+=u),n==="finished"&&(t.loading=!1,t.consume_tokens={total_tokens:i.token_count},o&&s.value!==o&&(s.value=o,w(o)))}catch{}})},onclose:()=>{t.loading=!1,p.getUser(),l.value=!1,r.value=!1,I&&z({id:s.value,title:e,conversation_id:s.value,content:e})}})}catch(a){t.loading=!1,t.reply=a||"发生错误",h.msgError(a||"发生错误"),l.value=!1,r.value=!1}else try{r.value=!0;const{conversation_id:a,id:c}=await L(E);a&&s.value!==a&&(s.value=a,w(a));const n={id:g,conversation_id:s.value},{start:u,end:i}=P(async()=>{try{const{status:o,id:R}=await M({chat_id:c,...n});if(o==="completed"){i();const d=await U({chat_id:R,...n});d&&d.length&&d.forEach(b=>t.reply+=b.content),t.loading=!1,C(),I&&z({id:s.value,title:e,conversation_id:s.value,content:e})}else if(o==="failed")throw i(),new Error("聊天失败")}catch{throw i(),t.loading=!1,t.reply="聊天失败，请稍后重试",new Error("聊天失败")}},{});u()}catch(a){t.loading=!1,t.reply=a||"发生错误",h.msgError(a||"发生错误"),C()}},C=()=>{l.value=!1,r.value=!1};return{chatContentList:f,isReceiving:l,isStopChat:r,sendMessage:A,stopChat:()=>{var e;_.value?((e=y.value)==null||e.cancel(),l.value=!1,r.value=!1):h.msgWarning("直接返回类型，聊天不可取消~")},setConversationId:e=>{s.value=e}}}export{B as useCozeChat};
