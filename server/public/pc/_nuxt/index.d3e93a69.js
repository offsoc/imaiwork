import{d as _e,aF as fe,r as p,c as P,A as Y,o as ve,b as he,k as i,l as m,m as a,q as f,s as _,J as w,K as C,I as v,Z as s,aI as we,a3 as ge,t as S,v as ye,Y as xe,L as G,G as h,aH as A,y as Ee,ax as be,cQ as ke,u as Ce,eg as Se,_ as Le}from"./entry.d9d53b29.js";import{E as Fe}from"./index.890e9d1e.js";import{E as Ae}from"./el-avatar.24f27c8b.js";import{E as De}from"./index.050c9b6b.js";import{E as Re}from"./el-empty.03c7f5cd.js";/* empty css                   *//* empty css                     */import{ar as Be,as as J,at as Ie,au as $e,z as Ue}from"./person_wechat.8bcf26fc.js";import{BoardHandleTypeEnum as g}from"./index.a1206616.js";import{_ as Ve}from"./add-friend.vue.a7978f13.js";import Ne from"./user-detail-panel.7a77c50a.js";import{_ as Te}from"./board-handle.vue.8a45c463.js";import ze from"./useTask.9d1d5451.js";import{E as K,a as Q}from"./index.79f7263c.js";import"./index.9a037d22.js";import"./_baseIteratee.73cb21ab.js";import"./debounce.39f38609.js";import"./index.4538c991.js";import"./index.vue.930f6062.js";/* empty css                        *//* empty css               */import"./usePaging.64764a63.js";import"./sidebar-panel.vue.1471e6a4.js";import"./index.8a3302e5.js";import"./el-tabs.4663b04e.js";import"./strings.fbd015b4.js";import"./index.85329892.js";import"./index.b40f47a5.js";/* empty css                  */import"./index.cf59f1a8.js";import"./user-flow.vue.64f3a782.js";import"./7_day.257301c1.js";import"./flow_title_img.b33c9278.js";import"./user-todo.35abf04b.js";import"./user-sop.d5b30d55.js";import"./el-image.239907bf.js";import"./el-image-viewer.291603f7.js";import"./throttle.cbb177ea.js";import"./position.0f08d59c.js";import"./index.vue.1675bfa5.js";import"./index.vue.9f493129.js";import"./date.95a59cef.js";import"./vue-virtual-scroller.esm.4d447b5a.js";/* empty css                             */import"./mini-program-card.vue.f970ef8c.js";import"./link-card.vue.a9ecbef6.js";import"./file-card.vue.dc0b899b.js";import"./useHandle.eb1dbbb2.js";import"./useTodo.d1e920f0.js";import"./friends-bind-tag.vue.5bff87cc.js";/* empty css                  */import"./user-todo-edit.vue.8080b8ec.js";import"./el-date-picker.24271fb2.js";import"./customParseFormat.b95a1bc9.js";import"./panel-time-pick.495d72ea.js";import"./index.3c330aca.js";const He={class:"h-full flex flex-col"},Pe={class:"bg-white p-4 rounded-xl"},Ge={class:"flex items-center gap-2"},Me={class:"grow min-h-0 bg-white rounded-xl mt-4 px-6"},Oe={class:"flex gap-5 py-6 h-full whitespace-nowrap"},We={class:"h-[4px] bg-[#E0E0E0]"},je={class:"h-[72px] flex items-center justify-between border-b border-primary-light-8 px-4"},qe={class:"flex items-center gap-2"},Ye={class:"text-[#5E656E] text-lg"},Je={class:"py-2"},Ke={class:"flex flex-col"},Qe=["onClick"],Ze=["onClick"],Xe={class:"min-h-0 grow"},et=["data-index"],tt=["onClick"],st={class:"flex-shrink-0"},at=["src"],ot={class:"font-medium mb-1"},lt={class:"text-[#9E9E9E] text-xs whitespace-normal"},rt={class:"text-[#9E9E9E] text-xs whitespace-normal"},it={key:1,class:"flex items-center justify-center h-full"},nt=_e({__name:"index",setup(dt){const o=fe({wechat_id:"",flow_id:""}),D=p(!1),d=p([]),R=p([]),{flowLists:y,getFlowLists:Z}=ze(),X=p({}),ee=[{label:"清除此阶段内的所有客户",value:g.CLEAR},{label:"将此阶段内的客户转移到别的阶段",value:g.TRANSFER},{label:"将此阶段内的客户转移到别的周期阶段中",value:g.TRANSFER_TO_CYCLE},{label:"给此阶段内的客户群发消息（内测中）",value:g.SEND_MESSAGE,disabled:!0}],te=Ce(),B=P(()=>d.value[x.value].members),se=P(()=>{var t;return(t=y.value.find(e=>e.id==o.flow_id))==null?void 0:t.key_stages}),M=P(()=>d.value[x.value].stage_id),I=p(!1),O=p(),ae=async(t,e)=>{var c;if(x.value=e,t===g.CLEAR){if(B.value.length==0){h.msgWarning("此阶段内没有数据");return}te.$confirm({title:"是否确认清除此阶段内的所有客户？",message:"删除选择的此阶段的客户后，这些删除的客户将不会出现在此阶段中，且该操作不可逆。",onConfirm:async()=>{try{await Be({wechat_id:o.wechat_id,flow_id:o.flow_id,stage_id:M.value,friend_id:B.value.map(n=>n.friend_id)}),E(),h.msgSuccess("清空成功")}catch(n){h.msgError(n)}}});return}else if(t==g.SEND_MESSAGE){h.msgWarning("该功能暂未开放");return}I.value=!0,await A(),(c=O.value)==null||c.open(t)},W=Y(),$=p(!1),oe=async t=>{var e;$.value=!0,await A(),(e=W.value)==null||e.open()},le=async t=>{try{await J({...t,wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:B.value.map(e=>e.friend_id)}),E(),h.msgSuccess("转移成功")}catch(e){h.msgError(e)}},j=Y(),U=p(!1),x=p(-1),re=async t=>{var e;x.value=t,U.value=!0,await A(),(e=j.value)==null||e.open()},ie=async t=>{const e=t.map(n=>n.friend_id),c=d.value[x.value].stage_id;try{await Ie({wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:e,stage_id:c}),E()}catch(n){h.msgError(n)}};let q=[];const ne=()=>{d.value.forEach((t,e)=>{const c=R.value[e];if(c){const n=Se.create(c,{group:"sharedGroup",animation:150,forceFallback:!0,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:F=>de(F,e)});q.push(n)}})},de=async(t,e)=>{const{oldIndex:c,newIndex:n,from:F,to:N}=t,b=d.value[e],T=b.members.splice(c,1),k=d.value.findIndex((ct,pe)=>R.value[pe]===N);k!==-1&&d.value[k].members.splice(n,0,...T);const l=d.value[k],z=l.members[n],u=b.stage_id,r=l.stage_id,H={wechat_id:o.wechat_id,flow_id:o.flow_id,to_flow_id:o.flow_id,friend_id:[z.friend_id],stage_id:u,to_stage_id:r};await J(H),E()},ce=(t,e)=>{R.value[e]=t},L=p([]),me=async()=>{const{lists:t}=await Ue({page_size:999});L.value=t},V=async()=>{const t=await $e(o);d.value=t.sub_stage_list},ue=async()=>{await Promise.all([me(),Z()]),L.value.length>0&&(o.wechat_id=L.value[0].wechat_id),y.value.length>0&&(o.flow_id=y.value[0].id),E()},E=async()=>{D.value=!0;try{await V(),await A(),await ne()}finally{D.value=!1}};return ve(ue),he(()=>{q.forEach(t=>t.destroy())}),(t,e)=>{const c=Ee,n=be,F=Fe,N=Ae,b=De,T=Re,k=ke;return i(),m(w,null,[a("div",He,[a("div",Pe,[a("div",Ge,[f(s(Q),{modelValue:s(o).wechat_id,"onUpdate:modelValue":e[0]||(e[0]=l=>s(o).wechat_id=l),placeholder:"请选择微信",class:"!w-[200px]",onChange:V},{prefix:_(()=>e[5]||(e[5]=[a("div",null,"选择微信",-1)])),default:_(()=>[(i(!0),m(w,null,C(s(L),l=>(i(),v(s(K),{key:l.id,label:l.wechat_nickname,value:l.wechat_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(s(Q),{modelValue:s(o).flow_id,"onUpdate:modelValue":e[1]||(e[1]=l=>s(o).flow_id=l),placeholder:"请选择客户流程",class:"!w-[200px]",onChange:V},{prefix:_(()=>e[6]||(e[6]=[a("div",null,"客户流程",-1)])),default:_(()=>[(i(!0),m(w,null,C(s(y),l=>(i(),v(s(K),{key:l.id,label:l.flow_name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),we((i(),m("div",Me,[s(d).length>0?(i(),v(b,{key:0},{default:_(()=>[a("div",Oe,[(i(!0),m(w,null,C(s(d),({members:l,sub_stage_name:z},u)=>(i(),m("div",{key:u,class:"rounded-md border border-[#E0E0E0] w-[243px] flex flex-col flex-shrink-0 overflow-hidden"},[a("div",We,[a("div",{class:"h-full",style:ge({width:`${(u+1)/s(d).length*100}%`,backgroundColor:"var(--color-primary)"})},null,4)]),a("div",je,[a("div",qe,[f(c,{name:"el-icon-LocationFilled",color:"var(--color-primary)",size:20}),a("span",Ye,S(z),1)]),f(F,{trigger:"click","show-arrow":!1,"popper-class":"!w-[290px] !rounded-lg !p-0"},{reference:_(()=>[f(n,{type:"primary",link:""},{default:_(()=>e[7]||(e[7]=[ye("操作",-1)])),_:1,__:[7]})]),default:_(()=>[a("div",Je,[a("div",Ke,[(i(),m(w,null,C(ee,r=>a("div",{key:r.value,class:xe(["flex items-center gap-2 h-9 px-4 cursor-pointer hover:bg-primary-light-9 hover:text-primary",{"bg-primary-light-8 text-primary":s(X)[u]===r.value}]),onClick:H=>ae(r.value,u)},S(r.label),11,Qe)),64))])])]),_:2},1024)]),a("div",{class:"flex items-center justify-center gap-x-4 bg-primary-light-9 p-2 rounded-md mx-2 mt-6 cursor-pointer",onClick:r=>re(u)},[f(c,{name:"local-icon-add_box_fill",color:"var(--color-primary)",size:20}),e[8]||(e[8]=a("span",{class:"text-primary"},"添加用户",-1))],8,Ze),a("div",Xe,[f(b,null,{default:_(()=>[a("div",{class:"p-4 flex flex-col gap-4 h-full",ref_for:!0,ref:r=>ce(r,u),"data-index":u},[(i(!0),m(w,null,C(l,r=>(i(),m("div",{key:`List${u+1}-Item${r.friend_id}`,class:"flex gap-x-4 p-3 bg-white shadow-lighter mb-2 rounded cursor-move",onClick:H=>oe(r)},[a("div",st,[r.avatar?(i(),m("img",{key:0,class:"w-12 h-12 rounded-md",src:r.avatar},null,8,at)):(i(),v(N,{key:1,size:48,src:r.avatar,shape:"square",icon:"el-icon-UserFilled"},null,8,["src"]))]),a("div",null,[a("div",ot,S(r.remark||"-"),1),a("div",lt," 微信昵称："+S(r.nickname),1),a("div",rt," 微信ID："+S(r.friend_id),1)])],8,tt))),128))],8,et)]),_:2},1024)])]))),128))])]),_:1})):(i(),m("div",it,[f(T,{description:"暂无数据"})]))])),[[k,s(D)]])]),s(U)?(i(),v(Ve,{key:0,ref_key:"addFriendRef",ref:j,"wechat-id":s(o).wechat_id,onClose:e[2]||(e[2]=l=>U.value=!1),onSuccess:ie},null,8,["wechat-id"])):G("",!0),s($)?(i(),v(Ne,{key:1,ref_key:"userDetailRef",ref:W,onClose:e[3]||(e[3]=l=>$.value=!1)},null,512)):G("",!0),s(I)?(i(),v(Te,{key:2,ref_key:"boardHandleRef",ref:O,"wechat-id":s(o).wechat_id,"flow-id":s(o).flow_id,"stage-id":s(M),"flow-lists":s(y),"stage-lists":s(se),onClose:e[4]||(e[4]=l=>I.value=!1),onConfirm:le},null,8,["wechat-id","flow-id","stage-id","flow-lists","stage-lists"])):G("",!0)],64)}}});const ps=Le(nt,[["__scopeId","data-v-9edf4ebd"]]);export{ps as default};
