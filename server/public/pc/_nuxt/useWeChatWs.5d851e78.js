import{r as h,G as u}from"./entry.f4f46cb5.js";import{u as M}from"./useWebSocket.5253d560.js";import{MsgErrorCodeEnum as n,MsgTypeEnum as t}from"./index.cf59f1a8.js";import{G as T,H as _,I as A}from"./person_wechat.703f63bb.js";const f=new Map;function x(C={}){const I=`wss://${location.host}/wechat`,{on:d,send:i,reconnect:D,isConnected:g}=M(I,{manualHeartbeat:!0,...C}),l=h(!1),s=h(),o=(e,a)=>{const r=f.get(e);r&&r(a)};d("open",()=>o("open")),d("error",e=>o("error",e)),d("close",()=>o("close")),d("message",async e=>{const{Code:a,Message:r,Data:v}=e||{};if(a===n.Success){const{MsgType:W,Content:c}=v||{};if(o("message",v),o("action",{type:s.value,accessToken:c.AccessToken,deviceId:c.DeviceId,wechatId:c.WeChatId,content:v.Content}),s.value===t.AddDevice){await m(c);return}if(W===t.Auth&&s.value===t.Auth){await p(c);return}if(c.WeChatId&&s.value===t.WxInfo){await y(c);return}}else w(r,a,v)}),d("heartbeat",()=>{s.value=t.Heartbeat,i({MsgType:t.Heartbeat,Content:{}}),o("heartbeat")});const m=async e=>{try{await T({device_code:e.DeviceId,device_model:e.DeviceModel,sdk_version:e.SdkVersion,device_status:e.IsOnline?1:0}),i({MsgType:t.Auth,Content:{DeviceId:e.DeviceId}}),s.value=t.Auth}catch(a){u.msgError(`${a}`),o("error")}finally{l.value=!1}},p=async e=>{i({MsgType:t.WxInfo,Content:{DeviceId:e.DeviceId,AccessToken:e.AccessToken,WeChatId:e.WeChatId}}),s.value=t.WxInfo},y=async e=>{try{await _({device_code:e.DeviceId,wechat_id:e.WeChatId,wechat_nickname:e.WeChatNick||"",wechat_avatar:e.Avatar||"",wechat_status:e.Status==="online",wechat_no:e.WeChatNo}),A({device_code:e.DeviceId,is_used:!0}),u.msgSuccess("设备添加成功"),o("success",{type:"add-device"}),s.value=void 0}catch(a){s.value=void 0,u.msgError(`${a}，请联系站长`)}},w=(e,a,r)=>{o("error",{Message:e,Code:a,MsgType:r.MsgType,Content:r.Content}),l.value=!1,s.value=void 0,[n.DataNotFound,n.DeviceNotFound,n.DeviceOffline,n.DeviceExist,n.DeviceWechatNotFound,n.SystemError].includes(a)&&u.msgError(e)};return{isConnected:g,addDeviceLoading:l,actionType:s,on:(e,a)=>{f.set(e,a)},send:i,reconnect:D}}export{x as default};
