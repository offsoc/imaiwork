import{Q as mt,S as J,O as ut,d as rt,c as b,A as st,r as B,o as dt,D as vt,b as gt,ba as ht,k as K,l as X,H as _t,a3 as xt,aa as bt,aR as yt,am as wt,at as kt,z as Ct,bM as St,ek as Z,m as F,q as Y,s as D,Z as y,ak as It,t as Q,a8 as Mt,v as $t,J as it,K as At,L as Et,bK as zt,el as Bt,u as Rt,G as ct,em as ot,ax as Wt}from"./entry.46557796.js";import{E as Nt}from"./index.304400de.js";import{_ as Pt}from"./chatting.db6ea2ec.js";/* empty css                     */import{H as Tt,I as Ft,J as Ht,K as Lt}from"./agent.a3fcedc5.js";import{_ as Ot}from"./pwd-check.vue.57ecb2fd.js";import"./index.vue.6f8ad13e.js";import"./debounce.22e3311f.js";import"./index.3864ff87.js";import"./katex.ff257f19.js";import"./el-image.663be0a1.js";import"./el-image-viewer.4c392e93.js";import"./throttle.f2fe0ca7.js";import"./position.bb07cf08.js";import"./index.6c2ab172.js";/* empty css                    */import"./index.52e544f1.js";import"./index.c76cd001.js";import"./strings.1c189114.js";import"./_baseIteratee.6084bee0.js";import"./index.1d76ef55.js";/* empty css                  *//* empty css               */import"./useCopy.84a3fbb4.js";import"./cloneDeep.2c9fdb34.js";import"./el-slider.239593a3.js";import"./el-input-number.2848ce7e.js";import"./index.08e202f9.js";import"./el-switch.03413428.js";import"./index.816355b6.js";/* empty css                   */const Ut=mt({zIndex:{type:Number,default:9},rotate:{type:Number,default:-22},width:Number,height:Number,image:String,content:{type:J([String,Array]),default:"Element Plus"},font:{type:J(Object)},gap:{type:J(Array),default:()=>[100,100]},offset:{type:J(Array)}});function jt(f){return f.replace(/([A-Z])/g,"-$1").toLowerCase()}function Dt(f){return Object.keys(f).map(o=>`${jt(o)}: ${f[o]};`).join(" ")}function qt(){return window.devicePixelRatio||1}const Yt=(f,o)=>{let r=!1;return f.removedNodes.length&&o&&(r=Array.from(f.removedNodes).includes(o)),f.type==="attributes"&&f.target===o&&(r=!0),r},ft=3;function nt(f,o,r=1){const p=document.createElement("canvas"),l=p.getContext("2d"),u=f*r,g=o*r;return p.setAttribute("width",`${u}px`),p.setAttribute("height",`${g}px`),l.save(),[l,p,u,g]}function Kt(){function f(o,r,p,l,u,g,R,j){const[w,W,I,k]=nt(l,u,p);if(o instanceof HTMLImageElement)w.drawImage(o,0,0,I,k);else{const{color:S,fontSize:z,fontStyle:L,fontWeight:T,fontFamily:G,textAlign:et,textBaseline:at}=g,V=Number(z)*p;w.font=`${L} normal ${T} ${V}px/${u}px ${G}`,w.fillStyle=S,w.textAlign=et,w.textBaseline=at;const q=ut(o)?o:[o];q==null||q.forEach((lt,pt)=>{w.fillText(lt??"",I/2,pt*(V+ft*p))})}const M=Math.PI/180*Number(r),O=Math.max(l,u),[N,C,x]=nt(O,O,p);N.translate(x/2,x/2),N.rotate(M),I>0&&k>0&&N.drawImage(W,-I/2,-k/2);function i(S,z){const L=S*Math.cos(M)-z*Math.sin(M),T=S*Math.sin(M)+z*Math.cos(M);return[L,T]}let m=0,$=0,H=0,U=0;const A=I/2,E=k/2;[[0-A,0-E],[0+A,0-E],[0+A,0+E],[0-A,0+E]].forEach(([S,z])=>{const[L,T]=i(S,z);m=Math.min(m,L),$=Math.max($,L),H=Math.min(H,T),U=Math.max(U,T)});const e=m+x/2,t=H+x/2,a=$-m,s=U-H,c=R*p,h=j*p,_=(a+c)*2,d=s+h,[v,n]=nt(_,d);function P(S=0,z=0){v.drawImage(C,e,t,a,s,S,z,a,s)}return P(),P(a+c,-s/2-h/2),P(a+c,+s/2+h/2),[n.toDataURL(),_/p,d/p]}return f}const Xt=rt({name:"ElWatermark"}),Gt=rt({...Xt,props:Ut,setup(f){const o=f,r={position:"relative"},p=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.color)!=null?t:"rgba(0,0,0,.15)"}),l=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.fontSize)!=null?t:16}),u=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.fontWeight)!=null?t:"normal"}),g=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.fontStyle)!=null?t:"normal"}),R=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.fontFamily)!=null?t:"sans-serif"}),j=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.textAlign)!=null?t:"center"}),w=b(()=>{var e,t;return(t=(e=o.font)==null?void 0:e.textBaseline)!=null?t:"hanging"}),W=b(()=>o.gap[0]),I=b(()=>o.gap[1]),k=b(()=>W.value/2),M=b(()=>I.value/2),O=b(()=>{var e,t;return(t=(e=o.offset)==null?void 0:e[0])!=null?t:k.value}),N=b(()=>{var e,t;return(t=(e=o.offset)==null?void 0:e[1])!=null?t:M.value}),C=()=>{const e={zIndex:o.zIndex,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let t=O.value-k.value,a=N.value-M.value;return t>0&&(e.left=`${t}px`,e.width=`calc(100% - ${t}px)`,t=0),a>0&&(e.top=`${a}px`,e.height=`calc(100% - ${a}px)`,a=0),e.backgroundPosition=`${t}px ${a}px`,e},x=st(null),i=st(),m=B(!1),$=()=>{i.value&&(i.value.remove(),i.value=void 0)},H=(e,t)=>{var a;x.value&&i.value&&(m.value=!0,i.value.setAttribute("style",Dt({...C(),backgroundImage:`url('${e}')`,backgroundSize:`${Math.floor(t)}px`})),(a=x.value)==null||a.append(i.value),setTimeout(()=>{m.value=!1}))},U=e=>{let t=120,a=64;const{image:s,content:c,width:h,height:_,rotate:d}=o;if(!s&&e.measureText){e.font=`${Number(l.value)}px ${R.value}`;const v=ut(c)?c:[c];let n=0,P=0;v.forEach(L=>{const{width:T,fontBoundingBoxAscent:G,fontBoundingBoxDescent:et,actualBoundingBoxAscent:at,actualBoundingBoxDescent:V}=e.measureText(L),q=yt(G)?at+V:G+et;T>n&&(n=Math.ceil(T)),q>P&&(P=Math.ceil(q))}),t=n,a=P*v.length+(v.length-1)*ft;const S=Math.PI/180*Number(d),z=Math.ceil(Math.abs(Math.sin(S)*a)/2);t+=z}return[h??t,_??a]},A=Kt(),E=()=>{const t=document.createElement("canvas").getContext("2d"),a=o.image,s=o.content,c=o.rotate;if(t){i.value||(i.value=document.createElement("div"));const h=qt(),[_,d]=U(t),v=n=>{const[P,S]=A(n||"",c,h,_,d,{color:p.value,fontSize:l.value,fontStyle:g.value,fontWeight:u.value,fontFamily:R.value,textAlign:j.value,textBaseline:w.value},W.value,I.value);H(P,S)};if(a){const n=new Image;n.onload=()=>{v(n)},n.onerror=()=>{v(s)},n.crossOrigin="anonymous",n.referrerPolicy="no-referrer",n.src=a}else v(s)}};return dt(()=>{E()}),vt(()=>o,()=>{E()},{deep:!0,flush:"post"}),gt(()=>{$()}),ht(x,e=>{m.value||e.forEach(t=>{Yt(t,i.value)&&($(),E())})},{attributes:!0,subtree:!0,childList:!0}),(e,t)=>(K(),X("div",{ref_key:"containerRef",ref:x,style:xt([r])},[_t(e.$slots,"default")],4))}});var Vt=bt(Gt,[["__file","watermark.vue"]]);const Jt=wt(Vt),Zt={class:"h-screen"},Qt={class:"px-4 h-full"},te={class:"h-full flex flex-col items-center justify-center"},ee=["src"],ae={class:"text-[32px] font-bold mt-4"},oe={class:"text-[#7b7b7b] mt-[10px] text-xs w-[383px] mx-auto text-center"},ne={class:"flex items-center gap-3"},se={key:0},re={class:"flex pb-3 gap-3"},le=["onClick"],ie={class:"text-xs text-[#7b7b7b] text-center mt-2 line-clamp-1"},Le=rt({__name:"[key]",setup(f){const o=kt(),r=Ct(),l=St().params.key,u=B([]),g=B(!1),R=B(!1),j=st(),w=async()=>{try{const{lists:t}=await Ft({share_apikey:l,identity:r.visitorId,page_size:25e3},{password:m.value,authorization:l,identity:r.visitorId});u.value=t.map(a=>a.type==1?{...a,message:a.content}:{...a,reply:a.content,form_avatar:C.value.image}),k()}catch(t){return t=="访问密码错误!"&&(U(),await $()),Promise.reject()}};let W=null;const I=async t=>{await r.getFingerprint(),await $();const a=Date.now();u.value.push({type:1,message:t,reasoning:""}),u.value.push({type:2,reply:"",reasoning:"",loading:!0,key:a,form_avatar:C.value.image});const s=u.value.find(c=>c.key===a);g.value=!0,k();try{await Bt({question:t,unique_id:A.value,stream:!0},{password:m.value,authorization:l,identity:r.visitorId},{onstart:c=>{W=c,R.value=!0},onmessage:c=>{c.trim().split("data:").forEach(h=>{if(h)try{const{object:_,content:d,task_id:v,usage:n}=JSON.parse(h);_==="loading"?s.reply+=d:_==="finished"&&(s.loading=!1,s.consume_tokens=n),k()}catch(_){console.error("解析流式消息失败:",_,"原始文本:",h)}})},onclose:()=>{s.loading=!1,g.value=!1,R.value=!1,k()}})}catch{s.loading=!1,g.value=!1,s.reply="请求失败，请重试"}},k=()=>{setTimeout(()=>{j.value.scrollToBottom()},100)},M=()=>{Rt().$confirm({title:"提示",message:"确定要清空聊天记录吗？",onConfirm:async()=>{if(g.value&&O(),u.value.length==0){ct.msgError("没有聊天记录");return}try{await Tt({},{password:m.value,authorization:l,identity:r.visitorId}),await w()}catch(t){ct.msgError(t)}}})},O=()=>{if(W==null||W.cancel(),g.value){const t=u.value[u.value.length-1];t.loading=!1,g.value=!1,R.value=!1}},N=B({}),C=B({}),x=B([]),i=B(!1);B();const m=B(""),$=()=>{const t=Z(ot,{});if(m.value=t.value[l]||"",N.value.pwd&&!m.value)return i.value=!0,Promise.reject()},H=async t=>{const a=Z(ot,{});m.value=t.password,a.value=Object.assign(a.value,{[l]:t.password}),i.value=!1,await w()},U=()=>{const t=Z(ot,{});t.value=Object.assign(t.value,{[l]:""})},A=Z("SHARE_CHAT_UNIQUE_ID",""),E=async()=>{if(A.value)return;const t=await Lt({robot_id:N.value.robot.id},{password:m.value,authorization:l,identity:r.visitorId});A.value=t[0]},tt=async()=>{const t=await Ht({apikey:l});N.value=t,C.value=t.robot,x.value=t.menus,$(),E()},e=async()=>{await tt(),await w()};return dt(async()=>{await r.getFingerprint(),e()}),(t,a)=>{const s=Wt,c=Nt,h=Pt,_=Jt;return K(),X(it,null,[F("div",Zt,[Y(_,{class:"h-full",content:y(o).getWebsiteConfig.shop_name,"z-index":-1,font:{color:"rgba(0,0,0,0.06)",fontSize:12}},{default:D(()=>[F("div",Qt,[Y(h,{ref_key:"chattingRef",ref:j,"is-stop":y(R),"content-list":y(u),"send-disabled":y(g),"is-disabled-humanize":!0,"is-new-chat":!1,"is-auth-login":!1,onClose:O,onContentPost:I},It({content:D(()=>{var d,v,n;return[F("div",te,[F("img",{src:(d=y(C))==null?void 0:d.image,class:"w-[112px] h-[112px] rounded-full"},null,8,ee),F("div",ae,Q((v=y(C))==null?void 0:v.name),1),F("div",oe,Q((n=y(C))==null?void 0:n.welcome_introducer),1)])]}),"chat-area-top":D(()=>[F("div",ne,[Y(s,{round:"",icon:y(Mt),onClick:M,class:"mb-3"},{default:D(()=>a[2]||(a[2]=[$t("清空",-1)])),_:1,__:[2]},8,["icon"]),y(x).length>0?(K(),X("div",se,[Y(c,null,{default:D(()=>[F("div",re,[(K(!0),X(it,null,At(y(x),(d,v)=>(K(),X("div",{class:"whitespace-nowrap rounded-[24px] py-2 px-4 bg-white border border-[#F1F1F2] text-xs cursor-pointer hover:bg-[#F1F1F2]",key:v,onClick:n=>I(d)},Q(d),9,le))),128))])]),_:1})])):Et("",!0)])]),_:2},[y(C).copyright?{name:"chat-area-bottom",fn:D(()=>[F("div",ie,Q(y(C).copyright),1)]),key:"0"}:void 0]),1032,["is-stop","content-list","send-disabled"])])]),_:1},8,["content"])]),Y(Ot,{show:y(i),"onUpdate:show":a[0]||(a[0]=d=>zt(i)?i.value=d:null),ref:"pwdCheckRef",onClose:a[1]||(a[1]=d=>i.value=!1),onConfirm:H},null,8,["show"])],64)}}});export{Le as default};
