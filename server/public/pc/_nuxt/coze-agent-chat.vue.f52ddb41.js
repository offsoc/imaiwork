import{_ as B}from"./chatting.db6ea2ec.js";import{d as S,z as T,aG as L,r as p,aj as G,D as u,k as M,I as P,s as j,m as A,Z as i,G as v,aH as m}from"./entry.46557796.js";import{a as D}from"./agent.a3fcedc5.js";import{useCozeChat as E}from"./useCozeChat.20be4941.js";const Z=S({__name:"coze-agent-chat",props:{agentId:{},cozeId:{},detail:{},conversationId:{}},emits:["new-conversation","conversation-id-change","update:isReceiving"],setup(_,{emit:g}){const s=_,c=g,h=T(),{userInfo:C,userTokens:k}=L(h),n=p(),d=p(!1),{chatContentList:r,isReceiving:l,isStopChat:y,sendMessage:w,stopChat:z,setConversationId:I}=E(G(s,"detail"),s.agentId);u(l,e=>c("update:isReceiving",e));const R=async e=>{if(k.value<=1){v.msgPowerInsufficient();return}await w(e,t=>{c("conversation-id-change",t)},t=>{c("new-conversation",t)})},b=async e=>{var t;if(!e){r.value=[];return}d.value=!0;try{const{lists:o}=await D({bot_id:s.cozeId,type:1,conversation_id:e,page_size:9999}),x=o.map(a=>{var f;return a.role==="user"?{...a,type:1,message:a.content,form_avatar:C.value.avatar}:{...a,type:2,reply:a.content,form_avatar:(f=s.detail)==null?void 0:f.avatar,consume_tokens:{total_tokens:a.token_total}}});r.value=x,await m(),(t=n.value)==null||t.scrollToBottom()}catch(o){v.msgError(o||"发生错误")}finally{d.value=!1}};return u(()=>s.conversationId,e=>{var t;I(e||""),l.value||b(e||""),(t=n.value)==null||t.resetScroll()},{immediate:!0}),u(()=>r.value,async()=>{var e;await m(),(e=n.value)==null||e.scrollToBottom()},{deep:!0}),(e,t)=>{const o=B;return M(),P(o,{ref_key:"chattingRef",ref:n,"is-new-chat":!1,"is-stop":i(y),"is-disabled-humanize":!0,"content-list":i(r),"send-disabled":i(l),"is-upload-file":!1,"is-network":!1,onContentPost:R,onClose:i(z)},{content:j(()=>t[0]||(t[0]=[A("div",{class:"h-full"},null,-1)])),_:1},8,["is-stop","content-list","send-disabled","onClose"])}}});export{Z as _};
