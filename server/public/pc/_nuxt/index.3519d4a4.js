import{d as he,aF as we,r as p,c as P,A as J,o as ge,b as ye,k as i,l as u,m as s,q as f,s as _,J as w,K as S,I as v,Z as a,aI as xe,a3 as Ee,t as L,v as be,Y as ke,L as W,G as h,aH as A,y as Ce,ax as Se,cP as Le,u as Fe,ee as Ae,_ as De}from"./entry.d7219633.js";import{E as Ie}from"./index.1f8dde63.js";import{E as Re}from"./el-avatar.e0eb87c8.js";import{E as Be}from"./index.f15af271.js";import{E as Ue}from"./el-empty.77af023a.js";/* empty css                   *//* empty css                     */import{ar as $e,as as K,at as Ne,au as Ve,z as Te}from"./person_wechat.8bcf26fc.js";import{BoardHandleTypeEnum as g}from"./index.a1206616.js";import{_ as ze}from"./add-friend.vue.4f71b94e.js";import He from"./user-detail-panel.3140458c.js";import{_ as Pe}from"./board-handle.vue.cb917c15.js";import We from"./useTask.c2b7e4e6.js";import Ge from"./useHandle.2b5b26f8.js";import{E as Z,a as Q}from"./index.50778a9c.js";import"./index.0a6eb9ae.js";import"./_baseIteratee.5c97421a.js";import"./debounce.085e8a4a.js";import"./index.ead96a32.js";import"./index.vue.5e2341cc.js";/* empty css                        *//* empty css               */import"./usePaging.3c53b51c.js";import"./sidebar-panel.vue.93578dd6.js";import"./index.4953ba77.js";import"./el-tabs.f915a42a.js";import"./strings.03d3529c.js";import"./index.35988ce8.js";import"./index.fe7bc2f3.js";/* empty css                  */import"./index.cf59f1a8.js";import"./user-flow.vue.9ea4e5d2.js";import"./7_day.257301c1.js";import"./flow_title_img.b33c9278.js";import"./user-todo.0dae8dcf.js";import"./user-sop.c2d6dd0e.js";import"./el-image.37ed17f2.js";import"./el-image-viewer.960ba8e6.js";import"./throttle.70466628.js";import"./position.cb246d7d.js";import"./index.vue.38c569b2.js";import"./index.vue.c82b4b26.js";import"./date.95a59cef.js";import"./vue-virtual-scroller.esm.d0916cd7.js";/* empty css                             */import"./mini-program-card.vue.dd66cb8d.js";import"./link-card.vue.5b27e20b.js";import"./file-card.vue.7b9fc004.js";import"./useTodo.60b74ae1.js";import"./friends-bind-tag.vue.76518142.js";/* empty css                  */import"./user-todo-edit.vue.f79f4fdd.js";import"./el-date-picker.fe7cdba3.js";import"./customParseFormat.76f0695f.js";import"./panel-time-pick.8be972f9.js";import"./index.2311001e.js";const Me={class:"h-full flex flex-col"},Oe={class:"bg-white p-4 rounded-xl"},je={class:"flex items-center gap-2"},qe={class:"grow min-h-0 bg-white rounded-xl mt-4 px-6"},Ye={class:"flex gap-5 py-6 h-full whitespace-nowrap"},Je={class:"h-[4px] bg-[#E0E0E0]"},Ke={class:"h-[72px] flex items-center justify-between border-b border-primary-light-8 px-4"},Ze={class:"flex items-center gap-2"},Qe={class:"text-[#5E656E] text-lg"},Xe={class:"py-2"},et={class:"flex flex-col"},tt=["onClick"],at=["onClick"],st={class:"min-h-0 grow"},ot=["data-index"],lt=["onClick"],rt={class:"flex-shrink-0"},it=["src"],nt={class:"font-medium mb-1"},dt={class:"text-[#9E9E9E] text-xs whitespace-normal"},ct={class:"text-[#9E9E9E] text-xs whitespace-normal"},ut={key:1,class:"flex items-center justify-center h-full"},mt=he({__name:"index",setup(pt){const{currentWechat:X,currentFriend:ee,friendInfo:G}=Ge(),o=we({wechat_id:"",flow_id:""}),D=p(!1),c=p([]),I=p([]),{flowLists:y,getFlowLists:te}=We(),ae=p({}),se=[{label:"清除此阶段内的所有客户",value:g.CLEAR},{label:"将此阶段内的客户转移到别的阶段",value:g.TRANSFER},{label:"将此阶段内的客户转移到别的周期阶段中",value:g.TRANSFER_TO_CYCLE},{label:"给此阶段内的客户群发消息（内测中）",value:g.SEND_MESSAGE,disabled:!0}],oe=Fe(),R=P(()=>c.value[x.value].members),le=P(()=>{var t;return(t=y.value.find(e=>e.id==o.flow_id))==null?void 0:t.key_stages}),M=P(()=>c.value[x.value].stage_id),B=p(!1),O=p(),re=async(t,e)=>{var n;if(x.value=e,t===g.CLEAR){if(R.value.length==0){h.msgWarning("此阶段内没有数据");return}oe.$confirm({title:"是否确认清除此阶段内的所有客户？",message:"删除选择的此阶段的客户后，这些删除的客户将不会出现在此阶段中，且该操作不可逆。",onConfirm:async()=>{try{await $e({wechat_id:o.wechat_id,flow_id:o.flow_id,stage_id:M.value,friend_id:R.value.map(d=>d.friend_id)}),b(),h.msgSuccess("清空成功")}catch(d){h.msgError(d)}}});return}else if(t==g.SEND_MESSAGE){h.msgWarning("该功能暂未开放");return}B.value=!0,await A(),(n=O.value)==null||n.open(t)},j=J(),U=p(!1),ie=async t=>{var e;ee.value={UserName:t.friend_id},X.value={...E.value.find(n=>n.wechat_id==o.wechat_id)},G.value={...G.value,...t},U.value=!0,await A(),(e=j.value)==null||e.open()},ne=async t=>{try{await K({...t,wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:R.value.map(e=>e.friend_id)}),b(),h.msgSuccess("转移成功")}catch(e){h.msgError(e)}},q=J(),$=p(!1),x=p(-1),de=async t=>{var e;x.value=t,$.value=!0,await A(),(e=q.value)==null||e.open()},ce=async t=>{const e=t.map(d=>d.friend_id),n=c.value[x.value].stage_id;try{await Ne({wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:e,stage_id:n}),b()}catch(d){h.msgError(d)}};let Y=[];const ue=()=>{c.value.forEach((t,e)=>{const n=I.value[e];if(n){const d=Ae.create(n,{group:"sharedGroup",animation:150,forceFallback:!0,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:F=>me(F,e)});Y.push(d)}})},me=async(t,e)=>{const{oldIndex:n,newIndex:d,from:F,to:V}=t,k=c.value[e],T=k.members.splice(n,1),C=c.value.findIndex((_t,ve)=>I.value[ve]===V);C!==-1&&c.value[C].members.splice(d,0,...T);const l=c.value[C],z=l.members[d],m=k.stage_id,r=l.stage_id,H={wechat_id:o.wechat_id,flow_id:o.flow_id,to_flow_id:o.flow_id,friend_id:[z.friend_id],stage_id:m,to_stage_id:r};await K(H),b()},pe=(t,e)=>{I.value[e]=t},E=p([]),_e=async()=>{const{lists:t}=await Te({page_size:999});E.value=t},N=async()=>{const t=await Ve(o);c.value=t.sub_stage_list},fe=async()=>{await Promise.all([_e(),te()]),E.value.length>0&&(o.wechat_id=E.value[0].wechat_id),y.value.length>0&&(o.flow_id=y.value[0].id),b()},b=async()=>{D.value=!0;try{await N(),await A(),await ue()}finally{D.value=!1}};return ge(fe),ye(()=>{Y.forEach(t=>t.destroy())}),(t,e)=>{const n=Ce,d=Se,F=Ie,V=Re,k=Be,T=Ue,C=Le;return i(),u(w,null,[s("div",Me,[s("div",Oe,[s("div",je,[f(a(Q),{modelValue:a(o).wechat_id,"onUpdate:modelValue":e[0]||(e[0]=l=>a(o).wechat_id=l),placeholder:"请选择微信",class:"!w-[200px]",onChange:N},{prefix:_(()=>e[5]||(e[5]=[s("div",null,"选择微信",-1)])),default:_(()=>[(i(!0),u(w,null,S(a(E),l=>(i(),v(a(Z),{key:l.id,label:l.wechat_nickname,value:l.wechat_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(a(Q),{modelValue:a(o).flow_id,"onUpdate:modelValue":e[1]||(e[1]=l=>a(o).flow_id=l),placeholder:"请选择客户流程",class:"!w-[200px]",onChange:N},{prefix:_(()=>e[6]||(e[6]=[s("div",null,"客户流程",-1)])),default:_(()=>[(i(!0),u(w,null,S(a(y),l=>(i(),v(a(Z),{key:l.id,label:l.flow_name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),xe((i(),u("div",qe,[a(c).length>0?(i(),v(k,{key:0},{default:_(()=>[s("div",Ye,[(i(!0),u(w,null,S(a(c),({members:l,sub_stage_name:z},m)=>(i(),u("div",{key:m,class:"rounded-md border border-[#E0E0E0] w-[243px] flex flex-col flex-shrink-0 overflow-hidden"},[s("div",Je,[s("div",{class:"h-full",style:Ee({width:`${(m+1)/a(c).length*100}%`,backgroundColor:"var(--color-primary)"})},null,4)]),s("div",Ke,[s("div",Ze,[f(n,{name:"el-icon-LocationFilled",color:"var(--color-primary)",size:20}),s("span",Qe,L(z),1)]),f(F,{trigger:"click","show-arrow":!1,"popper-class":"!w-[290px] !rounded-lg !p-0"},{reference:_(()=>[f(d,{type:"primary",link:""},{default:_(()=>e[7]||(e[7]=[be("操作",-1)])),_:1,__:[7]})]),default:_(()=>[s("div",Xe,[s("div",et,[(i(),u(w,null,S(se,r=>s("div",{key:r.value,class:ke(["flex items-center gap-2 h-9 px-4 cursor-pointer hover:bg-primary-light-9 hover:text-primary",{"bg-primary-light-8 text-primary":a(ae)[m]===r.value}]),onClick:H=>re(r.value,m)},L(r.label),11,tt)),64))])])]),_:2},1024)]),s("div",{class:"flex items-center justify-center gap-x-4 bg-primary-light-9 p-2 rounded-md mx-2 mt-6 cursor-pointer",onClick:r=>de(m)},[f(n,{name:"local-icon-add_box_fill",color:"var(--color-primary)",size:20}),e[8]||(e[8]=s("span",{class:"text-primary"},"添加用户",-1))],8,at),s("div",st,[f(k,null,{default:_(()=>[s("div",{class:"p-4 flex flex-col gap-4 h-full",ref_for:!0,ref:r=>pe(r,m),"data-index":m},[(i(!0),u(w,null,S(l,r=>(i(),u("div",{key:`List${m+1}-Item${r.friend_id}`,class:"flex gap-x-4 p-3 bg-white shadow-lighter mb-2 rounded cursor-move",onClick:H=>ie(r)},[s("div",rt,[r.avatar?(i(),u("img",{key:0,class:"w-12 h-12 rounded-md",src:r.avatar},null,8,it)):(i(),v(V,{key:1,size:48,src:r.avatar,shape:"square",icon:"el-icon-UserFilled"},null,8,["src"]))]),s("div",null,[s("div",nt,L(r.remark||"-"),1),s("div",dt," 微信昵称："+L(r.nickname),1),s("div",ct," 微信ID："+L(r.friend_id),1)])],8,lt))),128))],8,ot)]),_:2},1024)])]))),128))])]),_:1})):(i(),u("div",ut,[f(T,{description:"暂无数据"})]))])),[[C,a(D)]])]),a($)?(i(),v(ze,{key:0,ref_key:"addFriendRef",ref:q,"wechat-id":a(o).wechat_id,onClose:e[2]||(e[2]=l=>$.value=!1),onSuccess:ce},null,8,["wechat-id"])):W("",!0),a(U)?(i(),v(He,{key:1,ref_key:"userDetailRef",ref:j,onClose:e[3]||(e[3]=l=>U.value=!1)},null,512)):W("",!0),a(B)?(i(),v(Pe,{key:2,ref_key:"boardHandleRef",ref:O,"wechat-id":a(o).wechat_id,"flow-id":a(o).flow_id,"stage-id":a(M),"flow-lists":a(y),"stage-lists":a(le),onClose:e[4]||(e[4]=l=>B.value=!1),onConfirm:ne},null,8,["wechat-id","flow-id","stage-id","flow-lists","stage-lists"])):W("",!0)],64)}}});const ha=De(mt,[["__scopeId","data-v-b07781c1"]]);export{ha as default};
