import{r as i,bx as P,G as R}from"./entry.d9d53b29.js";import{f as y,h as D,i as V}from"./drawing.7058a163.js";import{ModelEnum as v}from"./index.fb0aa6a9.js";import{c as b}from"./cloneDeep.df46b56a.js";function C({type:p,model:_,task_id:k,dataLists:f,drawType:m="image"}){const l=i(null),o=i(b(f)),n=i(!1),g=i(!1),w=async({callback:r})=>{try{let e=!1;const a={task_id:k,type:p};if(m=="image"){const u=await y(a),{result:s}=u.result;if(!s||!s.sub_task_results||s.sub_task_results.length===0)return console.warn("API 响应缺少 'result' 或 'sub_task_results'。",u),!1;o.value=s.sub_task_results.map((t,c)=>({url:t.image,status:t.task_status,error:[3,4].includes(t.task_status),loading:t.task_status==0||t.task_status==2,progress:Math.round(parseFloat(t.task_completion)*100)})),e=s.sub_task_results.every(t=>t.image||[3,4].includes(t.task_status))}else if(m=="video"){const s=await function(t){return{[v.GENERAL]:D,[v.SEEDANCE]:V}[_](t)}(a);o.value=[{url:s.video_url,status:s.status||0,error:s.status==-1,loading:s.status==2||s.status==0,progress:s.status==1?100:0,msg:s.msg||""}],e=s.status==1||s.status==-1}return r==null||r(o.value),e}catch(e){throw console.error("获取或更新任务结果时出错：",e),e}},E=(r,e)=>{R.msgError(r),o.value.forEach(a=>{a.loading&&!a.url&&(a.error=!0,a.loading=!1)}),d(),e(r)},d=()=>{l.value!==null&&(clearTimeout(l.value),l.value=null)},h=({callback:r,onsuccess:e,onfail:a,resolve:u,reject:s})=>{const t=async()=>{if(n.value){l.value=setTimeout(t,1e3);return}n.value=!0;try{g.value=await w({callback:r}),n.value=!1,g.value?(d(),e==null||e(f),u(!0)):l.value=setTimeout(t,3e3)}catch(c){n.value=!1,E(c,s),a==null||a(c)}};t()},T=async({callback:r=()=>{},onsuccess:e=()=>{},onfail:a=()=>{}}={})=>new Promise((u,s)=>{h({callback:r,onsuccess:e,onfail:a,resolve:u,reject:s})});return P(()=>{d()}),{taskResultList:o,isAllTasksCompleted:g,processDrawingTask:T}}export{C as default};
