import{bM as H,z as O,at as j,bN as b,A as F,aH as q,bO as D,G as m,bP as G,bQ as N}from"./entry.d9d53b29.js";import{useChatStore as J}from"./chat.dee3e68b.js";function Y(){const z=H(),a=J(),S=O(),E=j(),{taskId:i,agentValue:k,chatContentList:c,isReceiving:y,isStopChat:P,isLoading:U,isDeep:M,isNetwork:C,fileLists:u,extraParams:x}=b(a),{userTokens:A,userInfo:w}=b(S),{chatConfig:v}=E,_=F(null),R=F(null),n=()=>{q(()=>{var e;return(e=_.value)==null?void 0:e.scrollToBottom()})},T=()=>{N({task_id:void 0,agent_name:void 0,agent_id:void 0})},B=e=>{e.trim().split("data:").forEach(t=>{var s,h;if(t)try{const{object:o,content:g,task_id:r,usage:p,reasoning_content:l}=JSON.parse(t),f=c.value[c.value.length-1];if(o==="loading"){const d={};l?(d.is_reasoning_finished=!1,d.reasoning_content=(f.reasoning_content||"")+l):g&&(d.is_reasoning_finished=!0,d.reply=(f.reply||"")+g),a.updateLastMessage(d)}else o==="finished"&&(a.updateLastMessage({consume_tokens:p}),a.setTaskId(r),N({task_id:r,agent_name:(s=k.value)==null?void 0:s.name,agent_id:(h=k.value)==null?void 0:h.id}));n()}catch(o){console.error("解析流式消息失败:",o,"原始文本:",t)}})},I=async()=>{if(!(!i.value||i.value==="undefined")){a.isLoading=!0;try{const e=await D({page_no:1,page_size:9999,task_id:i.value,assistant_id:0}),t=(e==null?void 0:e.map(s=>s.type===1?{...s,form_avatar:w.value.avatar,fileList:s!=null&&s.file_info?[s.file_info]:[]}:{...s,is_reasoning_finished:!0,form_avatar:v.logo,consume_tokens:s.tokens_info}))??[];a.chatContentList=t,n()}catch(e){console.error("获取聊天记录失败:",e),m.msgError("获取聊天记录失败")}finally{a.isLoading=!1}}},L=async(e,t=!1,s)=>{var o,g,r,p;if(A.value<=1)return m.msgPowerInsufficient();if(y.value||!e.trim()&&u.value.length===0)return;t||a.addMessage({type:1,message:e,form_avatar:w.value.avatar,fileList:u.value});const h={type:2,loading:!0,form_avatar:(o=v.value)==null?void 0:o.logo,is_reasoning_finished:M.value,error:"",reply:"",reasoning_content:"",consume_tokens:{}};a.addMessage(h),a.startReceiving(),n();try{await G({message:e,task_id:i.value,robot_id:(g=k.value)==null?void 0:g.id,open_reasoning:M.value?1:0,is_network_search:C.value?1:0,file_info:u.value.length?u.value[0]:void 0,...((p=(r=_.value)==null?void 0:r.getChatConfig)==null?void 0:p.call(r))||{},...x.value},{onstart:l=>{R.value=l},onmessage:B,onclose:()=>{a.updateLastMessage({loading:!1}),a.stopReceiving(),a.clearFiles(),S.getUser(),n(),s==null||s()}})}catch(l){const f=l||"消息发送失败";a.updateLastMessage({error:f,loading:!1}),m.msgError(f),a.stopReceiving()}finally{n()}};return{chattingRef:_,isLoading:U,isDeep:M,isNetwork:C,fileLists:u,taskId:i,chatContentList:c,isReceiving:y,isStopChat:P,initialize:async()=>{a.clearChat();const{content:e,task_id:t}=z.query;e?(await L(e),T()):t&&t!=="undefined"&&(a.setTaskId(t),await I()),n()},sendMessage:L,startNewChat:()=>{var e,t,s;if(!i.value)return m.msgError("当前已是新会话");a.clearChat(),T(),(t=(e=_.value)==null?void 0:e.cleanInput)==null||t.call(e),(s=v.value)!=null&&s.new_chat_prompt&&L(v.value.new_chat_prompt,!0)},stopStream:()=>{var e;if((e=R.value)==null||e.cancel(),y.value){const t=c.value[c.value.length-1];a.updateLastMessage({loading:!1,reply:t.reply||"用户已停止内容生成"}),a.stopReceiving()}},chatScrollToBottom:n,fetchChatHistory:I,setFiles:a.setFiles,clearFiles:a.clearFiles}}export{Y as useChatManager};
