import{d as he,aF as we,r as p,c as W,A as J,o as ge,b as ye,k as i,l as u,m as s,q as f,s as _,J as w,K as S,I as v,Z as a,aI as xe,a3 as Ee,t as L,v as be,Y as ke,L as P,G as h,aH as A,y as Ce,ax as Se,cW as Le,u as Fe,el as Ae,_ as De}from"./entry.ca4d3d61.js";import{E as Ie}from"./index.655612b0.js";import{E as Re}from"./el-avatar.c9f3005f.js";import{E as Be}from"./index.8b07fb5c.js";import{E as Ue}from"./el-empty.355e6a02.js";/* empty css                   *//* empty css                     */import{ar as $e,as as K,at as Ne,au as Ve,z as Te}from"./person_wechat.703f63bb.js";import{BoardHandleTypeEnum as g}from"./index.a1206616.js";import{_ as ze}from"./add-friend.vue.2e43f728.js";import He from"./user-detail-panel.23eeacaa.js";import{_ as We}from"./board-handle.vue.6a002270.js";import Pe from"./useTask.96c05b5e.js";import Ge from"./useHandle.f831cbb4.js";import{E as Z,a as Q}from"./index.5f182cdf.js";import"./index.9a4d38a6.js";import"./_baseIteratee.37ea2cef.js";import"./debounce.bdbfd9e6.js";import"./toNumber.33289b44.js";import"./index.d577d4c6.js";import"./raf.53a060df.js";import"./index.vue.441733b3.js";/* empty css                        *//* empty css               */import"./usePaging.15b2220c.js";import"./sidebar-panel.vue.ec613724.js";import"./index.ab577458.js";import"./el-tabs.4bed391d.js";import"./strings.5c02160d.js";import"./clamp.ba5ce84b.js";import"./index.cbddee2f.js";import"./index.0335933c.js";/* empty css                  */import"./index.cf59f1a8.js";import"./user-flow.vue.824efe6e.js";import"./7_day.257301c1.js";import"./flow_title_img.b33c9278.js";import"./user-todo.50c74aa5.js";import"./user-sop.1ef063a1.js";import"./el-image.a5590741.js";import"./el-image-viewer.c57baf7b.js";import"./throttle.da389ed1.js";import"./index.vue.9b80d373.js";import"./index.vue.fa049f69.js";import"./date.95a59cef.js";import"./vue-virtual-scroller.esm.8d2edff1.js";/* empty css                             */import"./mini-program-card.vue.dad06a0b.js";import"./link-card.vue.01b5a6a6.js";import"./file-card.vue.913fb3fb.js";import"./useTodo.b5ff9403.js";import"./friends-bind-tag.vue.cd84fb94.js";/* empty css                  */import"./user-todo-edit.vue.ccd74d72.js";import"./el-date-picker-panel.e4ec4aa6.js";import"./customParseFormat.06da92dd.js";import"./panel-time-pick.3d41fe8f.js";import"./index.4fbaf6cb.js";const Me={class:"h-full flex flex-col"},Oe={class:"bg-white p-4 rounded-xl"},je={class:"flex items-center gap-2"},qe={class:"grow min-h-0 bg-white rounded-xl mt-4 px-6"},Ye={class:"flex gap-5 py-6 h-full whitespace-nowrap"},Je={class:"flex-shrink-0"},Ke={class:"h-[4px] bg-[#E0E0E0]"},Ze={class:"h-[72px] flex items-center justify-between border-b border-primary-light-8 px-4"},Qe={class:"flex items-center gap-2"},Xe={class:"text-[#5E656E] text-lg"},et={class:"py-2"},tt={class:"flex flex-col"},st=["onClick"],at=["onClick"],ot={class:"min-h-0 grow"},lt=["data-index"],rt=["onClick"],it={class:"flex-shrink-0"},nt=["src"],dt={class:"font-medium mb-1"},ct={class:"text-[#9E9E9E] text-xs whitespace-normal"},ut={class:"text-[#9E9E9E] text-xs whitespace-normal"},mt={key:1,class:"flex items-center justify-center h-full"},pt=he({__name:"index",setup(_t){const{currentWechat:X,currentFriend:ee,friendInfo:G}=Ge(),o=we({wechat_id:"",flow_id:""}),D=p(!1),c=p([]),I=p([]),{flowLists:y,getFlowLists:te}=Pe(),se=p({}),ae=[{label:"清除此阶段内的所有客户",value:g.CLEAR},{label:"将此阶段内的客户转移到别的阶段",value:g.TRANSFER},{label:"将此阶段内的客户转移到别的周期阶段中",value:g.TRANSFER_TO_CYCLE},{label:"给此阶段内的客户群发消息（内测中）",value:g.SEND_MESSAGE,disabled:!0}],oe=Fe(),R=W(()=>c.value[x.value].members),le=W(()=>{var t;return(t=y.value.find(e=>e.id==o.flow_id))==null?void 0:t.key_stages}),M=W(()=>c.value[x.value].stage_id),B=p(!1),O=p(),re=async(t,e)=>{var n;if(x.value=e,t===g.CLEAR){if(R.value.length==0){h.msgWarning("此阶段内没有数据");return}oe.$confirm({title:"是否确认清除此阶段内的所有客户？",message:"删除选择的此阶段的客户后，这些删除的客户将不会出现在此阶段中，且该操作不可逆。",onConfirm:async()=>{try{await $e({wechat_id:o.wechat_id,flow_id:o.flow_id,stage_id:M.value,friend_id:R.value.map(d=>d.friend_id)}),b(),h.msgSuccess("清空成功")}catch(d){h.msgError(d)}}});return}else if(t==g.SEND_MESSAGE){h.msgWarning("该功能暂未开放");return}B.value=!0,await A(),(n=O.value)==null||n.open(t)},j=J(),U=p(!1),ie=async t=>{var e;ee.value={UserName:t.friend_id},X.value={...E.value.find(n=>n.wechat_id==o.wechat_id)},G.value={...G.value,...t},U.value=!0,await A(),(e=j.value)==null||e.open()},ne=async t=>{try{await K({...t,wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:R.value.map(e=>e.friend_id)}),b(),h.msgSuccess("转移成功")}catch(e){h.msgError(e)}},q=J(),$=p(!1),x=p(-1),de=async t=>{var e;x.value=t,$.value=!0,await A(),(e=q.value)==null||e.open()},ce=async t=>{const e=t.map(d=>d.friend_id),n=c.value[x.value].stage_id;try{await Ne({wechat_id:o.wechat_id,flow_id:o.flow_id,friend_id:e,stage_id:n}),b()}catch(d){h.msgError(d)}};let Y=[];const ue=()=>{c.value.forEach((t,e)=>{const n=I.value[e];if(n){const d=Ae.create(n,{group:"sharedGroup",animation:150,forceFallback:!0,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:F=>me(F,e)});Y.push(d)}})},me=async(t,e)=>{const{oldIndex:n,newIndex:d,from:F,to:V}=t,k=c.value[e],T=k.members.splice(n,1),C=c.value.findIndex((ft,ve)=>I.value[ve]===V);C!==-1&&c.value[C].members.splice(d,0,...T);const l=c.value[C],z=l.members[d],m=k.stage_id,r=l.stage_id,H={wechat_id:o.wechat_id,flow_id:o.flow_id,to_flow_id:o.flow_id,friend_id:[z.friend_id],stage_id:m,to_stage_id:r};await K(H),b()},pe=(t,e)=>{I.value[e]=t},E=p([]),_e=async()=>{const{lists:t}=await Te({page_size:999});E.value=t},N=async()=>{const t=await Ve(o);c.value=t.sub_stage_list},fe=async()=>{await Promise.all([_e(),te()]),E.value.length>0&&(o.wechat_id=E.value[0].wechat_id),y.value.length>0&&(o.flow_id=y.value[0].id),b()},b=async()=>{D.value=!0;try{await N(),await A(),await ue()}finally{D.value=!1}};return ge(fe),ye(()=>{Y.forEach(t=>t.destroy())}),(t,e)=>{const n=Ce,d=Se,F=Ie,V=Re,k=Be,T=Ue,C=Le;return i(),u(w,null,[s("div",Me,[s("div",Oe,[s("div",je,[f(a(Q),{modelValue:a(o).wechat_id,"onUpdate:modelValue":e[0]||(e[0]=l=>a(o).wechat_id=l),placeholder:"请选择微信",class:"!w-[200px]",onChange:N},{prefix:_(()=>[...e[5]||(e[5]=[s("div",null,"选择微信",-1)])]),default:_(()=>[(i(!0),u(w,null,S(a(E),l=>(i(),v(a(Z),{key:l.id,label:l.wechat_nickname,value:l.wechat_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(a(Q),{modelValue:a(o).flow_id,"onUpdate:modelValue":e[1]||(e[1]=l=>a(o).flow_id=l),placeholder:"请选择客户流程",class:"!w-[200px]",onChange:N},{prefix:_(()=>[...e[6]||(e[6]=[s("div",null,"客户流程",-1)])]),default:_(()=>[(i(!0),u(w,null,S(a(y),l=>(i(),v(a(Z),{key:l.id,label:l.flow_name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),xe((i(),u("div",qe,[a(c).length>0?(i(),v(k,{key:0},{default:_(()=>[s("div",Ye,[(i(!0),u(w,null,S(a(c),({members:l,sub_stage_name:z},m)=>(i(),u("div",{key:m,class:"rounded-md border border-[#E0E0E0] w-[243px] flex flex-col flex-shrink-0 overflow-hidden"},[s("div",Je,[s("div",Ke,[s("div",{class:"h-full",style:Ee({width:`${(m+1)/a(c).length*100}%`,backgroundColor:"var(--color-primary)"})},null,4)]),s("div",Ze,[s("div",Qe,[f(n,{name:"el-icon-LocationFilled",color:"var(--color-primary)",size:20}),s("span",Xe,L(z),1)]),f(F,{trigger:"click","show-arrow":!1,"popper-class":"!w-[290px] !rounded-lg !p-0"},{reference:_(()=>[f(d,{type:"primary",link:""},{default:_(()=>[...e[7]||(e[7]=[be("操作",-1)])]),_:1})]),default:_(()=>[s("div",et,[s("div",tt,[(i(),u(w,null,S(ae,r=>s("div",{key:r.value,class:ke(["flex items-center gap-2 h-9 px-4 cursor-pointer hover:bg-primary-light-9 hover:text-primary",{"bg-primary-light-8 text-primary":a(se)[m]===r.value}]),onClick:H=>re(r.value,m)},L(r.label),11,st)),64))])])]),_:2},1024)]),s("div",{class:"flex items-center justify-center gap-x-4 bg-primary-light-9 p-2 rounded-md mx-2 mt-6 cursor-pointer",onClick:r=>de(m)},[f(n,{name:"local-icon-add_box_fill",color:"var(--color-primary)",size:20}),e[8]||(e[8]=s("span",{class:"text-primary"},"添加用户",-1))],8,at)]),s("div",ot,[f(k,null,{default:_(()=>[s("div",{class:"p-4 flex flex-col gap-4 h-full",ref_for:!0,ref:r=>pe(r,m),"data-index":m},[(i(!0),u(w,null,S(l,r=>(i(),u("div",{key:`List${m+1}-Item${r.friend_id}`,class:"flex gap-x-4 p-3 bg-white shadow-lighter mb-2 rounded cursor-move",onClick:H=>ie(r)},[s("div",it,[r.avatar?(i(),u("img",{key:0,class:"w-12 h-12 rounded-md",src:r.avatar},null,8,nt)):(i(),v(V,{key:1,size:48,src:r.avatar,shape:"square",icon:"el-icon-UserFilled"},null,8,["src"]))]),s("div",null,[s("div",dt,L(r.remark||"-"),1),s("div",ct," 微信昵称："+L(r.nickname),1),s("div",ut," 微信ID："+L(r.friend_id),1)])],8,rt))),128))],8,lt)]),_:2},1024)])]))),128))])]),_:1})):(i(),u("div",mt,[f(T,{description:"暂无数据"})]))])),[[C,a(D)]])]),a($)?(i(),v(ze,{key:0,ref_key:"addFriendRef",ref:q,"wechat-id":a(o).wechat_id,onClose:e[2]||(e[2]=l=>$.value=!1),onSuccess:ce},null,8,["wechat-id"])):P("",!0),a(U)?(i(),v(He,{key:1,ref_key:"userDetailRef",ref:j,onClose:e[3]||(e[3]=l=>U.value=!1)},null,512)):P("",!0),a(B)?(i(),v(We,{key:2,ref_key:"boardHandleRef",ref:O,"wechat-id":a(o).wechat_id,"flow-id":a(o).flow_id,"stage-id":a(M),"flow-lists":a(y),"stage-lists":a(le),onClose:e[4]||(e[4]=l=>B.value=!1),onConfirm:ne},null,8,["wechat-id","flow-id","stage-id","flow-lists","stage-lists"])):P("",!0)],64)}}});const ys=De(pt,[["__scopeId","data-v-c6f51c67"]]);export{ys as default};
