import{E as Ee,a as be}from"./el-tabs.4663b04e.js";import{d as Ce,r as c,aF as Z,c as X,cq as Se,G as _,o as Ve,k as d,l as v,m as n,q as s,Z as l,aI as j,s as i,bK as K,v as $,Y as Pe,t as R,J as H,I as E,L as z,$ as Fe,K as Le,aH as M,ax as $e,au as Re,y as ze,cP as Ie,cQ as Ue,u as Be,_ as We}from"./entry.d9d53b29.js";import{a as Ne,E as Ae}from"./index.9a037d22.js";import{_ as De}from"./index.vue.930f6062.js";import{E as je,a as Ke}from"./index.79f7263c.js";/* empty css                        *//* empty css               *//* empty css                  *//* empty css                     */import{u as ee}from"./usePaging.64764a63.js";import{t as He,a8 as Me,i as Oe,a9 as qe,z as Ge,aa as Je,ab as Qe}from"./person_wechat.8bcf26fc.js";import{s as Ye,a as Ze}from"./vue-virtual-scroller.esm.4d447b5a.js";/* empty css                             */import{_ as Xe}from"./edit.vue.c50acb8d.js";import{_ as ea}from"./sidebar-panel.vue.1471e6a4.js";import"./strings.fbd015b4.js";import"./index.85329892.js";import"./index.050c9b6b.js";import"./_baseIteratee.73cb21ab.js";import"./debounce.39f38609.js";import"./index.4538c991.js";import"./index.8a3302e5.js";const aa={class:"h-full flex"},ta={class:"w-[320px] flex-shrink-0 rounded-xl bg-white flex overflow-hidden"},la={class:"w-[94px] flex-shrink-0"},sa={class:"flex-1 flex flex-col overflow-hidden"},na={class:"flex-shrink-0"},oa={class:"flex justify-center"},ia={class:"grow min-h-0 w-full"},ra=["onClick"],ca={key:0},da={key:0,class:"text-ellipsis overflow-hidden whitespace-nowrap"},ua=["onClick"],pa={class:"flex-shrink-0 p-3 flex flex-col gap-2 items-center"},_a={class:"text-[#9E9E9E] text-xs mr-2"},fa={class:"grow min-h-0 bg-white ml-4 rounded-xl overflow-hidden"},ga={class:"flex flex-col h-full"},ma={class:"flex-shrink-0"},va={class:"h-[70px] flex items-center justify-between gap-x-2 px-4"},ha={class:"grow min-h-0"},wa=["src"],ya={class:"p-4 flex justify-end"},xa=Ce({__name:"manual",setup(ka){const ae=Be(),I=c("tag"),O=c([]),h=c({}),C=Z({page_no:1,page_size:15,wechat_id:""}),{pager:u,getLists:te,resetPage:S}=ee({fetchFun:He,params:C,isScroll:!0}),o=c([]),b=c(null),w=c(!1),f=Z({tag_ids:"",friend_nickname:"",wechat_id:""}),{pager:y,getLists:q,resetPage:T}=ee({fetchFun:Me,params:f}),g=c(),m=c([]),x=c([]),U=c(!1),B=c(),G=c(),le=X(()=>u.lists.filter(a=>a.id!==0)),se=X(()=>o.value.length==1&&o.value[0]==b.value),ne=async()=>{var a;await oe(),C.wechat_id=(a=h.value)==null?void 0:a.wechat_id,await J(),q()},oe=async()=>{try{const{lists:a}=await Ge({page_size:999});O.value=a,h.value=a.find(e=>e.wechat_status==1)}catch{_.msgError("获取微信列表失败")}},J=async()=>{if(await S(),u.lists.length>0){const a=u.lists[0].id;b.value=a,o.value=[a]}else b.value=null,o.value=[]},ie=()=>{var a;m.value=[],(a=g.value)==null||a.clearSelection(),M(()=>{y.lists.forEach(e=>{var r;(r=g.value)==null||r.toggleRowSelection(e)})})},re=async a=>{var e;h.value=a,C.wechat_id=a.wechat_id,f.tag_ids="",f.wechat_id=a.wechat_id,f.friend_nickname="",o.value=[],m.value=[],w.value=!1,(e=g.value)==null||e.clearSelection(),await J(),T()},ce=async a=>{var r;if(w.value)return;if((r=g.value)==null||r.clearSelection(),a==0){o.value=[0],m.value=[],f.tag_ids="",T();return}o.value=o.value.filter(k=>k!==0);const e=o.value.indexOf(a);e>-1?o.value.length>1&&o.value.splice(e,1):o.value.push(a),f.tag_ids=o.value.join(","),await T()},de=()=>{o.value=[b.value],f.friend_nickname=""},ue=a=>{if(u.isLoad||u.loading)return;const{scrollHeight:e,clientHeight:r,scrollTop:k}=a.target;e-r-k<1&&(C.page_no++,te())},pe=async()=>{var a,e;U.value=!0,await M(),(a=B.value)==null||a.open(),(e=B.value)==null||e.setFormData({wechat_id:h.value.wechat_id})},_e=async a=>{await ae.$confirm({message:"确定要删除该标签吗？",onConfirm:async()=>{try{await Je({id:a}),u.lists=u.lists.filter(e=>e.id!==a),await T(),ie(),u.lists.length==1&&(o.value=[b.value]),_.msgSuccess("删除成功")}catch(e){_.msgError(e)}}})},fe=async a=>{if(!a.tag_name.trim()){_.msgWarning("标签名不能为空"),S();return}try{await Qe({id:a.id,tag_name:a.tag_name}),_.msgSuccess("修改成功")}catch(e){_.msgError(e)}},W=async()=>{var e,r;await T();const a=(e=g.value)==null?void 0:e.getSelectionRows();(r=g.value)==null||r.clearSelection(),a.forEach(k=>{var p;(p=g.value)==null||p.toggleRowSelection(k)})},ge=a=>{m.value=a},N=c(!1),V=c("add"),A=async(a,e)=>{var r;V.value=a,N.value=!0,await M(),(r=G.value)==null||r.open(),e&&(m.value=[e])},Q=()=>{N.value=!1,x.value=[]},{isLock:me,lockFn:ve}=Se(async()=>{var a;if(m.value.length===0)return _.msgWarning("请选择要分配标签的好友");if(x.value.length===0)return _.msgWarning("请选择要分配的标签");try{V.value=="add"?await Oe({tag_ids:x.value,friend_ids:m.value.map(e=>e.friend_id),wechat_id:h.value.wechat_id}):await qe({tag_id:x.value,friend_id:m.value.map(e=>e.friend_id),wechat_id:h.value.wechat_id}),m.value=[],_.msgSuccess("保存成功"),(a=g.value)==null||a.clearSelection(),Q(),S(),T()}catch(e){_.msgError(e)}});return Ve(async()=>{await ne()}),(a,e)=>{const r=Ee,k=be,p=$e,Y=Re,P=ze,F=Ae,he=De,we=je,ye=Ke,xe=Ie,D=Ue;return d(),v(H,null,[n("div",aa,[n("div",ta,[n("div",la,[s(ea,{"current-wechat":l(h),"wechat-list":l(O),"show-add-we-chat":!1,"onUpdate:currentWechat":re},null,8,["current-wechat","wechat-list"])]),j((d(),v("div",sa,[n("div",na,[s(k,{modelValue:l(I),"onUpdate:modelValue":e[0]||(e[0]=t=>K(I)?I.value=t:null)},{default:i(()=>[s(r,{label:"标签管理",name:"tag"})]),_:1},8,["modelValue"]),n("div",oa,[s(p,{type:"primary",link:"",onClick:de},{default:i(()=>e[8]||(e[8]=[$(" 取消已勾选的标签 ",-1)])),_:1,__:[8]})])]),n("div",ia,[s(l(Ze),{class:"dynamic-scroller w-full h-full",items:l(u).lists,"min-item-size":37,onScroll:ue},{default:i(({item:t,index:ke,active:Te})=>[s(l(Ye),{class:"px-6 py-4 relative",item:t,active:Te,"size-dependencies":[t.tag_name]},{default:i(()=>[n("div",{class:Pe(["tag-item",[l(o).includes(t.id)?"border-[transparent] bg-primary text-white is-selected":"border-primary border-dashed text-primary"]]),onClick:L=>ce(t.id)},[t.id==0?(d(),v("div",ca,R(t.tag_name),1)):(d(),v(H,{key:1},[l(w)?(d(),E(Y,{key:1,modelValue:t.tag_name,"onUpdate:modelValue":L=>t.tag_name=L,class:"w-full tag-input",autofocus:"",onBlur:L=>fe(t)},null,8,["modelValue","onUpdate:modelValue","onBlur"])):(d(),v("span",da,R(t.tag_name),1))],64)),n("span",null,"（"+R(t.friend_count)+"）",1)],10,ra),l(w)&&t.id!==0?(d(),v("div",{key:0,class:"absolute top-2 right-2 cursor-pointer",onClick:L=>_e(t.id)},[s(P,{name:"local-icon-close_circle_fill",color:"var(--el-color-error)",size:16})],8,ua)):z("",!0)]),_:2},1032,["item","active","size-dependencies"])]),_:1},8,["items"])]),n("div",pa,[s(p,{type:"primary",onClick:pe},{default:i(()=>[s(P,{name:"local-icon-add_box_fill",color:"#ffffff"}),e[9]||(e[9]=n("span",{class:"ml-2"},"添加标签",-1))]),_:1,__:[9]}),s(p,{link:"",color:"#9E9E9E",onClick:e[1]||(e[1]=t=>w.value=!l(w))},{default:i(()=>[n("span",_a,R(l(w)?"取消编辑":"编辑标签"),1),s(P,{name:"el-icon-Edit",color:"#9E9E9E"})]),_:1})])])),[[D,l(u).loading]])]),j((d(),v("div",fa,[n("div",ga,[n("div",ma,[n("div",va,[s(Y,{modelValue:l(f).friend_nickname,"onUpdate:modelValue":e[2]||(e[2]=t=>l(f).friend_nickname=t),placeholder:"搜索",class:"!w-[200px] h-[32px]",clearable:"",onClear:W,onKeyup:Fe(W,["enter"])},{append:i(()=>[s(p,{onClick:W},{default:i(()=>[s(P,{name:"el-icon-Search"})]),_:1})]),_:1},8,["modelValue"]),n("div",null,[s(p,{type:"danger",onClick:e[3]||(e[3]=t=>A("remove"))},{default:i(()=>e[10]||(e[10]=[$(" 批量移除标签 ",-1)])),_:1,__:[10]}),s(p,{type:"primary",onClick:e[4]||(e[4]=t=>A("add"))},{default:i(()=>e[11]||(e[11]=[$(" 批量新增标签 ",-1)])),_:1,__:[11]})])])]),n("div",ha,[j((d(),E(l(Ne),{ref_key:"friendTableRef",ref:g,data:l(y).lists,stripe:"",height:"100%","row-key":"friend_id","row-style":{height:"60px"},"header-row-style":{height:"63px"},onSelectionChange:ge},{default:i(()=>[s(F,{type:"selection","reserve-selection":"",width:"55",fixed:"left"}),s(F,{prop:"friend_nickname",label:"微信名称"}),s(F,{prop:"friend_avatar",label:"头像"},{default:i(({row:t})=>[n("img",{src:t.friend_avatar,class:"w-8 h-8 rounded mx-auto"},null,8,wa)]),_:1}),l(se)?z("",!0):(d(),E(F,{key:0,label:"操作",width:"160"},{default:i(({row:t})=>[s(p,{type:"primary",link:"",onClick:ke=>A("remove",t)},{default:i(()=>e[12]||(e[12]=[$(" 从已选标签中移除 ",-1)])),_:2,__:[12]},1032,["onClick"])]),_:1}))]),_:1},8,["data"])),[[D,l(y).loading]])]),n("div",ya,[s(he,{modelValue:l(y),"onUpdate:modelValue":e[5]||(e[5]=t=>K(y)?y.value=t:null),onChange:l(q)},null,8,["modelValue","onChange"])])])])),[[D,l(y).loading]])]),l(U)?(d(),E(Xe,{key:0,ref_key:"editTagPopupRef",ref:B,onClose:e[6]||(e[6]=t=>U.value=!1),onSuccess:l(S)},null,8,["onSuccess"])):z("",!0),l(N)?(d(),E(xe,{key:1,title:l(V)=="add"?"分配标签":"移除标签",ref_key:"tagPopupRef",ref:G,async:"","confirm-loading":l(me),onConfirm:l(ve),onClose:Q},{default:i(()=>[n("div",null,[s(ye,{modelValue:l(x),"onUpdate:modelValue":e[7]||(e[7]=t=>K(x)?x.value=t:null),placeholder:l(V)=="add"?"请选择要分配标签":"请选择要移除标签",multiple:"",filterable:""},{default:i(()=>[(d(!0),v(H,null,Le(l(le),t=>(d(),E(we,{key:t.id,label:t.tag_name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])])]),_:1},8,["title","confirm-loading","onConfirm"])):z("",!0)],64)}}});const Ma=We(xa,[["__scopeId","data-v-28e1cb72"]]);export{Ma as default};
