import{ca as h}from"./entry.f4f46cb5.js";class u{constructor(t={}){this.config=t,this.mermaidInstance=null,this.isLoading=!1,this.lastValidResult="",this.viewStateMap=new WeakMap,this.containerHeight=400}async loadMermaid(){if(this.mermaidInstance)return this.mermaidInstance;if(this.isLoading)return new Promise(t=>{const e=()=>{this.mermaidInstance?t(this.mermaidInstance):setTimeout(e,50)};e()});this.isLoading=!0;try{const{default:t}=await h(()=>import("./index.vue.9649ae9f.js").then(e=>e.m),["./index.vue.9649ae9f.js","./entry.f4f46cb5.js","./entry.3f39d9a2.css","./debounce.640f3738.js","./toNumber.d5c70aa7.js","./index.3864ff87.js","./index.55f66020.css"],import.meta.url);return t.initialize({theme:this.config.theme||"default",startOnLoad:!1,suppressErrorRendering:!0,...this.config}),this.mermaidInstance=t,t}catch(t){throw console.error("Failed to load mermaid:",t),new Error("Failed to load mermaid library")}finally{this.isLoading=!1}}async renderToContainer(t,e,a="light"){const i=await this.renderMermaid(e,a);t.innerHTML=i;const s=t.querySelector("svg");s&&(this.initViewState(t,s),this.applyTransform(t,s),s.addEventListener("mousedown",r=>this.onSvgMouseDown(r,t,s)))}initViewState(t,e){let a=e.getAttribute("viewBox"),i=0,s=0;if(a){const l=a.split(/\s+/);i=parseFloat(l[2]),s=parseFloat(l[3])}else i=e.width.baseVal.value||e.getBoundingClientRect().width,s=e.height.baseVal.value||e.getBoundingClientRect().height;const r=t.clientWidth||0,n=this.containerHeight;let o=1;i&&s&&r&&n&&(o=Math.min(r/i,n/s,1)),this.viewStateMap.set(t,{scale:o,offsetX:0,offsetY:0,dragging:!1,dragStart:{x:0,y:0},lastOffset:{x:0,y:0}})}applyTransform(t,e){const a=this.viewStateMap.get(t);a&&(e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.transform=`translate(-50%, -50%) translate(${a.offsetX}px, ${a.offsetY}px) scale(${a.scale})`,e.style.transformOrigin="center center",e.style.cursor=a.dragging?"grabbing":"grab")}zoomIn(t){const e=t.querySelector("svg"),a=this.viewStateMap.get(t);e&&a&&(a.scale=Math.min(a.scale+.2,3),this.applyTransform(t,e))}zoomOut(t){const e=t.querySelector("svg"),a=this.viewStateMap.get(t);e&&a&&(a.scale=Math.max(a.scale-.2,.2),this.applyTransform(t,e))}reset(t){const e=t.querySelector("svg");e&&(this.initViewState(t,e),this.applyTransform(t,e))}async download(t,e="diagram.png"){const a=t.querySelector("svg");if(a)try{const i=a.cloneNode(!0),s=new XMLSerializer().serializeToString(i),r=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(s)}`,n=new Image;await new Promise((d,m)=>{n.onload=()=>d(),n.onerror=c=>m(new Error("Image loading failed")),n.src=r});const o=document.createElement("canvas"),l=o.getContext("2d");if(!l)throw new Error("Canvas context not available");o.width=n.width*2,o.height=n.height*2,l.fillStyle="white",l.fillRect(0,0,o.width,o.height),l.drawImage(n,0,0),o.toBlob(d=>{if(!d){console.error("Failed to create blob from canvas");return}const m=URL.createObjectURL(d),c=document.createElement("a");c.href=m,c.download=e,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),URL.revokeObjectURL(m)},100)},"image/png")}catch(i){console.error("Failed to download diagram:",i)}}onSvgMouseDown(t,e,a){const i=this.viewStateMap.get(e);if(!i)return;i.dragging=!0,i.dragStart={x:t.clientX,y:t.clientY},i.lastOffset={x:i.offsetX,y:i.offsetY};const s=n=>this.onSvgMouseMove(n,e,a),r=()=>this.onSvgMouseUp(e,a,s,r);document.addEventListener("mousemove",s),document.addEventListener("mouseup",r),this.applyTransform(e,a)}onSvgMouseMove(t,e,a){const i=this.viewStateMap.get(e);!i||!i.dragging||(i.offsetX=i.lastOffset.x+(t.clientX-i.dragStart.x),i.offsetY=i.lastOffset.y+(t.clientY-i.dragStart.y),this.applyTransform(e,a))}onSvgMouseUp(t,e,a,i){const s=this.viewStateMap.get(t);s&&(s.dragging=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i),this.applyTransform(t,e))}async renderMermaid(t,e="light"){try{const a=await this.loadMermaid();this.config.theme!==e&&(this.config.theme=e,a.initialize({startOnLoad:!1,suppressErrorRendering:!0,theme:e==="dark"?"dark":"default",...this.config}));const i=`mc_mermaid_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{svg:s}=await a.render(i,t);return this.lastValidResult=s,s}catch{return this.lastValidResult}}}export{u as MermaidService};
