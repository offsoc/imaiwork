"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),n=require("../../../../api/app.js"),r=require("../../../../api/digital_human.js"),o=require("../../enums/index.js"),a=require("../../../../stores/user.js"),u=require("../../../../stores/app.js"),t=require("../../hooks/useUpload.js"),s=require("../../../../utils/file.js"),c=require("../../../../hooks/usePolling.js"),l=require("../../../../enums/appEnums.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-popup")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const d=e.defineComponent({__name:"anchor_create",setup(d){const p=a.useUserStore(),{userTokens:m}=e.toRefs(p),h=u.useAppStore(),v=e.computed((()=>h.config.is_oss_transcode)),f=e.reactive({name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM"),pic:"",url:"",width:0,height:0,anchor_id:""}),g=e.reactive({name:e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM"),pic:"",url:""}),_=e.ref({}),w=e.ref(!1),j=e.ref([]),x=e.ref(),A=e.ref(!1),y=["mp4","mov"],q=e.shallowRef(),T=e.computed((()=>{var e,i;const n=null==(e=p.getTokenByScene(l.TokensSceneEnum.HUMAN_AVATAR_SHANJIAN))?void 0:e.score,r=null==(i=p.getTokenByScene(l.TokensSceneEnum.HUMAN_AVATAR_CHANJING))?void 0:i.score;return parseFloat(n)+parseFloat(r)})),k=e.computed((()=>x.value==o.DigitalHumanModelVersionEnum.CHANJING)),E=e.computed((()=>(k.value||g.url)&&f.url)),L=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/video_upload/video_upload",params:{type:o.ModeTypeEnum.ANCHOR}})},H=()=>{e.index.showActionSheet({itemList:["录制授权视频","从手机相册选择","选择历史授权视频"],success:async i=>{if(0===i.tapIndex){if(!(await s.requestAuthorization("scope.camera")))return void e.index.$u.toast("您关闭了权限，请前往设置打开权限");e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_auth_camera/anchor_auth_camera"})}else 1===i.tapIndex?b():2===i.tapIndex&&e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_auth_video/anchor_auth_video"})}})},N=async e=>new Promise((async(i,r)=>{try{const r=await n.videoTranscode({video_url:e}),{start:o,end:a}=c.usePolling((async()=>{try{const e=await n.getVideoTranscodeResult({jobid:r.jobid});"TranscodeSuccess"==e.state?(a(),i(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(a(),i(!1))}catch(e){a(),i(!1)}}),{});j.value.push(a),await o()}catch(o){i(!1)}})),b=()=>{const{upload:i}=t.useUpload({duration:[1,120],extension:y,onProgress:i=>{e.index.showLoading({title:"视频上传中",mask:!0})},onSuccess:async i=>{e.index.hideLoading(),e.index.showToast({title:"视频上传成功",icon:"none",duration:3e3}),g.pic=i.pic,g.url=i.url,g.width=i.width,g.height=i.height},onError:i=>{const{type:n,error:r}=i;e.index.hideLoading(),"video"==n&&e.index.showToast({title:r||"视频上传失败",icon:"none",duration:3e3})}});i()},C=async()=>{var i;if(m.value<=T.value)return void(null==(i=q.value)||i.open());if(!f.url)return void e.index.showToast({title:"请上传形象视频",icon:"none",duration:3e3});if(!g.url)return void e.index.showToast({title:"请上传授权视频",icon:"none",duration:3e3});if(e.index.showLoading({title:"创建形象中...",mask:!0}),v.value)try{Promise.allSettled([await N(f.url),await N(g.url)])}catch(n){}try{const[i,n]=await Promise.allSettled([new Promise((async(e,i)=>{await r.createShanjianAnchor({name:f.name,pic:f.pic,anchor_url:f.url,authorized_pic:g.pic,authorized_url:g.url}).then((async i=>{e(i)})).catch((e=>{i(!1)}))})),new Promise((async(e,i)=>{await r.createAnchor({name:f.name,url:f.url,pic:f.pic,model_version:o.DigitalHumanModelVersionEnum.CHANJING,width:f.width,height:f.height}).then((i=>{e(i)})).catch((e=>{i(!1)}))}))]),a=x.value==o.DigitalHumanModelVersionEnum.SHANJIAN;if(x.value)if(a){const{start:n,end:o}=c.usePolling((async()=>{_.value=await r.getShanjianAnchorDetail({id:i.value.id});const{status:n}=_.value;if(2==n||3==n||5==n||6==n)return e.index.hideLoading(),w.value=!0,A.value=3==n||6==n,void o()}));j.value.push(o),n()}else k.value&&(e.index.hideLoading(),w.value=!0,f.anchor_id=n.value.id,f.model_version=o.DigitalHumanModelVersionEnum.CHANJING,A.value=!!n.value);else e.index.hideLoading(),w.value=!0,A.value=!0}catch(n){A.value=!1,e.index.hideLoading()}},M=()=>{A.value?(e.index.$emit("confirm",{type:o.ListenerTypeEnum.CREATE_ANCHOR,data:o.DigitalHumanModelVersionEnum.SHANJIAN==x.value?_.value:f}),e.index.navigateBack()):(g.pic="",g.url="",g.name="",g.width=0,g.height=0,g.anchor_id="",w.value=!1)};return e.onLoad((i=>{i.source&&(x.value=i.source),e.index.$on("confirm",(e=>{const{type:i,data:n}=e;i===o.ListenerTypeEnum.VIDEO_UPLOAD&&(e=>{f.name=e.name,f.pic=e.pic,f.url=e.url,f.width=e.width,f.height=e.height})(n),i!==o.ListenerTypeEnum.ANCHOR_AUTH&&i!==o.ListenerTypeEnum.UPLOAD_AUTH_CAMERA||(e=>{g.name=e.name,g.pic=e.pic,g.url=e.url})(n)}))})),e.onUnload((()=>{e.index.hideLoading(),j.value.forEach((e=>e())),j.value=[]})),(n,r)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.unref(f).pic},e.unref(f).pic?{c:e.o(L)}:{},{d:!e.unref(f).pic},e.unref(f).pic?{j:e.unref(f).url,k:e.unref(f).pic}:{e:i._imports_0$13,f:e.t(e.unref(t.commonUploadLimit).videoMinDuration),g:e.t(e.unref(t.commonUploadLimit).videoMaxDuration),h:e.t(e.unref(t.commonUploadLimit).size),i:e.o(L)},{l:e.unref(g).pic},e.unref(g).pic?{m:e.o(H)}:{},{n:!e.unref(g).pic},e.unref(g).pic?{q:e.unref(g).url,r:e.unref(g).pic}:{o:i._imports_0$13,p:e.o(H)},{s:e.t(e.unref(T)),t:e.n(e.unref(E)?"bg-black":"bg-_h787878CC_"),v:e.o(C),w:e.p({name:e.unref(A)?"checkmark":"error",color:"#ffffff",size:"28"}),x:e.t(e.unref(A)?"克隆成功":e.unref(_).remark||"创建失败"),y:e.o(M),z:e.o((i=>e.isRef(w)?w.value=i:null)),A:e.p({mode:"center","border-radius":"48",width:"90%","mask-close-able":!1,modelValue:e.unref(w)}),B:e.sr(q,"1824b2d7-3",{k:"rechargePopupRef"})})}}),p=e._export_sfc(d,[["__scopeId","data-v-1824b2d7"]]);wx.createPage(p);
