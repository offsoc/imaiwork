"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),u=require("../../../../api/app.js"),a=require("../../../../api/digital_human.js"),o=require("../../../../hooks/useAudio.js"),i=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),d=require("../../enums/index.js"),m=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("data-select")+e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const p=e.defineComponent({__name:"tone_clone",setup(p){const f=s.useAppStore(),v=l.useUserStore(),{userTokens:_}=e.toRefs(v),g=e.ref(),h=e.computed((()=>{const{channel:e}=f.getDigitalHumanConfig;return e&&e.length>0?e.filter((e=>1==e.status&&e.id==d.DigitalHumanModelVersionEnum.CHANJING)).map((e=>({text:e.name,value:e.id}))):[]})),y=e.computed((()=>{var e,r,n,u,a;return{[d.DigitalHumanModelVersionEnum.STANDARD]:null==(e=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[d.DigitalHumanModelVersionEnum.SUPER]:null==(r=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_PRO))?void 0:r.score,[d.DigitalHumanModelVersionEnum.ADVANCED]:null==(n=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ADVANCED))?void 0:n.score,[d.DigitalHumanModelVersionEnum.ELITE]:null==(u=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ELITE))?void 0:u.score,[d.DigitalHumanModelVersionEnum.CHANJING]:null==(a=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:a.score}[j.model_version]})),j=e.reactive({url:"",name:"",gender:"male",model_version:""}),q=[{name:"男声",value:"male"},{name:"女声",value:"female"}],E=e.ref(!1),x=async e=>{"record"==e?(await k(),M.value=3,E.value=!0,R(j.url)):"transcribe"==e&&(M.value=1,E.value=!0)},k=async()=>{const e=await n.chooseFile({type:"file",extension:["mp3","wav","m4a"]});await C(e)},w=r=>!(r>20971520)||(e.index.$u.toast("音频文件大小不能超过20M"),!1),C=async e=>{const{tempFiles:r}=e,{size:n}=r[0];w(n)&&await b(r[0].path)},b=async r=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:e}=await u.uploadFile("audio",{filePath:r});j.url=e}catch(n){e.index.showToast({title:n||"上传失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},A=e.ref(0),T=e.ref(null),D=e.ref(0),{authorize:V,isRecording:$,start:B,stop:H,close:S}=i.useRecorder({onstart:()=>{N()},onstop:async e=>{const{tempFilePath:r,fileSize:n}=e;w(n)&&(clearInterval(T.value),await b(r),R(r),M.value=3)},onerror:e=>{F()}},{duration:6e4}),M=e.ref(1),I=async r=>{if(2!=M.value||j.url||1!=r){if($.value){if(!(await e.index.showModal({title:"提示",content:"当前录制中，是否继续录制？"})).confirm)return;$.value=!1,S(),F()}M.value+=r,0==M.value?(A.value=0,E.value=!1):M.value}else e.index.$u.toast("请先上传音频")},N=()=>{F(),T.value=setInterval((()=>{D.value+=1}),1e3)},F=()=>{D.value=0,clearInterval(T.value)},U=async r=>{switch(r){case"play":await V(),$.value?H():B();break;case"cancel":$.value=!1,S(),F();break;case"done":if(D.value<15)return void e.index.$u.toast("录制时间不能少于15秒");H(),M.value=2}},{setUrl:R,isPlaying:P,play:L,pause:O,destroy:z}=o.useAudio(),G=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"redirect"})};return e.watch((()=>f.getDigitalHumanConfig),(e=>{e&&e.length>0&&(j.model_version=e[0].id)}),{immediate:!0}),(n,u)=>e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((r=>e.unref(j).name=r)),c:e.p({placeholder:"请输入音色名称",modelValue:e.unref(j).name}),d:e.f(q,((n,u,a)=>e.e({a:e.t(n.name),b:e.unref(j).gender===n.value},e.unref(j).gender===n.value?{c:r._imports_2$3}:{d:r._imports_3$3},{e:e.unref(j).gender===n.value?"#0065FB":"#e5e5e5",f:e.unref(j).gender===n.value?"#0065FB":"#6a6a6a",g:u,h:e.o((r=>e.unref(j).gender=n.value),u)}))),e:e.o((r=>e.unref(j).model_version=r)),f:e.p({placeholder:"请选择模型",localdata:e.unref(h),modelValue:e.unref(j).model_version}),g:e.unref(E)},e.unref(E)?e.e({h:1==e.unref(M)},1==e.unref(M)?{i:e.f(e.unref(m.cratedVoiceCopywriter),((r,n,u)=>({a:e.t(r),b:n,c:e.unref(A)===n?"#0065FB":"#EBEBEB",d:e.unref(A)===n?"#0065FB":"#D9D9D9",e:e.o((e=>A.value=n),n)})))}:{},{j:2==e.unref(M)},2==e.unref(M)?e.e({k:e.t(e.unref(m.cratedVoiceCopywriter)[e.unref(A)]),l:e.t(e.unref(t.formatAudioTime)(e.unref(D))),m:r._imports_0$9,n:e.unref($)?"#808080":"#BFBFBF",o:e.o((e=>U("cancel"))),p:!e.unref($)},e.unref($)?{r:r._imports_4$2}:{q:r._imports_3$2},{s:e.o((e=>U("play"))),t:r._imports_5$1,v:e.unref($)?1:"",w:e.o((e=>U("done")))}):{},{x:3==e.unref(M)},3==e.unref(M)?e.e({y:r._imports_6$1,z:e.o((e=>(M.value=1,E.value=!1,$.value=!1,j.url="",z(),void F()))),A:e.unref(P)},e.unref(P)?{B:r._imports_1$5}:{C:r._imports_0$10},{D:e.o((e=>(async()=>{P.value?O():L(j.url)})()))}):{}):{},{E:!e.unref(E)},e.unref(E)?{}:{F:r._imports_9,G:e.o((e=>x("transcribe"))),H:r._imports_10,I:e.o((e=>x("record"))),J:e.t(20)},{K:e.unref(E)&&3!=e.unref(M)},e.unref(E)&&3!=e.unref(M)?e.e({L:e.unref(M)>=1&&e.unref(M)<3},e.unref(M)>=1&&e.unref(M)<3?{M:e.o((e=>I(-1))),N:e.p({shape:"circle",type:"primary"})}:{},{O:e.unref(M)>=1&&e.unref(M)<3},e.unref(M)>=1&&e.unref(M)<3?{P:e.o((e=>I(1))),Q:e.p({shape:"circle",type:"primary"})}:{}):{},{R:e.unref(j).url},e.unref(j).url?e.e({S:e.unref(y)},e.unref(y)?{T:e.t(e.unref(y))}:{},{U:e.o((r=>(async()=>{var r;if(j.name)if(j.url){if(_.value<y.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(r=g.value)||r.open());try{e.index.showLoading({title:"克隆中",mask:!0}),await a.voiceClone(j),v.getUser(),setTimeout((()=>{e.index.$u.toast("克隆成功，请在我的音色中查看"),G()}),300)}catch(n){e.index.$u.toast(n||"克隆失败")}finally{e.index.hideLoading()}}else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),V:e.p({shape:"circle",type:"primary"})}):{},{W:e.sr(g,"66cb9f14-6",{k:"rechargePopupRef"})})}}),f=e._export_sfc(p,[["__scopeId","data-v-66cb9f14"]]);wx.createPage(f);
