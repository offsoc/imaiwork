"use strict";const e=require("../../../../common/vendor.js"),n=require("../../../../common/assets.js"),o=require("../../../../components/file-upload/choose-file.js"),r=require("../../../../api/app.js"),a=require("../../../../api/digital_human.js"),u=require("../../../../hooks/useAudio.js"),i=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),m=require("../../enums/index.js"),d=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../common/vendor.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("recharge-popup")+e.resolveComponent("popup-bottom"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js")+p+(()=>"../../../../components/popup-bottom/popup-bottom.js"))();const p=()=>"../../components/choose-model/choose-model.js",v=e.defineComponent({__name:"tone_clone",setup(p){const v=s.useAppStore(),f=l.useUserStore(),{userTokens:g}=e.toRefs(f),h=e.computed((()=>{const{channel:e}=v.getDigitalHumanConfig;return e&&e.length>0?e.find((e=>e.id==j.model_version)):{}})),_=e.computed((()=>{var e,n,o,r,a;const u={[m.DigitalHumanModelVersionEnum.STANDARD]:null==(e=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[m.DigitalHumanModelVersionEnum.SUPER]:null==(n=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_PRO))?void 0:n.score,[m.DigitalHumanModelVersionEnum.ADVANCED]:null==(o=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ADVANCED))?void 0:o.score,[m.DigitalHumanModelVersionEnum.ELITE]:null==(r=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ELITE))?void 0:r.score,[m.DigitalHumanModelVersionEnum.CHANJING]:null==(a=f.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:a.score};return parseFloat(u[j.model_version])})),j=e.reactive({url:"",name:"",gender:"male",model_version:""}),q=e.ref(""),y=[{name:"男声",value:"male",icon:n.ManIcon,activeIcon:n.ManActiveIcon},{name:"女声",value:"female",icon:n.WomanIcon,activeIcon:n.WomanActiveIcon}],w=e.ref(!1),x=e.ref(!1),E=e.ref(0),k=e.ref(null),C=e.ref(0),A=e.ref(!1),{setUrl:I,isPlaying:M,play:T,pause:b,destroy:H}=u.useAudio(),{authorize:S,isRecording:V,start:D,stop:N,close:$}=i.useRecorder({onstart:()=>{G()},onstop:async e=>{if(A.value)return;const{tempFilePath:n,fileSize:o}=e;L(o)&&(clearInterval(k.value),await z(n),I(n))},onerror:e=>{J()}},{duration:6e4}),B=e.ref(),F=e=>{j.model_version=e},R=()=>{x.value=!0,A.value=!1},U=async()=>{await O(),I(j.url)},L=n=>!(n>20971520)||(e.index.$u.toast("音频文件大小不能超过20M"),!1),O=async()=>{try{const e=await o.chooseFile({type:"file",extension:["mp3","wav","m4a"]});await P(e)}catch(e){console.error("选择文件出错:",e)}},P=async n=>{var o;const{tempFiles:r}=n,{size:a,name:u}=r[0],i=null==(o=u.split(".").pop())?void 0:o.toLowerCase();i&&["mp3","m4a","wav"].includes(i)?L(a)&&await z(r[0].path):e.index.$u.toast("请上传mp3、m4a、wav格式的音频文件")},z=async n=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:e,name:o}=await r.uploadFile("audio",{filePath:n});j.url=e,q.value=o,x.value=!1}catch(o){e.index.showToast({title:o.message||"上传失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},G=()=>{J(),k.value=setInterval((()=>{C.value+=1}),1e3)},J=()=>{C.value=0,clearInterval(k.value)},W=async()=>{await S(),V.value||D()},K=()=>{C.value<15?e.index.$u.toast("录制时间不能少于15秒"):N()},Q=()=>{V.value=!1,x.value=!1,A.value=!0,N(),H(),J(),$()},X=()=>{V.value=!1,x.value=!1,A.value=!1,j.url="",q.value="",N(),H(),J(),$()},Y=()=>{E.value=Math.floor(Math.random()*d.cratedVoiceCopywriter.length)},Z=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/clone_manage/clone_manage",type:"redirect"})};return e.watch((()=>v.getDigitalHumanConfig.channel),(e=>{var n;e&&e.length>0&&(j.model_version=null==(n=e.find((e=>e.id==m.DigitalHumanModelVersionEnum.CHANJING)))?void 0:n.id)}),{immediate:!0}),(o,r)=>{var u;return e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((n=>e.unref(j).name=n)),c:e.p({placeholder:"请输入音色名称",maxlength:"30",clearable:!0,modelValue:e.unref(j).name}),d:e.f(y,((n,o,r)=>e.e({a:e.unref(j).gender===n.value},e.unref(j).gender===n.value?{b:n.activeIcon}:{c:n.icon},{d:e.t(n.name),e:e.n(e.unref(j).gender===n.value?"border-_h0065FB_ text-primary":"border-_transparent_ text-_h00000080_"),f:o,g:e.o((e=>{return o=n.value,void(j.gender=o);var o}),o)}))),e:e.t((null==(u=e.unref(h))?void 0:u.name)||"请选择"),f:e.p({name:"arrow-right",color:"#B2B2B2",size:20}),g:e.o((e=>w.value=!0)),h:e.unref(j).url},e.unref(j).url?e.e({i:n._imports_0$9,j:e.t(e.unref(q)),k:!e.unref(M)},e.unref(M)?{m:n._imports_1$5}:{l:n._imports_2$2},{n:e.t(e.unref(M)?"暂停":"试听"),o:e.o((e=>(async()=>{M.value?b():T()})())),p:e.o(X)}):{q:n._imports_3$3,r:e.o(R),s:n._imports_4$2,t:e.o(U)},{v:e.unref(_)},e.unref(_)?{w:e.t(e.unref(_))}:{},{x:e.o((n=>(async()=>{var n;if(j.name.trim())if(j.url)if(j.model_version){if(g.value<_.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(n=B.value)||n.open());try{e.index.showLoading({title:"克隆中",mask:!0}),await a.voiceClone(j),f.getUser(),setTimeout((()=>{e.index.$u.toast("克隆成功，请在我的音色中查看"),Z()}),300)}catch(o){e.index.$u.toast(o.message||"克隆失败")}finally{e.index.hideLoading()}}else e.index.$u.toast("请选择使用模型");else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),y:e.sr(B,"aafdcdac-3",{k:"rechargePopupRef"}),z:e.o(F),A:e.o((n=>e.isRef(w)?w.value=n:null)),B:e.p({show:e.unref(w)}),C:e.t(e.unref(d.cratedVoiceCopywriter)[e.unref(E)]),D:e.p({name:"reload",color:"#0065FB"}),E:e.o(Y),F:e.unref(V)},e.unref(V)?{G:e.t(e.unref(t.formatAudioTime)(e.unref(C)))}:{},{H:!e.unref(V)},e.unref(V)?{K:e.o(K)}:{I:n._imports_5,J:e.o(W)},{L:e.o(Q),M:e.o(X),N:e.o((n=>e.isRef(x)?x.value=n:null)),O:e.p({title:"录制声音","custom-class":"bg-_hF6F6F6_","show-footer":!1,height:"80%",show:e.unref(x)})})}}}),f=e._export_sfc(v,[["__scopeId","data-v-aafdcdac"]]);wx.createPage(f);
