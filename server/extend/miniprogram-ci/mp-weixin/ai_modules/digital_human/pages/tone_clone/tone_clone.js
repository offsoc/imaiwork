"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js"),u=require("../../../../api/app.js"),i=require("../../../../api/digital_human.js"),a=require("../../../../hooks/useAudio.js"),o=require("../../../../hooks/useRecorder.js"),t=require("../../../../utils/util.js"),s=require("../../../../stores/app.js"),l=require("../../../../stores/user.js"),c=require("../../../../enums/appEnums.js"),d=require("../../enums/index.js"),m=require("../../config/copywriter.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const p=e.defineComponent({__name:"tone_clone",setup(p){const f=s.useAppStore(),v=l.useUserStore(),{userTokens:g}=e.toRefs(v),_=e.ref();e.computed((()=>{const{channel:e}=f.getDigitalHumanConfig;return e&&e.length>0?e.filter((e=>1==e.status&&e.id==d.DigitalHumanModelVersionEnum.CHANJING)).map((e=>({text:e.name,value:e.id}))):[]}));const h=e.computed((()=>{var e,r,n,u,i;return{[d.DigitalHumanModelVersionEnum.STANDARD]:null==(e=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE))?void 0:e.score,[d.DigitalHumanModelVersionEnum.SUPER]:null==(r=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_PRO))?void 0:r.score,[d.DigitalHumanModelVersionEnum.ADVANCED]:null==(n=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ADVANCED))?void 0:n.score,[d.DigitalHumanModelVersionEnum.ELITE]:null==(u=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_ELITE))?void 0:u.score,[d.DigitalHumanModelVersionEnum.CHANJING]:null==(i=v.getTokenByScene(c.TokensSceneEnum.HUMAN_VOICE_CHANJING))?void 0:i.score}[y.model_version]})),y=e.reactive({url:"",name:"",gender:"male",model_version:""}),j=[{name:"男声",value:"male"},{name:"女声",value:"female"}],q=e.ref(!1),E=async e=>{"record"==e?(await x(),N.value=3,q.value=!0,U(y.url)):"transcribe"==e&&(N.value=1,q.value=!0)},x=async()=>{const e=await n.chooseFile({type:"file",extension:["mp3","wav","m4a"]});await w(e)},k=r=>!(r>20971520)||(e.index.$u.toast("音频文件大小不能超过20M"),!1),w=async e=>{const{tempFiles:r}=e,{size:n}=r[0];k(n)&&await C(r[0].path)},C=async r=>{e.index.showLoading({title:"上传中",mask:!0});try{const{uri:e}=await u.uploadFile("audio",{filePath:r});y.url=e}catch(n){e.index.showToast({title:n||"上传失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}},A=e.ref(0),D=e.ref(null),H=e.ref(0),{authorize:T,isRecording:b,start:$,stop:B,close:M}=o.useRecorder({onstart:()=>{V()},onstop:async e=>{const{tempFilePath:r,fileSize:n}=e;k(n)&&(clearInterval(D.value),await C(r),U(r),N.value=3)},onerror:e=>{I()}},{duration:6e4}),N=e.ref(1),S=async r=>{if(2!=N.value||y.url||1!=r){if(b.value){if(!(await e.index.showModal({title:"提示",content:"当前录制中，是否继续录制？"})).confirm)return;b.value=!1,M(),I()}N.value+=r,0==N.value?(A.value=0,q.value=!1):N.value}else e.index.$u.toast("请先上传音频")},V=()=>{I(),D.value=setInterval((()=>{H.value+=1}),1e3)},I=()=>{H.value=0,clearInterval(D.value)},F=async r=>{switch(r){case"play":await T(),b.value?B():$();break;case"cancel":b.value=!1,M(),I();break;case"done":if(H.value<15)return void e.index.$u.toast("录制时间不能少于15秒");B(),N.value=2}},{setUrl:U,isPlaying:R,play:P,pause:L,destroy:O}=a.useAudio(),G=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"redirect"})};return e.watch((()=>f.getDigitalHumanConfig),(e=>{e&&e.length>0&&(y.model_version=e[0].id)}),{immediate:!0}),(n,u)=>e.e({a:e.p({"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"},title:"音色克隆","title-bold":!0}),b:e.o((r=>e.unref(y).name=r)),c:e.p({placeholder:"请输入音色名称",modelValue:e.unref(y).name}),d:e.f(j,((n,u,i)=>e.e({a:e.t(n.name),b:e.unref(y).gender===n.value},e.unref(y).gender===n.value?{c:r._imports_2$3}:{d:r._imports_3$3},{e:e.unref(y).gender===n.value?"#0065FB":"#e5e5e5",f:e.unref(y).gender===n.value?"#0065FB":"#6a6a6a",g:u,h:e.o((r=>e.unref(y).gender=n.value),u)}))),e:e.unref(q)},e.unref(q)?e.e({f:1==e.unref(N)},1==e.unref(N)?{g:e.f(e.unref(m.cratedVoiceCopywriter),((r,n,u)=>({a:e.t(r),b:n,c:e.unref(A)===n?"#0065FB":"#EBEBEB",d:e.unref(A)===n?"#0065FB":"#D9D9D9",e:e.o((e=>A.value=n),n)})))}:{},{h:2==e.unref(N)},2==e.unref(N)?e.e({i:e.t(e.unref(m.cratedVoiceCopywriter)[e.unref(A)]),j:e.t(e.unref(t.formatAudioTime)(e.unref(H))),k:r._imports_2$2,l:e.unref(b)?"#808080":"#BFBFBF",m:e.o((e=>F("cancel"))),n:!e.unref(b)},e.unref(b)?{p:r._imports_4$2}:{o:r._imports_3$2},{q:e.o((e=>F("play"))),r:r._imports_5$1,s:e.unref(b)?1:"",t:e.o((e=>F("done")))}):{},{v:3==e.unref(N)},3==e.unref(N)?e.e({w:r._imports_6$1,x:e.o((e=>(N.value=1,q.value=!1,b.value=!1,y.url="",O(),void I()))),y:e.unref(R)},e.unref(R)?{z:r._imports_1$5}:{A:r._imports_0$7},{B:e.o((e=>(async()=>{R.value?L():P(y.url)})()))}):{}):{},{C:!e.unref(q)},e.unref(q)?{}:{D:r._imports_9,E:e.o((e=>E("transcribe"))),F:r._imports_10,G:e.o((e=>E("record"))),H:e.t(20)},{I:e.unref(q)&&3!=e.unref(N)},e.unref(q)&&3!=e.unref(N)?e.e({J:e.unref(N)>=1&&e.unref(N)<3},e.unref(N)>=1&&e.unref(N)<3?{K:e.o((e=>S(-1))),L:e.p({shape:"circle",type:"primary"})}:{},{M:e.unref(N)>=1&&e.unref(N)<3},e.unref(N)>=1&&e.unref(N)<3?{N:e.o((e=>S(1))),O:e.p({shape:"circle",type:"primary"})}:{}):{},{P:e.unref(y).url},e.unref(y).url?e.e({Q:e.unref(h)},e.unref(h)?{R:e.t(e.unref(h))}:{},{S:e.o((r=>(async()=>{var r;if(y.name)if(y.url){if(g.value<h.value)return e.index.$u.toast("算力不足，请充值！"),void(null==(r=_.value)||r.open());try{e.index.showLoading({title:"克隆中",mask:!0}),await i.voiceClone({...y,model_version:d.DigitalHumanModelVersionEnum.CHANJING}),v.getUser(),setTimeout((()=>{e.index.$u.toast("克隆成功，请在我的音色中查看"),G()}),300)}catch(n){e.index.$u.toast(n||"克隆失败")}finally{e.index.hideLoading()}}else e.index.$u.toast("请先上传音频");else e.index.$u.toast("请输入音色名称")})())),T:e.p({shape:"circle",type:"primary"})}):{},{U:e.sr(_,"81c639dd-5",{k:"rechargePopupRef"})})}}),f=e._export_sfc(p,[["__scopeId","data-v-81c639dd"]]);wx.createPage(f);
