"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),n=require("../../../../api/digital_human.js"),r=require("../../../../api/material.js"),i=require("../../../../stores/user.js"),o=require("../../../../stores/app.js"),a=require("../../../../api/app.js"),s=require("../../../../enums/appEnums.js"),u=require("../../../../components/file-upload/choose-file.js"),l=require("../../enums/index.js"),c=require("../../../../hooks/usePolling.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("u-popup")+e.resolveComponent("u-line-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js")+p+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const p=()=>"../../components/video-preview/video-preview.js",d=e.defineComponent({__name:"montage_create",setup(p){const d=i.useUserStore(),{userTokens:f}=e.toRefs(d),m=o.useAppStore(),h=e.computed((()=>m.config.is_oss_transcode)),g=e.ref([{step:1,title:"选形象"},{step:2,title:"填身份"},{step:3,title:"选文案"},{step:4,title:"传素材"},{step:5,title:"交任务"}]),v=e.ref(1),_=e.reactive({anchorLists:[],name:"",introduction:"",copywriterList:[],materialList:[]}),y=e.ref([]),w=e.ref([]),x=e.ref(!1),L=e.ref(!1),b=e.ref(null),j=e.ref(!1),A=20971520,C=[2e3,2e3],$=209715200,k=[1,60],T=e.ref([]),q=e.ref(!1),E=e.ref(null),R=e.ref(!1),S=e.reactive({poster:"",url:""}),I=e.ref(!1),N=e.shallowRef(),F=e.ref(!1),P=e.ref(null),z=e=>{switch(e){case 1:return _.anchorLists.length>0;case 2:return!!_.name&&!!_.introduction;case 3:return _.copywriterList.length>0;case 4:return _.materialList.length>=3;case 5:return!0;default:return!1}},H=e.computed((()=>z(v.value))),V=e.computed((()=>{if(!T.value.length)return 0;const e=T.value.find((e=>e.progress<100));return e?e.progress:100})),M=e.computed((()=>T.value.every((e=>100===e.progress))?T.value.length:(T.value.findIndex((e=>100!==e.progress))||0)+1)),O=e=>d.getTokenByScene(e),U=(t,n)=>{if("prev"!==n)if("next"!==n){if(t!==v.value)if(t<v.value)v.value=t;else{for(let n=1;n<t;n++)if(!z(n))return void e.index.$u.toast("请按顺序完成步骤");v.value=t}}else if(H.value)v.value++;else{const t={1:"请至少选择一个形象",2:"请填写人物名称和介绍",3:"请至少添加一条文案",4:"请上传至少3个素材"};e.index.$u.toast(t[v.value]||"请完成当前步骤")}else v.value--},J=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_anchor_create/montage_anchor_create"})},B=async()=>{var t;x.value=!0,await e.nextTick$1(),null==(t=b.value)||t.reload()},D=async(e,t)=>{var r;try{const{lists:i}=await n.getShanjianPersonList({page_no:e,page_size:t});null==(r=b.value)||r.complete(i)}catch(i){console.error("查询历史记录失败:",i)}},G=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_ai_copywriter/montage_ai_copywriter"})},W=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_copywriter/montage_copywriter"})},Y=(e,t)=>{const n=T.value.findIndex((e=>e.tempFilePath===t.tempFilePath));if(-1!==n){const t=[...T.value];t[n]={...t[n],progress:e},T.value=t}},K=async e=>new Promise((async(t,n)=>{try{const n=await a.videoTranscode({video_url:e}),{start:r,end:i}=c.usePolling((async()=>{try{const e=await a.getVideoTranscodeResult({jobid:n.jobid});"TranscodeSuccess"==e.state?(i(),t(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(i(),t(!1))}catch(e){i(),t(!1)}}),{});await r()}catch(r){t(!1)}})),Q=async t=>{try{const i="image"===t,{tempFiles:o}=await u.chooseFile({type:t,count:9,sourceType:["album"],sizeType:["original"],extension:i?["jpg","png"]:[]}),s=[];for(const p of o)if(i)try{const{width:d,height:f}=await e.index.getImageInfo({src:p.tempFilePath});if(d>C[0]||f>C[1]){e.index.$u.toast(`图片分辨率不能超过${C[0]}*${C[1]}`);continue}if(p.size>A){e.index.$u.toast("图片大小不能超过20M");continue}s.push(p)}catch(n){continue}else{if(!(p.duration>=k[0]&&p.duration<=k[1])){e.index.$u.toast(`视频时长不能超过${k[1]}秒`);continue}if(p.size>$){e.index.$u.toast("视频大小不能超过200M");continue}s.push(p)}if(0===s.length)return void e.index.$u.toast(`所选${i?"图片":"视频"}素材均不符合条件，重新上传`);T.value=s.map((e=>({...e,progress:0}))),q.value=!0;const l=[];for(const m of T.value){const g=i?null:await a.uploadFile("image",{filePath:m.thumbTempFilePath}),v=await a.uploadFile(t,{filePath:m.tempFilePath},(e=>Y(e,m)));l.push({item:m,coverRes:i?v:g,fileRes:v})}async function c(e){try{const{item:n,coverRes:i,fileRes:o}=e,a=await r.addMaterialLibrary({name:n.name,size:n.size,type:0,sort:0,m_type:2,content:o.uri,duration:n.duration||0});_.materialList.push({url:o.uri,type:t,pic:i.uri,id:a.id})}catch(n){console.error("添加素材失败:",n)}}if("video"===t){for(const[y,w]of l.entries()){const{fileRes:x}=w;if(h.value){e.index.showLoading({title:`转码中(${y+1}/${l.length})...`,mask:!0});try{await K(x.uri),e.index.hideLoading()}catch(n){e.index.hideLoading(),q.value=!1}}await c(w)}e.index.hideLoading()}else for(const L of l)await c(L);T.value.every((e=>100===e.progress))&&(q.value=!1,e.index.$u.toast("上传成功"))}catch(n){e.index.$u.toast(n),T.value=[],q.value=!1}},X=()=>{j.value=!1,e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:e=>{0===e.tapIndex?Q("image"):1===e.tapIndex&&Q("video")}})},Z=async()=>{var t;if(f.value<0)null==(t=N.value)||t.open();else{e.index.showLoading({title:"创建中...",mask:!0});try{const t=await n.createShanjianTask({anchor:_.anchorLists.map((e=>({anchor_id:e.anchor_id,pic:e.pic,anchor_url:e.anchor_url,name:e.name}))),character_design:[{name:_.name,introduced:_.introduction}],voice:_.anchorLists.map((e=>({voice_id:e.voice_id,voice_url:e.voice_url,voice_name:e.voice_name}))),copywriting:_.copywriterList,material:_.materialList.map((e=>({fileUrl:e.url,type:e.type})))});L.value||n.addShanjianPerson({name:_.name,introduced:_.introduction}),e.index.hideLoading(),P.value=t,F.value=!0}catch(r){e.index.hideLoading(),e.index.showToast({title:r||"创建失败",icon:"none",duration:3e3})}}},ee=()=>{F.value=!1,e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",params:{task_id:JSON.stringify([P.value.id]),scene:1}})},te=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"reLaunch"})};return e.onLoad((()=>{(async()=>{const{lists:e}=await n.getShanjianAnchorList({page_no:1,page_size:20,status:6});y.value=e})(),e.index.$on("confirm-v2",(e=>{const{type:t,data:n}=e;if(t===l.ListenerTypeEnum.CHOOSE_MONTAGE_ANCHOR){if(!n)return;y.value=y.value.concat(n)}if(t===l.ListenerTypeEnum.MONTAGE_COPYWRITER||t===l.ListenerTypeEnum.AI_COPYWRITER){if(0==n.copywriterList.length)return;_.copywriterList=_.copywriterList.concat(n.copywriterList)}}))})),(i,o)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(g),((n,r,i)=>e.e({a:e.unref(v)>n.step},e.unref(v)>n.step?{b:t._imports_0$15}:{},{c:e.t(n.title),d:n.step!==e.unref(g).length},n.step!==e.unref(g).length?{e:e.unref(v)>n.step?1:""}:{},{f:n.step,g:e.unref(v)==n.step?1:"",h:e.o((e=>U(n.step)),n.step)}))),c:1===e.unref(v)},1===e.unref(v)?e.e({d:t._imports_1$4,e:e.o(J),f:e.unref(y).length>0},e.unref(y).length>0?{g:e.f(e.unref(y),((n,r,i)=>e.e({a:n.pic,b:e.unref(_).anchorLists.includes(n)},e.unref(_).anchorLists.includes(n)?{c:t._imports_1$5}:{},{d:r,e:e.o((e=>{return t=n,void(_.anchorLists.includes(t)?_.anchorLists=_.anchorLists.filter((e=>e!==t)):_.anchorLists.push(t));var t}),r)})))}:{h:t._imports_3$1,i:e.o(J)}):{},{j:2===e.unref(v)},2===e.unref(v)?{k:e.o((e=>L.value=!1)),l:e.o((t=>e.unref(_).name=t)),m:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(_).name}),n:e.o((e=>L.value=!1)),o:e.o((t=>e.unref(_).introduction=t)),p:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(_).introduction}),q:t._imports_4$3,r:e.o(B)}:{},{s:3===e.unref(v)},3===e.unref(v)?{t:e.o(W),v:t._imports_0$14,w:e.o(G),x:e.f(e.unref(_).copywriterList,((t,n,r)=>({a:"5f1ef8b6-3-"+r,b:e.o((e=>t.title=e),n),c:e.p({"placeholder-style":"color: #7C7E80; ",maxlength:"30",modelValue:t.title}),d:"5f1ef8b6-4-"+r,e:e.o((e=>t.content=e),n),f:e.p({type:"textarea","placeholder-style":"color: #7C7E80; ",maxlength:"500",modelValue:t.content}),g:"5f1ef8b6-5-"+r,h:e.o((e=>(e=>{_.copywriterList.splice(e,1)})(n)),n),i:n}))),y:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{z:4===e.unref(v)},4===e.unref(v)?{A:e.t(e.unref(_).materialList.length),B:t._imports_1$4,C:e.o((e=>j.value=!0)),D:e.f(e.unref(_).materialList,((n,i,o)=>e.e({a:n.pic,b:"image"===n.type},"image"===n.type?{c:t._imports_6$1}:{d:t._imports_3$3},{e:e.o((t=>(t=>{const{type:n,pic:r,url:i}=t;"image"===n?e.index.previewImage({urls:[r]}):(S.poster=r,S.url=i,R.value=!0)})(n)),i),f:"5f1ef8b6-6-"+o,g:e.o((e=>{return t=n.id,_.materialList=_.materialList.filter((e=>e.id!==t)),void r.deleteMaterialLibrary({id:t});var t}),i),h:i}))),E:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{F:5===e.unref(v)},5===e.unref(v)?{G:e.t(e.unref(_).anchorLists.length),H:e.p({name:"arrow-right",color:"#C5CACA"}),I:e.o((e=>U(1))),J:e.f(e.unref(_).anchorLists,((e,t,n)=>({a:e.pic,b:t}))),K:e.t(e.unref(_).name),L:e.t(e.unref(_).introduction),M:e.p({name:"arrow-right",color:"#C5CACA"}),N:e.o((e=>U(2))),O:e.t(e.unref(_).copywriterList.length),P:e.p({name:"arrow-right",color:"#C5CACA"}),Q:e.o((e=>U(3))),R:e.t(e.unref(_).materialList.length),S:e.p({name:"arrow-right",color:"#C5CACA"}),T:e.o((e=>U(4)))}:{},{U:e.unref(v)!=e.unref(g).length},e.unref(v)!=e.unref(g).length?e.e({V:1===e.unref(v)},1===e.unref(v)?{W:e.t(e.unref(_).anchorLists.length),X:e.n(e.unref(_).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{Y:e.o((t=>U(e.unref(v),"prev")))},{Z:e.n(e.unref(H)?"bg-black":"bg-_h787878CC_"),aa:e.o((t=>U(e.unref(v),"next")))}):{ab:t._imports_8,ac:e.o((e=>I.value=!0)),ad:e.t(e.unref(_).copywriterList.length),ae:e.o(Z)},{af:e.f(e.unref(w),((t,r,i)=>({a:e.t(t.name),b:e.t(t.introduced),c:"5f1ef8b6-13-"+i+",5f1ef8b6-12",d:e.o((r=>(async t=>{e.index.showLoading({title:"删除中...",mask:!0});try{await n.deleteShanjianPerson({id:t}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),w.value=w.value.filter((e=>e.id!==t))}catch(r){e.index.hideLoading(),e.index.showToast({title:r||"删除失败",icon:"none",duration:3e3})}})(t.id)),r),e:r,f:e.o((e=>(e=>{_.name=e.name,_.introduction=e.introduced,L.value=!0,x.value=!1})(t)),r)}))),ag:e.p({name:"close",color:"#ffffff",size:"16"}),ah:e.sr(b,"5f1ef8b6-12,5f1ef8b6-11",{k:"pagingHistoryRef"}),ai:e.o(D),aj:e.o((t=>e.isRef(w)?w.value=t:null)),ak:e.p({auto:!1,fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(w)}),al:e.o((t=>e.isRef(x)?x.value=t:null)),am:e.p({title:"历史人设","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(x)}),an:e.t(k[0]),ao:e.t(k[1]),ap:e.t(200),aq:e.t(20),ar:e.t(C[0]),as:e.t(C[1]),at:e.o((e=>j.value=!1)),av:e.o(X),aw:e.o((t=>e.isRef(j)?j.value=t:null)),ax:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(j)}),ay:e.t(e.unref(M)),az:e.t(e.unref(V)),aA:e.p({striped:!0,percent:e.unref(V),height:16,"striped-active":!0,"active-color":"#0065FB","inactive-color":"#CDE0FC"}),aB:e.t(e.unref(M)),aC:e.t(e.unref(T).length),aD:e.p({striped:!0,percent:parseInt((e.unref(M)/e.unref(T).length*100).toFixed(2)),height:16,"striped-active":!0,"active-color":"#0065FB","inactive-color":"#CDE0FC"}),aE:e.o((t=>e.isRef(q)?q.value=t:null)),aF:e.p({mode:"center","border-radius":"24",width:"90%","mask-close-able":!1,modelValue:e.unref(q)}),aG:e.sr(E,"5f1ef8b6-19",{k:"videoPreviewRef"}),aH:e.o((t=>e.isRef(R)?R.value=t:null)),aI:e.p({title:"视频预览",poster:e.unref(S).poster,"video-url":e.unref(S).url,show:e.unref(R)}),aJ:t._imports_9$1,aK:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).score),aL:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).unit),aM:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).score),aN:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).unit),aO:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).score),aP:e.t(O(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).unit),aQ:e.o((t=>e.isRef(I)?I.value=t:null)),aR:e.p({title:"批量数字人口播混剪",height:"70%",show:e.unref(I)}),aS:t._imports_10$1,aT:e.o(ee),aU:t._imports_0$8,aV:e.o(te),aW:e.o((t=>e.isRef(F)?F.value=t:null)),aX:e.p({mode:"center","border-radius":"64",width:"90%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(F)}),aY:e.sr(N,"5f1ef8b6-22",{k:"rechargePopupRef"})})}}),f=e._export_sfc(d,[["__scopeId","data-v-5f1ef8b6"]]);wx.createPage(f);
