"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),n=require("../../../../api/digital_human.js"),r=require("../../../../api/material.js"),a=require("../../../../stores/user.js"),i=require("../../../../api/app.js"),o=require("../../../../enums/appEnums.js"),u=require("../../../../components/file-upload/choose-file.js"),s=require("../../enums/index.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("u-popup")+e.resolveComponent("u-line-progress")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js")+l+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const l=()=>"../../components/video-preview/video-preview.js",c=e.defineComponent({__name:"montage_create",setup(l){const c=a.useUserStore(),{userTokens:p}=e.toRefs(c),d=e.ref([{step:1,title:"选形象"},{step:2,title:"填身份"},{step:3,title:"选文案"},{step:4,title:"传素材"},{step:5,title:"交任务"}]),m=e.ref(1),f=e.reactive({anchorLists:[],name:"",introduction:"",copywriterList:[],materialList:[]}),h=e.ref([]),g=e.ref([]),v=e.ref(!1),_=e.ref(!1),y=e.ref(null),w=e.ref(!1),x=20971520,L=[2e3,2e3],j=209715200,A=[1,60],C=e.ref([]),b=e.ref(!1),$=e.ref(null),k=e.ref(!1),q=e.reactive({poster:"",url:""}),E=e.ref(!1),T=e.shallowRef(),S=e.ref(!1),I=e.ref(null),N=e=>{switch(e){case 1:return f.anchorLists.length>0;case 2:return!!f.name&&!!f.introduction;case 3:return f.copywriterList.length>0;case 4:return f.materialList.length>=3;case 5:return!0;default:return!1}},R=e.computed((()=>N(m.value))),F=e.computed((()=>{if(!C.value.length)return 0;const e=C.value.find((e=>e.progress<100));return e?e.progress:100})),z=e.computed((()=>C.value.every((e=>100===e.progress))?C.value.length:(C.value.findIndex((e=>100!==e.progress))||0)+1)),H=e=>c.getTokenByScene(e),P=(t,n)=>{if("prev"!==n)if("next"!==n){if(t!==m.value)if(t<m.value)m.value=t;else{for(let n=1;n<t;n++)if(!N(n))return void e.index.$u.toast("请按顺序完成步骤");m.value=t}}else if(R.value)m.value++;else{const t={1:"请至少选择一个形象",2:"请填写人物名称和介绍",3:"请至少添加一条文案",4:"请上传至少3个素材"};e.index.$u.toast(t[m.value]||"请完成当前步骤")}else m.value--},M=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_anchor_create/montage_anchor_create"})},V=async()=>{var t;v.value=!0,await e.nextTick$1(),null==(t=y.value)||t.reload()},O=async(e,t)=>{var r;try{const{lists:a}=await n.getShanjianPersonList({page_no:e,page_size:t});null==(r=y.value)||r.complete(a)}catch(a){console.error("查询历史记录失败:",a)}},U=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_ai_copywriter/montage_ai_copywriter"})},J=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_copywriter/montage_copywriter"})},B=(e,t)=>{const n=C.value.findIndex((e=>e.tempFilePath===t.tempFilePath));-1!==n&&(C.value[n]={...C.value[n],progress:e})},D=async t=>{try{const a="image"===t,{tempFiles:o}=await u.chooseFile({type:t,count:9,extension:a?["jpg","png"]:[]}),s=[];for(const t of o)if(a)try{const{width:n,height:r}=await e.index.getImageInfo({src:t.tempFilePath});if(n>L[0]||r>L[1]){e.index.$u.toast(`图片分辨率不能超过${L[0]}*${L[1]}`);continue}if(t.size>x){e.index.$u.toast("图片大小不能超过20M");continue}s.push(t)}catch(n){continue}else{if(!(t.duration>=A[0]&&t.duration<=A[1])){e.index.$u.toast(`视频时长不能超过${A[1]}秒`);continue}if(t.size>j){e.index.$u.toast("视频大小不能超过200M");continue}s.push(t)}if(0===s.length)return void e.index.$u.toast(`所选${a?"图片":"视频"}素材均不符合条件，可以放弃原图模式，重新上传`);C.value=s.map((e=>({...e,progress:0}))),b.value=!0;for(const e of C.value){const n=a?null:await i.uploadFile("image",{filePath:e.thumbTempFilePath}),o=await i.uploadFile(t,{filePath:e.tempFilePath},(t=>B(t,e))),u=await r.addMaterialLibrary({name:e.name,size:e.size,type:0,sort:0,m_type:a?1:2,content:o.uri,duration:e.duration||0});f.materialList.push({url:o.uri,type:t,pic:a?o.uri:n.uri,id:u.id})}C.value.every((e=>100===e.progress))&&(b.value=!1,e.index.$u.toast("上传成功"))}catch(n){e.index.$u.toast(n),C.value=[],b.value=!1}},G=()=>{w.value=!1,e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:e=>{0===e.tapIndex?D("image"):1===e.tapIndex&&D("video")}})},W=async()=>{var t;if(p.value<0)null==(t=T.value)||t.open();else{e.index.showLoading({title:"创建中...",mask:!0});try{const t=await n.createShanjianTask({anchor:f.anchorLists.map((e=>({anchor_id:e.anchor_id,pic:e.pic,anchor_url:e.anchor_url,name:e.name}))),character_design:[{name:f.name,introduced:f.introduction}],voice:f.anchorLists.map((e=>({voice_id:e.voice_id,voice_url:e.voice_url,voice_name:e.voice_name}))),copywriting:f.copywriterList,material:f.materialList.map((e=>({fileUrl:e.url,type:e.type})))});_.value||n.addShanjianPerson({name:f.name,introduced:f.introduction}),e.index.hideLoading(),I.value=t,S.value=!0}catch(r){e.index.hideLoading(),e.index.showToast({title:r||"创建失败",icon:"none",duration:3e3})}}},Y=()=>{S.value=!1,e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",params:{task_id:JSON.stringify([I.value.id]),scene:1}})},K=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"reLaunch"})};return e.onLoad((()=>{(async()=>{const{lists:e}=await n.getShanjianAnchorList({page_no:1,page_size:20,status:6});h.value=e})(),e.index.$on("confirm-v2",(e=>{const{type:t,data:n}=e;if(t===s.ListenerTypeEnum.CHOOSE_MONTAGE_ANCHOR){if(!n)return;h.value=h.value.concat(n)}if(t===s.ListenerTypeEnum.MONTAGE_COPYWRITER||t===s.ListenerTypeEnum.AI_COPYWRITER){if(0==n.copywriterList.length)return;f.copywriterList=f.copywriterList.concat(n.copywriterList)}}))})),(a,i)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(d),((n,r,a)=>e.e({a:e.unref(m)>n.step},e.unref(m)>n.step?{b:t._imports_0$15}:{},{c:e.t(n.title),d:n.step!==e.unref(d).length},n.step!==e.unref(d).length?{e:e.unref(m)>n.step?1:""}:{},{f:n.step,g:e.unref(m)==n.step?1:"",h:e.o((e=>P(n.step)),n.step)}))),c:1===e.unref(m)},1===e.unref(m)?e.e({d:t._imports_1$4,e:e.o(M),f:e.unref(h).length>0},e.unref(h).length>0?{g:e.f(e.unref(h),((n,r,a)=>e.e({a:n.pic,b:e.unref(f).anchorLists.includes(n)},e.unref(f).anchorLists.includes(n)?{c:t._imports_1$5}:{},{d:r,e:e.o((e=>{return t=n,void(f.anchorLists.includes(t)?f.anchorLists=f.anchorLists.filter((e=>e!==t)):f.anchorLists.push(t));var t}),r)})))}:{h:t._imports_3$1,i:e.o(M)}):{},{j:2===e.unref(m)},2===e.unref(m)?{k:e.o((e=>_.value=!1)),l:e.o((t=>e.unref(f).name=t)),m:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(f).name}),n:e.o((e=>_.value=!1)),o:e.o((t=>e.unref(f).introduction=t)),p:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(f).introduction}),q:t._imports_4$3,r:e.o(V)}:{},{s:3===e.unref(m)},3===e.unref(m)?{t:e.o(J),v:t._imports_0$14,w:e.o(U),x:e.f(e.unref(f).copywriterList,((t,n,r)=>({a:"a51c8e1a-3-"+r,b:e.o((e=>t.title=e),n),c:e.p({"placeholder-style":"color: #7C7E80; ",maxlength:"30",modelValue:t.title}),d:"a51c8e1a-4-"+r,e:e.o((e=>t.content=e),n),f:e.p({type:"textarea","placeholder-style":"color: #7C7E80; ",maxlength:"500",modelValue:t.content}),g:"a51c8e1a-5-"+r,h:e.o((e=>(e=>{f.copywriterList.splice(e,1)})(n)),n),i:n}))),y:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{z:4===e.unref(m)},4===e.unref(m)?{A:e.t(e.unref(f).materialList.length),B:t._imports_1$4,C:e.o((e=>w.value=!0)),D:e.f(e.unref(f).materialList,((n,a,i)=>e.e({a:n.pic,b:"image"===n.type},"image"===n.type?{c:t._imports_6$1}:{d:t._imports_3$3},{e:e.o((t=>(t=>{const{type:n,pic:r,url:a}=t;"image"===n?e.index.previewImage({urls:[r]}):(q.poster=r,q.url=a,k.value=!0)})(n)),a),f:"a51c8e1a-6-"+i,g:e.o((e=>{return t=n.id,f.materialList=f.materialList.filter((e=>e.id!==t)),void r.deleteMaterialLibrary({id:t});var t}),a),h:a}))),E:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{F:5===e.unref(m)},5===e.unref(m)?{G:e.t(e.unref(f).anchorLists.length),H:e.p({name:"arrow-right",color:"#C5CACA"}),I:e.o((e=>P(1))),J:e.f(e.unref(f).anchorLists,((e,t,n)=>({a:e.pic,b:t}))),K:e.t(e.unref(f).name),L:e.t(e.unref(f).introduction),M:e.p({name:"arrow-right",color:"#C5CACA"}),N:e.o((e=>P(2))),O:e.t(e.unref(f).copywriterList.length),P:e.p({name:"arrow-right",color:"#C5CACA"}),Q:e.o((e=>P(3))),R:e.t(e.unref(f).materialList.length),S:e.p({name:"arrow-right",color:"#C5CACA"}),T:e.o((e=>P(4)))}:{},{U:e.unref(m)!=e.unref(d).length},e.unref(m)!=e.unref(d).length?e.e({V:1===e.unref(m)},1===e.unref(m)?{W:e.t(e.unref(f).anchorLists.length),X:e.n(e.unref(f).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{Y:e.o((t=>P(e.unref(m),"prev")))},{Z:e.n(e.unref(R)?"bg-black":"bg-_h787878CC_"),aa:e.o((t=>P(e.unref(m),"next")))}):{ab:t._imports_8,ac:e.o((e=>E.value=!0)),ad:e.t(e.unref(f).copywriterList.length),ae:e.o(W)},{af:e.f(e.unref(g),((t,r,a)=>({a:e.t(t.name),b:e.t(t.introduced),c:"a51c8e1a-13-"+a+",a51c8e1a-12",d:e.o((r=>(async t=>{e.index.showLoading({title:"删除中...",mask:!0});try{await n.deleteShanjianPerson({id:t}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),g.value=g.value.filter((e=>e.id!==t))}catch(r){e.index.hideLoading(),e.index.showToast({title:r||"删除失败",icon:"none",duration:3e3})}})(t.id)),r),e:r,f:e.o((e=>(e=>{f.name=e.name,f.introduction=e.introduced,_.value=!0,v.value=!1})(t)),r)}))),ag:e.p({name:"close",color:"#ffffff",size:"16"}),ah:e.sr(y,"a51c8e1a-12,a51c8e1a-11",{k:"pagingHistoryRef"}),ai:e.o(O),aj:e.o((t=>e.isRef(g)?g.value=t:null)),ak:e.p({auto:!1,fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(g)}),al:e.o((t=>e.isRef(v)?v.value=t:null)),am:e.p({title:"历史人设","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(v)}),an:e.t(A[0]),ao:e.t(A[1]),ap:e.t(200),aq:e.t(20),ar:e.t(L[0]),as:e.t(L[1]),at:e.o((e=>w.value=!1)),av:e.o(G),aw:e.o((t=>e.isRef(w)?w.value=t:null)),ax:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(w)}),ay:e.t(e.unref(z)),az:e.t(e.unref(F)),aA:e.p({striped:!0,percent:e.unref(F),height:16,"striped-active":!0,"active-color":"#0065FB","inactive-color":"#CDE0FC"}),aB:e.t(e.unref(z)),aC:e.t(e.unref(C).length),aD:e.p({striped:!0,percent:parseInt((e.unref(z)/e.unref(C).length*100).toFixed(2)),height:16,"striped-active":!0,"active-color":"#0065FB","inactive-color":"#CDE0FC"}),aE:e.o((t=>e.isRef(b)?b.value=t:null)),aF:e.p({mode:"center","border-radius":"24",width:"90%","mask-close-able":!1,modelValue:e.unref(b)}),aG:e.sr($,"a51c8e1a-19",{k:"videoPreviewRef"}),aH:e.o((t=>e.isRef(k)?k.value=t:null)),aI:e.p({title:"视频预览",poster:e.unref(q).poster,"video-url":e.unref(q).url,show:e.unref(k)}),aJ:t._imports_9$1,aK:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).score),aL:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).unit),aM:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).score),aN:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).unit),aO:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).score),aP:e.t(H(e.unref(o.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).unit),aQ:e.o((t=>e.isRef(E)?E.value=t:null)),aR:e.p({title:"批量数字人口播混剪",height:"70%",show:e.unref(E)}),aS:t._imports_10$1,aT:e.o(Y),aU:t._imports_0$8,aV:e.o(K),aW:e.o((t=>e.isRef(S)?S.value=t:null)),aX:e.p({mode:"center","border-radius":"64",width:"90%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(S)}),aY:e.sr(T,"a51c8e1a-22",{k:"rechargePopupRef"})})}}),p=e._export_sfc(c,[["__scopeId","data-v-a51c8e1a"]]);wx.createPage(p);
