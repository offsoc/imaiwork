"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),n=require("../../../../api/digital_human.js"),i=require("../../../../api/material.js"),o=require("../../../../stores/user.js"),r=require("../../../../stores/app.js"),a=require("../../../../api/app.js"),s=require("../../../../enums/appEnums.js"),u=require("../../../../components/file-upload/choose-file.js"),l=require("../../enums/index.js"),c=require("../../../../hooks/usePolling.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("u-popup")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}const p=()=>"../../../../components/recharge-popup/recharge-popup.js";Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+e.unref(videoPreview)+p)();const d=e.defineComponent({__name:"montage_create",setup(p){const d=o.useUserStore(),{userTokens:f}=e.toRefs(d),m=r.useAppStore(),h=e.computed((()=>m.config.is_oss_transcode)),g=e.ref([{step:1,title:"选形象"},{step:2,title:"填身份"},{step:3,title:"选文案"},{step:4,title:"传素材"},{step:5,title:"交任务"}]),v=e.ref(1),_=e.reactive({anchorLists:[],name:"",introduction:"",copywriterList:[],materialList:[]}),y=e.ref([]),w=e.ref([]),L=e.ref(!1),x=e.ref(!1),j=e.ref(null),A=e.ref(-1),b=e.ref(!1),C=["webp","jpg","png"],$=[2e3,2e3],q=[1,60],k=e.ref([]),T=e.ref(!1),R=e.shallowRef(null),S=e.ref(!1),N=e.reactive({poster:"",url:""}),E=e.ref(!1),I=e.shallowRef(),P=e.ref(!1),z=e.ref(null),H=e=>{switch(e){case 1:return _.anchorLists.length>0;case 2:return!!_.name&&!!_.introduction;case 3:return _.copywriterList.length>0;case 4:return _.materialList.length>=3;case 5:return!0;default:return!1}},M=e.computed((()=>H(v.value))),F=e=>d.getTokenByScene(e),O=(t,n)=>{if("prev"!==n)if("next"!==n){if(t!==v.value)if(t<v.value)v.value=t;else{for(let n=1;n<t;n++)if(!H(n))return void e.index.$u.toast("请按顺序完成步骤");v.value=t}}else if(M.value)v.value++;else{const t={1:"请至少选择一个形象",2:"请填写人物名称和介绍",3:"请至少添加一条文案",4:"请上传至少3个素材"};e.index.$u.toast(t[v.value]||"请完成当前步骤")}else v.value--},V=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_anchor_create/montage_anchor_create"})},J=async()=>{var t;L.value=!0,await e.nextTick$1(),null==(t=j.value)||t.reload()},U=async(e,t)=>{var i;try{const{lists:o}=await n.getShanjianPersonList({page_no:e,page_size:t});null==(i=j.value)||i.complete(o)}catch(o){console.error("查询历史记录失败:",o)}},B=t=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_copywriter/montage_copywriter",params:{data:t?JSON.stringify(t):""}})},D=(e,t)=>{const n=k.value.findIndex((e=>e.tempFilePath===t.tempFilePath));if(-1!==n){const t=[...k.value];t[n]={...t[n],progress:e},k.value=t}},G=async e=>new Promise((async(t,n)=>{try{const n=await a.videoTranscode({video_url:e}),{start:i,end:o}=c.usePolling((async()=>{try{const e=await a.getVideoTranscodeResult({jobid:n.jobid});"TranscodeSuccess"==e.state?(o(),t(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(o(),t(!1))}catch(e){o(),t(!1)}}),{});await i()}catch(i){t(!1)}})),W=async t=>{k.value=[];try{const o="image"===t,{tempFiles:r}=await u.chooseFile({type:t,count:9,sourceType:["album"]}),s=[];for(const p of r)if(o)try{const{width:d,height:f}=await e.index.getImageInfo({src:p.tempFilePath});if(console.log('file.name.split(".").pop()',p.name.split(".").pop()),!C.includes(p.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${C.join("、")}`);continue}if(d>$[0]||f>$[1]){e.index.$u.toast(`图片分辨率不能超过${$[0]}*${$[1]}`);continue}if(p.size>20971520){e.index.$u.toast("图片大小不能超过20M");continue}s.push(p)}catch(n){continue}else{if(!(p.duration>=q[0]&&p.duration<=q[1])){e.index.$u.toast(`视频时长不能超过${q[1]}秒`);continue}if(p.size>209715200){e.index.$u.toast("视频大小不能超过200M");continue}s.push(p)}if(0===s.length)return void e.index.$u.toast(`所选${o?"图片":"视频"}素材均不符合条件，重新上传`);k.value=s.map((e=>({...e,progress:0}))),T.value=!0;const l=[];for(const m of k.value){const g=o?null:await a.uploadFile("image",{filePath:m.thumbTempFilePath}),v=await a.uploadFile(t,{filePath:m.tempFilePath},(e=>D(e,m)));l.push({item:m,coverRes:o?v:g,fileRes:v})}async function c(e){try{const{item:n,coverRes:o,fileRes:r}=e,a=await i.addMaterialLibrary({name:n.name,size:n.size,type:0,sort:0,m_type:2,content:r.uri,duration:n.duration||0});_.materialList.push({url:r.uri,type:t,pic:o.uri,id:a.id})}catch(n){console.error("添加素材失败:",n)}}if("video"===t){for(const[y,w]of l.entries()){const{fileRes:L}=w;if(h.value){e.index.showLoading({title:`转码中(${y+1}/${l.length})...`,mask:!0});try{await G(L.uri),e.index.hideLoading()}catch(n){e.index.hideLoading(),T.value=!1}}await c(w)}e.index.hideLoading()}else for(const x of l)await c(x);k.value.every((e=>100===e.progress))&&(T.value=!1,e.index.$u.toast("上传成功"))}catch(n){e.index.$u.toast(n),k.value=[],T.value=!1}},Y=()=>{b.value=!1,e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:e=>{0===e.tapIndex?W("image"):1===e.tapIndex&&W("video")}})},K=async()=>{var t;if(f.value<0)null==(t=I.value)||t.open();else{e.index.showLoading({title:"创建中...",mask:!0});try{const t=await n.createShanjianTask({anchor:_.anchorLists.map((e=>({anchor_id:e.anchor_id,pic:e.pic,anchor_url:e.anchor_url,name:e.name}))),character_design:[{name:_.name,introduced:_.introduction}],voice:_.anchorLists.map((e=>({voice_id:e.voice_id,voice_url:e.voice_url,voice_name:e.voice_name}))),copywriting:_.copywriterList,material:_.materialList.map((e=>({fileUrl:e.url,type:e.type})))});x.value||n.addShanjianPerson({name:_.name,introduced:_.introduction}),e.index.hideLoading(),z.value=t,P.value=!0}catch(i){e.index.hideLoading(),e.index.showToast({title:i||"创建失败",icon:"none",duration:3e3})}}},Q=()=>{P.value=!1,e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",params:{task_id:JSON.stringify([z.value.id]),scene:1}})},X=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"reLaunch"})};return e.onLoad((()=>{(async()=>{const{lists:e}=await n.getShanjianAnchorList({page_no:1,page_size:20,status:6});y.value=e})(),e.index.$on("confirm",(e=>{const{type:t,data:n}=e;if(t===l.ListenerTypeEnum.CHOOSE_MONTAGE_ANCHOR){if(!n)return;y.value=y.value.concat(n)}if(t===l.ListenerTypeEnum.MONTAGE_COPYWRITER||t===l.ListenerTypeEnum.AI_COPYWRITER){if(0==n.copywriterList.length)return;_.copywriterList=_.copywriterList.concat(n.copywriterList)}}))})),(o,r)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(g),((n,i,o)=>e.e({a:e.unref(v)>n.step},e.unref(v)>n.step?{b:t._imports_0$14}:{},{c:e.t(n.title),d:n.step!==e.unref(g).length},n.step!==e.unref(g).length?{e:e.unref(v)>n.step?1:""}:{},{f:n.step,g:e.unref(v)==n.step?1:"",h:e.o((e=>O(n.step)),n.step)}))),c:1===e.unref(v)},1===e.unref(v)?e.e({d:t._imports_1$3,e:e.o(V),f:e.unref(y).length>0},e.unref(y).length>0?{g:e.f(e.unref(y),((n,i,o)=>e.e({a:n.pic,b:e.unref(_).anchorLists.includes(n)},e.unref(_).anchorLists.includes(n)?{c:t._imports_1$4}:{},{d:i,e:e.o((e=>{return t=n,void(_.anchorLists.includes(t)?_.anchorLists=_.anchorLists.filter((e=>e!==t)):_.anchorLists.push(t));var t}),i)})))}:{h:t._imports_3$1,i:e.o(V)}):{},{j:2===e.unref(v)},2===e.unref(v)?{k:e.o((e=>x.value=!1)),l:e.o((t=>e.unref(_).name=t)),m:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(_).name}),n:e.o((e=>x.value=!1)),o:e.o((t=>e.unref(_).introduction=t)),p:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(_).introduction}),q:t._imports_4$3,r:e.o(J)}:{},{s:3===e.unref(v)},3===e.unref(v)?{t:e.o(B),v:e.f(e.unref(_).copywriterList,((t,n,i)=>({a:e.t(t.title),b:e.t(t.content),c:"81567c54-3-"+i,d:e.o((e=>(e=>{_.copywriterList.splice(e,1)})(n)),n),e:n,f:e.o((e=>(e=>{A.value=e;const t=_.copywriterList[e];B(t)})(n)),n)}))),w:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{x:4===e.unref(v)},4===e.unref(v)?{y:e.t(e.unref(_).materialList.length),z:t._imports_1$3,A:e.o((e=>b.value=!0)),B:e.f(e.unref(_).materialList,((n,o,r)=>e.e({a:n.pic,b:"image"===n.type},"image"===n.type?{c:t._imports_5$2}:{d:t._imports_3$3},{e:e.o((t=>(t=>{const{type:n,pic:i,url:o}=t;"image"===n?e.index.previewImage({urls:[i]}):(N.poster=i,N.url=o,S.value=!0)})(n)),o),f:"81567c54-4-"+r,g:e.o((e=>{return t=n.id,_.materialList=_.materialList.filter((e=>e.id!==t)),void i.deleteMaterialLibrary({id:t});var t}),o),h:o}))),C:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{D:5===e.unref(v)},5===e.unref(v)?{E:e.t(e.unref(_).anchorLists.length),F:e.p({name:"arrow-right",color:"#C5CACA"}),G:e.o((e=>O(1))),H:e.f(e.unref(_).anchorLists,((e,t,n)=>({a:e.pic,b:t}))),I:e.t(e.unref(_).name),J:e.t(e.unref(_).introduction),K:e.p({name:"arrow-right",color:"#C5CACA"}),L:e.o((e=>O(2))),M:e.t(e.unref(_).copywriterList.length),N:e.p({name:"arrow-right",color:"#C5CACA"}),O:e.o((e=>O(3))),P:e.t(e.unref(_).materialList.length),Q:e.p({name:"arrow-right",color:"#C5CACA"}),R:e.o((e=>O(4)))}:{},{S:e.unref(v)!=e.unref(g).length},e.unref(v)!=e.unref(g).length?e.e({T:1===e.unref(v)},1===e.unref(v)?{U:e.t(e.unref(_).anchorLists.length),V:e.n(e.unref(_).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{W:e.o((t=>O(e.unref(v),"prev")))},{X:e.n(e.unref(M)?"bg-black":"bg-_h787878CC_"),Y:e.o((t=>O(e.unref(v),"next")))}):{Z:t._imports_7,aa:e.o((e=>E.value=!0)),ab:e.t(e.unref(_).copywriterList.length),ac:e.o(K)},{ad:e.f(e.unref(w),((t,i,o)=>({a:e.t(t.name),b:e.t(t.introduced),c:"81567c54-11-"+o+",81567c54-10",d:e.o((i=>(async t=>{e.index.showLoading({title:"删除中...",mask:!0});try{await n.deleteShanjianPerson({id:t}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),w.value=w.value.filter((e=>e.id!==t))}catch(i){e.index.hideLoading(),e.index.showToast({title:i||"删除失败",icon:"none",duration:3e3})}})(t.id)),i),e:i,f:e.o((e=>(e=>{_.name=e.name,_.introduction=e.introduced,x.value=!0,L.value=!1})(t)),i)}))),ae:e.p({name:"close",color:"#ffffff",size:"16"}),af:e.sr(j,"81567c54-10,81567c54-9",{k:"pagingHistoryRef"}),ag:e.o(U),ah:e.o((t=>e.isRef(w)?w.value=t:null)),ai:e.p({auto:!1,fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(w)}),aj:e.o((t=>e.isRef(L)?L.value=t:null)),ak:e.p({title:"历史人设","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(L)}),al:e.t(q[0]),am:e.t(q[1]),an:e.t(200),ao:e.t(C.join("、")),ap:e.t(20),aq:e.t($[0]),ar:e.t($[1]),as:e.o((e=>b.value=!1)),at:e.o(Y),av:e.o((t=>e.isRef(b)?b.value=t:null)),aw:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(b)}),ax:e.o((t=>e.isRef(T)?T.value=t:null)),ay:e.p({"upload-list":e.unref(k),modelValue:e.unref(T)}),az:e.sr(R,"81567c54-15",{k:"videoPreviewRef"}),aA:e.o((t=>e.isRef(S)?S.value=t:null)),aB:e.p({title:"视频预览",poster:e.unref(N).poster,"video-url":e.unref(N).url,show:e.unref(S)}),aC:t._imports_8,aD:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).score),aE:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).unit),aF:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).score),aG:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).unit),aH:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).score),aI:e.t(F(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).unit),aJ:e.o((t=>e.isRef(E)?E.value=t:null)),aK:e.p({title:"批量数字人口播混剪",height:"70%",show:e.unref(E)}),aL:t._imports_9$1,aM:e.o(Q),aN:t._imports_0$8,aO:e.o(X),aP:e.o((t=>e.isRef(P)?P.value=t:null)),aQ:e.p({mode:"center","border-radius":"64",width:"90%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(P)}),aR:e.sr(I,"81567c54-18",{k:"rechargePopupRef"})})}}),f=e._export_sfc(d,[["__scopeId","data-v-81567c54"]]);wx.createPage(f);
