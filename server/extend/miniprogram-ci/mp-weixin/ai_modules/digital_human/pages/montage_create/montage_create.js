"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),n=require("../../../../api/digital_human.js"),a=require("../../../../api/material.js"),i=require("../../../../stores/user.js"),r=require("../../../../stores/app.js"),o=require("../../../../api/app.js"),s=require("../../../../enums/appEnums.js"),u=require("../../../../components/file-upload/choose-file.js"),l=require("../../enums/index.js"),c=require("../../../../hooks/usePolling.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-input")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("u-popup")+e.resolveComponent("upload-progress")+e.resolveComponent("recharge-popup"))()}const p=()=>"../../../../components/recharge-popup/recharge-popup.js";Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+e.unref(videoPreview)+p)();const d=e.defineComponent({__name:"montage_create",setup(p){const d=i.useUserStore(),{userTokens:f}=e.toRefs(d),m=r.useAppStore(),h=e.computed((()=>m.config.is_oss_transcode)),v=e.ref([{step:1,title:"选形象"},{step:2,title:"填身份"},{step:3,title:"选文案"},{step:4,title:"传素材"},{step:5,title:"交任务"}]),g=e.ref(1),_=e.reactive({anchorLists:[],name:"",introduction:"",copywriterList:[],materialList:[]}),y=e.ref([]),w=e.ref(!1),b=e.ref(!1),L=e.reactive({page_no:1,page_size:20,status:6}),x=e.ref([]),j=e.ref(!1),A=e.ref(!1),C=e.ref(null),k=e.ref(-1),q=e.ref(!1),T=["webp","jpg","png"],$=[2e3,2e3],R=[1,60],N=e.ref([]),S=e.ref(!1),E=e.shallowRef(null),I=e.ref(!1),P=e.reactive({poster:"",url:""}),z=e.ref(!1),H=e.shallowRef(),M=e.ref(!1),F=e.ref(null),V=e=>{switch(e){case 1:return _.anchorLists.length>0;case 2:return!!_.name&&!!_.introduction;case 3:return _.copywriterList.length>0;case 4:return _.materialList.length>=3;case 5:return!0;default:return!1}},O=e.computed((()=>V(g.value))),J=e=>d.getTokenByScene(e),U=(t,n)=>{if("prev"!==n)if("next"!==n){if(t!==g.value)if(t<g.value)g.value=t;else{for(let n=1;n<t;n++)if(!V(n))return void e.index.$u.toast("请按顺序完成步骤");g.value=t}}else if(O.value)g.value++;else{const t={1:"请至少选择一个形象",2:"请填写人物名称和介绍",3:"请至少添加一条文案",4:"请上传至少3个素材"};e.index.$u.toast(t[g.value]||"请完成当前步骤")}else g.value--},B=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/anchor_create/anchor_create",params:{source:l.DigitalHumanModelVersionEnum.SHANJIAN}})},D=async()=>{var t;j.value=!0,await e.nextTick$1(),null==(t=C.value)||t.reload()},G=async(e,t)=>{var a;try{const{lists:i}=await n.getShanjianPersonList({page_no:e,page_size:t});null==(a=C.value)||a.complete(i)}catch(i){console.error("查询历史记录失败:",i)}},W=t=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_copywriter/montage_copywriter",params:{data:t?JSON.stringify(t):""}})},Y=(e,t)=>{const n=N.value.findIndex((e=>e.tempFilePath===t.tempFilePath));if(-1!==n){const t=[...N.value];t[n]={...t[n],progress:e},N.value=t}},K=async e=>new Promise((async(t,n)=>{try{const n=await o.videoTranscode({video_url:e}),{start:a,end:i}=c.usePolling((async()=>{try{const e=await o.getVideoTranscodeResult({jobid:n.jobid});"TranscodeSuccess"==e.state?(i(),t(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(i(),t(!1))}catch(e){i(),t(!1)}}),{});await a()}catch(a){t(!1)}})),Q=async t=>{N.value=[];try{const i="image"===t,{tempFiles:r}=await u.chooseFile({type:t,count:9,sourceType:["album"]}),s=[];for(const p of r)if(i)try{const{width:d,height:f}=await e.index.getImageInfo({src:p.tempFilePath});if(!T.includes(p.name.split(".").pop())){e.index.$u.toast(`图片格式必须是${T.join("、")}`);continue}if(d>$[0]||f>$[1]){e.index.$u.toast(`图片分辨率不能超过${$[0]}*${$[1]}`);continue}if(p.size>20971520){e.index.$u.toast("图片大小不能超过20M");continue}s.push(p)}catch(n){continue}else{if(!(p.duration>=R[0]&&p.duration<=R[1])){e.index.$u.toast(`视频时长不能超过${R[1]}秒`);continue}if(p.size>209715200){e.index.$u.toast("视频大小不能超过200M");continue}s.push(p)}if(0===s.length)return void e.index.$u.toast(`所选${i?"图片":"视频"}素材均不符合条件，重新上传`);N.value=s.map((e=>({...e,progress:0}))),S.value=!0;const l=[];for(const m of N.value){const v=i?null:await o.uploadFile("image",{filePath:m.thumbTempFilePath}),g=await o.uploadFile(t,{filePath:m.tempFilePath},(e=>Y(e,m)));l.push({item:m,coverRes:i?g:v,fileRes:g})}async function c(e){try{const{item:n,coverRes:i,fileRes:r}=e,o=await a.addMaterialLibrary({name:n.name,size:n.size,type:0,sort:0,m_type:2,content:r.uri,duration:n.duration||0});_.materialList.push({url:r.uri,type:t,pic:i.uri,id:o.id})}catch(n){console.error("添加素材失败:",n)}}if("video"===t){for(const[y,w]of l.entries()){const{fileRes:b}=w;if(h.value){e.index.showLoading({title:`转码中(${y+1}/${l.length})...`,mask:!0});try{await K(b.uri),e.index.hideLoading()}catch(n){e.index.hideLoading(),S.value=!1}}await c(w)}e.index.hideLoading()}else for(const L of l)await c(L);N.value.every((e=>100===e.progress))&&(S.value=!1,e.index.$u.toast("上传成功"))}catch(n){e.index.$u.toast(n),N.value=[],S.value=!1}},X=()=>{q.value=!1,e.index.showActionSheet({itemList:["选择图片素材","选择视频素材"],success:e=>{0===e.tapIndex?Q("image"):1===e.tapIndex&&Q("video")}})},Z=async()=>{var t;if(f.value<0)null==(t=H.value)||t.open();else{e.index.showLoading({title:"创建中...",mask:!0});try{const t=await n.createShanjianTask({anchor:_.anchorLists.map((e=>({anchor_id:e.anchor_id,pic:e.pic,anchor_url:e.anchor_url,name:e.name}))),character_design:[{name:_.name,introduced:_.introduction}],voice:_.anchorLists.map((e=>({voice_id:e.voice_id,voice_url:e.voice_url,voice_name:e.voice_name}))),copywriting:_.copywriterList,material:_.materialList.map((e=>({fileUrl:e.url,type:e.type})))});A.value||n.addShanjianPerson({name:_.name,introduced:_.introduction}),e.index.hideLoading(),F.value=t,M.value=!0}catch(a){e.index.hideLoading(),e.index.showToast({title:a||"创建失败",icon:"none",duration:3e3})}}},ee=()=>{M.value=!1,e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_publish/montage_publish",type:"reLaunch",params:{task_id:JSON.stringify([F.value.id]),scene:1}})},te=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_works/montage_works",type:"reLaunch"})},ne=async()=>{w.value=!0;try{const{lists:e,count:t}=await n.getShanjianAnchorList(L);b.value=!(e.length<(L.page_size||t)),y.value=y.value.concat(e)}finally{w.value=!1}},ae=()=>{b.value&&!w.value&&(L.page_no++,ne())};return e.onLoad((()=>{ne(),e.index.$on("confirm",(e=>{const{type:t,data:n}=e;if(t===l.ListenerTypeEnum.CREATE_ANCHOR){if(!n)return;y.value=y.value.concat(n)}if(t===l.ListenerTypeEnum.MONTAGE_COPYWRITER||t===l.ListenerTypeEnum.MONTAGE_AI_COPYWRITER){if(0==n.length)return;-1!==k.value?_.copywriterList[k.value]=n[0]:_.copywriterList=_.copywriterList.concat(n)}}))})),(i,r)=>e.e({a:e.p({title:"数字人口播混剪","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.f(e.unref(v),((n,a,i)=>e.e({a:e.unref(g)>n.step},e.unref(g)>n.step?{b:t._imports_0$12}:{},{c:e.t(n.title),d:n.step!==e.unref(v).length},n.step!==e.unref(v).length?{e:e.unref(g)>n.step?1:""}:{},{f:n.step,g:e.unref(g)==n.step?1:"",h:e.o((e=>U(n.step)),n.step)}))),c:1===e.unref(g)},1===e.unref(g)?e.e({d:t._imports_1$3,e:e.o(B),f:e.unref(y).length>0},e.unref(y).length>0?{g:e.f(e.unref(y),((n,a,i)=>e.e({a:n.pic,b:e.unref(_).anchorLists.includes(n)},e.unref(_).anchorLists.includes(n)?{c:t._imports_1$4}:{},{d:a,e:e.o((e=>{return t=n,void(_.anchorLists.includes(t)?_.anchorLists=_.anchorLists.filter((e=>e!==t)):_.anchorLists.push(t));var t}),a)}))),h:e.o(ae)}:{i:t._imports_3$1,j:e.o(B)}):{},{k:2===e.unref(g)},2===e.unref(g)?{l:e.o((e=>A.value=!1)),m:e.o((t=>e.unref(_).name=t)),n:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物名称",maxlength:"20",modelValue:e.unref(_).name}),o:e.o((e=>A.value=!1)),p:e.o((t=>e.unref(_).introduction=t)),q:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入人物介绍",maxlength:"50",modelValue:e.unref(_).introduction}),r:t._imports_4$4,s:e.o(D)}:{},{t:3===e.unref(g)},3===e.unref(g)?{v:e.o((e=>W())),w:e.f(e.unref(_).copywriterList,((t,n,a)=>({a:e.t(t.title),b:e.t(t.content),c:"8965b3fb-3-"+a,d:e.o((e=>(e=>{_.copywriterList.splice(e,1)})(n)),n),e:n,f:e.o((e=>(e=>{k.value=e;const t=_.copywriterList[e];W(t)})(n)),n)}))),x:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{y:4===e.unref(g)},4===e.unref(g)?{z:e.t(e.unref(_).materialList.length),A:t._imports_1$3,B:e.o((e=>q.value=!0)),C:e.f(e.unref(_).materialList,((n,i,r)=>e.e({a:n.pic,b:"image"===n.type},"image"===n.type?{c:t._imports_5$2}:{d:t._imports_3$4},{e:e.o((t=>(t=>{const{type:n,pic:a,url:i}=t;"image"===n?e.index.previewImage({urls:[a]}):(P.poster=a,P.url=i,I.value=!0)})(n)),i),f:"8965b3fb-4-"+r,g:e.o((e=>{return t=n.id,_.materialList=_.materialList.filter((e=>e.id!==t)),void a.deleteMaterialLibrary({id:t});var t}),i),h:i}))),D:e.p({name:"close",color:"#ffffff",size:"16"})}:{},{E:5===e.unref(g)},5===e.unref(g)?{F:e.t(e.unref(_).anchorLists.length),G:e.p({name:"arrow-right",color:"#C5CACA"}),H:e.o((e=>U(1))),I:e.f(e.unref(_).anchorLists,((e,t,n)=>({a:e.pic,b:t}))),J:e.t(e.unref(_).name),K:e.t(e.unref(_).introduction),L:e.p({name:"arrow-right",color:"#C5CACA"}),M:e.o((e=>U(2))),N:e.t(e.unref(_).copywriterList.length),O:e.p({name:"arrow-right",color:"#C5CACA"}),P:e.o((e=>U(3))),Q:e.t(e.unref(_).materialList.length),R:e.p({name:"arrow-right",color:"#C5CACA"}),S:e.o((e=>U(4)))}:{},{T:e.unref(g)!=e.unref(v).length},e.unref(g)!=e.unref(v).length?e.e({U:1===e.unref(g)},1===e.unref(g)?{V:e.t(e.unref(_).anchorLists.length),W:e.n(e.unref(_).anchorLists.length>0?"bg-black":"bg-_h787878CC_")}:{X:e.o((t=>U(e.unref(g),"prev")))},{Y:e.n(e.unref(O)?"bg-black":"bg-_h787878CC_"),Z:e.o((t=>U(e.unref(g),"next")))}):{aa:t._imports_7,ab:e.o((e=>z.value=!0)),ac:e.t(e.unref(_).copywriterList.length),ad:e.o(Z)},{ae:e.f(e.unref(x),((t,a,i)=>({a:e.t(t.name),b:e.t(t.introduced),c:"8965b3fb-11-"+i+",8965b3fb-10",d:e.o((a=>(async t=>{e.index.showLoading({title:"删除中...",mask:!0});try{await n.deleteShanjianPerson({id:t}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),x.value=x.value.filter((e=>e.id!==t))}catch(a){e.index.hideLoading(),e.index.showToast({title:a||"删除失败",icon:"none",duration:3e3})}})(t.id)),a),e:a,f:e.o((e=>(e=>{_.name=e.name,_.introduction=e.introduced,A.value=!0,j.value=!1})(t)),a)}))),af:e.p({name:"close",color:"#ffffff",size:"16"}),ag:e.sr(C,"8965b3fb-10,8965b3fb-9",{k:"pagingHistoryRef"}),ah:e.o(G),ai:e.o((t=>e.isRef(x)?x.value=t:null)),aj:e.p({auto:!1,fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(x)}),ak:e.o((t=>e.isRef(j)?j.value=t:null)),al:e.p({title:"历史人设","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(j)}),am:e.t(R[0]),an:e.t(R[1]),ao:e.t(200),ap:e.t(T.join("、")),aq:e.t(20),ar:e.t($[0]),as:e.t($[1]),at:e.o((e=>q.value=!1)),av:e.o(X),aw:e.o((t=>e.isRef(q)?q.value=t:null)),ax:e.p({mode:"center","border-radius":"24",width:"90%",modelValue:e.unref(q)}),ay:e.o((t=>e.isRef(S)?S.value=t:null)),az:e.p({"upload-list":e.unref(N),modelValue:e.unref(S)}),aA:e.sr(E,"8965b3fb-15",{k:"videoPreviewRef"}),aB:e.o((t=>e.isRef(I)?I.value=t:null)),aC:e.p({title:"视频预览",poster:e.unref(P).poster,"video-url":e.unref(P).url,show:e.unref(I)}),aD:t._imports_8,aE:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).score),aF:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_VOICE_SHANJIAN).unit),aG:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).score),aH:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_AVATAR_SHANJIAN).unit),aI:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).score),aJ:e.t(J(e.unref(s.TokensSceneEnum).HUMAN_VIDEO_SHANJIAN).unit),aK:e.o((t=>e.isRef(z)?z.value=t:null)),aL:e.p({title:"批量数字人口播混剪",height:"70%",show:e.unref(z)}),aM:e.o(ee),aN:e.o(te),aO:e.o((t=>e.isRef(M)?M.value=t:null)),aP:e.p({mode:"center","border-radius":"20",width:"85%","custom-style":{backgroundColor:"transparent"},"mask-close-able":!1,modelValue:e.unref(M)}),aQ:e.sr(H,"8965b3fb-18",{k:"rechargePopupRef"})})}}),f=e._export_sfc(d,[["__scopeId","data-v-8965b3fb"]]);wx.createPage(f);
