"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../common/assets.js"),i=require("../../../../config/index.js"),r=require("../../../../api/digital_human.js"),n=require("../../../../enums/appEnums.js"),a=require("../../enums/index.js"),s=require("../../../../stores/user.js"),u=require("../../hooks/useUpload.js"),t=require("../../../../utils/request/cancel.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||(l+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+m+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const l=()=>"../../components/video-player/video-player.js",m=()=>"../../components/upload-loading/upload-loading.js",d=e.defineComponent({__name:"video_upload",setup(l){const m=["mp4","mov"],d=s.useUserStore(),{userTokens:c}=e.toRefs(d),p=e.shallowRef(),v=e.reactive({name:"",url:"",pic:"",anchor_id:"",model_version:"",width:0,height:0}),g=e.ref(!1),f=e.ref(),_=e.ref(!1),h=e.ref(0),A=e.shallowRef(),E=e.ref(!1),D=e.ref(""),j={resolution:`${u.commonUploadLimit.minResolution}P-${u.commonUploadLimit.maxResolution}P`,fileSize:u.commonUploadLimit.size},x=e=>`${u.uploadLimit[e].minResolution}P-${u.uploadLimit[e].maxResolution}P`,M={[a.DigitalHumanModelVersionEnum.STANDARD]:{resolution:x(a.DigitalHumanModelVersionEnum.STANDARD),fileSize:u.uploadLimit[a.DigitalHumanModelVersionEnum.STANDARD].size},[a.DigitalHumanModelVersionEnum.SUPER]:{resolution:x(a.DigitalHumanModelVersionEnum.SUPER),fileSize:u.uploadLimit[a.DigitalHumanModelVersionEnum.SUPER].size},[a.DigitalHumanModelVersionEnum.ADVANCED]:j,[a.DigitalHumanModelVersionEnum.ELITE]:j,[a.DigitalHumanModelVersionEnum.CHANJING]:{resolution:x(a.DigitalHumanModelVersionEnum.CHANJING),fileSize:u.uploadLimit[a.DigitalHumanModelVersionEnum.CHANJING].size}},y=e.computed((()=>{const e=v.model_version?"string"==typeof v.model_version?parseInt(v.model_version):v.model_version:a.DigitalHumanModelVersionEnum.STANDARD,o=Object.values(a.DigitalHumanModelVersionEnum).includes(e)?e:a.DigitalHumanModelVersionEnum.STANDARD,i=M[o]||j;return[{name:"视频方向",value:"横向或纵向"},{name:"文件格式",value:m.join("、")},{name:"分辨率",value:i.resolution},{name:"声音要求",value:"视频内音频需要清晰、响亮且无嘈杂背景音等干扰"},{name:"文件大小",value:`小于${i.fileSize}MB`}]})),q=e.computed((()=>v.model_version?u.uploadLimit[v.model_version]:null)),H=async()=>{var o,i;if(p.value===a.ModeTypeEnum.ANCHOR){const r=(e=>{const o={pro:{avatar:n.TokensSceneEnum.HUMAN_AVATAR_PRO},normal:{avatar:n.TokensSceneEnum.HUMAN_AVATAR},advanced:{avatar:n.TokensSceneEnum.HUMAN_AVATAR_ADVANCED},elite:{avatar:n.TokensSceneEnum.HUMAN_AVATAR_ELITE},chanjing:{avatar:n.TokensSceneEnum.HUMAN_AVATAR_CHANJING}};switch(e){case a.DigitalHumanModelVersionEnum.SUPER:return o.pro;case a.DigitalHumanModelVersionEnum.ADVANCED:return o.advanced;case a.DigitalHumanModelVersionEnum.ELITE:return o.elite;case a.DigitalHumanModelVersionEnum.CHANJING:return o.chanjing;default:return o.normal}})(parseInt(String(v.model_version))),{score:s}=(i=r.avatar,d.getTokenByScene(i));if(c.value<s)return g.value=!0,await e.nextTick$1(),void(null==(o=f.value)||o.open())}if(e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#000000"}),!q.value)return void e.index.$u.toast("上传参数无效，请检查模型版本");const{upload:s}=u.useUpload({size:q.value.size,resolution:[q.value.minResolution,q.value.maxResolution],duration:[q.value.videoMinDuration,q.value.videoMaxDuration],extension:m,async onSuccess(o){const{url:i,pic:n,width:a,height:s}=o;v.url=i,v.pic=n,v.width=a,v.height=s,v.name=e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM").substring(2),D.value="形象克隆中...";try{const e=await r.createAnchor(v);v.anchor_id=e.id,E.value=!0,D.value=""}catch(u){_.value=!1,h.value=0,D.value="";let o="上传失败";if(u)if("string"==typeof u)o=u;else if("object"==typeof u){o=u.message||"上传失败"}e.index.$u.toast(o),R()}},onProgress(e){A.value=e.type,h.value=e.progress,D.value="video"===A.value?"视频正在上传中...":"图片正在上传中...",_.value=!0},onError(o){o.errMsg&&"chooseMedia:fail api scope is not declared in the privacy agreement"===o.errMsg?e.index.$u.toast("请完善隐私协议，否则无法使用"):e.index.$u.toast(o.errMsg||"上传失败"),_.value=!1,h.value=0,R()}});s()},N=()=>{t.requestCancel.remove("/upload/video"),t.requestCancel.remove("/upload/image"),_.value=!1,h.value=0,D.value="",R()},S=async()=>{try{e.index.$u.route({url:"/ai_modules/digital_human/pages/video_create/video_create",type:"redirect",params:{type:a.ListenerTypeEnum.UPLOAD_VIDEO,data:JSON.stringify(v)}})}catch(o){console.error("导航到视频创建页面失败:",o),e.index.$u.toast("页面跳转失败，请重试")}},V=()=>{try{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"redirect"})}catch(o){console.error("返回首页失败:",o),e.index.$u.toast("页面跳转失败，请重试")}},R=()=>{try{e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#F9FAFB"})}catch(o){console.error("重置导航栏颜色失败:",o)}};return e.onLoad((e=>{try{if(e.type&&(p.value=e.type),e.model_version){const o=parseInt(e.model_version);isNaN(o)?console.warn("无效的模型版本:",e.model_version):v.model_version=o}}catch(o){console.error("页面加载参数处理失败:",o)}})),(r,n)=>e.e({a:o._imports_0$7,b:e.p({"play-icon-size":88,poster:`${e.unref(i.config).baseUrl}static/images/dh_example_bg2.png`,"video-url":`${e.unref(i.config).baseUrl}static/videos/dh_example2.mp4`}),c:o._imports_1$3,d:o._imports_2$1,e:e.f(e.unref(y),((o,i,r)=>({a:e.t(i+1),b:e.t(o.name),c:e.t(o.value),d:i}))),f:o._imports_3,g:o._imports_4,h:e.o((e=>H())),i:e.p({type:"primary",shape:"circle","custom-style":{height:"90rpx",boxShadow:" 0px 3px 12px 0px rgba(0, 0, 0, 0.12)",fontSize:"26rpx"}}),j:e.unref(_)},e.unref(_)?{k:e.o(N),l:e.o(V),m:e.o(S),n:e.p({progress:e.unref(h),"loading-text":e.unref(D),"is-success":e.unref(E),"progress-type":e.unref(A)})}:{},{o:e.unref(g)},e.unref(g)?{p:e.sr(f,"1896c5fd-3",{k:"rechargePopupRef"}),q:e.o((e=>g.value=!1))}:{})}}),c=e._export_sfc(d,[["__scopeId","data-v-1896c5fd"]]);wx.createPage(c);
