"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),o=require("../../../../config/index.js"),n=require("../../../../api/digital_human.js"),r=require("../../../../enums/appEnums.js"),a=require("../../enums/index.js"),u=require("../../../../stores/user.js"),s=require("../../hooks/useUpload.js"),t=require("../../../../utils/request/cancel.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-button")+e.resolveComponent("recharge-popup"))()}Math||(l+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+m+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const l=()=>"../../components/video-player/video-player.js",m=()=>"../../components/upload-loading/upload-loading.js",d=e.defineComponent({__name:"video_upload",setup(l){const m=["mp4","mov"],d=u.useUserStore(),{userTokens:p}=e.toRefs(d),c=e.shallowRef(),v=e.reactive({name:"",url:"",pic:"",anchor_id:"",model_version:"",width:0,height:0}),g=e.ref(!1),A=e.ref(),_=e.ref(!1),f=e.ref(0),E=e.shallowRef(),h=e.ref(!1),D=e.ref(""),M={resolution:`${s.commonUploadLimit.minResolution}P-${s.commonUploadLimit.maxResolution}P`,fileSize:s.commonUploadLimit.size},N=e=>`${s.uploadLimit[e].minResolution}P-${s.uploadLimit[e].maxResolution}P`,H={[a.DigitalHumanModelVersionEnum.STANDARD]:{resolution:N(a.DigitalHumanModelVersionEnum.STANDARD),fileSize:s.uploadLimit[a.DigitalHumanModelVersionEnum.STANDARD].size},[a.DigitalHumanModelVersionEnum.SUPER]:{resolution:N(a.DigitalHumanModelVersionEnum.SUPER),fileSize:s.uploadLimit[a.DigitalHumanModelVersionEnum.SUPER].size},[a.DigitalHumanModelVersionEnum.ADVANCED]:M,[a.DigitalHumanModelVersionEnum.ELITE]:M,[a.DigitalHumanModelVersionEnum.CHANJING]:{resolution:N(a.DigitalHumanModelVersionEnum.CHANJING),fileSize:s.uploadLimit[a.DigitalHumanModelVersionEnum.CHANJING].size},[a.DigitalHumanModelVersionEnum.SHANJIAN]:{resolution:N(a.DigitalHumanModelVersionEnum.SHANJIAN),fileSize:s.uploadLimit[a.DigitalHumanModelVersionEnum.SHANJIAN].size}},x=e.computed((()=>{const e=v.model_version?"string"==typeof v.model_version?parseInt(v.model_version):v.model_version:a.DigitalHumanModelVersionEnum.STANDARD,i=Object.values(a.DigitalHumanModelVersionEnum).includes(e)?e:a.DigitalHumanModelVersionEnum.STANDARD,o=H[i]||M;return[{name:"视频方向",value:"横向或纵向"},{name:"文件格式",value:m.join("、")},{name:"分辨率",value:o.resolution},{name:"声音要求",value:"视频内音频需要清晰、响亮且无嘈杂背景音等干扰"},{name:"文件大小",value:`小于${o.fileSize}MB`}]})),j=e.computed((()=>v.model_version?s.uploadLimit[v.model_version]:null)),S=async()=>{var i,o;if(c.value===a.ModeTypeEnum.ANCHOR){const n=(e=>{const i={pro:{avatar:r.TokensSceneEnum.HUMAN_AVATAR_PRO},normal:{avatar:r.TokensSceneEnum.HUMAN_AVATAR},advanced:{avatar:r.TokensSceneEnum.HUMAN_AVATAR_ADVANCED},elite:{avatar:r.TokensSceneEnum.HUMAN_AVATAR_ELITE},chanjing:{avatar:r.TokensSceneEnum.HUMAN_AVATAR_CHANJING}};switch(e){case a.DigitalHumanModelVersionEnum.SUPER:return i.pro;case a.DigitalHumanModelVersionEnum.ADVANCED:return i.advanced;case a.DigitalHumanModelVersionEnum.ELITE:return i.elite;case a.DigitalHumanModelVersionEnum.CHANJING:return i.chanjing;default:return i.normal}})(parseInt(String(v.model_version))),{score:u}=(o=n.avatar,d.getTokenByScene(o));if(p.value<u)return g.value=!0,await e.nextTick$1(),void(null==(i=A.value)||i.open())}if(e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#000000"}),!j.value)return void e.index.$u.toast("上传参数无效，请检查模型版本");const{upload:u}=s.useUpload({size:j.value.size,resolution:[j.value.minResolution,j.value.maxResolution],duration:[j.value.videoMinDuration,j.value.videoMaxDuration],extension:m,async onSuccess(i){const{url:o,pic:r,width:u,height:s}=i;if(v.url=o,v.pic=r,v.width=u,v.height=s,v.name=e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM").substring(2),v.model_version!=a.DigitalHumanModelVersionEnum.SHANJIAN){D.value="形象克隆中...";try{const e=await n.createAnchor(v);v.anchor_id=e.id,h.value=!0,D.value=""}catch(t){_.value=!1,f.value=0,D.value="",e.index.$u.toast(t||"上传失败"),R()}}else h.value=!0},onProgress(e){E.value=e.type,f.value=e.progress,D.value="video"===E.value?"视频正在上传中...":"图片正在上传中...",_.value=!0},onError(i){i.errMsg&&"chooseMedia:fail api scope is not declared in the privacy agreement"===i.errMsg?e.index.$u.toast("请完善隐私协议，否则无法使用"):i&&i.errMsg&&-1==i.errMsg.indexOf("cancel")&&e.index.$u.toast(i.errMsg||"上传失败"),_.value=!1,f.value=0,R()}});u()},V=()=>{t.requestCancel.remove("/upload/video"),t.requestCancel.remove("/upload/image"),_.value=!1,f.value=0,D.value="",R()},q=async()=>{if(v.model_version==a.DigitalHumanModelVersionEnum.SHANJIAN)return e.index.$emit("confirm",{type:a.ListenerTypeEnum.MONTAGE_ANCHOR,data:v}),void e.index.navigateBack();e.index.$u.route({url:"/ai_modules/digital_human/pages/video_create/video_create",type:"redirect",params:{type:a.ListenerTypeEnum.UPLOAD_VIDEO,data:JSON.stringify(v)}})},y=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/index/index",type:"redirect"})},R=()=>{e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#F9FAFB"})};return e.onLoad((e=>{try{if(e.type&&(c.value=e.type),e.model_version){const i=parseInt(e.model_version);isNaN(i)?console.warn("无效的模型版本:",e.model_version):v.model_version=i}}catch(i){console.error("页面加载参数处理失败:",i)}})),(n,r)=>e.e({a:i._imports_0$7,b:e.p({"play-icon-size":88,poster:`${e.unref(o.config).baseUrl}static/images/dh_example_bg2.png`,"video-url":`${e.unref(o.config).baseUrl}static/videos/dh_example2.mp4`}),c:i._imports_1$3,d:i._imports_2$1,e:e.f(e.unref(x),((i,o,n)=>({a:e.t(o+1),b:e.t(i.name),c:e.t(i.value),d:o}))),f:i._imports_3,g:i._imports_4,h:e.o((e=>S())),i:e.p({type:"primary",shape:"circle","custom-style":{height:"90rpx",boxShadow:" 0px 3px 12px 0px rgba(0, 0, 0, 0.12)",fontSize:"26rpx"}}),j:e.unref(_)},e.unref(_)?{k:e.o(V),l:e.o(y),m:e.o(q),n:e.p({progress:e.unref(f),"loading-text":e.unref(D),"is-success":e.unref(h),"progress-type":e.unref(E),"show-back":e.unref(v).model_version!==e.unref(a.DigitalHumanModelVersionEnum).SHANJIAN})}:{},{o:e.unref(g)},e.unref(g)?{p:e.sr(A,"5f3a2d85-3",{k:"rechargePopupRef"}),q:e.o((e=>g.value=!1))}:{})}}),p=e._export_sfc(d,[["__scopeId","data-v-5f3a2d85"]]);wx.createPage(p);
