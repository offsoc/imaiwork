"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),n=require("../../../../api/app.js"),r=require("../../../../api/digital_human.js"),o=require("../../enums/index.js"),a=require("../../../../stores/user.js"),u=require("../../../../stores/app.js"),t=require("../../hooks/useUpload.js"),s=require("../../../../utils/file.js"),c=require("../../../../hooks/usePolling.js"),d=require("../../../../enums/appEnums.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../components/file-upload/choose-file.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-popup")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const l=e.defineComponent({__name:"montage_anchor_create",setup(l){const p=a.useUserStore(),{userTokens:m}=e.toRefs(p),h=u.useAppStore(),f=e.computed((()=>h.config.is_oss_transcode)),v=e.reactive({name:"",pic:"",url:""}),_=e.reactive({name:"",pic:"",url:""}),g=e.ref({}),j=e.ref(!1),q=e.shallowRef(),x=e.computed((()=>{var e;return null==(e=p.getTokenByScene(d.TokensSceneEnum.HUMAN_AVATAR_SHANJIAN))?void 0:e.score})),A=e.computed((()=>_.url&&v.url)),w=e.computed((()=>6==g.value.status)),T=e.computed((()=>t.uploadLimit[o.DigitalHumanModelVersionEnum.SHANJIAN])),k=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/video_upload/video_upload",params:{model_version:o.DigitalHumanModelVersionEnum.SHANJIAN}})},y=()=>{e.index.showActionSheet({itemList:["录制授权视频","从手机相册选择","选择历史授权视频"],success:async i=>{if(0===i.tapIndex){if(!(await s.requestAuthorization("scope.camera")))return void e.index.$u.toast("您关闭了权限，请前往设置打开权限");e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_auth_camera/montage_auth_camera"})}else 1===i.tapIndex?E():2===i.tapIndex&&e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_auth_video/montage_auth_video"})}})},b=async e=>new Promise((async(i,r)=>{try{const r=await n.videoTranscode({video_url:e}),{start:o,end:a}=c.usePolling((async()=>{try{const e=await n.getVideoTranscodeResult({jobid:r.jobid});"TranscodeSuccess"==e.state?(a(),i(!0)):"TranscodeFail"!=e.state&&"TranscodeCancelled"!=e.state||(a(),i(!1))}catch(e){a(),i(!1)}}),{});await o()}catch(o){i(!1)}})),E=()=>{const{upload:i}=t.useUpload({duration:[1,120],onProgress:i=>{e.index.showLoading({title:"视频上传中",mask:!0})},onSuccess:async i=>{e.index.hideLoading(),e.index.showToast({title:"视频上传成功",icon:"none",duration:3e3}),_.pic=i.pic,_.name=i.name,_.url=i.url},onError:i=>{const{type:n,error:r}=i;e.index.hideLoading(),"video"==n&&e.index.showToast({title:r||"视频上传失败",icon:"none",duration:3e3})}});i()},L=async()=>{var i;if(m.value<=x.value)null==(i=q.value)||i.open();else if(v.url)if(_.url){if(e.index.showLoading({title:"创建形象中...",mask:!0}),f.value)try{Promise.allSettled([await b(v.url),await b(_.url)])}catch(n){}try{const i=await r.createShanjianAnchor({name:"",pic:v.pic,anchor_url:v.url,authorized_pic:_.pic,authorized_url:_.url});e.index.hideLoading(),e.index.showLoading({title:"人脸对比中...",mask:!0});const{start:n,end:o}=c.usePolling((async()=>{g.value=await r.getShanjianAnchorDetail({id:i.id});const{status:n}=g.value;if(2==n||3==n||5==n||6==n)return o(),e.index.hideLoading(),void(j.value=!0)}),{});await n()}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"创建形象失败",icon:"none",duration:3e3})}}else e.index.showToast({title:"请上传授权视频",icon:"none",duration:3e3});else e.index.showToast({title:"请上传形象视频",icon:"none",duration:3e3})},S=()=>{w.value?(e.index.$emit("confirm-v2",{type:o.ListenerTypeEnum.CHOOSE_MONTAGE_ANCHOR,data:g.value}),e.index.navigateBack()):(_.pic="",_.url="",_.name="",j.value=!1)};return e.onLoad((()=>{e.index.$on("confirm",(e=>{const{type:i,data:n}=e;i===o.ListenerTypeEnum.MONTAGE_ANCHOR&&(e=>{v.name=e.name,v.pic=e.pic,v.url=e.url})(n),i!==o.ListenerTypeEnum.MONTAGE_AUTH&&i!==o.ListenerTypeEnum.UPLOAD_AUTH_CAMERA||(e=>{_.name=e.name,_.pic=e.pic,_.url=e.url})(n)}))})),(n,r)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.unref(v).pic},e.unref(v).pic?{c:e.o(k)}:{},{d:!e.unref(v).pic},e.unref(v).pic?{j:e.unref(v).url,k:e.unref(v).pic}:{e:i._imports_0$15,f:e.t(e.unref(T).videoMinDuration),g:e.t(e.unref(T).videoMaxDuration),h:e.t(e.unref(T).size),i:e.o(k)},{l:e.unref(_).pic},e.unref(_).pic?{m:e.o(y)}:{},{n:!e.unref(_).pic},e.unref(_).pic?{q:e.unref(_).url,r:e.unref(_).pic}:{o:i._imports_0$15,p:e.o(y)},{s:e.t(e.unref(x)),t:e.n(e.unref(A)?"bg-black":"bg-_h787878CC_"),v:e.o(L),w:e.p({name:e.unref(w)?"checkmark":"error",color:"#ffffff",size:"28"}),x:e.t(e.unref(w)?"克隆成功":e.unref(g).remark),y:e.t(e.unref(g).anchor_id?"返回":"确认"),z:e.o(S),A:e.o((i=>e.isRef(j)?j.value=i:null)),B:e.p({mode:"center","border-radius":"48",width:"90%","mask-close-able":!1,modelValue:e.unref(j)}),C:e.sr(q,"30094f95-3",{k:"rechargePopupRef"})})}}),p=e._export_sfc(l,[["__scopeId","data-v-30094f95"]]);wx.createPage(p);
