"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),n=require("../../../../api/digital_human.js"),r=require("../../enums/index.js"),u=require("../../hooks/useUpload.js"),o=require("../../../../utils/file.js"),a=require("../../../../hooks/usePolling.js"),t=require("../../../../stores/user.js"),s=require("../../../../enums/appEnums.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../components/file-upload/choose-file.js"),require("../../../../api/app.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-popup")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const c=e.defineComponent({__name:"montage_anchor_create",setup(c){const d=t.useUserStore(),{userTokens:l}=e.toRefs(d),p=e.reactive({name:"",pic:"",url:""}),m=e.reactive({name:"",pic:"",url:""}),f=e.ref({}),h=e.ref(!1),v=e.shallowRef(),_=e.computed((()=>{var e;return null==(e=d.getTokenByScene(s.TokensSceneEnum.HUMAN_AVATAR_SHANJIAN))?void 0:e.score})),g=e.computed((()=>m.url&&p.url)),j=e.computed((()=>6==f.value.status)),q=e.computed((()=>u.uploadLimit[r.DigitalHumanModelVersionEnum.SHANJIAN])),x=()=>{e.index.$u.route({url:"/ai_modules/digital_human/pages/video_upload/video_upload",params:{model_version:r.DigitalHumanModelVersionEnum.SHANJIAN}})},A=()=>{e.index.showActionSheet({itemList:["录制授权视频","从手机相册选择","选择历史授权视频"],success:async i=>{if(0===i.tapIndex){if(!(await o.requestAuthorization("scope.camera")))return void e.index.$u.toast("您关闭了权限，请前往设置打开权限");e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_auth_camera/montage_auth_camera"})}else 1===i.tapIndex?k():2===i.tapIndex&&e.index.$u.route({url:"/ai_modules/digital_human/pages/montage_auth_video/montage_auth_video"})}})},k=()=>{e.index.showLoading({title:"视频上传中",mask:!0});const{upload:i}=u.useUpload({duration:[1,120],onSuccess:i=>{e.index.hideLoading(),e.index.showToast({title:"视频上传成功",icon:"none",duration:3e3}),m.url=i.url,m.pic=i.pic,m.name=i.name},onError:i=>{e.index.hideLoading(),e.index.showToast({title:i||"视频上传失败",icon:"none",duration:3e3})}});i()},w=async()=>{var i;if(l.value<=_.value)null==(i=v.value)||i.open();else{e.index.showLoading({title:"创建形象中",mask:!0});try{const i=await n.createShanjianAnchor({name:"",pic:p.pic,anchor_url:p.url,authorized_pic:m.pic,authorized_url:m.url});e.index.hideLoading(),e.index.showLoading({title:"人脸对比中...",mask:!0});const{start:r,end:u}=a.usePolling((async()=>{f.value=await n.getShanjianAnchorDetail({id:i.id});const{status:r}=f.value;if(2==r||3==r||5==r||6==r)return u(),e.index.hideLoading(),void(h.value=!0)}),{});await r()}catch(r){e.index.hideLoading(),e.index.showToast({title:r||"创建形象失败",icon:"none",duration:3e3})}}},T=()=>{j.value?(e.index.$emit("confirm-v2",{type:r.ListenerTypeEnum.CHOOSE_MONTAGE_ANCHOR,data:f.value}),e.index.navigateBack()):(m.pic="",m.url="",m.name="",h.value=!1)};return e.onShow((()=>{e.index.$on("confirm",(i=>{const{type:n,data:u}=i;n===r.ListenerTypeEnum.MONTAGE_ANCHOR&&(e=>{p.name=e.name,p.pic=e.pic,p.url=e.url})(u),n!==r.ListenerTypeEnum.MONTAGE_AUTH&&n!==r.ListenerTypeEnum.UPLOAD_AUTH_CAMERA||(e=>{m.name=e.name,m.pic=e.pic,m.url=e.url})(u),e.index.$off("confirm")}))})),(n,r)=>e.e({a:e.p({title:"智能数字人","title-bold":!0,"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:e.unref(p).pic},e.unref(p).pic?{c:e.o(x)}:{},{d:!e.unref(p).pic},e.unref(p).pic?{k:e.unref(p).url,l:e.unref(p).pic}:{e:i._imports_0$16,f:e.t(e.unref(q).videoMinDuration),g:e.t(e.unref(q).videoMaxDuration),h:e.t(e.unref(q).videoMaxDuration),i:e.t(e.unref(q).size),j:e.o(x)},{m:e.unref(m).pic},e.unref(m).pic?{n:e.o(A)}:{},{o:!e.unref(m).pic},e.unref(m).pic?{r:e.unref(m).url,s:e.unref(m).pic}:{p:i._imports_0$16,q:e.o(A)},{t:e.t(e.unref(_)),v:e.n(e.unref(g)?"bg-black":"bg-_h787878CC_"),w:e.o(w),x:e.p({name:e.unref(j)?"checkmark":"error",color:"#ffffff",size:"28"}),y:e.t(e.unref(j)?"克隆成功":e.unref(f).remark),z:e.t(e.unref(f).anchor_id?"返回":"确认"),A:e.o(T),B:e.o((i=>e.isRef(h)?h.value=i:null)),C:e.p({mode:"center","border-radius":"48",width:"90%","mask-close-able":!1,modelValue:e.unref(h)}),D:e.sr(v,"c61d018f-3",{k:"rechargePopupRef"})})}}),d=e._export_sfc(c,[["__scopeId","data-v-c61d018f"]]);wx.createPage(d);
