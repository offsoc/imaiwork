"use strict";const e=require("../../../../common/vendor.js"),r=require("../../../../api/sph.js"),a=require("../../../../api/device.js"),t=require("../../../../api/person_wechat.js"),n=require("../../../../hooks/usePaging.js"),o=require("../../../../stores/app.js"),u=require("../../../../stores/user.js"),i=require("../../../../common/assets.js"),s=require("../../enums/index.js"),l=require("../../../../enums/appEnums.js"),d=require("../../../../hooks/useDictOptions.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-radio")+e.resolveComponent("u-radio-group")+e.resolveComponent("u-switch")+e.resolveComponent("data-select")+e.resolveComponent("u-input")+e.resolveComponent("u-button")+e.resolveComponent("u-popup")+e.resolveComponent("u-line")+e.resolveComponent("confirm-dialog"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-radio/u-radio.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-radio-group/u-radio-group.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-switch/u-switch.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../../components/confirm-dialog/confirm-dialog.js"))();const p=e.defineComponent({__name:"create_task",setup(p){const c=o.useAppStore(),f=u.useUserStore(),m=e.computed((()=>c.config.wechat_remarks||[])),_=e.computed((()=>{var e;return null==(e=f.getTokenByScene(l.TokensSceneEnum.SPH_OCR))?void 0:e.score})),v=e.computed((()=>{var e;return null==(e=f.getTokenByScene(l.TokensSceneEnum.SPH_LOCAL_OCR))?void 0:e.score})),g=e.ref([{step:1,title:"选择类型"},{step:2,title:"设置线索"},{step:3,title:"填设置"},{step:4,title:"设定时间"}]),h=e.ref(1),y=[{title:"账号获客",value:1,icon:i.AccountIcon,primaryIcon:i.AccountPrimaryIcon},{title:"视频获客",value:0,icon:i.VideoIcon,primaryIcon:i.VideoPrimaryIcon}],x=e.reactive({name:`视频号获客任务${e.index.$u.timeFormat(Date.now(),"yyyymmddhhMM")}`,crawl_type:1,chat_type:"0",chat_number:30,chat_interval_time:10,greeting_content:"",add_type:"1",remark:"",add_number:15,add_interval_time:10,private_message_prompt:"",add_friends_prompt:"",wechat_id:"",wechat_reg_type:0,add_remark_enable:1,ocr_type:1,remarks:m.value,keywords:[],device_codes:[],task_frep:1,time_config:["09:00","09:30"],custom_date:[]}),w=e.ref(!1),b=e.ref(""),k=e.ref(-1),j=e.ref(!1),q=e.ref(!1),S=e.ref(-1),z=e.ref(""),C=e.ref(0),$=e.ref(!1),L=e.ref(""),E=e.ref(!1),T=e.ref("private_message_prompt"),V=e.computed((()=>D(h.value))),D=e=>{switch(e){case 1:case 4:return!0;case 2:return 0!=x.keywords.length;case 3:return"1"!=x.add_type||0!=x.wechat_id.length&&!(1==x.add_remark_enable&&!x.remarks.length);default:return!1}},O=(r,a)=>{if("prev"!==a)if("next"!==a){if(r!==h.value)if(r<h.value)h.value=r;else{for(let a=1;a<r;a++)if(!D(a)){const r={2:"请至少添加一条线索",3:"请完善加微设置",4:"请设定时间"};return void e.index.$u.toast(r[a]||"请按顺序完成步骤")}h.value=r}}else V.value?h.value++:e.index.$u.toast("请完成当前步骤");else h.value--},{pager:I,getLists:R}=n.usePaging({fetchFun:a.getDeviceList,params:{page_size:999}}),{optionsData:A}=d.useDictOptions({wechatLists:{api:t.getWeChatLists,params:{page_size:9999},transformData:e=>{var r;return null==(r=e.lists)?void 0:r.map((e=>({text:e.wechat_nickname,value:e.wechat_id})))}}}),M=()=>{b.value?(-1==k.value?x.keywords.unshift(b.value):x.keywords[k.value]=b.value,b.value="",w.value=!1):e.index.$u.toast("请输入检索词")},P=()=>{k.value=-1,b.value="",w.value=!1},H=()=>{z.value?(-1==S.value?x.remarks.push(z.value):x.remarks[S.value]=z.value,S.value=-1,z.value="",q.value=!1):e.index.$u.toast("请输入加好友备注内容")},F=()=>{e.index.$u.route({url:"/ai_modules/device/pages/custom_date/custom_date",params:{date:x.custom_date.length>0?JSON.stringify(x.custom_date):null}})},B=r=>{const{value:a}=r.detail,t=new Date(`2000/01/01 ${a}`);x.time_config[0]=a,t.setMinutes(t.getMinutes()+30),x.time_config[1]=e.index.$u.timeFormat(t,"hh:MM")},J=r=>{const{value:a}=r.detail;if(a<=x.time_config[0])return void e.index.$u.toast("结束时间不能小于开始时间");const t=new Date(`2000/01/01 ${x.time_config[0]}`);new Date(`2000/01/01 ${a}`).getTime()-t.getTime()<18e5?e.index.$u.toast("结束时间不能小于开始时间30分钟"):x.time_config[1]=a},N=()=>{x.time_config[0]||e.index.$u.toast("请先选择开始时间")},U=()=>{E.value=!1,e.index.$u.route({url:"/ai_modules/sph/pages/index/index",type:"reLaunch"})},K=async()=>{if(0!=x.device_codes.length)if(""!=x.time_config[0]&&""!=x.time_config[1]){e.index.showLoading({title:"创建中...",mask:!0});try{await r.createTask({...x,time_config:[`${x.time_config[0]}-${x.time_config[1]}`],type:[l.AppTypeEnum.SPH]}),e.index.hideLoading(),E.value=!0}catch(a){L.value=a,e.index.hideLoading(),e.index.showToast({title:a,icon:"none",duration:3e3})}}else e.index.$u.toast("请选择时间");else e.index.$u.route({url:"/ai_modules/device/pages/device_choose/device_choose"})};return e.watch((()=>c.config.wechat_remarks),(()=>{x.remarks=m.value})),e.onShow((()=>{R()})),e.onLoad((({type:r})=>{r&&(x.crawl_type=r),e.index.$on("confirm",(e=>{const{type:r,data:a}=e;if(r===s.ListenerTypeEnum.TASK_AI_CLUE){if(0===a.length)return;x.keywords.push(...a)}if(r===s.ListenerTypeEnum.CHOOSE_DEVICE){if(0===a.length)return;x.device_codes=a}if(r===s.ListenerTypeEnum.CHOOSE_DATE){if(0===a.length)return;C.value=5,x.custom_date=a}}))})),(r,a)=>e.e({a:e.p({"title-bold":!0,title:"视频号获客","border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(g),((r,a,t)=>e.e({a:e.unref(h)>r.step},e.unref(h)>r.step?{b:"177ac7a1-1-"+t,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(r.title),e:r.step!==e.unref(g).length},r.step!==e.unref(g).length?{f:e.unref(h)>r.step?1:""}:{},{g:r.step,h:e.unref(h)==r.step?1:"",i:e.o((e=>O(r.step)),r.step)}))),c:1===e.unref(h)},1===e.unref(h)?{d:e.f(y,((r,a,t)=>({a:e.unref(x).crawl_type==r.value?r.primaryIcon:r.icon,b:e.t(r.title),c:e.unref(x).crawl_type==r.value?1:"",d:a,e:e.unref(x).crawl_type==r.value?1:"",f:e.o((a=>e.unref(x).crawl_type=r.value),a)})))}:{},{e:2===e.unref(h)},2===e.unref(h)?{f:e.o((e=>w.value=!0)),g:"/ai_modules/sph/pages/task_ai_clue/task_ai_clue?type="+(0==e.unref(x).crawl_type?2:3),h:e.t(e.unref(x).keywords.length),i:e.f(e.unref(x).keywords,((r,a,t)=>({a:e.t(r),b:"177ac7a1-2-"+t,c:e.o((e=>(e=>{x.keywords.splice(e,1)})(a)),a),d:a,e:e.o((e=>(e=>{k.value=e,b.value=x.keywords[e],w.value=!0})(a)),a)}))),j:e.p({name:"close",size:"20",color:"#ffffff"})}:{},{k:3===e.unref(h)},3===e.unref(h)?e.e({l:e.p({name:"info",size:16,color:"#ffffff"}),m:e.o((e=>j.value=!0)),n:e.p({name:1,"label-size":"24",size:"28"}),o:e.p({name:2,"label-size":"24",size:"28"}),p:e.o((r=>e.unref(x).ocr_type=r)),q:e.p({modelValue:e.unref(x).ocr_type}),r:e.o((r=>e.unref(x).add_type="1"==r?"0":"1")),s:e.p({"model-value":"1"==e.unref(x).add_type,size:32,"active-value":"1","inactive-value":"0"}),t:"1"==e.unref(x).add_type},"1"==e.unref(x).add_type?{v:e.o((r=>e.unref(x).wechat_id=r)),w:e.p({multiple:!0,localdata:e.unref(A).wechatLists,modelValue:e.unref(x).wechat_id}),x:e.o((r=>e.unref(x).wechat_reg_type=r)),y:e.p({clear:!1,localdata:[{text:"全部",value:0},{text:"微信号",value:1},{text:"手机号",value:2}],modelValue:e.unref(x).wechat_reg_type}),z:e.o((r=>e.unref(x).add_number=r)),A:e.p({type:"digit",placeholder:"请输入","placeholder-style":"font-size:26rpx;color:rgba(0,0,0,0.2)",modelValue:e.unref(x).add_number}),B:e.o((r=>e.unref(x).add_interval_time=r)),C:e.p({type:"digit",placeholder:"请输入","placeholder-style":"font-size:26rpx;color:rgba(0,0,0,0.2)",modelValue:e.unref(x).add_interval_time})}:{},{D:"1"==e.unref(x).add_type},"1"==e.unref(x).add_type?e.e({E:e.o((r=>e.unref(x).add_remark_enable=1==r?0:1)),F:e.p({"model-value":e.unref(x).add_remark_enable,size:32,"active-value":"1","inactive-value":"0"}),G:0==e.unref(x).add_remark_enable},0==e.unref(x).add_remark_enable?{H:e.o((r=>e.unref(x).remark=r)),I:e.p({type:"textarea",height:"160",placeholder:"请输入打招呼内容，为了避免封控，系统将自动调用AI进行去重润色","placeholder-style":"font-size:26rpx;color:rgba(0,0,0,0.2)",modelValue:e.unref(x).remark}),J:e.o((r=>{return a="add_friends_prompt",T.value=a,void e.index.$u.route({url:"/ai_modules/sph/pages/task_prompt/task_prompt",params:{type:a,prompt:JSON.stringify(x[a])}});var a})),K:e.p({type:"primary","custom-style":{width:"240rpx",height:"80rpx",boxShadow:"0 6px 12px 0 rgba(0, 101, 251, 0.20)",fontSize:"26rpx",borderRadius:"24rpx"}})}:{},{L:1==e.unref(x).add_remark_enable},1==e.unref(x).add_remark_enable?{M:e.f(e.unref(x).remarks,((r,a,t)=>({a:e.t(r),b:"177ac7a1-15-"+t,c:e.o((e=>(e=>{x.remarks.splice(e,1)})(a)),a),d:a,e:e.o((e=>(e=>{S.value=e,z.value=x.remarks[e],q.value=!0})(a)),a)}))),N:e.p({name:"close",size:16,color:"#00000080"}),O:e.o((e=>q.value=!0)),P:e.p({type:"primary","custom-style":{boxShadow:"0 6px 12px 0 rgba(0, 101, 251, 0.20)",fontSize:"26rpx",borderRadius:"24rpx"}})}:{}):{}):{},{Q:4===e.unref(h)},4===e.unref(h)?e.e({R:e.o((r=>e.unref(x).name=r)),S:e.p({"placeholder-style":"font-size: 24rpx;",placeholder:"请输入任务名称",maxlength:"50",modelValue:e.unref(x).name}),T:e.t(e.unref(x).device_codes.length?`${e.unref(x).device_codes.length}个设备`:"选择设备"),U:e.n(e.unref(x).device_codes.length?"text-primary font-bold":"text-_h00000033_"),V:e.p({name:"arrow-right",size:"24",color:"#00000033"}),W:`/ai_modules/device/pages/device_choose/device_choose?device=${JSON.stringify(e.unref(x).device_codes)}`,X:e.f([1,3,5,10,30],((r,a,t)=>({a:e.t(r),b:a,c:e.unref(x).task_frep==r&&5!=e.unref(C)?1:"",d:e.o((e=>((e,r)=>{C.value=r,x.task_frep=e})(r,a)),a)}))),Y:5==e.unref(C)?1:"",Z:e.o(F),aa:e.unref(x).custom_date.length&&5==e.unref(C)},e.unref(x).custom_date.length&&5==e.unref(C)?e.e({ab:e.unref(x).custom_date.length>8},e.unref(x).custom_date.length>8?{ac:e.t(e.unref($)?"收起":"展开"),ad:e.p({name:e.unref($)?"arrow-up":"arrow-down",size:"24",color:"#00000033"}),ae:e.o((r=>$.value=!e.unref($)))}:{},{af:e.f(e.unref(x).custom_date,((r,a,t)=>{return{a:e.t((n=r,e.index.$u.timeFormat(new Date(n),"mm月dd日"))),b:a};var n})),ag:e.unref($)?"":1}):{},{ah:e.t(e.unref(x).time_config[0]||"开始时间"),ai:e.n(e.unref(x).time_config[0]?"text-primary font-bold":"text-_h00000033_"),aj:e.p({name:"arrow-right",size:"24",color:"#00000033"}),ak:e.unref(x).time_config[0],al:e.o(B),am:e.t(e.unref(x).time_config[1]||"结束时间"),an:e.n(e.unref(x).time_config[1]?"text-primary font-bold":"text-_h00000033_"),ao:e.p({name:"arrow-right",size:"24",color:"#00000033"}),ap:e.unref(x).time_config[1],aq:!e.unref(x).time_config[0],ar:e.o(N),as:e.o(J),at:e.unref(L)},e.unref(L)?{av:e.t(e.unref(L))}:{}):{},{aw:e.unref(h)!=e.unref(g).length},e.unref(h)!=e.unref(g).length?{ax:1!=e.unref(h),ay:e.o((r=>O(e.unref(h),"prev"))),az:e.n(e.unref(V)?"bg-primary":"bg-_h787878CC_"),aA:e.o((r=>O(e.unref(h),"next")))}:{aB:e.o(K)},{aC:e.unref(w),aD:e.unref(b),aE:e.o((r=>e.isRef(b)?b.value=r.detail.value:null)),aF:e.o(P),aG:e.p({shape:"circle","custom-style":{height:"100rpx",boxShadow:"0 0 0 1px rgba(0, 0, 0, 0.1)",backgroundColor:"transparent",color:"rgba(0,0,0,0.3)",fontSize:"26rpx"}}),aH:e.o(M),aI:e.p({type:"primary",shape:"circle","custom-style":{flex:1,height:"100rpx",boxShadow:"0 6px 12px 0 rgba(0, 101, 251, 0.20)",fontSize:"26rpx"}}),aJ:e.o(P),aK:e.o((r=>e.isRef(w)?w.value=r:null)),aL:e.p({mode:"center",width:"90%","border-radius":"64",closeable:!1,modelValue:e.unref(w)}),aM:e.t(e.unref(v)),aN:e.t(e.unref(_)),aO:e.t(e.unref(_)),aP:e.o((e=>j.value=!1)),aQ:e.o((r=>e.isRef(j)?j.value=r:null)),aR:e.p({mode:"bottom","border-radius":"24",modelValue:e.unref(j)}),aS:e.o((r=>e.isRef(z)?z.value=r:null)),aT:e.p({maxlength:"100",placeholder:"请输入打招呼内容","placeholder-style":"font-size:26rpx;color:rgba(0,0,0,0.2)",modelValue:e.unref(z)}),aU:e.o(H),aV:e.p({type:"primary","custom-style":{height:"100rpx",boxShadow:"0 6px 12px 0 rgba(0, 101, 251, 0.20)",fontSize:"26rpx",borderRadius:"24rpx"}}),aW:e.o((r=>e.isRef(q)?q.value=r:null)),aX:e.p({mode:"center","border-radius":"24",width:"90%",closeable:!0,modelValue:e.unref(q)}),aY:e.o(U),aZ:e.o(U),ba:e.o((r=>e.isRef(E)?E.value=r:null)),bb:e.p({center:!0,"confirm-text":"确定",content:"创建成功，回到首页？",modelValue:e.unref(E)})})}}),c=e._export_sfc(p,[["__scopeId","data-v-177ac7a1"]]);wx.createPage(c);
