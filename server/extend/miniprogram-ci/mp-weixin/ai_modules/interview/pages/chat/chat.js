"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),a=require("../../../../api/interview.js"),n=require("../../../../hooks/useKeyboardHeight.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+r+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+t)();const r=()=>"../../components/chatting/chatting.js",t=()=>"../../components/recorder/recorder.js",u=e.defineComponent({__name:"chat",setup(r){const t=e.reactive({id:"",type:"",record_id:""}),u=e.shallowRef(),o=e.shallowRef(),s=e.ref(null),l=e.ref(),d=e.computed((()=>"audio"===l.value)),v=e.ref(""),c=e.ref(!1),p=e.ref(""),f=e.ref("interviewing"),h=e.ref(!1),w=e.ref(""),m=async()=>{const{type:i,msg:n}=await a.interviewCheck({job_id:t.id});[0,7,9].includes(i)?e.index.$u.toast(n):T.value?e.index.$u.toast("目前正在对话中，请稍后再试"):R.value.length<=1?e.index.$u.toast("请先进行对话"):h.value=!0},g=async()=>{if(w.value){e.index.showLoading({title:"重新面试中...",mask:!0});try{await _(3,w.value),t.record_id="",e.index.hideLoading(),y(),F()}catch(i){e.index.hideLoading(),e.index.showToast({title:i||"重新面试失败",icon:"none",duration:3e3})}}else e.index.$u.toast("请输入重新面试的原因")},y=()=>{var e;R.value=[],f.value="interviewing",w.value="",h.value=!1,null==(e=u.value)||e.pauseAll()},_=async(e,i)=>{await a.interviewAgain({interview_id:p.value||t.record_id,reason:i,type:e})},x=e.ref(""),j=async()=>{e.index.showLoading({title:"提交中...",mask:!0});try{await a.interviewFeedback({job_id:t.id,content:x.value}),e.index.hideLoading(),e.index.showToast({title:"反馈已提交，请等待面试官的回复",icon:"success",duration:3e3}),q()}catch(i){e.index.hideLoading(),e.index.showToast({title:i,icon:"none",duration:3e3})}},q=()=>{var i;e.index.$u.route({url:"/ai_modules/interview/pages/index/index",params:{job_id:t.id,user_id:null==(i=null==s?void 0:s.value)?void 0:i.user_id},type:"reLaunch"})},b=()=>{"interviewing"!==f.value?q():e.index.showModal({title:"提示",content:"当前面试还未结束，确定要离开吗？",success:async({confirm:i})=>{if(i){e.index.showLoading({title:"退出中...",mask:!0});try{await _(3,"用户手动退出"),q()}catch(a){e.index.showToast({title:a||"退出失败",icon:"none"})}finally{e.index.hideLoading()}}}})},k=e.ref(!1);e.shallowRef();const R=e.ref([]),T=e.ref(!1),$=e.ref(0),L=e.shallowRef(),C=async()=>{var i;c.value||(H({message:v.value}),$.value=0,null==(i=L.value)||i.blur(),e.index.hideKeyboard())},B=async e=>{k.value=!1,H(e)},I=async()=>{var i,a;T.value?e.index.$u.toast("目前正在对话中，请稍后再试"):(await(null==(i=o.value)?void 0:i.authorize()),null==(a=u.value)||a.pauseAll(),k.value=!0)},A=i=>e.reactive({type:2,loading:!0,reply:"",link:"",auto:!1,logo:i,duration:0}),E=(e,i)=>{e.duration=Number(i.toFixed(0)),e.loading=!1,e.reply=e.reply,e.auto=d.value,T.value=!1,setTimeout((()=>{var e;null==(e=u.value)||e.scrollToBottom()}),300)},F=async()=>{const e=A(s.value.avatar);R.value.push(e);try{T.value=!0;const{prologue:i,audio_duration:n,audio_url:r,id:u}=await a.startInterviewChat({job_id:t.id});p.value=u,e.reply=i||"",e.link=r||"",E(e,n||0)}catch(i){e.loading=!1,e.reply=i||"发生错误",T.value=!1}},H=async e=>{var i;if(T.value)return;T.value=!0;const n=Math.ceil(e.duration/1e3);R.value.push({type:1,message:e.message,duration:n,link:e.link});const r=A(s.value.avatar);R.value.push(r),v.value="";try{null==(i=u.value)||i.scrollToBottom();const{audio_url:t,message:o,status:s}=await a.continueInterviewChat({id:p.value,answer:e.message,answer_url:e.link});d.value&&(r.link=t||""),r.reply=o||"",E(r,n||0),1==s&&(f.value="finished",h.value=1==s)}catch(t){r.loading=!1,r.reply=t||"发生错误",T.value=!1}},{dynamicHeight:K}=n.useKeyboardHeight(),M=async()=>{var i;const n=await a.getInterviewChatRecord({interview_id:t.record_id});n&&n.length>0&&n.forEach((e=>{R.value.push({type:2,reply:e.question,duration:e.question_duration,logo:s.value.avatar,link:e.question_url},{type:1,duration:e.answer_duration,message:e.answer,link:e.answer_url})})),await e.nextTick$1(),null==(i=u.value)||i.scrollToBottom()};return e.onLoad((i=>{t.id=i.id,t.record_id=i.record_id,t.type=i.type,y(),(async()=>{const i=await a.getInterviewJobDetail({id:t.id});s.value=i,l.value=1===s.value.type?"text":"audio",e.index.setNavigationBarTitle({title:s.value.name}),3==t.type?M():F()})()})),e.onUnload((()=>{_(3,"意外退出")})),(a,n)=>{var r;return e.e({a:e.unref(s)},e.unref(s)?e.e({b:e.p({title:null==(r=e.unref(s))?void 0:r.name,"title-bold":!0,"border-bottom":!1,"custom-back":b}),c:e.t(e.unref(s).company),d:"interviewing"===e.unref(f)?"#4EC133":"finished"===e.unref(f)?"#F54747":"",e:"interviewing"===e.unref(f)},"interviewing"===e.unref(f)?{f:e.o(m)}:{},{g:e.sr(u,"9add1bf5-1",{k:"chattingRef"}),h:e.p({"chat-type":e.unref(l),"content-list":e.unref(R)}),i:"interviewing"===e.unref(f)},"interviewing"===e.unref(f)?e.e({j:"text"===e.unref(l)},"text"===e.unref(l)?{k:e.unref(v),l:e.o((i=>e.isRef(v)?v.value=i.detail.value:null)),m:i._imports_0$27,n:!e.unref(v)||e.unref(T),o:e.o(C)}:{p:i._imports_1$17,q:e.o(I)}):{},{r:"finished"===e.unref(f)},"finished"===e.unref(f)?{s:i._imports_2$6,t:e.unref(x),v:e.o((i=>e.isRef(x)?x.value=i.detail.value:null)),w:!e.unref(x),x:e.o(j)}:{},{y:e.unref(K)+"px"}):{},{z:i._imports_3$9,A:e.unref(w),B:e.o((i=>e.isRef(w)?w.value=i.detail.value:null)),C:e.o((e=>h.value=!1)),D:e.o(g),E:e.o((e=>h.value=!1)),F:e.o((i=>e.isRef(h)?h.value=i:null)),G:e.p({mode:"center",width:"90%","border-radius":16,modelValue:e.unref(h)}),H:e.sr(o,"9add1bf5-3",{k:"recorderRef"}),I:e.o((e=>k.value=!1)),J:e.o(B),K:e.p({show:e.unref(k)})})}}}),o=e._export_sfc(u,[["__scopeId","data-v-9add1bf5"]]);wx.createPage(o);
