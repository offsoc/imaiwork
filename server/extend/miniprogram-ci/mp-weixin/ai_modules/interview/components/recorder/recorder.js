"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../api/app.js"),s=require("../../../../utils/util.js"),i=require("../../hooks/useRecorder.js"),r=require("../../../../api/interview.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),require("../../static/Recorder-UniCore/app-uni-support.js"),!Array){e.resolveComponent("u-popup")()}Math;const t=e.defineComponent({__name:"recorder",props:{show:{type:Boolean,default:!1}},emits:["update:show","success","close"],setup(t,{expose:o,emit:u}){const n=t,c=e.computed({get:()=>n.show,set(e){u("update:show",e)}}),{proxy:l}=e.getCurrentInstance(),d=e.ref(!1),p=e.ref(!1),h=e.ref(!1),m=e.ref(null),{start:v,stop:q,pause:j,resume:w,authorize:f,recordTime:x,isRecording:g}=i.useRecorder({duration:18e4},{onstart:()=>{d.value=!1},ondata:e=>{const{pcmData:a,powerLevel:s,sampleRate:i,duration:r}=e;l.audioCanvas&&l.audioCanvas.input(a,s,i)},onstop:async e=>{d.value||p.value||(m.value=e,await C())},ondrawAudio:(e,a)=>{e(l,[".audio-canvas"],"proxy.audioCanvas=Recorder.WaveView({compatibleCanvas:canvas,lineWidth: 5,width: 300, height: 100});",(e=>{l.audioCanvas=a.WaveView({compatibleCanvas:e,width:300,height:100,lineWidth:3,keep:!1})}))}}),y=()=>{c.value=!1,p.value=!0,q(),u("close")},C=async()=>{const{tempFilePath:s,duration:i}=m.value;e.index.showLoading({mask:!0,title:"正在上传中"});try{const{uri:e}=await a.uploadFile("audio",{filePath:s});let r;for(let a=0;a<3&&(r=await k(e),!r);a++);u("success",{link:e,duration:i,message:r}),m.value=null,h.value=!1}catch(r){h.value=!0,e.index.showToast({title:"上传失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}},k=async e=>new Promise(((a,s)=>{r.speechToText({audio_url:e}).then((e=>{a(e.message)})).catch((e=>{s(e)}))}));return e.watch(c,(async e=>{e&&(p.value=!1,d.value=!1,v())})),o({authorize:f}),(a,i)=>({a:e.t(e.unref(s.formatAudioTime)(e.unref(x)/1e3)),b:e.o((a=>(async()=>{j(),(await e.index.showModal({content:"确认重新录制么？",cancelText:"考虑一下",confirmText:"立即重录"})).cancel?w():(d.value=!0,e.index.showLoading({mask:!0,title:"正在重新录制中"}),q(),v(),e.index.hideLoading())})())),c:e.o((a=>(async()=>{h.value?C():x.value<1e3?e.index.$u.toast("说话时间太短"):q()})())),d:e.o(y),e:e.o((a=>e.isRef(c)?c.value=a:null)),f:e.p({mode:"bottom",mask:!1,"mask-close-able":!1,"border-radius":"24",height:"28%",modelValue:e.unref(c)})})}}),o=e._export_sfc(t,[["__scopeId","data-v-608a94ea"]]);wx.createComponent(o);
