"use strict";const e=require("../../../../common/vendor.js"),a=require("../../../../api/app.js"),s=require("../../../../utils/util.js"),i=require("../../hooks/useRecorder.js"),r=require("../../../../api/interview.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),require("../../static/Recorder-UniCore/app-uni-support.js"),!Array){e.resolveComponent("u-popup")()}Math;const t=e.defineComponent({__name:"recorder",props:{show:{type:Boolean,default:!1}},emits:["update:show","success","close"],setup(t,{expose:o,emit:u}){const n=t,c=e.computed({get:()=>n.show,set(e){u("update:show",e)}}),{proxy:d}=e.getCurrentInstance(),l=e.ref(!1),p=e.ref(!1),h=e.ref(!1),m=e.ref(null),{start:v,stop:q,pause:j,resume:w,authorize:x,recordTime:f,isRecording:g}=i.useRecorder({duration:18e4},{onstart:()=>{l.value=!1},ondata:e=>{const{pcmData:a,powerLevel:s,sampleRate:i,duration:r}=e;d.audioCanvas&&d.audioCanvas.input(a,s,i)},onstop:async e=>{l.value||p.value||(m.value=e,await C())},ondrawAudio:(e,a)=>{e(d,[".audio-canvas"],"proxy.audioCanvas=Recorder.WaveView({compatibleCanvas:canvas,lineWidth: 5,width: 300, height: 100});",(e=>{d.audioCanvas=a.WaveView({compatibleCanvas:e,width:300,height:100,lineWidth:3,keep:!1})}))}}),y=()=>{c.value=!1,p.value=!0,q(),u("close")},C=async()=>{const{tempFilePath:s,duration:i}=m.value;e.index.showLoading({mask:!0,title:"正在上传中"});try{const{uri:r}=await a.uploadFile("audio",{filePath:s});let t;for(let e=0;e<3&&(t=await b(r),!t);e++);e.index.hideLoading(),u("success",{link:r,duration:i,message:t}),m.value=null,h.value=!1}catch(r){h.value=!0,e.index.hideLoading(),e.index.showToast({title:r||"上传失败",icon:"none",duration:3e3})}},b=async e=>new Promise(((a,s)=>{r.speechToText({audio_url:e}).then((e=>{a(e.message)})).catch((e=>{s(e)}))}));return e.watch(c,(async e=>{e&&(p.value=!1,l.value=!1,v())})),o({authorize:x}),(a,i)=>({a:e.t(e.unref(s.formatAudioTime)(e.unref(f)/1e3)),b:e.o((a=>(async()=>{j(),(await e.index.showModal({content:"确认重新录制么？",cancelText:"考虑一下",confirmText:"立即重录"})).cancel?w():(l.value=!0,e.index.showLoading({mask:!0,title:"正在重新录制中"}),q(),v(),e.index.hideLoading())})())),c:e.o((a=>(async()=>{h.value?C():f.value<1e3?e.index.$u.toast("说话时间太短"):q()})())),d:e.o(y),e:e.o((a=>e.isRef(c)?c.value=a:null)),f:e.p({mode:"bottom",mask:!1,"mask-close-able":!1,"border-radius":"24",height:"28%",modelValue:e.unref(c)})})}}),o=e._export_sfc(t,[["__scopeId","data-v-b1b117d0"]]);wx.createComponent(o);
