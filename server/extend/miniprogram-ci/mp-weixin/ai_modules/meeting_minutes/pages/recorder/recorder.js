"use strict";const e=require("../../../../common/vendor.js"),n=require("../../../../common/assets.js");require("../../static/Recorder-UniCore/app-uni-support.js");const i=require("../../../../api/app.js"),t=require("../../../../api/meeting_minutes.js"),a=require("../../hooks/useHandleApi.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),require("../../enums/index.js"),require("../../../../enums/appEnums.js"),require("../../../../hooks/usePaging.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js"))();const r=e.defineComponent({__name:"recorder",setup(r){const{speakerOptions:o,userTokens:s,tokensValue:u}=a.useHandleApi();e.Recorder.install=!0;const l=e.computed((()=>Math.floor(s.value/3))),c=e.computed((()=>u.score/60)),p=e.reactive({language:"",speaker:0,translation:0,name:"",url:"",task_type:1}),{proxy:d}=e.getCurrentInstance(),m=e.ref(!1);e.ref(null);const v=e.ref(!1),f=e.ref(!1),w=e.ref(!1),h=108e5,g=e.ref(0),j=e.ref(null),q=e=>{let n=Math.floor(e/1e3),i=Math.floor(n/3600);n%=3600;let t=Math.floor(n/60),a=n%60;return i=i.toString().padStart(2,"0"),t=t.toString().padStart(2,"0"),a=a.toString().padStart(2,"0"),`${i}:${t}:${a}`},x=()=>{e.RecordApp.UniWebViewActivate(d),e.RecordApp.Start({type:"mp3",bitRate:16,sampleRate:16e3,onProcess:(e,n,i,t)=>{g.value=i,g.value>h||g.value/1e3*c.value>s.value?k():d.waveView&&d.waveView.input(e[e.length-1],n,t)},onProcess_renderjs:"function(buffers,powerLevel,duration,bufferSampleRate,newBufferIdx,asyncEnd){\n                if(this.waveView) this.waveView.input(buffers[buffers.length-1],powerLevel,bufferSampleRate);\n            }"},(()=>{e.RecordApp.UniFindCanvas(d,[".recorder-wave-view"],"this.waveView=Recorder.WaveView({compatibleCanvas:canvas1,lineWidth: 5,width: 375, height: 200});",(n=>{d.waveView=e.Recorder.WaveView({compatibleCanvas:n,width:375,height:200,lineWidth:5,keep:!1})}))}))},k=async()=>{const n=`${e.index.$u.timeFormat(new Date,"yyyy-mm-dd hh:MM:ss")} 记录`;await new Promise(((i,t)=>{e.RecordApp.Stop(((a,r,o)=>{e.RecordApp.UniSaveLocalFile("record.mp3",a,(async a=>{j.value=a,e.index.showLoading({title:"上传中",mask:!0});try{await M(),p.name=n,await V(),i(!0)}catch(r){e.index.showToast({title:r||"上传失败",icon:"none",duration:1e3}),w.value=!0,t(!1)}finally{e.index.hideLoading()}}),(e=>{w.value=!0,t(!1)})),v.value=!1,f.value=!0}))}))},R=()=>{e.RecordApp.GetCurrentRecOrNull()&&e.RecordApp.Pause()},y=()=>{e.RecordApp.GetCurrentRecOrNull()&&e.RecordApp.Resume()},b=()=>{v.value?(f.value=!f.value,f.value?R():y()):e.index.$u.toast("请先开始录音")},_=()=>{m.value=!1,y()},A=()=>{m.value=!1,k()},S=async()=>{m.value=!0,R()},$=async()=>{e.index.showModal({title:"提示",content:"确定尝试重新上传吗？",success:e=>{e.confirm&&V()}})},C=async()=>{e.index.showModal({title:"提示",content:"确定尝试重新录音吗？",success:e=>{e.confirm&&(w.value=!1,L())}})},M=async()=>{const{uri:e}=await i.uploadFile("audio",{filePath:j.value});p.url=e},V=async()=>{try{e.index.showLoading({title:"开始创建会议纪要...",mask:!0}),j.value&&!p.url&&await M(),await t.meetingMinutesCreate({...p,translation:0==p.translation?"":p.translation}),e.index.showToast({title:"创建成功，即将返回首页",icon:"none",duration:4e3}),setTimeout((()=>{e.index.$u.route({url:"/ai_modules/meeting_minutes/pages/index/index",type:"reLaunch"})}),1e3)}catch(n){w.value=!0,e.index.showToast({title:n||"创建失败",icon:"none",duration:5e3})}finally{e.index.hideLoading()}},L=async()=>{e.index.setKeepScreenOn({keepScreenOn:!0}),await e.nextTick$1(),e.index.showLoading({title:"正在加载录音器..."}),g.value=0,f.value=!1,v.value=!1,setTimeout((()=>{e.index.hideLoading(),v.value=!0,e.RecordApp.UniWebViewActivate(d),e.RecordApp.RequestPermission((()=>{x()}))}),2e3)},P=()=>{v.value?(R(),e.index.showModal({title:"提示",content:"确定返回首页吗？",success:async e=>{e.confirm&&await k(),y()}})):e.index.navigateBack()};return e.onMounted((async()=>{await e.nextTick$1(),e.RecordApp.UniPageOnShow(d),L()})),e.onUnmounted((()=>{e.RecordApp.Stop()})),e.onLoad((e=>{p.language=e.language,p.translation=e.translation})),e.onHide((()=>{k()})),(i,t)=>e.e({a:e.p({"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"},"custom-back":P}),b:e.t(e.unref(f)?"录音已暂停":"录音中..."),c:e.t(q(e.unref(g))),d:e.t(q(h)),e:!e.unref(w)},e.unref(w)?{l:n._imports_3$4,m:e.o(C),n:n._imports_4$3,o:e.o($)}:e.e({f:n._imports_0$14,g:e.o(S),h:!e.unref(f)},e.unref(f)?{j:n._imports_1$10}:{i:n._imports_1$9},{k:e.o(b)}),{p:e.p({name:"info-circle",size:20}),q:e.t(e.unref(l)),r:e.p({name:"info-circle",color:"#FE975F",size:32}),s:e.f(e.unref(o),((n,i,t)=>({a:e.t(n.text),b:i,c:e.unref(p).speaker===n.value?1:"",d:e.o((i=>e.unref(p).speaker=n.value),i)}))),t:e.o(_),v:e.o(A),w:e.o((n=>e.isRef(m)?m.value=n:null)),x:e.p({mode:"bottom",mask:!1,"border-radius":"40",height:"35%",modelValue:e.unref(m)})})}});wx.createPage(r);
