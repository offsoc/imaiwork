"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),n=require("../../../../components/file-upload/choose-file.js");require("../../static/Recorder-UniCore/app-uni-support.js");const a=require("../../../../api/meeting_minutes.js"),r=require("../../../../api/app.js"),u=require("../../../../stores/user.js"),s=require("../../hooks/useHandleApi.js"),o=require("../../enums/index.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../router/index.js"),require("../../../../config/index.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../enums/appEnums.js"),require("../../../../hooks/usePaging.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("data-select")+e.resolveComponent("u-button")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-popup")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/recharge-popup/recharge-popup.js"))();const i=e.defineComponent({__name:"audio_upload",setup(i){e.Recorder.install=!0;const l=u.useUserStore(),{userTokens:p}=e.toRefs(l),c=e.ref(),d=e.reactive({type:o.CreateType.SINGLE}),{tokensValue:m,languageList:f,targetLanguageList:g,speakerOptions:v}=s.useHandleApi(),y=e.reactive({language:"cn",speaker:0,translation:0}),h=e.ref([]),j=["mp3","wav","wma","aac","ogg","amr","flac","aiff"],q=async t=>{const{tempFiles:n}=t,a=524288e3;n.some((e=>e.size>a))&&e.index.$u.toast("单个文件最大500M,已过滤超出限制的文件");const r=n.filter(((e,t)=>(e.size>a&&n.splice(t,1),e.size<a)));r.length>10?e.index.$u.toast("上传文件超出限制,最多可上传10个音频文件"):(r.forEach(((t,n)=>{const a=e.reactive({url:"",loading:!0,file:t,file_url:t.path,status:2});h.value.push(a)})),await C())},C=async()=>{e.index.showLoading({title:"上传中",mask:!0});const t=h.value.map(((e,t)=>x(e,t)));await Promise.allSettled(t),h.value=h.value.filter((e=>1===e.status)),e.index.hideLoading(),e.index.showToast({title:`已成功上传${h.value.length}个文件`,icon:"none",duration:3e3}),0!==h.value.length&&setTimeout((async()=>{try{e.index.showLoading({title:"开始创建会议纪要...",mask:!0});const t=h.value.map((e=>({...y,url:e.url,name:e.file.name,translation:0==y.translation?"":y.translation})));await a.meetingMinutesBatchCreate(t),e.index.hideLoading(),e.index.showToast({title:"创建成功，即将返回首页",icon:"none",duration:3e3}),setTimeout((()=>{e.index.navigateBack()}),1e3)}catch(t){e.index.hideLoading(),e.index.showToast({title:t||"创建失败",icon:"none",duration:3e3})}}),1e3)},x=async(t,n)=>{if(2==t.status)try{t.loading=!0;const e=await r.uploadFile("audio",{filePath:t.file_url});t.loading=!1,t.status=1,t.url=e.uri,h.value[n]=t}catch(a){e.index.$u.toast(`无法上传“${t.file.name}”,已过滤文件`),t.loading=!1,h.value=h.value.splice(n,1)}},T=async()=>{if(p.value<=0)return e.index.$u.toast("算力不足，请充值！"),void c.value.open();d.type===o.CreateType.SINGLE&&k(),d.type===o.CreateType.BATCH&&(async()=>{var t;if(m<=0)return e.index.$u.toast("算力不足，请充值！"),void(null==(t=c.value)||t.open());const a=await n.chooseFile({type:"file",count:10,extension:j});q(a)})()},{proxy:w}=e.getCurrentInstance(),k=async()=>{const t=()=>{e.index.$u.route({url:"/ai_modules/meeting_minutes/pages/recorder/recorder",params:{language:y.language,translation:y.translation}})};e.RecordApp.RequestPermission((()=>{t()}),(async n=>{e.index.showModal({title:"开启麦克风权限",content:"为了正常使用语音输入功能，请开启麦克风权限",confirmText:"去设置",success:async n=>{if(n.confirm){const{authSetting:n}=await e.index.openSetting();n["scope.record"]&&t()}}})}))},_=e.ref(!1),b=()=>{_.value=!0};return e.onMounted((()=>{e.RecordApp.UniPageOnShow(w)})),e.onLoad((e=>{d.type=e.type||o.CreateType.BATCH})),(n,a)=>e.e({a:e.p({"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"}}),b:t._imports_0$21,c:e.f(e.unref(f),((t,n,a)=>({a:e.t(t.text),b:n,c:e.unref(y).language===t.value?1:"",d:e.o((n=>e.unref(y).language=t.value),n)}))),d:e.o((t=>e.unref(y).translation=t)),e:e.p({localdata:e.unref(g),modelValue:e.unref(y).translation}),f:e.unref(d).type==e.unref(o.CreateType).BATCH},e.unref(d).type==e.unref(o.CreateType).BATCH?{g:e.o((t=>e.unref(y).speaker=t)),h:e.p({localdata:e.unref(v),modelValue:e.unref(y).speaker})}:{},{i:e.t(e.unref(d).type==e.unref(o.CreateType).SINGLE?"开始录音":"上传音视频文件"),j:e.o(T),k:e.p({type:"primary",shape:"circle","custom-style":{height:"96rpx"}}),l:e.p({name:"question-circle",size:"32",color:"#0065FB"}),m:e.t(e.unref(d).type==e.unref(o.CreateType).BATCH?"查看支持格式":"查看注意事项"),n:e.o(b),o:e.t(e.unref(d).type==e.unref(o.CreateType).BATCH?"支持格式":"注意事项"),p:e.unref(d).type==e.unref(o.CreateType).BATCH},e.unref(d).type==e.unref(o.CreateType).BATCH?{q:e.t(j.join("/")),r:e.t(500)}:{},{s:e.unref(d).type==e.unref(o.CreateType).SINGLE},(e.unref(d).type,e.unref(o.CreateType).SINGLE,{}),{t:e.o((e=>_.value=!1)),v:e.o((t=>e.isRef(_)?_.value=t:null)),w:e.p({mode:"bottom","border-radius":"24",modelValue:e.unref(_)}),x:e.sr(c,"95f43166-7",{k:"rechargePopupRef"})})}});wx.createPage(i);
