"use strict";const e=require("../../../../common/vendor.js"),i=require("../../../../common/assets.js"),a=require("../../../../api/ladder_player.js"),n=require("../../../../stores/app.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../config/index.js"),require("../../../../api/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-button")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-popup"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+o+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+s)();const o=()=>"../../components/chatting/chatting.js",s=()=>"../../components/recorder/recorder.js",l=e.defineComponent({__name:"chat",setup(o){const s=n.useAppStore(),l=e.computed((()=>{var e;return((null==(e=s.getLadderConfig)?void 0:e.voice)||[]).find((e=>{var i;return e.code==(null==(i=d.value)?void 0:i.coach_voice)}))||{}})),r=e.reactive({scene_id:"",analysis_id:""}),u=e.ref(!1),t=e.ref(),d=e.ref(null),c=e.ref([]),p=e.ref(!1),v=e.ref(!1),_=e.shallowRef(),y=e.ref(!1),m=e.ref(null),h=e.ref(!1),f=i=>e.reactive({id:"",type:2,loading:!0,reply:"",link:"",auto:!1,logo:i,duration:0}),g=(e,i)=>{e.duration=Number(i.toFixed(0)),e.loading=!1,e.reply=e.reply,e.auto=!0,p.value=!1,setTimeout((()=>{var e;null==(e=t.value)||e.scrollToBottom()}),300)},k=async()=>{var e;const i=f((null==(e=l.value)?void 0:e.logo)||"");c.value.push(i);try{p.value=!0;const e=await a.lpSceneChatStart({scene_id:r.scene_id});r.analysis_id=(null==e?void 0:e.analysis_id)||"",i.id=(null==e?void 0:e.id)||"",i.link=(null==e?void 0:e.preliminary_ask_audio)||"",i.reply=(null==e?void 0:e.preliminary_ask)||"",g(i,(null==e?void 0:e.preliminary_ask_audio_duration)||0),w(e.id)}catch(n){i.loading=!1,i.reply="发生错误",p.value=!1}},j=async e=>{await a.lpScenePerformance({scene_id:r.scene_id,analysis_id:r.analysis_id,chat_id:e})},q=()=>{p.value?S():y.value=!y.value},w=async e=>{h.value=!0;try{const i=await a.lpSceneChatTips({scene_id:r.scene_id,analysis_id:r.analysis_id,chat_id:e});m.value=i.speechcraft}finally{h.value=!1}},x=async()=>{var e,i;y.value=!1,p.value?S():(await(null==(e=_.value)?void 0:e.authorize(_.value.proxy)),null==(i=t.value)||i.pauseAll(),v.value=!0)},b=async e=>{v.value=!1,(async e=>{var i,n;if(p.value)return;p.value=!0;const o=Math.ceil(e.duration/1e3);c.value.push({type:1,message:e.message,duration:o,link:e.link});const s=f((null==(i=l.value)?void 0:i.logo)||"");c.value.push(s);try{null==(n=t.value)||n.scrollToBottom();const i=await a.lpSceneChatContinue({scene_id:r.scene_id,analysis_id:r.analysis_id,ask:e.message,ask_audio:e.link,ask_audio_duration:o});s.id=(null==i?void 0:i.id)||"",s.link=(null==i?void 0:i.reply_audio)||"",s.reply=(null==i?void 0:i.reply)||"",g(s,i.reply_audio_duration||0),w(i.id),j(i.id)}catch(u){s.loading=!1,s.reply=u||"发生错误",p.value=!1}})(e)},C=()=>{p.value?S():u.value=!0},T=async()=>{e.index.showLoading({title:"正在结束对话中...",mask:!0});try{u.value=!1,await(async()=>{await a.lpSceneChatEnd({scene_id:r.scene_id,analysis_id:r.analysis_id})})(),e.index.showToast({icon:"none",title:"提交成功，3秒跳转到报告页面~",duration:3e3}),setTimeout((()=>{e.index.$u.route({url:"/ai_modules/ladder_player/pages/report/report",type:"redirect"})}),3e3)}catch(i){e.index.showToast({title:i||"结束对话失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}},L=async()=>{u.value=!1,c.value=[],e.index.showLoading({title:"正在重新练习中...",mask:!0});try{await k()}catch(i){e.index.showToast({title:i||"重新练习失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}},S=()=>{e.index.$u.toast("当前还有对话中，请稍等")},z=async()=>{e.index.showLoading({title:"加载中...",mask:!0});try{const e=await a.lpSceneDetail({id:r.scene_id});d.value=e||{},r.analysis_id?(async()=>{var e;const{lists:i}=await a.lpRecordLists({analysis_id:r.analysis_id,page_size:9999}),n=i.map((e=>e.preliminary_ask?{type:2,reply:e.preliminary_ask,duration:e.preliminary_ask_audio_duration,logo:l.value.logo,link:e.preliminary_ask_audio}:[{type:1,duration:e.ask_audio_duration,message:e.ask,link:e.ask_audio},{type:2,reply:e.reply,duration:e.reply_audio_duration,logo:l.value.logo,link:e.reply_audio}])).flat();c.value=n,null==(e=t.value)||e.scrollToBottom()})():k()}catch(i){e.index.showToast({title:i||"获取场景详情失败",icon:"none",duration:2e3})}finally{e.index.hideLoading()}};return e.onLoad((e=>{r.scene_id=e.id,e.analysis_id&&(r.analysis_id=e.analysis_id),z()})),(a,n)=>e.e({a:e.unref(d)},e.unref(d)?{b:e.p({"is-fixed":!1,"border-bottom":!1,background:{background:"transparent"},title:"AI陪练","title-bold":!0}),c:e.t(e.unref(d).name),d:e.t(e.unref(d).coach_name),e:e.o(C),f:e.p({type:"error",size:"mini","custom-style":{fontWeight:"bold"}}),g:e.sr(t,"6e1a317b-2",{k:"chattingRef"}),h:e.p({contentList:e.unref(c)}),i:i._imports_0$23,j:e.o(q),k:i._imports_1$15,l:e.o(x)}:{},{m:e.unref(y)},e.unref(y)?e.e({n:i._imports_0$23,o:!e.unref(h)},e.unref(h)?{}:{p:e.t(e.unref(m))}):{},{q:e.p({name:"info-circle",color:"#FE975F",size:32}),r:e.p({name:"close",color:"#2C2C36",size:32}),s:e.o((e=>u.value=!1)),t:e.o(L),v:e.o(T),w:e.o((i=>e.isRef(u)?u.value=i:null)),x:e.p({mode:"bottom","border-radius":"40",height:"25%",modelValue:e.unref(u)}),y:e.sr(_,"6e1a317b-7",{k:"recorderRef"}),z:e.o((e=>v.value=!1)),A:e.o(b),B:e.p({show:e.unref(v)})})}}),r=e._export_sfc(l,[["__scopeId","data-v-6e1a317b"]]);wx.createPage(r);
