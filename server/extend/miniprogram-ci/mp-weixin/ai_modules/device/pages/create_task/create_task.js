"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/device.js"),i=require("../../enums/index.js"),s=require("../../../../api/app.js"),a=require("../../../../components/file-upload/choose-file.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("confirm-dialog")+e.resolveComponent("upload-progress")+e.resolveComponent("video-preview"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+n+(()=>"../../../../components/confirm-dialog/confirm-dialog.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../components/video-preview/video-preview.js"))();const n=()=>"../../components/bast-setting/bast-setting.js",u=e.defineComponent({__name:"create_task",setup(n){const u=e.ref(1),o=e.ref([{step:1,title:"选择素材"},{step:2,title:"填写文案"},{step:3,title:"设定时间"}]),l=e.ref(1),f=e.reactive({name:"",introduction:"",copywriterList:[],materialLists:[],time_config:[{start_time:"09:00",end_time:"09:30"},{start_time:"09:30",end_time:"10:30"}],accounts:[],publish_frep:2,custom_date:[],task_frep:1}),c=e.shallowRef(),p=e.ref(-1),m=e.ref(-1),d=e.ref(!1),v=e.ref(!1),h=e.ref(!1),g=[1,60],_=["mp4","mov"],y=e.ref(!0),L=e.ref(-1),x=e.reactive({url:"",pic:""}),w=e.ref(!1),j=e.ref([]),b=e.ref(""),q=e.ref(-1),$=e.ref(!1),k=e.computed((()=>2==u.value?"发布图文":"发布视频")),C=e.computed((()=>`\n        <div>· 视频素材支持：${_.join("、")}格式，100M以内，时长范围${g[0]}s-${g[1]}s</div>\n    <div class="mt-2">· 最多可传99个视频</div>\n    <div class="mt-2">· 不符合条件的视频会被自动删除</div>\n    `)),T=e.computed((()=>R(l.value))),R=e=>{switch(e){case 1:return f.materialLists.length>0;case 2:return f.copywriterList.length>0;case 3:return!0;default:return!1}},F=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==l.value)if(t<l.value)l.value=t;else{for(let r=1;r<t;r++)if(!R(r))return void e.index.$u.toast("请按顺序完成步骤");l.value=t}}else if(T.value)l.value++;else{const t={1:"请至少选择一个图组",2:"请至少添加一条文案"};e.index.$u.toast(t[l.value]||"请完成当前步骤")}else l.value--},z=t=>{m.value=t??-1,e.index.$u.route({url:"/ai_modules/device/pages/task_img_group/task_img_group",params:{imgs:-1!==m.value?JSON.stringify(f.materialLists[m.value].url):""}})},E=()=>{f.materialLists.splice(p.value,1),d.value=!1,p.value=-1},O=()=>{y.value?(y.value=!1,v.value=!0):P()},P=async()=>{j.value=[];try{const{tempFiles:t}=await a.chooseFile({type:"video",count:99,extension:_}),r=[];for(const i of t){i.duration>=g[0]&&i.duration<=g[1]?i.size>104857600?e.index.$u.toast("视频大小不能超过100M"):r.push(i):e.index.$u.toast(`视频时长不能超过${g[1]}秒`)}if(0===r.length)return void e.index.$u.toast("所选视频素材均不符合条件，请重新上传");j.value=r,h.value=!0;for(const e of j.value){const t=await s.uploadFile("image",{filePath:e.thumbTempFilePath}),r=await s.uploadFile("video",{filePath:e.tempFilePath},(t=>M(t,e)));-1!==L.value?(f.materialLists[L.value].url=[t.uri,r.uri],L.value=-1):f.materialLists.push({url:[t.uri,r.uri]})}j.value.every((e=>100===e.progress))&&(h.value=!1)}catch(t){e.index.$u.toast(t),j.value=[],h.value=!1}},M=(e,t)=>{const r=j.value.findIndex((e=>e.tempFilePath===t.tempFilePath));-1!==r&&(j.value[r]={...j.value[r],progress:e})},S=()=>{e.index.$u.route({url:"/pages/phone/phone",type:"reLaunch"}),$.value=!1},I=async()=>{var t;if(null==(t=c.value)?void 0:t.validateForm())e.index.$u.toast("时间配置存在冲突");else if(f.name){if(0===f.accounts.length)return e.index.$u.toast("请选择发布账号"),void e.index.$u.route({url:"/ai_modules/device/pages/account_choose/account_choose"});e.index.showLoading({title:"创建中...",mask:!0});try{const{id:t}=await r.addMatrixTask({name:f.name,media_type:u.value,media_url:f.materialLists,copywriting:f.copywriterList});await r.publishDeviceTask({name:f.name,matrix_media_setting_id:t,time_config:f.time_config.map((e=>`${e.start_time}-${e.end_time}`)),accounts:f.accounts,publish_frep:f.publish_frep,media_type:u.value,task_type:3,scene:2,data_type:0}),$.value=!0,e.index.hideLoading()}catch(i){b.value=i,e.index.hideLoading(),e.index.showToast({title:i,icon:"none",duration:3e3})}}else e.index.$u.toast("请输入任务名称")};return e.onLoad((t=>{if(t.type){u.value=t.type;const r=2==u.value?"图文":"视频";f.name=`${r}矩阵任务${e.index.$u.timeFormat(new Date,"yyyymmddhhMM")}`}e.index.$on("confirm",(e=>{const{type:t,data:r}=e;if(t===i.ListenerTypeEnum.CHOOSE_IMG)if(-1!==m.value){if(0===r.length)return void f.materialLists.splice(m.value,1);f.materialLists[m.value].url=r}else f.materialLists.push({url:r});if(t===i.ListenerTypeEnum.TASK_COPYWRITER||t===i.ListenerTypeEnum.TASK_AI_COPYWRITER){if(0===r.length)return;-1!==q.value?f.copywriterList[q.value]=r[0]:f.copywriterList=f.copywriterList.concat(r)}if(t===i.ListenerTypeEnum.CHOOSE_ACCOUNT){if(0===r.length)return;f.accounts=r.map((e=>({account:e.account,type:e.type,id:e.id})))}}))})),(r,i)=>e.e({a:e.p({"title-bold":!0,title:e.unref(k),"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(o),((t,r,i)=>e.e({a:e.unref(l)>t.step},e.unref(l)>t.step?{b:"31f62c1f-1-"+i,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(o).length},t.step!==e.unref(o).length?{f:e.unref(l)>t.step?1:""}:{},{g:t.step,h:e.unref(l)==t.step?1:"",i:e.o((e=>F(t.step)),t.step)}))),c:1===e.unref(l)},1===e.unref(l)?e.e({d:e.t(2==e.unref(u)?"图组列表":"视频素材"),e:e.t(e.unref(f).materialLists.length),f:2==e.unref(u)},2==e.unref(u)?{g:e.o((e=>z()))}:{},{h:2==e.unref(u)},2==e.unref(u)?e.e({i:e.unref(f).materialLists.length>0},e.unref(f).materialLists.length>0?{j:e.f(e.unref(f).materialLists,((t,r,i)=>({a:e.t(`图组${e.unref(f).materialLists.length<10?`0${r+1}`:r+1}`),b:e.t(t.url.length),c:"31f62c1f-2-"+i,d:e.o((e=>z(r)),r),e:e.f(t.url,((e,t,r)=>({a:e,b:t}))),f:"31f62c1f-3-"+i,g:e.o((e=>(e=>{p.value=e,d.value=!0})(r)),r),h:r}))),k:e.p({name:"arrow-right",size:"20",color:"#00000099"}),l:e.p({name:"trash",size:"28",color:"#0000004d"})}:{m:e.p({size:260,text:"您还没有图组哦"}),n:e.p({name:"plus",size:"24"}),o:e.o((e=>z()))}):e.e({p:e.unref(f).materialLists.length<99},e.unref(f).materialLists.length<99?{q:e.p({name:"plus",size:"24",color:"#ffffff"}),r:e.o(O)}:{},{s:e.f(e.unref(f).materialLists,((t,r,i)=>({a:t.url[0],b:e.o((e=>(e=>{x.pic=e[0],x.url=e[1],w.value=!0})(t.url)),r),c:"31f62c1f-7-"+i,d:e.o((e=>(e=>{f.materialLists.splice(e,1)})(r)),r),e:e.o((e=>(e=>{L.value=e,P()})(r)),r),f:r}))),t:e.p({name:"close",size:"20",color:"#ffffff"})})):{},{v:2===e.unref(l)},2===e.unref(l)?e.e({w:t._imports_0$32,x:e.t(e.unref(f).copywriterList.length),y:e.unref(f).copywriterList.length>0},e.unref(f).copywriterList.length>0?{z:e.f(e.unref(f).copywriterList,((t,r,i)=>({a:e.t(t.title),b:e.t(t.content),c:e.f(t.topic,((t,r,i)=>({a:e.t(t),b:r}))),d:"31f62c1f-8-"+i,e:e.o((e=>(e=>{f.copywriterList.splice(e,1)})(r)),r),f:r,g:e.o((t=>(t=>{q.value=t,e.index.$u.route({url:"/ai_modules/device/pages/task_copywriter/task_copywriter",params:{copywriter:JSON.stringify(f.copywriterList[t])}})})(r)),r)}))),A:e.p({name:"close",size:"20",color:"#ffffff"})}:{B:e.p({size:260,text:"您还没有文案哦"})}):{},{C:3===e.unref(l)},3===e.unref(l)?e.e({D:e.sr(c,"31f62c1f-10",{k:"baseFormRef"}),E:e.o((t=>e.isRef(f)?f.value=t:null)),F:e.p({modelValue:e.unref(f)}),G:e.unref(b)},e.unref(b)?{H:e.t(e.unref(b))}:{}):{},{I:e.unref(l)!=e.unref(o).length},e.unref(l)!=e.unref(o).length?e.e({J:1===e.unref(l)},1===e.unref(l)?{K:e.t(e.unref(f).materialLists.length),L:e.n(e.unref(f).materialLists.length>0?"bg-primary":"bg-_h787878CC_")}:{M:e.o((t=>F(e.unref(l),"prev")))},{N:e.n(e.unref(T)?"bg-primary":"bg-_h787878CC_"),O:e.o((t=>F(e.unref(l),"next")))}):{P:e.o(I)},{Q:e.o(E),R:e.o((t=>e.isRef(d)?d.value=t:null)),S:e.p({"confirm-text":"删除",center:!0,content:"是否确定删除图组？",modelValue:e.unref(d)}),T:e.o(S),U:e.o((t=>e.isRef($)?$.value=t:null)),V:e.p({"confirm-text":"确定",center:!0,content:"创建成功，回到任务列表？","show-close":!1,modelValue:e.unref($)}),W:e.o(P),X:e.o((t=>e.isRef(v)?v.value=t:null)),Y:e.p({"confirm-text":"去上传",content:e.unref(C),modelValue:e.unref(v)}),Z:e.o((t=>e.isRef(h)?h.value=t:null)),aa:e.p({"upload-list":e.unref(j),modelValue:e.unref(h)}),ab:e.o((e=>w.value=!1)),ac:e.o((t=>e.isRef(w)?w.value=t:null)),ad:e.p({"video-url":e.unref(x).url,poster:e.unref(x).pic,show:e.unref(w)})})}}),o=e._export_sfc(u,[["__scopeId","data-v-31f62c1f"]]);wx.createPage(o);
