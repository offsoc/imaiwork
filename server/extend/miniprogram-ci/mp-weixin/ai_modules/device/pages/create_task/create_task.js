"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/device.js"),i=require("../../enums/index.js"),a=require("../../../../api/app.js"),s=require("../../../../components/file-upload/choose-file.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../stores/app.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),require("../../../../config/index.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("confirm-dialog")+e.resolveComponent("upload-progress")+e.resolveComponent("video-preview"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../../components/empty/empty.js")+n+(()=>"../../../../components/confirm-dialog/confirm-dialog.js")+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../components/video-preview/video-preview.js"))();const n=()=>"../../components/bast-setting/bast-setting.js",u=e.defineComponent({__name:"create_task",setup(n){const u=e.ref(1),o=e.ref([{step:1,title:"选择素材"},{step:2,title:"填写文案"},{step:3,title:"设定时间"}]),l=e.ref(1),f=e.reactive({name:"",introduction:"",copywriterList:[],materialLists:[],time_config:[{start_time:"09:00",end_time:"09:30"},{start_time:"09:30",end_time:"10:30"}],accounts:[],publish_frep:2,custom_date:[],task_frep:1}),p=e.shallowRef(),c=e.ref(-1),m=e.ref(-1),d=e.ref(!1),v=e.ref(!1),h=e.ref(!1),g=["mp4","mov"],_=e.ref(!0),y=e.ref(-1),L=e.reactive({url:"",pic:""}),x=e.ref(!1),w=e.ref([]),j=e.ref(""),b=e.ref(-1),q=e.ref(!1),$=e.computed((()=>2==u.value?"发布图文":"发布视频")),k=e.computed((()=>`\n        <div>· 视频素材支持：${g.join("、")}格式，100M以内</div>\n    <div class="mt-2">· 最多可传99个视频</div>\n    <div class="mt-2">· 不符合条件的视频会被自动删除</div>\n    `)),C=e.computed((()=>T(l.value))),T=e=>{switch(e){case 1:return f.materialLists.length>0;case 2:return f.copywriterList.length>0;case 3:return!0;default:return!1}},R=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==l.value)if(t<l.value)l.value=t;else{for(let r=1;r<t;r++)if(!T(r))return void e.index.$u.toast("请按顺序完成步骤");l.value=t}}else if(C.value)l.value++;else{const t={1:"请至少选择一个图组",2:"请至少添加一条文案"};e.index.$u.toast(t[l.value]||"请完成当前步骤")}else l.value--},F=t=>{m.value=t??-1,e.index.$u.route({url:"/ai_modules/device/pages/task_img_group/task_img_group",params:{imgs:-1!==m.value?JSON.stringify(f.materialLists[m.value].url):""}})},z=()=>{f.materialLists.splice(c.value,1),d.value=!1,c.value=-1},E=()=>{_.value?(_.value=!1,v.value=!0):O()},O=async()=>{w.value=[];try{const{tempFiles:t}=await s.chooseFile({type:"video",count:99,extension:g}),r=[];for(const i of t)i.size>104857600?e.index.$u.toast("视频大小不能超过100M"):r.push(i);if(0===r.length)return void e.index.$u.toast("所选视频素材均不符合条件，请重新上传");w.value=r,h.value=!0;for(const e of w.value){const t=await a.uploadFile("image",{filePath:e.thumbTempFilePath}),r=await a.uploadFile("video",{filePath:e.tempFilePath},(t=>P(t,e)));-1!==y.value?(f.materialLists[y.value].url=[t.uri,r.uri],y.value=-1):f.materialLists.push({url:[t.uri,r.uri]})}w.value.every((e=>100===e.progress))&&(h.value=!1)}catch(t){e.index.$u.toast(t),w.value=[],h.value=!1}},P=(e,t)=>{const r=w.value.findIndex((e=>e.tempFilePath===t.tempFilePath));-1!==r&&(w.value[r]={...w.value[r],progress:e})},M=()=>{e.index.$u.route({url:"/pages/phone/phone",type:"reLaunch"}),q.value=!1},S=async()=>{var t;if(null==(t=p.value)?void 0:t.validateForm())e.index.$u.toast("时间配置存在冲突");else if(f.name){if(0===f.accounts.length)return e.index.$u.toast("请选择发布账号"),void e.index.$u.route({url:"/ai_modules/device/pages/account_choose/account_choose"});e.index.showLoading({title:"创建中...",mask:!0});try{const{id:t}=await r.addMatrixTask({name:f.name,media_type:u.value,media_url:f.materialLists,copywriting:f.copywriterList});await r.publishDeviceTask({name:f.name,matrix_media_setting_id:t,time_config:f.time_config.map((e=>`${e.start_time}-${e.end_time}`)),accounts:f.accounts,publish_frep:f.publish_frep,media_type:u.value,task_type:3,scene:2,data_type:0}),q.value=!0,e.index.hideLoading()}catch(i){j.value=i,e.index.hideLoading(),e.index.showToast({title:i,icon:"none",duration:3e3})}}else e.index.$u.toast("请输入任务名称")};return e.onLoad((t=>{if(t.type){u.value=t.type;const r=2==u.value?"图文":"视频";f.name=`${r}矩阵任务${e.index.$u.timeFormat(new Date,"yyyymmddhhMM")}`}e.index.$on("confirm",(e=>{const{type:t,data:r}=e;if(t===i.ListenerTypeEnum.CHOOSE_IMG)if(-1!==m.value){if(0===r.length)return void f.materialLists.splice(m.value,1);f.materialLists[m.value].url=r}else f.materialLists.push({url:r});if(t===i.ListenerTypeEnum.TASK_COPYWRITER||t===i.ListenerTypeEnum.TASK_AI_COPYWRITER){if(0===r.length)return;-1!==b.value?f.copywriterList[b.value]=r[0]:f.copywriterList=f.copywriterList.concat(r)}if(t===i.ListenerTypeEnum.CHOOSE_ACCOUNT){if(0===r.length)return;f.accounts=r.map((e=>({account:e.account,type:e.type,id:e.id})))}}))})),(r,i)=>e.e({a:e.p({"title-bold":!0,title:e.unref($),"border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(o),((t,r,i)=>e.e({a:e.unref(l)>t.step},e.unref(l)>t.step?{b:"a77e8941-1-"+i,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(o).length},t.step!==e.unref(o).length?{f:e.unref(l)>t.step?1:""}:{},{g:t.step,h:e.unref(l)==t.step?1:"",i:e.o((e=>R(t.step)),t.step)}))),c:1===e.unref(l)},1===e.unref(l)?e.e({d:e.t(2==e.unref(u)?"图组列表":"视频素材"),e:e.t(e.unref(f).materialLists.length),f:2==e.unref(u)},2==e.unref(u)?{g:e.o((e=>F()))}:{},{h:2==e.unref(u)},2==e.unref(u)?e.e({i:e.unref(f).materialLists.length>0},e.unref(f).materialLists.length>0?{j:e.f(e.unref(f).materialLists,((t,r,i)=>({a:e.t(`图组${e.unref(f).materialLists.length<10?`0${r+1}`:r+1}`),b:e.t(t.url.length),c:"a77e8941-2-"+i,d:e.o((e=>F(r)),r),e:e.f(t.url,((e,t,r)=>({a:e,b:t}))),f:"a77e8941-3-"+i,g:e.o((e=>(e=>{c.value=e,d.value=!0})(r)),r),h:r}))),k:e.p({name:"arrow-right",size:"20",color:"#00000099"}),l:e.p({name:"trash",size:"28",color:"#0000004d"})}:{m:e.p({size:260,text:"您还没有图组哦"}),n:e.p({name:"plus",size:"24"}),o:e.o((e=>F()))}):e.e({p:e.unref(f).materialLists.length<99},e.unref(f).materialLists.length<99?{q:e.p({name:"plus",size:"24",color:"#ffffff"}),r:e.o(E)}:{},{s:e.f(e.unref(f).materialLists,((t,r,i)=>({a:t.url[0],b:e.o((e=>(e=>{L.pic=e[0],L.url=e[1],x.value=!0})(t.url)),r),c:"a77e8941-7-"+i,d:e.o((e=>(e=>{f.materialLists.splice(e,1)})(r)),r),e:e.o((e=>(e=>{y.value=e,O()})(r)),r),f:r}))),t:e.p({name:"close",size:"20",color:"#ffffff"})})):{},{v:2===e.unref(l)},2===e.unref(l)?e.e({w:t._imports_0$30,x:e.t(e.unref(f).copywriterList.length),y:e.unref(f).copywriterList.length>0},e.unref(f).copywriterList.length>0?{z:e.f(e.unref(f).copywriterList,((t,r,i)=>({a:e.t(t.title),b:e.t(t.content),c:e.f(t.topic,((t,r,i)=>({a:e.t(t),b:r}))),d:"a77e8941-8-"+i,e:e.o((e=>(e=>{f.copywriterList.splice(e,1)})(r)),r),f:r,g:e.o((t=>(t=>{b.value=t,e.index.$u.route({url:"/ai_modules/device/pages/task_copywriter/task_copywriter",params:{copywriter:JSON.stringify(f.copywriterList[t])}})})(r)),r)}))),A:e.p({name:"close",size:"20",color:"#ffffff"})}:{B:e.p({size:260,text:"您还没有文案哦"})}):{},{C:3===e.unref(l)},3===e.unref(l)?e.e({D:e.sr(p,"a77e8941-10",{k:"baseFormRef"}),E:e.o((t=>e.isRef(f)?f.value=t:null)),F:e.p({modelValue:e.unref(f)}),G:e.unref(j)},e.unref(j)?{H:e.t(e.unref(j))}:{}):{},{I:e.unref(l)!=e.unref(o).length},e.unref(l)!=e.unref(o).length?e.e({J:1===e.unref(l)},1===e.unref(l)?{K:e.t(e.unref(f).materialLists.length),L:e.n(e.unref(f).materialLists.length>0?"bg-primary":"bg-_h787878CC_")}:{M:e.o((t=>R(e.unref(l),"prev")))},{N:e.n(e.unref(C)?"bg-primary":"bg-_h787878CC_"),O:e.o((t=>R(e.unref(l),"next")))}):{P:e.o(S)},{Q:e.o(z),R:e.o((t=>e.isRef(d)?d.value=t:null)),S:e.p({"confirm-text":"删除",center:!0,content:"是否确定删除图组？",modelValue:e.unref(d)}),T:e.o(M),U:e.o((t=>e.isRef(q)?q.value=t:null)),V:e.p({"confirm-text":"确定",center:!0,content:"创建成功，回到任务列表？","show-close":!1,modelValue:e.unref(q)}),W:e.o(O),X:e.o((t=>e.isRef(v)?v.value=t:null)),Y:e.p({"confirm-text":"去上传",content:e.unref(k),modelValue:e.unref(v)}),Z:e.o((t=>e.isRef(h)?h.value=t:null)),aa:e.p({"upload-list":e.unref(w),modelValue:e.unref(h)}),ab:e.o((e=>x.value=!1)),ac:e.o((t=>e.isRef(x)?x.value=t:null)),ad:e.p({"video-url":e.unref(L).url,poster:e.unref(L).pic,show:e.unref(x)})})}}),o=e._export_sfc(u,[["__scopeId","data-v-a77e8941"]]);wx.createPage(o);
