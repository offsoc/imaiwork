"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../common/assets.js"),r=require("../../../../api/device.js"),u=require("../../enums/index.js"),a=require("../../../../components/file-upload/choose-file.js"),n=require("../../../../api/app.js"),s=require("../../../../stores/app.js"),o=require("../../../../api/person_wechat.js"),i=require("../../../../hooks/useDictOptions.js");if(require("../../../../utils/request/index.js"),require("../../../../utils/request/http.js"),require("../../../../enums/requestEnums.js"),require("../../../../utils/request/cancel.js"),require("../../../../utils/auth.js"),require("../../../../enums/constantEnums.js"),require("../../../../utils/cache.js"),require("../../../../stores/user.js"),require("../../../../api/user.js"),require("../../../../hooks/useShareMessage.js"),require("../../../../router/index.js"),require("../../../../utils/util.js"),require("../../../../stores/navigationBarTitle.js"),require("../../../../config/index.js"),require("../../../../api/chat.js"),require("../../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-navbar")+e.resolveComponent("u-icon")+e.resolveComponent("empty")+e.resolveComponent("data-select")+e.resolveComponent("u-input")+e.resolveComponent("upload-progress")+e.resolveComponent("u-popup")+e.resolveComponent("confirm-dialog"))()}Math||((()=>"../../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+l+(()=>"../../../../components/empty/empty.js")+(()=>"../../../../components/data-select/data-select.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+c+(()=>"../../../../components/upload-progress/upload-progress.js")+(()=>"../../../../uni_modules/vk-uview-ui/components/u-popup/u-popup.js")+(()=>"../../../../components/confirm-dialog/confirm-dialog.js"))();const l=()=>"../../components/clue-card/clue-card.js",c=()=>"../../components/bast-setting-v2/bast-setting-v2.js",f=e.defineComponent({__name:"create_add_wechat",setup(l){const c=s.useAppStore(),f=e.ref([{step:1,title:"选择线索"},{step:2,title:"调设置"},{step:3,title:"设定时间"}]),p=e.ref(1),d=e.computed((()=>c.config.wechat_remarks||[])),m=e.reactive({name:`自动加好友任务${e.index.$u.timeFormat(new Date,"yyyymmddhhMM")}`,crawling_task_ids:[],add_number:1,add_interval_time:5,remarks:d.value||[],add_remark_enable:1,add_friends_prompt:"",source:1,fileurl:"",add_type:"1",wechat_id:[],wechat_reg_type:0,time_config:["09:00","09:30"],task_frep:1,device_codes:[],custom_date:[]}),v=e.ref([]),h=e.ref([]),_=e.ref(!1),g=[1,3,5,10,15],x=[5,10,15,20],j=e.ref(0),w=e.ref(),y=e.ref(!1),q=e.ref(""),k=e.ref(-1),b=e.ref(0),C=e.ref(""),$=e.ref(!1),{optionsData:L}=i.useDictOptions({wechatLists:{api:o.getWeChatLists,params:{page_size:9999},transformData:e=>{var t;return null==(t=e.lists)?void 0:t.map((e=>({text:e.wechat_nickname,value:e.wechat_id})))}}}),E=e.computed((()=>z(p.value))),z=e=>{switch(e){case 1:return v.value.length>0;case 2:return 0!=m.wechat_id.length&&(!(4==j.value&&!w.value)&&(m.add_remark_enable=0==m.remarks.length?0:1,!0));case 3:return!0;default:return!1}},V=(t,r)=>{if("prev"!==r)if("next"!==r){if(t!==p.value)if(t<p.value)p.value=t;else{for(let r=1;r<t;r++)if(!z(r))return void e.index.$u.toast("请按顺序完成步骤");p.value=t}}else if(E.value)p.value++;else{const t={1:"请至少添加一个线索",3:"请设定时间"};e.index.$u.toast(t[p.value]||"请完成当前步骤")}else p.value--},T=(e,t)=>{const r=h.value.findIndex((e=>e.tempFilePath===t.tempFilePath));-1!==r&&(h.value[r]={...h.value[r],progress:e})},D=()=>{e.index.showActionSheet({itemList:["从聊天记录中选择文件（需要符合模板）","从获客任务中选择线索"],success:async t=>{if(0===t.tapIndex)try{h.value=[];const{tempFiles:t}=await a.chooseFile({type:"file",extension:[".csv",".xlsx"],count:1}),r=[];for(const u of t)u.size>20971520?e.index.$u.toast("文件大小不能超过20M"):r.push(u);if(0===r.length)return;h.value=r,_.value=!0;for(const e of h.value){const t=await n.uploadFile("file",{filePath:e.path},(t=>T(t,e)));2==m.source&&(m.source=1),v.value.length=0,v.value.push({url:t.uri,name:e.name,size:e.size,file_type:1})}h.value.every((e=>100===e.progress))&&(_.value=!1)}catch(r){e.index.$u.toast(r),h.value=[],_.value=!1}else e.index.navigateTo({url:"/ai_modules/device/pages/wechat_clue/wechat_clue"})},fail:e=>{console.log(e)}})},A=e=>{y.value=!0,k.value=e??-1,e>-1&&(q.value=m.remarks[e])},F=()=>{-1==k.value?m.remarks.push(q.value):m.remarks[k.value]=q.value,k.value=-1,y.value=!1},M=()=>{y.value=!1,q.value="",k.value=-1},O=()=>{$.value=!1,e.index.$u.route({url:"/pages/phone/phone",type:"reLaunch"})},R=async()=>{if(!m.name)return e.index.$u.toast("请输入任务名称"),!1;if(0==m.device_codes.length)return e.index.$u.toast("请选择设备"),!1;if(5!==b.value||m.custom_date.length){if(!m.time_config[0]||!m.time_config[1])return e.index.$u.toast("请选择时间"),!1;e.index.showLoading({title:"创建中...",mask:!0});try{await r.createManualAddWechat({...m,crawling_task_ids:2==m.source?v.value.map((e=>e.id)):[],fileurl:1==m.source?v.value[0].url:"",time_config:[`${m.time_config[0]}-${m.time_config[1]}`],add_interval_time:4==j.value?w.value:m.add_interval_time}),e.index.hideLoading(),$.value=!0}catch(t){C.value=t,e.index.hideLoading(),e.index.showToast({title:t,icon:"none",duration:3e3})}}else e.index.$u.toast("请选择任务日期")};return e.watch((()=>c.config.wechat_remarks),(e=>{m.remarks=e||[]})),e.onLoad((()=>{e.index.$on("confirm",(e=>{const{type:t,data:r}=e;if(t===u.ListenerTypeEnum.WECHAT_CLUE&&r&&r.length>0&&(1==m.source&&(v.value=[],m.fileurl="",m.source=2),v.value=v.value.concat(r)),t===u.ListenerTypeEnum.CHOOSE_DATE){if(0===r.length)return;m.custom_date=r,b.value=5}if(t===u.ListenerTypeEnum.CHOOSE_DEVICE){if(0===r.length)return;m.device_codes=r}}))})),(r,u)=>e.e({a:e.p({"title-bold":!0,title:"自动加好友","border-bottom":!1,"is-fixed":!1,background:{background:"transparent"}}),b:e.f(e.unref(f),((t,r,u)=>e.e({a:e.unref(p)>t.step},e.unref(p)>t.step?{b:"36349fc8-1-"+u,c:e.p({name:"checkmark",color:"#ffffff",size:"14"})}:{},{d:e.t(t.title),e:t.step!==e.unref(f).length},t.step!==e.unref(f).length?{f:e.unref(p)>t.step?1:""}:{},{g:t.step,h:e.unref(p)==t.step?1:"",i:e.o((e=>V(t.step)),t.step)}))),c:1===e.unref(p)},1===e.unref(p)?e.e({d:t._imports_0$32,e:e.o(D),f:e.t(e.unref(v).length),g:e.unref(v).length},e.unref(v).length?{h:e.f(e.unref(v),((t,r,u)=>({a:"36349fc8-2-"+u,b:e.o((e=>(e=>{v.value.splice(e,1)})(r)),r),c:"36349fc8-3-"+u,d:e.p({data:t,type:t.file_type}),e:r}))),i:e.p({name:"close",size:"20",color:"#ffffff"})}:{j:e.p({size:260,text:"您还没有添加任务哦"})}):{},{k:2===e.unref(p)},2===e.unref(p)?e.e({l:e.o((t=>e.unref(m).wechat_id=t)),m:e.p({multiple:!0,localdata:e.unref(L).wechatLists,modelValue:e.unref(m).wechat_id}),n:e.o((t=>e.unref(m).wechat_reg_type=t)),o:e.p({clear:!1,localdata:[{text:"全部",value:0},{text:"微信号",value:1},{text:"手机号",value:2}],modelValue:e.unref(m).wechat_reg_type}),p:e.f(g,((t,r,u)=>({a:e.t(t),b:r,c:e.unref(m).add_number==t?1:"",d:e.o((e=>(e=>{m.add_number=e})(t)),r)}))),q:e.f(x,((t,r,u)=>({a:e.t(t),b:r,c:e.unref(j)==r?1:"",d:e.o((e=>((e,t)=>{j.value=t,m.add_interval_time=e})(t,r)),r)}))),r:4==e.unref(j)},4==e.unref(j)?{s:e.o((e=>j.value=4)),t:e.o((t=>e.isRef(w)?w.value=t:null)),v:e.p({type:"digit",height:"20",placeholder:"请输入","placeholder-style":"color: #00000080;font-size: 24rpx;",modelValue:e.unref(w)})}:{},{w:4==e.unref(j)?1:"",x:e.o((e=>j.value=4)),y:t._imports_1$20,z:e.o((e=>A(-1))),A:e.f(e.unref(m).remarks,((t,r,u)=>({a:e.t(t),b:"36349fc8-8-"+u,c:e.o((e=>(e=>{m.remarks.splice(e,1)})(r)),r),d:r,e:e.o((e=>A(r)),r)}))),B:e.p({name:"close",size:"16",color:"#ffffff"})}):{},{C:3===e.unref(p)},3===e.unref(p)?{D:e.o((e=>b.value=e)),E:e.o((t=>e.isRef(m)?m.value=t:null)),F:e.p({"current-frequency":e.unref(b),modelValue:e.unref(m)})}:{},{G:e.unref(p)!=e.unref(f).length},e.unref(p)!=e.unref(f).length?e.e({H:1===e.unref(p)},1===e.unref(p)?{I:e.t(e.unref(v).length),J:e.n(e.unref(v).length>0?"bg-primary":"bg-_h787878CC_")}:{K:e.o((t=>V(e.unref(p),"prev")))},{L:e.n(e.unref(E)?"bg-primary":"bg-_h787878CC_"),M:e.o((t=>V(e.unref(p),"next")))}):{N:e.o(R)},{O:e.o((t=>e.isRef(_)?_.value=t:null)),P:e.p({"upload-list":e.unref(h),modelValue:e.unref(_)}),Q:e.o((t=>e.isRef(q)?q.value=t:null)),R:e.p({placeholder:"请输入备注内容",maxlength:"100","placeholder-style":"color: #0000004d; font-size: 26rpx;",modelValue:e.unref(q)}),S:e.o(M),T:e.o(F),U:e.o((t=>e.isRef(y)?y.value=t:null)),V:e.p({mode:"center",width:"90%","border-radius":20,modelValue:e.unref(y)}),W:e.o(O),X:e.o(O),Y:e.o((t=>e.isRef($)?$.value=t:null)),Z:e.p({center:!0,"confirm-text":"确定",content:"创建成功，回到首页？","show-close":!1,modelValue:e.unref($)})})}}),p=e._export_sfc(f,[["__scopeId","data-v-36349fc8"]]);wx.createPage(p);
