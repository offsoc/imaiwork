"use strict";const e=require("../../../common/vendor.js"),s=require("../../../hooks/useWebSocket.js"),o=require("../../../enums/appEnums.js"),n=require("../../../stores/user.js"),c=require("../../../config/index.js"),r=require("../../../utils/util.js"),t=c.config.version;exports.useDeviceWs=function(d){const i=n.useUserStore(),{userInfo:u}=e.toRefs(i),{baseUrl:C}=c.config,m=`wss://${C.split("//")[1]}wss`,{on:v,send:E,isConnected:p,reconnect:a,close:D}=s.useWebSocket(m,{...d}),S=(e,s)=>{const o=I.get(e);o&&o(s)},I=new Map,l=s=>{if(!p.value)return void e.index.$u.toast(o.DeviceWsMessage[o.DeviceCmdCodeEnum.CONNECT_ERROR]);const{appType:n}=s;return E({type:s.type,content:{...s.content,userId:u.value.id,deviceId:s.deviceId||void 0,accountType:s.accountType},deviceId:s.deviceId||"",messageId:Date.now(),appVersion:t,appType:n})};return v("open",(()=>{S("open"),l({type:o.DeviceCmdEnum.BIND_WS,content:{type:o.DeviceCmdEnum.BIND_WS}})})),v("close",(()=>{S("close",{error:o.DeviceWsMessage[o.DeviceCmdCodeEnum.CONNECT_ERROR],code:o.DeviceCmdCodeEnum.CONNECT_ERROR})})),v("error",(e=>{S("error",e)})),v("message",(e=>{let{type:s,code:n,content:c,deviceId:t}=e;if(c=r.isJson(c)?JSON.parse(c):c,n==o.DeviceCmdCodeEnum.SUCCESS)switch(n){case o.DeviceCmdCodeEnum.SUCCESS:case o.DeviceCmdCodeEnum.INIT_COMPLETE:case o.DeviceCmdCodeEnum.CHECK_INIT:S("success",{...e,content:c});break;default:S("error",{error:c.msg,code:o.DeviceCmdCodeEnum.PUSH_MESSAGE_ERROR,deviceCode:t})}else S("error",{error:c.msg,type:s,code:n,deviceCode:t})})),{on:v,send:l,reconnect:a,isConnected:p,onEvent:(e,s)=>{I.set(e,s)},close:D}};
