"use strict";const e=require("../../../common/vendor.js"),s=require("../../../hooks/useWebSocket.js"),o=require("../../../enums/appEnums.js"),c=require("../../../stores/user.js"),n=require("../../../config/index.js"),r=require("../../../utils/util.js"),t=n.config.version;exports.useDeviceWs=function(d){const i=c.useUserStore(),{userInfo:u}=e.toRefs(i),{baseUrl:C}=n.config,m=`wss://${C.split("//")[1]}wss`,{on:v,send:p,isConnected:E,reconnect:a,close:D}=s.useWebSocket(m,{...d}),S=(e,s)=>{const o=I.get(e);o&&o(s)},I=new Map,l=s=>{if(!E.value)return void e.index.$u.toast(o.DeviceWsMessage[o.DeviceCmdCodeEnum.CONNECT_ERROR]);const{appType:c}=s;return p({type:s.type,content:{...s.content,userId:u.value.id,deviceId:s.deviceId||void 0,accountType:s.accountType},deviceId:s.deviceId||"",messageId:Date.now(),appVersion:t,appType:c})};return v("open",(()=>{S("open"),l({type:o.DeviceCmdEnum.BIND_WS,content:{type:o.DeviceCmdEnum.BIND_WS,sourceType:"mprog"}})})),v("close",(()=>{S("close",{error:o.DeviceWsMessage[o.DeviceCmdCodeEnum.CONNECT_ERROR],code:o.DeviceCmdCodeEnum.CONNECT_ERROR})})),v("error",(e=>{S("error",e)})),v("message",(e=>{let{type:s,code:c,content:n,deviceId:t}=e;if(n=r.isJson(n)?JSON.parse(n):n,c==o.DeviceCmdCodeEnum.SUCCESS)switch(c){case o.DeviceCmdCodeEnum.SUCCESS:case o.DeviceCmdCodeEnum.INIT_COMPLETE:case o.DeviceCmdCodeEnum.CHECK_INIT:S("success",{...e,content:n});break;default:S("error",{error:n.msg,code:o.DeviceCmdCodeEnum.PUSH_MESSAGE_ERROR,deviceCode:t})}else S("error",{error:n.msg,type:s,code:c,deviceCode:t})})),{on:v,send:l,reconnect:a,isConnected:E,onEvent:(e,s)=>{I.set(e,s)},close:D}};
