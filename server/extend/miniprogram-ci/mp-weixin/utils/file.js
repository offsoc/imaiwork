"use strict";const e=require("../common/vendor.js"),t=t=>new Promise(((i,o)=>{e.index.getSetting({success:n=>{n.authSetting[t]?i(!0):e.index.authorize({scope:t,success:()=>{i(!0)},fail:async n=>{try{if((await e.index.showModal({title:"提示",content:"您关闭了权限，需要前往设置页面打开权限才能继续使用该功能。",confirmText:"去设置",cancelText:"取消"})).confirm){const o=await e.index.openSetting();o.authSetting&&o.authSetting[t]?i(!0):i(!1)}else i(!1)}catch(a){o(a)}}})}})})),i=e.ref(!1);exports.requestAuthorization=t,exports.saveImageToPhotosAlbum=async function(t){if(!t)return e.index.$u.toast("图片错误");if(!i.value){e.index.showLoading({title:"下载中"}),i.value=!0;try{const o=await e.index.downloadFile({url:t,timeout:1e4});await e.index.saveImageToPhotosAlbum({filePath:o.tempFilePath}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success"}),i.value=!1}catch(o){if(e.index.hideLoading(),i.value=!1,"saveImageToPhotosAlbum:fail cancel"==o.errMsg)return void e.index.$u.toast("取消保存");if("downloadFile:fail fail:timeout"==o.errMsg)return void e.index.$u.toast("下载图片超时，请重新下载");if("saveImageToPhotosAlbum:fail auth deny"==o.errMsg){if((await e.index.showModal({title:"提示",content:"您关闭了权限，请前往设置打开权限"})).confirm){(await e.index.openSetting()).authSetting["scope.writePhotosAlbum"]?e.index.showModal({title:"提示",content:"获取权限成功,再次保存图片即可成功",showCancel:!1}):e.index.showModal({title:"提示",content:"获取权限失败，无法保存到相册",showCancel:!1})}return}e.index.$u.toast(o.errMsg||"保存失败")}}},exports.saveVideoToPhotosAlbum=async function(i){try{if(!(await t("scope.writePhotosAlbum")))return void e.index.$u.toast("您关闭了权限，请前往设置打开权限");e.index.showLoading({title:"下载中"});const{tempFilePath:o}=await e.index.downloadFile({url:i});await e.index.saveVideoToPhotosAlbum({filePath:o}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success",duration:3e3})}catch(o){e.index.hideLoading(),e.index.showToast({title:"保存失败",icon:"none",duration:3e3})}};
