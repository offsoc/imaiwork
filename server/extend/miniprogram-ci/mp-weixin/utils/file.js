"use strict";const e=require("../common/vendor.js"),t=e.ref(!1);exports.requestAuthorization=t=>new Promise(((i,o)=>{e.index.getSetting({success:n=>{n.authSetting[t]?i(!0):e.index.authorize({scope:t,success:()=>{i(!0)},fail:async n=>{try{if((await e.index.showModal({title:"提示",content:"您关闭了权限，需要前往设置页面打开权限才能继续使用该功能。",confirmText:"去设置",cancelText:"取消"})).confirm){const o=await e.index.openSetting();o.authSetting&&o.authSetting[t]?i(!0):i(!1)}else i(!1)}catch(a){o(a)}}})}})})),exports.saveImageToPhotosAlbum=async function(i){if(!i)return e.index.$u.toast("图片错误");if(!t.value){e.index.showLoading({title:"下载中"}),t.value=!0;try{const o=await e.index.downloadFile({url:i,timeout:1e4});await e.index.saveImageToPhotosAlbum({filePath:o.tempFilePath}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success",duration:3e3}),t.value=!1}catch(o){if(e.index.hideLoading(),t.value=!1,"saveImageToPhotosAlbum:fail cancel"==o.errMsg)return void e.index.$u.toast("取消保存");if("downloadFile:fail fail:timeout"==o.errMsg)return void e.index.$u.toast("下载图片超时，请重新下载");if("saveImageToPhotosAlbum:fail auth deny"==o.errMsg){if((await e.index.showModal({title:"提示",content:"您关闭了权限，请前往设置打开权限"})).confirm){(await e.index.openSetting()).authSetting["scope.writePhotosAlbum"]?e.index.showModal({title:"提示",content:"获取权限成功,再次保存图片即可成功",showCancel:!1}):e.index.showModal({title:"提示",content:"获取权限失败，无法保存到相册",showCancel:!1})}return}if(112==o.errno)return void e.index.$u.toast("请到对应小程序后台完善用户隐私保护指引");e.index.showToast({title:o.errMsg||"保存失败",icon:"success",duration:3e3})}}},exports.saveVideoToPhotosAlbum=async function(t){try{e.index.showLoading({title:"下载中"});const{tempFilePath:i}=await e.index.downloadFile({url:t});await e.index.saveVideoToPhotosAlbum({filePath:i}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"success",duration:3e3})}catch(i){if(console.log(i),"saveVideoToPhotosAlbum:fail cancel"==i.errMsg)return void e.index.$u.toast("取消保存");if("downloadFile:fail fail:timeout"==i.errMsg)return void e.index.$u.toast("下载视频超时，请重新下载");if("saveVideoToPhotosAlbum:fail auth deny"==i.errMsg){if((await e.index.showModal({title:"提示",content:"您关闭了权限，请前往设置打开权限"})).confirm){(await e.index.openSetting()).authSetting["scope.writePhotosAlbum"]?e.index.showModal({title:"提示",content:"获取权限成功,再次保存视频即可成功",showCancel:!1}):e.index.showModal({title:"提示",content:"获取权限失败，无法保存到相册",showCancel:!1})}return}if(112==i.errno)return void e.index.$u.toast("请到对应小程序后台完善用户隐私保护指引");e.index.hideLoading(),e.index.showToast({title:i.errMsg||"保存失败",icon:"none",duration:3e3})}};
