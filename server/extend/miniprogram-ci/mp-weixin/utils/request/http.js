"use strict";var e=Object.defineProperty,t=(t,s,r)=>(((t,s,r)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r})(t,"symbol"!=typeof s?s+"":s,r),r);const s=require("../../common/vendor.js"),r=require("../../enums/requestEnums.js"),n=require("./cancel.js");exports.HttpRequest=class{constructor(e){t(this,"options"),t(this,"requestTask"),this.options=e}retryRequest(e,t){var n;const{retryCount:o,retryTimeout:u}=t;return o&&(null==(n=e.method)?void 0:n.toUpperCase())!=r.RequestMethodsEnum.POST?(s.index.showLoading({title:"加载中..."}),t.hasRetryCount=t.hasRetryCount||0,t.hasRetryCount>=o?Promise.reject():(t.hasRetryCount++,t.requestHooks.requestInterceptorsHook=e=>e,new Promise((e=>setTimeout(e,u))).then((()=>this.request(e,t))).finally((()=>s.index.hideLoading())))):Promise.reject()}get(e,t){return this.request({...e,method:r.RequestMethodsEnum.GET},t)}post(e,t){return this.request({...e,method:r.RequestMethodsEnum.POST},t)}eventStream(e,t){let r=s.merge({},this.options.requestOptions,e);const n=s.merge({},this.options,t),{requestInterceptorsHook:o,responseInterceptorsHook:u}=n.requestHooks||{};o&&s.isFunction(o)&&(r=o(r,n));const{onmessage:i,onclose:a,onstart:c}=n;return new Promise(((e,t)=>{try{let o={};const l=s.index.request({...r,enableChunked:!0,responseType:"arraybuffer",async success(s){200===s.statusCode?e(s):t(s)},fail(e){t(e)},complete(){null==a||a()}});null==c||c(l),l.onHeadersReceived((e=>{o=e.header})),l.onChunkReceived((async a=>{const c=a.data,l=function(e){let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return decodeURIComponent(escape(t))}(new Uint8Array(c));if(function(e){const t=(null==e?void 0:e["Content-Type"])||(null==e?void 0:e["content-type"])||e.get("content-type");return"string"==typeof t&&t.includes("text/event-stream")}(o))null==i||i(l);else{const o=s.parse(l);if(u&&s.isFunction(u)){try{const t=await u({data:o,statusCode:200},n,r);e(t)}catch(h){t(h)}return}}}))}catch(o){t()}}))}uploadFile(e,t){let o=s.merge({},this.options.requestOptions,e);const u=s.merge({},this.options,t),{requestInterceptorsHook:i,responseInterceptorsHook:a,responseInterceptorsCatchHook:c}=u.requestHooks||{};return i&&s.isFunction(i)&&(o=i(o,u)),new Promise(((t,i)=>{this.requestTask=s.index.uploadFile({...o,header:{...o.header},async success(e){if(200==e.statusCode){if(e.data=s.parse(e.data),a&&s.isFunction(a)){try{e=await a(e,u,o),t(e)}catch(r){i(r)}return}t(e)}else i(e.errMsg)},fail(e){if(e.errMsg==r.RequestErrMsgEnum.UPLOAD_ABORT)return i(e.errMsg);c&&s.isFunction(c)?i(c(o,e)):i(e.errMsg||e)}}),this.requestTask.onProgressUpdate((({progress:e})=>{var t;null==(t=u.onProgress)||t.call(u,e)}));const{ignoreCancel:l}=u;!l&&n.requestCancel.add(e.url,this.requestTask)}))}async request(e,t){let o=s.merge({},this.options.requestOptions,e);const u=s.merge({},this.options,t),{requestInterceptorsHook:i,responseInterceptorsHook:a,responseInterceptorsCatchHook:c}=u.requestHooks||{};return i&&s.isFunction(i)&&(o=i(o,u)),new Promise(((t,i)=>{this.requestTask=s.index.request({...o,async success(e){if(200!==e.statusCode)return i();if(a&&s.isFunction(a))try{e=await a(e,u,o),t(e)}catch(r){i(r)}else t(e)},fail:async e=>{e.errMsg!=r.RequestErrMsgEnum.TIMEOUT?e.errMsg!=r.RequestErrMsgEnum.ABORT?c&&s.isFunction(c)?i(await c(o,e)):i(e):i({message:"请求已终止",errno:r.RequestCodeEnum.ABORT}):this.retryRequest(o,u).then((e=>t(e))).catch((e=>i(e)))},complete(t){t.errMsg!==r.RequestErrMsgEnum.ABORT&&n.requestCancel.remove(e.url)}});const{ignoreCancel:l}=u;!l&&n.requestCancel.add(e.url,this.requestTask)}))}cancelRequest(){this.requestTask&&this.requestTask.abort()}};
