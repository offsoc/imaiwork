"use strict";const e=require("../../common/vendor.js"),s=require("./choose-file.js"),r=require("../../api/app.js"),a=require("../../stores/app.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),require("../../router/index.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../config/index.js"),require("../../api/chat.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-line-progress"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js"))();const t=e.defineComponent({__name:"file-upload",props:{modelValue:{type:[Array,Object],default:()=>[]},limit:{type:Number,default:10},disabled:{type:Boolean,default:!1},fileType:{type:String,default:"all"},returnType:{type:String,default:"array"},fileExtname:{type:Array,default:()=>[]},data:{type:Object,default:()=>({})},header:{type:Object,default:()=>({})},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},showProgress:{type:Boolean,default:!0},maxCount:{type:Number,default:2},isGpt:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(t,{expose:u,emit:l}){const i=t,o=a.useAppStore(),{uploadAssistantId:n}=e.toRefs(o),p=e.ref([]),c=e.computed((()=>"object"===i.returnType?1:i.limit?i.limit:1)),d=async()=>{if(i.disabled)return;if(p.value.length>=Number(c.value)&&"array"===i.returnType&&c.value>1)return void e.index.showToast({title:`您最多选择 ${c.value} 个文件`,icon:"none"});const r=await s.chooseFile({type:i.fileType,compressed:!1,sizeType:i.sizeType,sourceType:i.sourceType,extension:i.fileExtname.length?i.fileExtname:void 0,count:c.value-p.value.length});m(r)},m=async e=>{1===Number(c.value)&&(p.value=[]);const{files:r}=s.getFilesByExtname(e,i.fileExtname),a=[];for(let t=0;t<r.length&&!(c.value-p.value.length<=0);t++){const e=s.normalizeFileData(r[t]);p.value.push(e),a.push(e)}await y(a),f()},f=()=>{let e={};if("object"===i.returnType){const[s]=p.value;"success"===s.status&&(e={url:s.url,name:s.name})}else{e=p.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name,id:e.id})))}l("update:modelValue",e)},y=e=>{const s=e.length;let a=0,t=0;return new Promise((u=>{const l=async()=>{const o=a++,c=e[o],d=p.value.findIndex((e=>e.path===c.path));try{const{uri:e,id:s}=i.isGpt?await r.uploadGPTFile({filePath:c.url,formData:{purpose:"assistants",assistants_id:n.value},header:i.header},(e=>{p.value[d].progress=e})):await r.uploadFile(i.fileType,{filePath:c.url,formData:i.data,header:i.header},(e=>{p.value[d].progress=e}));p.value[d].status="success",p.value[d].url=e,p.value[d].id=s}catch(m){console.log(m),p.value[d].errMsg=m,p.value[d].status="error"}t++,t!==s?a<s&&l():u()};for(let e=0;e<Math.min(s,i.maxCount);e++)l()}))},h=e.computed((()=>{switch(i.fileType){case"image":return"上传图片";case"video":return"上传视频";default:return"上传文件"}})),v=e=>{if(!e.url)return;p.value.some((s=>s.url==e.url))||(e.name||(e.name=s.getFileName(e.url)),e.status="success",p.value.push({...e}))};e.watch((()=>i.modelValue),(e=>{Array.isArray(e)?e.forEach((e=>{v(e)})):(e.url||(p.value=[]),v(e))}),{immediate:!0});return u({clear:()=>{p.value=[]}}),(s,r)=>e.e({a:s.$slots.trigger},s.$slots.trigger?{}:e.e({b:"file"===t.fileType},"file"===t.fileType?{c:e.p({name:"arrow-upward",size:32})}:{d:e.p({name:"camera",size:32})},{e:e.t(e.unref(h))}),{f:e.o(d),g:e.f(p.value,((s,r,a)=>e.e("file"==t.fileType?{a:"2aa12f98-2-"+a,b:e.p({size:32,name:"file-text"})}:{},"image"==t.fileType?{c:s.path||s.url}:{},"video"==t.fileType?{d:s.path||s.url}:{},{e:e.t(s.name)},t.disabled?{}:{f:"2aa12f98-3-"+a,g:e.p({name:"close",size:28}),h:e.o((e=>(e=>{const s=p.value.findIndex((s=>s.url===e));s>-1&&(p.value.splice(s,1),f())})(s.url)),s.url)},{i:t.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status},t.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status?{j:"2aa12f98-4-"+a,k:e.p({height:"6","show-percent":!1,"active-color":"#0065FB",percent:s.progress})}:{},{l:"error"===s.status},"error"===s.status?{m:e.o((e=>(async e=>{e.status="ready",e.progress=0,await y([{...e}])})(s)),s.url)}:{},{n:s.url}))),h:"file"==t.fileType,i:"image"==t.fileType,j:"video"==t.fileType,k:!t.disabled})}});wx.createComponent(t);
