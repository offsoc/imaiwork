"use strict";const e=require("../../common/vendor.js"),s=require("./choose-file.js"),r=require("../../api/app.js"),t=require("../../stores/app.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),require("../../router/index.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../config/index.js"),require("../../api/chat.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-line-progress"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js"))();const a=e.defineComponent({__name:"file-upload",props:{modelValue:{type:[Array,Object],default:()=>[]},limit:{type:Number,default:10},disabled:{type:Boolean,default:!1},fileType:{type:String,default:"all"},returnType:{type:String,default:"array"},fileExtname:{type:Array,default:()=>[]},data:{type:Object,default:()=>({})},header:{type:Object,default:()=>({})},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},showProgress:{type:Boolean,default:!0},maxCount:{type:Number,default:2},isGpt:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(a,{expose:u,emit:l}){const i=a,o=t.useAppStore(),{uploadAssistantId:n}=e.toRefs(o),p=e.ref([]),c=e.computed((()=>"object"===i.returnType?1:i.limit?i.limit:1)),f=async()=>{if(i.disabled)return;if(p.value.length>=Number(c.value)&&"array"===i.returnType&&c.value>1)return void e.index.showToast({title:`您最多选择 ${c.value} 个文件`,icon:"none"});const r=await s.chooseFile({type:i.fileType,compressed:!1,sizeType:i.sizeType,sourceType:i.sourceType,extension:i.fileExtname.length?i.fileExtname:void 0,count:c.value-p.value.length});d(r)},d=async e=>{1===Number(c.value)&&(p.value=[]);const{files:r}=s.getFilesByExtname(e,i.fileExtname),t=[];for(let a=0;a<r.length&&!(c.value-p.value.length<=0);a++){const e=s.normalizeFileData(r[a]);p.value.push(e),t.push(e)}await y(t),m()},m=()=>{let e={};if("object"===i.returnType){const[s]=p.value;"success"===s.status&&(e={url:s.url,name:s.name})}else{e=p.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name,id:e.id})))}l("update:modelValue",e)},y=e=>{const s=e.length;let t=0,a=0;return new Promise((u=>{const l=async()=>{const o=t++,c=e[o],f=p.value.findIndex((e=>e.path===c.path));try{const{uri:e,id:s}=i.isGpt?await r.uploadGPTFile({filePath:c.url,formData:{purpose:"assistants",assistants_id:n.value},header:i.header},(e=>{p.value[f].progress=e})):await r.uploadFile(i.fileType,{filePath:c.url,formData:i.data,header:i.header},(e=>{p.value[f].progress=e}));p.value[f].status="success",p.value[f].url=e,p.value[f].id=s}catch(d){console.log(d),p.value[f].errMsg=d,p.value[f].status="error"}a++,a!==s?t<s&&l():u()};for(let e=0;e<Math.min(s,i.maxCount);e++)l()}))},v=e.computed((()=>{switch(i.fileType){case"image":return"上传图片";case"video":return"上传视频";default:return"上传文件"}})),h=e=>{if(!e.url)return;p.value.some((s=>s.url==e.url))||(e.name||(e.name=s.getFileName(e.url)),e.status="success",p.value.push({...e}))};e.watch((()=>i.modelValue),(e=>{Array.isArray(e)?e.forEach((e=>{h(e)})):(e.url||(p.value=[]),h(e))}),{immediate:!0});return u({clear:()=>{p.value=[]}}),(s,r)=>e.e({a:s.$slots.trigger},s.$slots.trigger?{}:{b:e.p({name:"/static/images/icons/upload.svg",size:48}),c:e.t(e.unref(v))},{d:e.o(f),e:e.f(p.value,((s,r,t)=>e.e("file"==a.fileType?{a:"2aa12f98-1-"+t,b:e.p({size:30,name:"file-text",color:"#ffffff"})}:{},"image"==a.fileType?{c:s.path||s.url}:{},"video"==a.fileType?{d:s.path||s.url}:{},{e:e.t(s.name)},a.disabled?{}:{f:"2aa12f98-2-"+t,g:e.p({name:"close",size:16,color:"#ffffff"}),h:e.o((e=>(e=>{const s=p.value.findIndex((s=>s.url===e));s>-1&&(p.value.splice(s,1),m())})(s.url)),s.url)},{i:a.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status},a.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status?{j:"2aa12f98-3-"+t,k:e.p({height:"6","show-percent":!1,"active-color":"#0065FB",percent:s.progress})}:{},{l:"error"===s.status},"error"===s.status?{m:e.o((e=>(async e=>{e.status="ready",e.progress=0,await y([{...e}])})(s)),s.url)}:{},{n:s.url}))),f:"file"==a.fileType,g:"image"==a.fileType,h:"video"==a.fileType,i:!a.disabled})}});wx.createComponent(a);
