"use strict";const e=require("../../common/vendor.js"),s=require("./choose-file.js"),a=require("../../api/app.js"),r=require("../../stores/app.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../stores/user.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),require("../../router/index.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../config/index.js"),require("../../api/chat.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-line-progress"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-line-progress/u-line-progress.js"))();const t=e.defineComponent({__name:"file-upload",props:{modelValue:{type:[Array,Object],default:()=>[]},limit:{type:Number,default:10},disabled:{type:Boolean,default:!1},fileType:{type:String,default:"file",validator:e=>["image","video","file","all"].includes(e)},returnType:{type:String,default:"array"},fileExtname:{type:Array,default:()=>[]},data:{type:Object,default:()=>({})},header:{type:Object,default:()=>({})},sizeType:{type:Array,default:()=>["original","compressed"]},sourceType:{type:Array,default:()=>["album","camera"]},showProgress:{type:Boolean,default:!0},maxCount:{type:Number,default:2},isGpt:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(t,{expose:u,emit:i}){const l=t,o=r.useAppStore(),{uploadAssistantId:n}=e.toRefs(o),c=e.ref([]),p=e.computed((()=>"object"===l.returnType?1:l.limit?l.limit:1)),d=e.ref(l.fileType),f=async()=>{if(l.disabled)return;const a=p.value-c.value.length;if(a<=0&&"array"===l.returnType&&p.value>1)return void e.index.showToast({title:`您最多选择 ${p.value} 个文件`,icon:"none"});const r={compressed:!1,sizeType:l.sizeType,sourceType:l.sourceType,extension:l.fileExtname.length?l.fileExtname:void 0,count:a};if("all"===l.fileType){const a={0:"image",1:"video",2:"file"};return void e.index.showActionSheet({itemList:["选择图片","选择视频","选择文件"],success:async e=>{d.value=a[e.tapIndex];const t=await s.chooseFile({type:d.value,...r});m(t)}})}const t=await s.chooseFile({type:d.value,...r});m(t)},m=async e=>{1===Number(p.value)&&(c.value=[]);const{files:a}=s.getFilesByExtname(e,l.fileExtname),r=[];for(let t=0;t<a.length&&!(p.value-c.value.length<=0);t++){const e=s.normalizeFileData(a[t]);c.value.push(e),r.push(e)}await y(r),v()},v=()=>{let e={};if("object"===l.returnType){const[s]=c.value;"success"===s.status&&(e={url:s.url,name:s.name})}else{e=c.value.filter((e=>"success"===e.status)).map((e=>({url:e.url,name:e.name,id:e.id})))}i("update:modelValue",e)},y=e=>{const s=e.length;let r=0,t=0;return new Promise((u=>{const i=async()=>{const o=r++,p=e[o],f=c.value.findIndex((e=>e.path===p.path));try{const{uri:e,id:s}=l.isGpt?await a.uploadGPTFile({filePath:p.url,formData:{purpose:"assistants",assistants_id:n.value},header:l.header},(e=>{c.value[f].progress=e})):await a.uploadFile(d.value,{filePath:p.url,formData:l.data,header:l.header},(e=>{c.value[f].progress=e}));c.value[f].status="success",c.value[f].url=e,c.value[f].id=s}catch(m){console.log(m),c.value[f].errMsg=m,c.value[f].status="error"}t++,t!==s?r<s&&i():u()};for(let e=0;e<Math.min(s,l.maxCount);e++)i()}))},h=e.computed((()=>{switch(l.fileType){case"image":return"上传图片";case"video":return"上传视频";default:return"上传文件"}})),g=e=>{if(!e.url)return;c.value.some((s=>s.url==e.url))||(e.name||(e.name=s.getFileName(e.url)),e.status="success",c.value.push({...e}))};e.watch((()=>l.modelValue),(e=>{Array.isArray(e)?e.forEach((e=>{g(e)})):(e.url||(c.value=[]),g(e))}),{immediate:!0});return u({clear:()=>{c.value=[]}}),(s,a)=>e.e({a:s.$slots.trigger},s.$slots.trigger?{}:{b:e.p({name:"/static/images/icons/upload.svg",size:48}),c:e.t(e.unref(h))},{d:e.o(f),e:e.f(c.value,((s,a,r)=>e.e("file"==d.value?{a:"13e802a2-1-"+r,b:e.p({size:30,name:"file-text",color:"#ffffff"})}:{},"image"==d.value?{c:s.path||s.url}:{},"video"==d.value?{d:"13e802a2-2-"+r,e:e.p({size:30,name:"camera",color:"#ffffff"})}:{},{f:e.t(s.name)},t.disabled?{}:{g:"13e802a2-3-"+r,h:e.p({name:"close",size:16,color:"#ffffff"}),i:e.o((e=>(e=>{const s=c.value.findIndex((s=>s.url===e));s>-1&&(c.value.splice(s,1),v())})(s.url)),s.url)},{j:t.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status},t.showProgress&&s.progress>=0&&s.progress&&"success"!==s.status?{k:"13e802a2-4-"+r,l:e.p({height:"6","show-percent":!1,"active-color":"#0065FB",percent:s.progress})}:{},{m:"error"===s.status},"error"===s.status?{n:e.o((e=>(async e=>{e.status="ready",e.progress=0,await y([{...e}])})(s)),s.url)}:{},{o:s.url}))),f:"file"==d.value,g:"image"==d.value,h:"video"==d.value,i:!t.disabled})}});wx.createComponent(t);
