"use strict";const e=require("../../common/vendor.js"),t=require("../../api/chat.js"),o=require("../../api/agent.js"),n=require("../../utils/util.js"),i=require("../../hooks/useKeyboardHeight.js"),a=require("../../stores/app.js"),s=require("../../enums/appEnums.js"),u=require("../../stores/user.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-switch")+e.resolveComponent("u-button")+e.resolveComponent("popup-bottom")+e.resolveComponent("empty")+e.resolveComponent("z-paging"))()}Math||((()=>"../chat-record-item/chat-record-item.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+r+(()=>"../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-switch/u-switch.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../popup-bottom/popup-bottom.js")+(()=>"../empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js"))();const r=()=>"./components/file-item.js",l=e.defineComponent({__name:"chat-scroll-view",props:{contentList:{default:()=>[]},fileList:{default:()=>[]},placeholder:{default:"在这里输入任何问题 ..."},sendDisabled:{type:Boolean,default:!1},tokens:{default:0},isStop:{type:Boolean},isNetwork:{type:Boolean,default:!0},isCoze:{type:Boolean,default:!1},isStaff:{type:Boolean,default:!1}},emits:["update:modelValue","contentPost","close","add-session","update:fileList","update:network"],setup(r,{expose:l,emit:d}){const p=r,f=a.useAppStore(),c=e.computed((()=>u.useUserStore().isLogin)),m=e.ref({id:"",name:"",model_id:"",model_sub_id:""}),g=e.computed((()=>{var e;return((null==(e=f.getAiModelConfig)?void 0:e.channel)||[]).filter((e=>"1"==e.status))})),v=e.ref(!1),_=()=>{c.value?(v.value=!v.value,d("update:network",v.value)):e.index.$u.route({url:"/pages/login/login"})},h=e.computed({get:()=>p.fileList,set(e){d("update:fileList",e)}}),b=e.computed((()=>{const e=0===h.value.length&&!I.value;return p.sendDisabled||e})),y=()=>{R(),e.index.$u.route({url:"/packages/pages/choose_file/choose_file",params:{limit:1}})},w=e.ref(!1),x=e.ref(!1),j=e.reactive({id:"",name:"",avatar:""}),C=()=>{j.id="",j.name="",j.avatar=""},q=e.ref(!1),z=e.reactive({top_p:.5,temperature:1,presence_penalty:.1,frequency_penalty:2,context_num:3,top_logprobs:10,logprobs:0}),k=e.computed((()=>m.value.model_id==s.ModelIdEnum.GPT_4O?2:1)),L=(e,t,o)=>{let{value:n}=e.detail;0==o||Number.isInteger(n)?z[t]=n:z[t]=n.toFixed(o)},S=()=>{R(),H(),q.value=!0},T=async()=>{e.index.showLoading({title:"保存中...",mask:!0});try{await t.saveUserChatConfig({model_id:m.value.model_id,model_sub_id:m.value.model_sub_id,...z}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"none",duration:3e3}),q.value=!1}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"保存失败",icon:"none",duration:3e3})}};e.shallowRef();const I=e.ref(""),O=e.ref(0),{dynamicHeight:E}=i.useKeyboardHeight(),M=e=>{0==I.value.indexOf("@")&&1==I.value.length&&(x.value=!0)},F=e.ref(!1),P=()=>{F.value=!0},$=()=>{R(),""!=I.value.replace(/(^\s*)|(\s*$)/g,"")||0!=h.value.length?p.sendDisabled||(d("contentPost",I.value),e.nextTick$1((()=>{A()})),J(),I.value="",h.value=[],d("update:fileList",[])):e.index.$u.toast("输入为空")},B=()=>{d("close")},R=()=>{c.value||e.index.$u.route({url:"/pages/login/login"})},{proxy:G}=e.getCurrentInstance(),A=async()=>{await e.nextTick$1(),n.getRect(".content-box",!1,G).then((e=>{O.value=e.height}))},N=e=>{h.value.splice(e,1)},D=e.shallowRef(),J=()=>{var t,o;(null==(t=D.value)?void 0:t.blur)&&(null==(o=D.value)||o.blur()),e.index.hideKeyboard()},U=e.ref(0),H=async()=>{var e,o;if(!(null==(e=m.value)?void 0:e.model_id)){const e=g.value[0];m.value=e?JSON.parse(JSON.stringify(e)):{}}if(null==(o=m.value)?void 0:o.model_id){const e=await t.getUserChatConfig({model_id:m.value.model_id,model_sub_id:m.value.model_sub_id});Object.keys(e).forEach((t=>{e[t]=parseFloat(e[t])})),n.setFormData(e,z)}},K=e.ref([]),V=e.shallowRef(),Q=async(e,t)=>{var n,i;try{const{lists:i}=await o.getAgentList({page_no:e,page_size:t,source:1});null==(n=V.value)||n.complete(i)}catch(a){null==(i=V.value)||i.complete([])}};return e.watch((()=>f.getAiModelConfig),(e=>{e&&H()}),{deep:!0,immediate:!0}),e.onMounted((()=>{(async()=>{await e.nextTick$1();const{safeAreaInsets:t}=e.index.$u.sys();n.getRect(".chatBottomBox",!1,G).then((e=>{U.value=e.height+t.bottom+100}))})()})),e.onUnmounted((()=>{B()})),l({scrollToBottom:A,setUserInput:(e="")=>{I.value=e},getChatConfig:()=>({model_id:m.value.model_id||void 0,model_sub_id:m.value.model_sub_id||void 0,robot_id:j.id||void 0,...z}),setAgentConfig:e=>{n.setFormData(e,j)}}),(t,o)=>e.e({a:r.contentList.length},r.contentList.length?e.e({b:r.contentList.length},r.contentList.length?{c:e.f(r.contentList,((t,o,n)=>({a:"3224b9a9-0-"+n,b:e.p({type:t.type,avatar:t.form_avatar,content:1==t.type?t.message:t.reply,"reasoning-content":t.reasoning_content,"is-reasoning-finished":t.is_reasoning_finished,loading:t.loading,"consume-tokens":t.consume_tokens,"file-list":t.fileList,index:o,"is-markdown":2==t.type,showCopyBtn:2==t.type}),c:`${t.id} + ${o} + ''`})))}:{},{d:e.unref(O),e:0==e.unref(E)},0==e.unref(E)?{f:e.o((e=>{d("add-session")}))}:{}):{},{g:r.isCoze||r.isStaff?1:"",h:e.unref(m).id&&!e.unref(j).id&&!r.isCoze&&!r.isStaff},!e.unref(m).id||e.unref(j).id||r.isCoze||r.isStaff?{}:{i:e.t(e.unref(m).name),j:e.p({name:"arrow-down",size:"20",color:"#a8abb2"}),k:e.o((e=>w.value=!0))},{l:e.unref(j).id&&!r.isCoze&&!r.isStaff},!e.unref(j).id||r.isCoze||r.isStaff?{}:{m:e.unref(j).avatar,n:e.t(e.unref(j).name),o:e.p({name:"close",color:"#ffffff",size:14}),p:e.o(C),q:e.o((e=>x.value=!0))},{r:t.$slots.sendLeft&&!e.unref(F)},(t.$slots.sendLeft&&e.unref(F),{}),{s:e.unref(h).length},e.unref(h).length?{t:e.f(e.unref(h),((t,o,n)=>({a:e.o(N,o),b:"3224b9a9-3-"+n,c:e.p({item:t,index:o}),d:o})))}:{},{v:e.unref(F)?"120rpx":"0",w:r.placeholder,x:e.o(P),y:e.o((e=>F.value=!1)),z:e.o([t=>e.isRef(I)?I.value=t.detail.value:null,M]),A:e.unref(I),B:r.isStop},r.isStop?{C:e.p({name:"/static/images/icons/chat_stop.svg",size:36}),D:e.o(B)}:e.e({E:!e.unref(b)},e.unref(b)?{G:e.p({name:"/static/images/icons/arrow_up.svg",size:36})}:{F:e.p({name:"/static/images/icons/arrow_up_primary.svg",size:36})},{H:e.n(e.unref(b)?"bg-_hF2F2F2_":"bg-primary-light-9"),I:e.o($)}),{J:r.isCoze||r.isStaff?1:"",K:!r.isCoze&&!r.isStaff},r.isCoze||r.isStaff?{}:e.e({L:r.isNetwork},r.isNetwork?{M:e.p({name:"/static/images/icons/deep.svg",size:28}),N:e.unref(v)?1:"",O:e.o(_)}:{},{P:e.p({direction:"vertical",color:"#F1F1F2"}),Q:e.p({name:"/static/images/icons/note_book.svg",size:28}),R:e.o(y),S:e.p({name:"/static/images/icons/setting.svg",size:36}),T:e.o(S)}),{U:e.p({name:"/static/images/icons/tips.svg",size:32}),V:0==r.contentList.length?1:"",W:r.contentList.length||r.isCoze||r.isStaff?e.unref(E)+"px":e.unref(E)-e.unref(U)+"px",X:e.unref(z).context_num,Y:e.o((e=>L(e,"context_num",0))),Z:e.t(e.unref(z).context_num),aa:e.unref(z).top_p,ab:e.o((e=>L(e,"top_p",1))),ac:e.t(e.unref(z).top_p),ad:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{ae:e.unref(z).frequency_penalty,af:-2,ag:e.o((e=>L(e,"frequency_penalty",1))),ah:e.t(e.unref(z).frequency_penalty)}:{},{ai:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{aj:e.unref(z).presence_penalty,ak:e.o((e=>L(e,"presence_penalty",1))),al:e.t(e.unref(z).presence_penalty)}:{},{am:e.unref(z).temperature,an:e.unref(k),ao:e.o((e=>L(e,"temperature",1))),ap:e.t(e.unref(z).temperature),aq:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{ar:e.unref(z).top_logprobs,as:e.o((e=>L(e,"top_logprobs",1))),at:e.t(e.unref(z).top_logprobs)}:{},{av:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{aw:e.o((t=>e.unref(z).logprobs=t)),ax:e.p({"active-value":1,"inactive-value":0,size:"40",modelValue:e.unref(z).logprobs})}:{},{ay:e.o(T),az:e.p({type:"primary","custom-style":{height:"100rpx",fontSize:"28rpx"}}),aA:e.o((t=>e.isRef(q)?q.value=t:null)),aB:e.p({title:"参数设置",height:"85%","show-close-btn":!0,"custom-class":"bg-white","is-disabled-touch":!0,show:e.unref(q)}),aC:e.f(e.unref(g),((t,o,n)=>({a:t.logo,b:e.t(t.name),c:o,d:e.unref(m).id==t.id?1:"",e:e.o((e=>(e=>{m.value=JSON.parse(JSON.stringify(e)),w.value=!1,H()})(t)),o)}))),aD:e.o((t=>e.isRef(w)?w.value=t:null)),aE:e.p({title:"选择模型",height:"55%",show:e.unref(w)}),aF:e.f(e.unref(K),((t,o,i)=>({a:t.image,b:e.t(t.name),c:e.t(t.intro),d:e.unref(j).id==t.id?1:"",e:o,f:e.o((e=>(e=>{n.setFormData(e,j),I.value="",x.value=!1})(t)),o)}))),aG:e.sr(V,"3224b9a9-17,3224b9a9-16",{k:"agentPagingRef"}),aH:e.o(Q),aI:e.o((t=>e.isRef(K)?K.value=t:null)),aJ:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(K)}),aK:e.o((t=>e.isRef(x)?x.value=t:null)),aL:e.p({title:"选择智能体",height:"85%","show-close-btn":!0,"is-disabled-touch":!0,show:e.unref(x)})})}}),d=e._export_sfc(l,[["__scopeId","data-v-3224b9a9"]]);wx.createComponent(d);
