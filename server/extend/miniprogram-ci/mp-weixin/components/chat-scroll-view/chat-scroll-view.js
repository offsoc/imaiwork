"use strict";const e=require("../../common/vendor.js"),t=require("../../api/chat.js"),o=require("../../api/agent.js"),n=require("../../utils/util.js"),i=require("../../hooks/useKeyboardHeight.js"),s=require("../../stores/app.js"),a=require("../../enums/appEnums.js"),u=require("../../stores/user.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-switch")+e.resolveComponent("u-button")+e.resolveComponent("popup-bottom")+e.resolveComponent("empty")+e.resolveComponent("z-paging"))()}Math||((()=>"../chat-record-item/chat-record-item.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+r+(()=>"../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-switch/u-switch.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../popup-bottom/popup-bottom.js")+(()=>"../empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js"))();const r=()=>"./components/file-item.js",l=e.defineComponent({__name:"chat-scroll-view",props:{contentList:{default:()=>[]},fileList:{default:()=>[]},placeholder:{default:"在这里输入任何问题 ..."},sendDisabled:{type:Boolean,default:!1},tokens:{default:0},isStop:{type:Boolean},isNetwork:{type:Boolean,default:!0},isCoze:{type:Boolean,default:!1}},emits:["update:modelValue","contentPost","close","add-session","update:fileList","update:network"],setup(r,{expose:l,emit:d}){const p=r,c=s.useAppStore(),m=e.computed((()=>u.useUserStore().isLogin)),f=e.ref({id:"",name:"",model_id:"",model_sub_id:""}),g=e.computed((()=>{var e;return(null==(e=c.getAiModelConfig)?void 0:e.channel)||[]})),v=e.ref(!1),_=()=>{v.value=!v.value,d("update:network",v.value)},h=e.computed({get:()=>p.fileList,set(e){d("update:fileList",e)}}),b=e.computed((()=>{const e=0===h.value.length&&!O.value;return p.sendDisabled||e})),y=()=>{e.index.$u.route({url:"/packages/pages/choose_file/choose_file",params:{limit:1}})},w=e.ref(!1),x=e.ref(!1),j=e.reactive({id:"",name:"",avatar:""}),C=()=>{j.id="",j.name="",j.avatar=""},q=e.ref(!1),z=e.reactive({top_p:.5,temperature:1,presence_penalty:.1,frequency_penalty:2,context_num:3,top_logprobs:10,logprobs:0}),k=e.computed((()=>f.value.model_id==a.ModelIdEnum.GPT_4O?2:1)),L=(e,t,o)=>{let{value:n}=e.detail;0==o||Number.isInteger(n)?z[t]=n:z[t]=n.toFixed(o)},T=()=>{m.value?(U(),q.value=!0):e.index.$u.route({url:"/pages/login/login"})},I=async()=>{e.index.showLoading({title:"保存中...",mask:!0});try{await t.saveUserChatConfig({model_id:f.value.model_id,model_sub_id:f.value.model_sub_id,...z}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"none",duration:3e3}),q.value=!1}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"保存失败",icon:"none",duration:3e3})}};e.shallowRef();const O=e.ref(""),E=e.ref(0),{dynamicHeight:M}=i.useKeyboardHeight(),F=e=>{0==O.value.indexOf("@")&&1==O.value.length&&(x.value=!0)},P=e.ref(!1),$=()=>{P.value=!0},R=()=>{m?""!=O.value.replace(/(^\s*)|(\s*$)/g,"")||0!=h.value.length?p.sendDisabled||(d("contentPost",O.value),e.nextTick$1((()=>{G()})),D(),O.value="",h.value=[],d("update:fileList",[])):e.index.$u.toast("输入为空"):e.index.$u.route({url:"/pages/login/login"})},S=()=>{d("close")},{proxy:B}=e.getCurrentInstance(),G=async()=>{await e.nextTick$1(),n.getRect(".content-box",!1,B).then((e=>{E.value=e.height}))},A=e=>{h.value.splice(e,1)},N=e.shallowRef(),D=()=>{var t,o;(null==(t=N.value)?void 0:t.blur)&&(null==(o=N.value)||o.blur()),e.index.hideKeyboard()},J=e.ref(0),U=async()=>{var e,o;if(!(null==(e=f.value)?void 0:e.model_id)){const e=g.value[0];f.value=e?JSON.parse(JSON.stringify(e)):{}}if(null==(o=f.value)?void 0:o.model_id){const e=await t.getUserChatConfig({model_id:f.value.model_id,model_sub_id:f.value.model_sub_id});Object.keys(e).forEach((t=>{e[t]=parseFloat(e[t])})),n.setFormData(e,z)}},H=e.ref([]),K=e.shallowRef(),V=async(e,t)=>{var n;try{const{lists:i}=await o.getAgentList({page_no:e,page_size:t,source:1});null==(n=K.value)||n.complete(i)}catch(i){}};return e.watch((()=>c.getAiModelConfig),(e=>{e&&U()}),{deep:!0,immediate:!0}),e.onMounted((()=>{(async()=>{await e.nextTick$1();const{safeAreaInsets:t}=e.index.$u.sys();n.getRect(".chatBottomBox",!1,B).then((e=>{J.value=e.height+t.bottom+100}))})()})),e.onUnmounted((()=>{S()})),l({scrollToBottom:G,setUserInput:(e="")=>{O.value=e},getChatConfig:()=>({model_id:f.value.model_id||void 0,model_sub_id:f.value.model_sub_id||void 0,robot_id:j.id||void 0,...z}),setAgentConfig:e=>{n.setFormData(e,j)}}),(t,o)=>e.e({a:r.contentList.length},r.contentList.length?e.e({b:r.contentList.length},r.contentList.length?{c:e.f(r.contentList,((t,o,n)=>({a:"4e320cc1-0-"+n,b:e.p({type:t.type,avatar:t.form_avatar,content:1==t.type?t.message:t.reply,"reasoning-content":t.reasoning_content,"is-reasoning-finished":t.is_reasoning_finished,loading:t.loading,"consume-tokens":t.consume_tokens,"file-list":t.fileList,index:o,"is-markdown":2==t.type,showCopyBtn:2==t.type}),c:`${t.id} + ${o} + ''`})))}:{},{d:e.unref(E),e:e.o((e=>{d("add-session")}))}):{},{f:r.isCoze?1:"",g:e.unref(f).id&&!e.unref(j).id&&!r.isCoze},!e.unref(f).id||e.unref(j).id||r.isCoze?{}:{h:e.t(e.unref(f).name),i:e.p({name:"arrow-down",size:"20",color:"#a8abb2"}),j:e.o((e=>w.value=!0))},{k:e.unref(j).id&&!r.isCoze},e.unref(j).id&&!r.isCoze?{l:e.unref(j).avatar,m:e.t(e.unref(j).name),n:e.p({name:"close",color:"#ffffff",size:14}),o:e.o(C),p:e.o((e=>x.value=!0))}:{},{q:t.$slots.sendLeft&&!e.unref(P)},(t.$slots.sendLeft&&e.unref(P),{}),{r:e.unref(h).length},e.unref(h).length?{s:e.f(e.unref(h),((t,o,n)=>({a:e.o(A,o),b:"4e320cc1-3-"+n,c:e.p({item:t,index:o}),d:o})))}:{},{t:e.unref(P)?"120rpx":"0",v:r.placeholder,w:e.o($),x:e.o((e=>P.value=!1)),y:e.o([t=>e.isRef(O)?O.value=t.detail.value:null,F]),z:e.unref(O),A:r.isStop},r.isStop?{B:e.p({name:"/static/images/icons/chat_stop.svg",size:36}),C:e.o(S)}:e.e({D:!e.unref(b)},e.unref(b)?{F:e.p({name:"/static/images/icons/arrow_up.svg",size:36})}:{E:e.p({name:"/static/images/icons/arrow_up_primary.svg",size:36})},{G:e.n(e.unref(b)?"bg-_hF2F2F2_":"bg-primary-light-9"),H:e.o(R)}),{I:r.isCoze?1:"",J:!r.isCoze},r.isCoze?{}:e.e({K:r.isNetwork},r.isNetwork?{L:e.p({name:"/static/images/icons/deep.svg",size:28}),M:e.unref(v)?1:"",N:e.o(_)}:{},{O:e.p({direction:"vertical",color:"#F1F1F2"}),P:e.p({name:"/static/images/icons/note_book.svg",size:28}),Q:e.o(y),R:e.p({name:"/static/images/icons/setting.svg",size:36}),S:e.o(T)}),{T:e.p({name:"/static/images/icons/tips.svg",size:32}),U:0==r.contentList.length?1:"",V:r.contentList.length||r.isCoze?e.unref(M)+"px":e.unref(M)-e.unref(J)+"px",W:e.unref(z).context_num,X:e.o((e=>L(e,"context_num",0))),Y:e.t(e.unref(z).context_num),Z:e.unref(z).top_p,aa:e.o((e=>L(e,"top_p",1))),ab:e.t(e.unref(z).top_p),ac:e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O},e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O?{ad:e.unref(z).frequency_penalty,ae:-2,af:e.o((e=>L(e,"frequency_penalty",1))),ag:e.t(e.unref(z).frequency_penalty)}:{},{ah:e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O},e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O?{ai:e.unref(z).presence_penalty,aj:e.o((e=>L(e,"presence_penalty",1))),ak:e.t(e.unref(z).presence_penalty)}:{},{al:e.unref(z).temperature,am:e.unref(k),an:e.o((e=>L(e,"temperature",1))),ao:e.t(e.unref(z).temperature),ap:e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O},e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O?{aq:e.unref(z).top_logprobs,ar:e.o((e=>L(e,"top_logprobs",1))),as:e.t(e.unref(z).top_logprobs)}:{},{at:e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O},e.unref(f).model_id==e.unref(a.ModelIdEnum).GPT_4O?{av:e.o((t=>e.unref(z).logprobs=t)),aw:e.p({"active-value":1,"inactive-value":0,size:"40",modelValue:e.unref(z).logprobs})}:{},{ax:e.o(I),ay:e.p({type:"primary","custom-style":{height:"100rpx",fontSize:"28rpx"}}),az:e.o((t=>e.isRef(q)?q.value=t:null)),aA:e.p({title:"参数设置",height:"85%","show-close-btn":!0,"custom-class":"bg-white","is-disabled-touch":!0,show:e.unref(q)}),aB:e.f(e.unref(g),((t,o,n)=>({a:e.t(t.name),b:o,c:e.unref(f).id==t.id?1:"",d:e.o((e=>(e=>{f.value=JSON.parse(JSON.stringify(e)),w.value=!1,U()})(t)),o)}))),aC:e.o((t=>e.isRef(w)?w.value=t:null)),aD:e.p({title:"选择模型",height:"55%",show:e.unref(w)}),aE:e.f(e.unref(H),((t,o,i)=>({a:t.avatar,b:e.t(t.name),c:e.t(t.intro),d:e.unref(j).id==t.id?1:"",e:o,f:e.o((e=>(e=>{n.setFormData(e,j),O.value="",x.value=!1})(t)),o)}))),aF:e.sr(K,"4e320cc1-17,4e320cc1-16",{k:"agentPagingRef"}),aG:e.o(V),aH:e.o((t=>e.isRef(H)?H.value=t:null)),aI:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(H)}),aJ:e.o((t=>e.isRef(x)?x.value=t:null)),aK:e.p({title:"选择智能体",height:"85%","show-close-btn":!0,"is-disabled-touch":!0,show:e.unref(x)})})}}),d=e._export_sfc(l,[["__scopeId","data-v-4e320cc1"]]);wx.createComponent(d);
