"use strict";const e=require("../../common/vendor.js"),t=require("../../api/chat.js"),o=require("../../api/agent.js"),n=require("../../utils/util.js"),i=require("../../hooks/useKeyboardHeight.js"),a=require("../../stores/app.js"),s=require("../../enums/appEnums.js"),u=require("../../stores/user.js");if(require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),require("../../api/user.js"),require("../../hooks/useShareMessage.js"),!Array){(e.resolveComponent("chat-record-item")+e.resolveComponent("u-icon")+e.resolveComponent("u-line")+e.resolveComponent("u-switch")+e.resolveComponent("u-button")+e.resolveComponent("popup-bottom")+e.resolveComponent("empty")+e.resolveComponent("z-paging"))()}Math||((()=>"../chat-record-item/chat-record-item.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+r+(()=>"../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-switch/u-switch.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-button/u-button.js")+(()=>"../popup-bottom/popup-bottom.js")+(()=>"../empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js"))();const r=()=>"./components/file-item.js",l=e.defineComponent({__name:"chat-scroll-view",props:{contentList:{default:()=>[]},fileList:{default:()=>[]},placeholder:{default:"在这里输入任何问题 ..."},sendDisabled:{type:Boolean,default:!1},tokens:{default:0},isStop:{type:Boolean},isNetwork:{type:Boolean,default:!0},isCoze:{type:Boolean,default:!1},isStaff:{type:Boolean,default:!1}},emits:["update:modelValue","contentPost","close","add-session","update:fileList","update:network"],setup(r,{expose:l,emit:d}){const f=r,p=a.useAppStore(),c=e.computed((()=>u.useUserStore().isLogin)),m=e.ref({id:"",name:"",model_id:"",model_sub_id:""}),g=e.computed((()=>{var e;return((null==(e=p.getAiModelConfig)?void 0:e.channel)||[]).filter((e=>"1"==e.status))})),v=e.ref(!1),_=()=>{c.value?(v.value=!v.value,d("update:network",v.value)):e.index.$u.route({url:"/pages/login/login"})},h=e.computed({get:()=>f.fileList,set(e){d("update:fileList",e)}}),y=e.computed((()=>{const e=0===h.value.length&&!I.value;return f.sendDisabled||e})),b=()=>{R(),e.index.$u.route({url:"/packages/pages/choose_file/choose_file",params:{limit:1}})},w=e.ref(!1),x=e.ref(!1),j=e.reactive({id:"",name:"",avatar:""}),C=()=>{j.id="",j.name="",j.avatar=""},q=e.ref(!1),z=e.reactive({top_p:.5,temperature:1,presence_penalty:.1,frequency_penalty:2,context_num:3,top_logprobs:10,logprobs:0}),k=e.computed((()=>m.value.model_id==s.ModelIdEnum.GPT_4O?2:1)),L=(e,t,o)=>{let{value:n}=e.detail;0==o||Number.isInteger(n)?z[t]=n:z[t]=n.toFixed(o)},S=()=>{R(),H(),q.value=!0},T=async()=>{e.index.showLoading({title:"保存中...",mask:!0});try{await t.saveUserChatConfig({model_id:m.value.model_id,model_sub_id:m.value.model_sub_id,...z}),e.index.hideLoading(),e.index.showToast({title:"保存成功",icon:"none",duration:3e3}),q.value=!1}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"保存失败",icon:"none",duration:3e3})}};e.shallowRef();const I=e.ref(""),M=e.ref(0),{dynamicHeight:O}=i.useKeyboardHeight(),E=e=>{0==I.value.indexOf("@")&&1==I.value.length&&(x.value=!0)},F=e.ref(!1),P=()=>{F.value=!0},$=()=>{R(),""!=I.value.replace(/(^\s*)|(\s*$)/g,"")||0!=h.value.length?f.sendDisabled||(d("contentPost",I.value),e.nextTick$1((()=>{A()})),J(),I.value="",h.value=[],d("update:fileList",[])):e.index.$u.toast("输入为空")},B=()=>{d("close")},R=()=>{c.value||e.index.$u.route({url:"/pages/login/login"})},{proxy:G}=e.getCurrentInstance(),A=async()=>{await e.nextTick$1(),n.getRect(".content-box",!1,G).then((e=>{M.value=e.height}))},N=e=>{h.value.splice(e,1)},D=e.shallowRef(),J=()=>{var t,o;(null==(t=D.value)?void 0:t.blur)&&(null==(o=D.value)||o.blur()),e.index.hideKeyboard()},U=e.ref(0),H=async()=>{var e,o;if(!(null==(e=m.value)?void 0:e.model_id)){const e=g.value[0];m.value=e?JSON.parse(JSON.stringify(e)):{}}if(null==(o=m.value)?void 0:o.model_id){const e=await t.getUserChatConfig({model_id:m.value.model_id,model_sub_id:m.value.model_sub_id});Object.keys(e).forEach((t=>{e[t]=parseFloat(e[t])})),n.setFormData(e,z)}},K=e.ref([]),V=e.shallowRef(),Q=async(e,t)=>{var n,i;try{const{lists:i}=await o.getAgentList({page_no:e,page_size:t,source:1});null==(n=V.value)||n.complete(i)}catch(a){null==(i=V.value)||i.complete([])}};return e.watch((()=>p.getAiModelConfig),(e=>{e&&H()}),{deep:!0,immediate:!0}),e.onMounted((()=>{(async()=>{await e.nextTick$1();const{safeAreaInsets:t}=e.index.$u.sys();n.getRect(".chatBottomBox",!1,G).then((e=>{U.value=e.height+t.bottom+100}))})()})),e.onUnmounted((()=>{B()})),l({scrollToBottom:A,setUserInput:(e="")=>{I.value=e},getChatConfig:()=>({model_id:m.value.model_id||void 0,model_sub_id:m.value.model_sub_id||void 0,robot_id:j.id||void 0,...z}),setAgentConfig:e=>{n.setFormData(e,j)}}),(t,o)=>e.e({a:r.contentList.length},r.contentList.length?e.e({b:r.contentList.length},r.contentList.length?{c:e.f(r.contentList,((t,o,n)=>({a:"089299d3-0-"+n,b:e.p({type:t.type,avatar:t.form_avatar,content:1==t.type?t.message:t.reply,"reasoning-content":t.reasoning_content,"is-reasoning-finished":t.is_reasoning_finished,loading:t.loading,"consume-tokens":t.consume_tokens,"file-list":t.fileList,index:o,"is-markdown":2==t.type,showCopyBtn:2==t.type}),c:`${t.id} + ${o} + ''`})))}:{},{d:e.unref(M),e:0==e.unref(O)},0==e.unref(O)?{f:e.o((e=>{d("add-session")}))}:{}):{},{g:r.isCoze||r.isStaff?1:"",h:e.unref(m).id&&!e.unref(j).id&&!r.isCoze&&!r.isStaff},!e.unref(m).id||e.unref(j).id||r.isCoze||r.isStaff?{}:{i:e.unref(m).logo,j:e.t(e.unref(m).name),k:e.p({name:"arrow-down",size:"20",color:"#a8abb2"}),l:e.o((e=>w.value=!0))},{m:e.unref(j).id&&!r.isCoze&&!r.isStaff},!e.unref(j).id||r.isCoze||r.isStaff?{}:{n:e.unref(j).avatar,o:e.t(e.unref(j).name),p:e.p({name:"close",color:"#ffffff",size:14}),q:e.o(C),r:e.o((e=>x.value=!0))},{s:t.$slots.sendLeft&&!e.unref(F)},(t.$slots.sendLeft&&e.unref(F),{}),{t:e.unref(h).length},e.unref(h).length?{v:e.f(e.unref(h),((t,o,n)=>({a:e.o(N,o),b:"089299d3-3-"+n,c:e.p({item:t,index:o}),d:o})))}:{},{w:e.unref(F)?"120rpx":"0",x:r.placeholder,y:e.o(P),z:e.o((e=>F.value=!1)),A:e.o([t=>e.isRef(I)?I.value=t.detail.value:null,E]),B:e.unref(I),C:r.isStop},r.isStop?{D:e.p({name:"/static/images/icons/chat_stop.svg",size:36}),E:e.o(B)}:e.e({F:!e.unref(y)},e.unref(y)?{H:e.p({name:"/static/images/icons/arrow_up.svg",size:36})}:{G:e.p({name:"/static/images/icons/arrow_up_primary.svg",size:36})},{I:e.n(e.unref(y)?"bg-_hF2F2F2_":"bg-primary-light-9"),J:e.o($)}),{K:r.isCoze||r.isStaff?1:"",L:!r.isCoze&&!r.isStaff},r.isCoze||r.isStaff?{}:e.e({M:r.isNetwork},r.isNetwork?{N:e.p({name:"/static/images/icons/deep.svg",size:28}),O:e.unref(v)?1:"",P:e.o(_)}:{},{Q:e.p({direction:"vertical",color:"#F1F1F2"}),R:e.p({name:"/static/images/icons/note_book.svg",size:28}),S:e.o(b),T:e.p({name:"/static/images/icons/setting.svg",size:36}),U:e.o(S)}),{V:e.p({name:"/static/images/icons/tips.svg",size:32}),W:0==r.contentList.length?1:"",X:r.contentList.length||r.isCoze||r.isStaff?e.unref(O)+"px":e.unref(O)-e.unref(U)+"px",Y:e.unref(z).context_num,Z:e.o((e=>L(e,"context_num",0))),aa:e.t(e.unref(z).context_num),ab:e.unref(z).top_p,ac:e.o((e=>L(e,"top_p",1))),ad:e.t(e.unref(z).top_p),ae:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{af:e.unref(z).frequency_penalty,ag:-2,ah:e.o((e=>L(e,"frequency_penalty",1))),ai:e.t(e.unref(z).frequency_penalty)}:{},{aj:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{ak:e.unref(z).presence_penalty,al:e.o((e=>L(e,"presence_penalty",1))),am:e.t(e.unref(z).presence_penalty)}:{},{an:e.unref(z).temperature,ao:e.unref(k),ap:e.o((e=>L(e,"temperature",1))),aq:e.t(e.unref(z).temperature),ar:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{as:e.unref(z).top_logprobs,at:e.o((e=>L(e,"top_logprobs",1))),av:e.t(e.unref(z).top_logprobs)}:{},{aw:e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O},e.unref(m).model_id==e.unref(s.ModelIdEnum).GPT_4O?{ax:e.o((t=>e.unref(z).logprobs=t)),ay:e.p({"active-value":1,"inactive-value":0,size:"40",modelValue:e.unref(z).logprobs})}:{},{az:e.o(T),aA:e.p({type:"primary","custom-style":{height:"100rpx",fontSize:"28rpx"}}),aB:e.o((t=>e.isRef(q)?q.value=t:null)),aC:e.p({title:"参数设置",height:"85%","show-close-btn":!0,"custom-class":"bg-white","is-disabled-touch":!0,show:e.unref(q)}),aD:e.f(e.unref(g),((t,o,n)=>({a:t.logo,b:e.t(t.name),c:o,d:e.unref(m).id==t.id?1:"",e:e.o((e=>(e=>{m.value=JSON.parse(JSON.stringify(e)),w.value=!1,H()})(t)),o)}))),aE:e.o((t=>e.isRef(w)?w.value=t:null)),aF:e.p({title:"选择模型",height:"55%",show:e.unref(w)}),aG:e.f(e.unref(K),((t,o,i)=>({a:t.image,b:e.t(t.name),c:e.t(t.intro),d:e.unref(j).id==t.id?1:"",e:o,f:e.o((e=>(e=>{n.setFormData(e,j),I.value="",x.value=!1})(t)),o)}))),aH:e.sr(V,"089299d3-17,089299d3-16",{k:"agentPagingRef"}),aI:e.o(Q),aJ:e.o((t=>e.isRef(K)?K.value=t:null)),aK:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(K)}),aL:e.o((t=>e.isRef(x)?x.value=t:null)),aM:e.p({title:"选择智能体",height:"85%","show-close-btn":!0,"is-disabled-touch":!0,show:e.unref(x)})})}}),d=e._export_sfc(l,[["__scopeId","data-v-089299d3"]]);wx.createComponent(d);
