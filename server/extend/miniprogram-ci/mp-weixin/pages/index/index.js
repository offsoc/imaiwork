"use strict";const e=require("../../common/vendor.js"),o=require("../../stores/user.js"),n=require("../../stores/app.js"),t=require("../../api/chat.js"),a=require("../../enums/appEnums.js");if(require("../../api/user.js"),require("../../utils/request/index.js"),require("../../utils/request/http.js"),require("../../enums/requestEnums.js"),require("../../utils/request/cancel.js"),require("../../utils/auth.js"),require("../../enums/constantEnums.js"),require("../../utils/cache.js"),require("../../router/index.js"),require("../../config/index.js"),require("../../hooks/useShareMessage.js"),require("../../utils/util.js"),require("../../stores/navigationBarTitle.js"),require("../../api/app.js"),require("../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("tabbar")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../components/tabbar/tabbar.js")+(()=>"../../components/empty/empty.js")+(()=>"../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../components/popup-bottom/popup-bottom.js")+(()=>"../../components/recharge-popup/recharge-popup.js"))();const s=e.defineComponent({__name:"index",setup(s){var r;const i=n.useAppStore(),u=o.useUserStore(),{chatConfig:l}=e.toRefs(i),c=e.computed((()=>i.getWebsiteConfig)),{userTokens:p,isLogin:v}=e.toRefs(u),f=null==(r=u.getTokenByScene(a.TokensSceneEnum.CHAT))?void 0:r.score,g=e.ref(),m=e.shallowRef(),d=e.shallowRef(),h=e.ref(50),_=e.ref(!1),b=e.ref(!1),j=e.ref(!1),k=e.ref(!1),q=e.ref([]),y=e.ref([]),w=e.ref(""),C=e.ref([]);let x=null;const T=e.reactive({page_no:1,page_size:1500,assistant_id:0}),R=e=>{_.value=e},A=async(e,o)=>{var n,a;try{const{lists:a}=await t.getCreativeRecord({page_no:e,page_size:o,scene_id:0,type:1});null==(n=d.value)||n.complete(a)}catch(s){null==(a=d.value)||a.complete([])}},S=async()=>{try{const o=await t.getChatLog({...T,task_id:w.value}),n=null==o?void 0:o.map((e=>1===e.type?{...e,fileList:(null==e?void 0:e.file_info)?Array.isArray(e.file_info)?e.file_info:[e.file_info]:[]}:{...e,is_reasoning_finished:!0,consume_tokens:e.tokens_info}));y.value=n,console.log("chatContentList",y.value),await e.nextTick$1(),m.value.scrollToBottom()}catch(o){console.error("获取聊天记录失败:",o)}},$=async(o,n=!1)=>{var a,s,r;if(p.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(a=g.value)||a.open());if(j.value)return;n||y.value.push({type:1,message:o,fileList:q.value});const i=e.reactive({type:2,loading:!0,reply:"",reasoning_content:"",consume_tokens:{}});y.value.push(i),j.value=!0;try{await t.chatSendTextStream({message:o,task_id:w.value,open_reasoning:0,is_network_search:_.value?1:0,file_info:q.value[0],...(null==(r=null==(s=m.value)?void 0:s.getChatConfig)?void 0:r.call(s))||{}},{onstart(e){x=e,k.value=!0},onmessage(e){z(e,i)},onclose(){B(i)}})}catch(u){L(u,i)}e.nextTick$1((()=>m.value.scrollToBottom()))},z=(e,o)=>{e.trim().split("data:").forEach((e=>{if(e)try{const{object:n,content:t,task_id:a,usage:s,reasoning_content:r}=JSON.parse(e);if((t||r)&&"loading"===n&&(r?o.reasoning_content+=r:o.reply+=t),"finished"===n)return o.loading=!1,o.consume_tokens=s,void(w.value||(w.value=a));m.value.scrollToBottom()}catch(n){console.error("解析流式消息失败:",n)}}))},B=e=>{e.loading=!1,F(),u.getUser(),setTimeout((()=>m.value.scrollToBottom()),600)},L=(o,n)=>{n.reply=600004===o.errno?"用户已停止内容生成":o||"发生错误",600004!==o.errno&&e.index.$u.toast(o),n.loading=!1,F()},E=()=>{w.value?(w.value="",y.value=[],F(),P(),$(l.value.new_chat_prompt,!0)):e.index.$u.toast("当前会话已经是最新的了")},F=()=>{q.value=[],j.value=!1,k.value=!1},M=()=>{y.value=[],F(),P()},P=()=>{null==x||x.abort(),j.value=!1,k.value=!1};return e.onMounted((()=>{const{safeArea:o}=e.index.$u.sys();h.value=o.top})),e.onLoad((o=>{(null==o?void 0:o.task_id)&&(w.value=o.task_id,S()),(async o=>{var n;await e.nextTick$1(),(null==o?void 0:o.agent_name)&&(null==(n=m.value)||n.setAgentConfig({name:o.agent_name,id:o.agent_id,avatar:o.agent_logo}))})(o),e.index.$on("chooseFile",(e=>{q.value=e}))})),e.onShow((()=>{i.getChatConfig()})),(o,n)=>e.e({a:e.p({name:"arrow-left",size:32}),b:0==e.unref(y).length?1:"",c:e.p({"border-bottom":!1,"is-fixed":!1,"is-back":e.unref(y).length>0,background:{background:"transparent"},"is-custom-back-icon":!0,"custom-back":M}),d:0==e.unref(y).length},0==e.unref(y).length?{e:e.unref(c).shop_logo}:{},{f:e.sr(m,"66e90c04-2",{k:"chattingRef"}),g:e.o(P),h:e.o(E),i:e.o(R),j:e.o($),k:e.o((o=>e.isRef(q)?q.value=o:null)),l:e.p({"is-stop":e.unref(k),"content-list":e.unref(y),"send-disabled":e.unref(j),tokens:e.unref(f),"file-list":e.unref(q)}),m:0==e.unref(y).length},0==e.unref(y).length?{n:e.o((e=>b.value=!0))}:{},{o:0===e.unref(y).length},(e.unref(y).length,{}),{p:e.f(e.unref(C),((o,n,t)=>({a:e.t(o.create_time),b:e.t(o.message||o.file_info.name),c:n,d:e.o((e=>(async e=>{var o;const{robot_id:n,avatar:t,robot_name:a,task_id:s}=e;null==(o=m.value)||o.setAgentConfig({id:n,avatar:t,name:a}),w.value=s,await S(),b.value=!1})(o)),n)}))),q:e.sr(d,"66e90c04-5,66e90c04-4",{k:"pagingRef"}),r:e.o(A),s:e.o((o=>e.isRef(C)?C.value=o:null)),t:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(C)}),v:e.o((o=>e.isRef(b)?b.value=o:null)),w:e.p({title:"历史记录","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(b)}),x:e.sr(g,"66e90c04-7",{k:"rechargePopupRef"})})}});wx.createPage(s);
