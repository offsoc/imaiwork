"use strict";const e=require("../common/vendor.js"),l=require("../ai_modules/digital_human/common/vendor.js");exports.useRecorder=(a,n)=>{n=n||{type:"mp3",sampleRate:16e3,bitRate:32,duration:3e5,numberOfChannels:1,encodeBitRate:64e3,format:"mp3",frameSize:1200};const o=e.ref(!1),r=e.shallowRef(),t=()=>{var e,l,a,n,o,t,u,c,v,i,s;r.value&&(null==(e=r.value)||e.stop()),null==(a=null==(l=r.value)?void 0:l.offStart)||a.call(l),null==(o=null==(n=r.value)?void 0:n.offStop)||o.call(n),null==(u=null==(t=r.value)?void 0:t.offError)||u.call(t),null==(v=null==(c=r.value)?void 0:c.offInterruptionEnd)||v.call(c),null==(s=null==(i=r.value)?void 0:i.onFrameRecorded)||s.call(i)},u=()=>{var e,l;null==(l=null==(e=r.value)?void 0:e.close)||l.call(e,(()=>{o.value=!1})),r.value=null};return e.onBeforeUnmount((()=>{t(),u()})),{isRecording:o,mediaRecorder:r,start:async()=>{var t;try{r.value||(r.value=e.index.getRecorderManager()),r.value.start(n),o.value=!0,null==(t=null==a?void 0:a.onstart)||t.call(a),r.value.onStart((()=>{var e;o.value=!0,null==(e=null==a?void 0:a.onstart)||e.call(a)})),r.value.onStop((e=>{var l;o.value=!1,null==(l=null==a?void 0:a.onstop)||l.call(a,e)})),r.value.onError((e=>{var l;o.value=!1,null==(l=null==a?void 0:a.onerror)||l.call(a,e)})),r.value.onInterruptionEnd((()=>{o.value=!0,r.value.resume()})),r.value.onFrameRecorded((async({frameBuffer:e})=>{var o;const r=l.jsMp3.newDecoder(e);if(null!=r){const e=r.decode(),l=new Int16Array(e),t=l.length;let u=0;for(let a=0;a<t;a++)u+=Math.abs(l[a]);let c=500*u/(16383*t);c>=100&&(c=100),c<=5&&(c=1),c=parseInt(String(c)),null==(o=null==a?void 0:a.ondata)||o.call(a,{pcmData:l,powerLevel:c,sampleRate:null==n?void 0:n.sampleRate})}}))}catch(u){return console.log(u),Promise.reject(u)}},authorize:()=>new Promise((async(l,a)=>{try{await e.index.authorize({scope:"scope.record"}),l()}catch(n){if((await e.index.showModal({title:"开启麦克风权限",content:"为了正常使用语音输入功能，请开启麦克风权限",confirmText:"去设置"})).confirm){const{authSetting:a}=await e.index.openSetting();if(a["scope.record"])return l()}a("无法录音：用户拒绝了麦克风权限")}})),stop:t,close:u,resume:()=>{var e;null==(e=r.value)||e.resume()}}};
