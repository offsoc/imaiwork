"use strict";const e=require("../common/vendor.js");exports.useRecorder=(l,a)=>{a=a||{type:"mp3",sampleRate:16e3,bitRate:32,duration:3e5,numberOfChannels:1,encodeBitRate:64e3,format:"mp3",frameSize:1200};const n=e.ref(!1),o=e.shallowRef(),r=()=>{var e,l,a,n,r,t,u,c,v,i,s;o.value&&(null==(e=o.value)||e.stop()),null==(a=null==(l=o.value)?void 0:l.offStart)||a.call(l),null==(r=null==(n=o.value)?void 0:n.offStop)||r.call(n),null==(u=null==(t=o.value)?void 0:t.offError)||u.call(t),null==(v=null==(c=o.value)?void 0:c.offInterruptionEnd)||v.call(c),null==(s=null==(i=o.value)?void 0:i.onFrameRecorded)||s.call(i)},t=()=>{var e,l;null==(l=null==(e=o.value)?void 0:e.close)||l.call(e,(()=>{n.value=!1})),o.value=null};return e.onBeforeUnmount((()=>{r(),t()})),{isRecording:n,mediaRecorder:o,start:async()=>{var r;try{o.value||(o.value=e.index.getRecorderManager()),o.value.start(a),n.value=!0,null==(r=null==l?void 0:l.onstart)||r.call(l),o.value.onStart((()=>{var e;n.value=!0,null==(e=null==l?void 0:l.onstart)||e.call(l)})),o.value.onStop((e=>{var a;n.value=!1,null==(a=null==l?void 0:l.onstop)||a.call(l,e)})),o.value.onError((e=>{var a;n.value=!1,null==(a=null==l?void 0:l.onerror)||a.call(l,e)})),o.value.onInterruptionEnd((()=>{n.value=!0,o.value.resume()})),o.value.onFrameRecorded((async({frameBuffer:n})=>{var o;const r=e.jsMp3.newDecoder(n);if(null!=r){const e=r.decode(),n=new Int16Array(e),t=n.length;let u=0;for(let l=0;l<t;l++)u+=Math.abs(n[l]);let c=500*u/(16383*t);c>=100&&(c=100),c<=5&&(c=1),c=parseInt(String(c)),null==(o=null==l?void 0:l.ondata)||o.call(l,{pcmData:n,powerLevel:c,sampleRate:null==a?void 0:a.sampleRate})}}))}catch(t){return console.log(t),Promise.reject(t)}},authorize:()=>new Promise((async(l,a)=>{try{await e.index.authorize({scope:"scope.record"}),l()}catch(n){if((await e.index.showModal({title:"开启麦克风权限",content:"为了正常使用语音输入功能，请开启麦克风权限",confirmText:"去设置"})).confirm){const{authSetting:a}=await e.index.openSetting();if(a["scope.record"])return l()}a("无法录音：用户拒绝了麦克风权限")}})),stop:r,close:t,resume:()=>{var e;null==(e=o.value)||e.resume()}}};
