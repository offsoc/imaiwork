"use strict";const e=require("../common/vendor.js"),a=require("../enums/appEnums.js");exports.useWebSocket=function(n,l={}){const r=e.ref(null),t=e.ref(!1),o=e.ref(0),{maxRetries:u=5,retryBaseDelay:s=1e3,heartbeatInterval:c=3e4,heartbeatMessage:v={type:"ping"},manualHeartbeat:m=!1,manual:d=!1}=l,i=new Map;let p=null,C=null;const E=()=>{r.value||(r.value=e.index.connectSocket({url:n,success:()=>{}}),r.value.onOpen((()=>{t.value=!0,o.value=0,g(),R("open")})),r.value.onMessage((e=>{try{const a=JSON.parse(e.data);R("message",a),y()}catch(n){R("error",{error:"消息解析失败",code:a.DeviceCmdCodeEnum.PARSE_ERROR})}})),r.value.onClose((()=>{t.value=!1,b(),o.value<u&&O(),R("close")})),r.value.onError((()=>{t.value=!1,R("error",{error:"连接失败",code:a.DeviceCmdCodeEnum.CONNECT_ERROR})})))},R=(e,a)=>{const n=i.get(e);n&&n(a)},g=()=>{C=setInterval((()=>{t.value&&(m?R("heartbeat"):f(v))}),c)},y=()=>{C&&(clearInterval(C),g())},O=()=>{const e=s*Math.pow(2,o.value);o.value+=1,p=setTimeout((()=>{o.value<=u&&E()}),e)},b=()=>{C&&clearInterval(C),p&&clearTimeout(p),C=null,p=null},f=e=>{var a;t.value&&(null==(a=r.value)||a.send({data:JSON.stringify(e)}))},h=(e,a)=>{r.value&&(r.value.close({code:e,reason:a}),b(),r.value=null)};return d||E(),e.onUnmounted((()=>{h(1e3,"Component unmounted"),i.clear()})),{socket:r,isConnected:t,retryCount:o,send:f,close:h,on:(e,a)=>{i.set(e,a)},reconnect:E}};
