"use strict";const e=require("../../../common/vendor.js"),n=require("../../../api/robot.js"),s=require("../../../stores/user.js"),i=require("../../../api/chat.js"),o=require("../../../enums/appEnums.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../utils/util.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../components/chat-scroll-view/chat-scroll-view.js")+r+(()=>"../../../components/recharge-popup/recharge-popup.js"))();const r=()=>"./components/sidebar.js",a=e.defineComponent({__name:"robot_chat",setup(r){var a;const t=e.shallowRef(),u=s.useUserStore(),{userTokens:l,isLogin:c}=e.toRefs(u),d=null==(a=u.getTokenByScene(o.TokensSceneEnum.SCENE_CHAT))?void 0:a.score,v=e.ref(),p=e.reactive({id:"",name:"",logo:"",form_info:"",description:"",template_info:{},preliminary_ask:[],assistants_id:""}),m=()=>{e.index.navigateBack()},f=e=>{const{type:n,data:s}=e;n==o.KnbTypeEnum.RAG?(q.indexid=s.index_id,q.rerank_min_score=s.rerank_min_score):n==o.KnbTypeEnum.VECTOR&&(q.kb_id=s.id,q.indexid=void 0,q.rerank_min_score=void 0)},g=e.shallowRef(),_=e.ref(!1),h=e.ref(!1),k=e.ref([]),j=e.ref(""),b=e.ref([]),y=e.reactive({page_no:1,page_size:1500}),q=e.reactive({indexid:"",rerank_min_score:""}),x=e=>{b.value=e.file||[],w()};let T=null;const w=async(n,s=!1)=>{var o,r;if(!c.value)return void e.index.$u.route({url:"/pages/login/login"});if(l.value<=0)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=v.value)||o.open());if(_.value)return;_.value=!0,s||k.value.push({type:1,message:n,fileLists:b.value});const a=e.reactive({type:2,loading:!0,reply:"",is_reasoning_finished:!1,reasoning_content:"",consume_tokens:{},error:""});k.value.push(a);try{await i.chatRobotSendTextStream({message:n||"",message_ext:JSON.stringify(null==(r=t.value)?void 0:r.formData),assistant_id:p.id,...q},{onstart(e){T=e,h.value=!0},onmessage(e){e.trim().split("data:").forEach(((e,n)=>{if(""!==e)try{const n=JSON.parse(e),{object:s,content:i,task_id:o,reasoning_content:r,usage:t}=n;if((i||r)&&"loading"===s&&(r?(a.is_reasoning_finished=!1,a.reasoning_content+=r):(a.is_reasoning_finished=!0,a.reply+=i)),"finished"===s)return a.loading=!1,a.consume_tokens={...t},void(j.value||(j.value=o));g.value.scrollToBottom()}catch(s){}}))},onclose(){a.loading=!1,R(),u.getUser(),setTimeout((async()=>{g.value.scrollToBottom()}),600)}})}catch(d){600004==d.errno?a.reply="用户已停止内容生成":(a.reply=d||"发生错误",e.index.$u.toast(d)),a.loading=!1,R()}e.nextTick$1((()=>{g.value.scrollToBottom()}))},E=async()=>{var n;_.value?e.index.$u.toast("当前有内容生成，请稍后再试"):null==(n=t.value)||n.open()},C=()=>{j.value?(j.value="",k.value=[],R(),w("你好",!0)):e.index.$u.toast("当前会话已经是最新的了")},R=()=>{b.value=[],_.value=!1,h.value=!1},S=()=>{null==T||T.abort(),_.value=!1,h.value=!1},B=e.computed((()=>{var e;return(null==(e=p.template_info)?void 0:e.form)||[]})),L=async()=>{try{await(async()=>{const e=await n.robotDetail({assistant_id:p.id});Object.keys(p).forEach((n=>{p[n]=e[n]}))})(),j.value&&(e.index.showLoading({title:"加载中"}),await(async()=>{try{const e=await i.getChatLog({...y,assistant_id:p.id,task_id:j.value}),n=null==e?void 0:e.map((e=>1==e.type?{...e}:{...e,consume_tokens:e.tokens_info||{}}));k.value=n}catch(e){}})(),setTimeout((()=>{var e;null==(e=g.value)||e.scrollToBottom()}),500),e.index.hideLoading()),E()}catch(s){e.index.hideLoading()}};return e.onLoad((({id:e,task_id:n})=>{p.id=e,j.value=n,L()})),(n,s)=>e.e({a:e.p({name:"/static/images/icons/back_black.svg",size:"32"}),b:e.o(m),c:e.unref(p).logo,d:e.t(e.unref(p).name),e:e.t(e.unref(p).description),f:e.p({"border-bottom":!1,"is-fixed":!1,"is-custom-back-icon":!0,background:{background:"transparent"}}),g:0==e.unref(k).length},0==e.unref(k).length?e.e({h:e.unref(p).logo},e.unref(p).logo?{i:e.unref(p).logo}:{},{j:e.t(e.unref(p).name),k:e.t(e.unref(p).description),l:e.f(e.unref(p).preliminary_ask,((n,s,i)=>e.e({a:n.value},n.value?{b:e.t(n.value),c:e.o((e=>w(n.value)),s)}:{},{d:s})))}):{},{m:e.p({name:"/static/images/icons/msg3.svg",size:58}),n:e.o(E),o:e.sr(g,"5d15bf44-2",{k:"chattingRef"}),p:e.o(S),q:e.o(C),r:e.o(w),s:e.o(f),t:e.p({"is-staff":!0,"is-stop":e.unref(h),"content-list":e.unref(k),"send-disabled":e.unref(_),tokens:e.unref(d)}),v:e.sr(t,"5d15bf44-4",{k:"sidebarRef"}),w:e.o(x),x:e.p({"form-list":e.unref(B),title:e.unref(p).name}),y:e.sr(v,"5d15bf44-5",{k:"rechargePopupRef"})})}});wx.createPage(a);
