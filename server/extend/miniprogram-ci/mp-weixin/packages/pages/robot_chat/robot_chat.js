"use strict";const e=require("../../../common/vendor.js"),t=require("../../../api/agent.js"),n=require("../../../stores/user.js"),o=require("../../../enums/appEnums.js"),a=require("../../../hooks/useLockFn.js"),i=require("../../../hooks/usePolling.js"),r=require("../../../utils/util.js"),s=require("../../../hooks/useCopy.js"),u=require("../../../utils/request/cancel.js"),l=require("../../../enums/requestEnums.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/chat.js"),require("../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("u-input")+e.resolveComponent("file-upload")+e.resolveComponent("u-line")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/file-upload/file-upload.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../components/empty/empty.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../components/recharge-popup/recharge-popup.js"))();const c=e.defineComponent({__name:"robot_chat",setup(c){var d;const p=n.useUserStore(),{userTokens:v,isLogin:f}=e.toRefs(p),m=null==(d=p.getTokenByScene(o.TokensSceneEnum.SCENE_CHAT))?void 0:d.score,g=e.ref(),h=e.shallowRef(),y=e.ref(),w=e.reactive({id:"",name:"",avatar:"",introduced:"",coze_id:"",stream:"",inputs:"",outputs:""}),_=e.ref({}),b=e.ref({}),k=e.computed((()=>1==w.stream)),j=e.computed((()=>{if(!w.inputs)return[];try{const e=JSON.parse(w.inputs);return e.forEach((e=>{_.value[e.fields]=e.value||"",b.value[e.fields]={required:Boolean(e.required),message:"file"===e.type?"请上传文件":"请输入"}})),e}catch(e){return console.error("解析表单配置失败:",e),[]}})),q=e.computed((()=>{if(!w.outputs)return{};try{return(r.isJson(w.outputs)?JSON.parse(w.outputs):[]).reduce(((e,t)=>(e[t.fields]={...t},e)),{})}catch(e){return console.error("解析输出参数失败:",e),{}}})),C=e.ref([]),z=e.ref(!1),{copy:x}=s.useCopy(),R=e.shallowRef(),A=e.ref(!1),T=e.ref(!1),E=e.ref([]),L=e.ref("");let B=null;const S=e.reactive({page_no:1,page_size:25e3}),F=async(e,n)=>{var o;try{const{lists:a}=await t.cozeAgentChatRecord({page_no:e,page_size:n,bot_id:w.coze_id,type:y.value});null==(o=h.value)||o.complete(a)}catch(a){console.error("查询历史记录失败:",a)}},O=()=>{e.index.navigateBack()},$=async()=>{try{const{lists:e}=await t.cozeAgentChatRecord({...S,bot_id:w.coze_id,type:y.value,conversation_id:L.value});E.value=e.map((e=>"user"===e.role?{...e,type:1,message:e.content}:{...e,type:2,reply:e.content,consume_tokens:{total_tokens:e.token_total}})),await K()}catch(n){console.error("获取聊天记录失败:",n),e.index.showToast({title:"获取聊天记录失败",icon:"none"})}},J=async t=>{var n;if(!f.value)return void e.index.$u.route({url:"/pages/login/login"});if(v.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(n=g.value)||n.open());if(A.value)return;E.value.push({type:1,message:t,conversation_id:L.value||""});const o=e.reactive({type:2,loading:!0,reply:"",conversation_id:L.value||"",consume_tokens:{}});E.value.push(o),A.value=!0,await K(),k.value?await M(t,o):await V(t,o)},M=async(e,n)=>{try{await t.cozeAgentChatStream({id:w.id,content:e||"",conversation_id:L.value},{onstart(e){B=e,T.value=!0},onmessage:e=>((e,t)=>{e.trim().split("data:").forEach((e=>{if(e)try{const{object:n,content:o,conversation_id:a,usage:i}=JSON.parse(e);if(o&&"loading"===n&&(t.reply+=o),"finished"===n)return t.loading=!1,t.consume_tokens={total_tokens:i.token_count},void(L.value||(L.value=a));K()}catch(n){console.error("解析流式消息失败:",n)}}))})(e,n),onclose(){n.loading=!1,p.getUser(),Q(),K()}})}catch(o){N(o,n)}};let P=null;const V=async(e,n)=>{try{T.value=!0;const o={id:w.id,content:e||"",conversation_id:L.value},{conversation_id:a,id:r}=await t.cozeAgentChat(o);a&&L.value!==a&&(L.value=a);const s={id:w.id,conversation_id:L.value},{start:u,end:l}=i.usePolling((async()=>{try{const{status:e,id:o}=await t.cozeAgentChatView({chat_id:r,...s});if("completed"===e){l();const e=await t.cozeAgentChatMsgList({chat_id:o,...s});(null==e?void 0:e.length)&&e.forEach((e=>n.reply+=e.content)),n.loading=!1,Q(),K()}else if("failed"===e)throw new Error("聊天失败")}catch(e){throw l(),N(e,n),K(),e}}),{});P=l,await u()}catch(o){N(o,n)}},N=(t,n)=>{n.loading=!1,n.reply=t.errno===l.RequestCodeEnum.ABORT?"用户已停止内容生成":t||"发生错误",t.errno!==l.RequestCodeEnum.ABORT&&e.index.$u.toast((null==t?void 0:t.message)||"发生错误"),n.loading=!1,Q()},D=e.ref(null),G=()=>j.value.every((t=>{if(t.required){if(!_.value[t.fields])return e.index.$u.toast(`请填写${t.name}`),!1}return!0})),H=()=>{D.value=null,Object.keys(_.value).forEach((e=>{_.value[e]=""}))},{lockFn:U,isLock:I}=a.useLockFn((async()=>{if(!A.value&&G()){e.index.showLoading({title:"生成中",mask:!0});try{const n=await t.cozeWorkflowGenerate({id:w.id,..._.value});D.value=n,e.index.hideLoading(),e.index.showToast({title:"生成成功",icon:"none",duration:3e3})}catch(n){e.index.hideLoading(),e.index.showToast({title:n||"生成失败",icon:"none",duration:3e3})}}})),K=async()=>{var t;await e.nextTick$1(),null==(t=R.value)||t.scrollToBottom()},W=()=>{L.value="",E.value=[],Q()},Q=()=>{A.value=!1,T.value=!1},X=()=>{null==B||B.abort(),Q(),P&&(P(),P=null),u.requestCancel.remove("/coze.cozeChat/chat"),u.requestCancel.remove("/coze.cozeChat/retrieve"),E.value.length>0&&T.value&&(E.value[E.value.length-1].loading=!1)},Y=async()=>{e.index.showLoading({title:"加载中"});try{await(async()=>{const e=await t.getCozeAgentDetail({id:w.id});r.setFormData(e,w)})(),L.value&&(await $(),setTimeout((()=>K()),500))}catch(n){console.error("初始化页面失败:",n)}finally{e.index.hideLoading()}};return e.onLoad((e=>{if(!e)return;const{id:t,task_id:n,type:o}=e;w.id=t,L.value=n||"",y.value=o,Y()})),(n,o)=>e.e({a:e.p({name:"/static/images/icons/back_black.svg",size:"32"}),b:e.o(O),c:e.unref(w).avatar,d:e.t(e.unref(w).name),e:e.t(e.unref(w).introduced),f:e.p({"border-bottom":!1,"is-fixed":!1,"is-custom-back-icon":!0,background:{background:"transparent"}}),g:1==e.unref(y)},1==e.unref(y)?e.e({h:0==e.unref(E).length},0==e.unref(E).length?e.e({i:e.unref(w).avatar},e.unref(w).avatar?{j:e.unref(w).avatar}:{},{k:e.t(e.unref(w).name),l:e.t(e.unref(w).description),m:e.f(e.unref(w).preliminary_ask,((t,n,o)=>e.e({a:t.value},t.value?{b:e.t(t.value),c:e.o((e=>J(t.value)),n)}:{},{d:n})))}):{},{n:e.p({name:"/static/images/icons/history.svg",size:48}),o:e.o((e=>z.value=!0)),p:e.sr(R,"5d15bf44-2",{k:"chattingRef"}),q:e.o(X),r:e.o(W),s:e.o(J),t:e.p({"is-coze":!0,"is-stop":e.unref(T),"content-list":e.unref(E),"send-disabled":e.unref(A),tokens:e.unref(m)})}):{},{v:2==e.unref(y)},2==e.unref(y)?e.e({w:!e.unref(D)},e.unref(D)?{y:e.f(e.unref(D),((t,n,o)=>{var a,i,r,s;return e.e({a:e.t((null==(a=e.unref(q)[n])?void 0:a.name)||"-"),b:e.t(null==(i=e.unref(q)[n])?void 0:i.type),c:"file"==(null==(r=e.unref(q)[n])?void 0:r.type)},"file"==(null==(s=e.unref(q)[n])?void 0:s.type)?{}:{d:e.o((n=>e.unref(x)(t)),n)},{e:e.t(t),f:n})}))}:{x:e.f(e.unref(j),((t,n,o)=>e.e({a:e.t(t.name),b:"input"===t.type},"input"===t.type?{c:"5d15bf44-4-"+o,d:e.o((n=>e.unref(_)[t.fields]=n),n),e:e.p({placeholder:t.message,modelValue:e.unref(_)[t.fields]})}:{},{f:"textarea"===t.type},"textarea"===t.type?{g:"5d15bf44-5-"+o,h:e.o((n=>e.unref(_)[t.fields]=n),n),i:e.p({height:"200",maxlength:1e3,placeholder:t.message,type:"textarea",modelValue:e.unref(_)[t.fields]})}:{},{j:"number"===t.type},"number"===t.type?{k:"5d15bf44-6-"+o,l:e.o((n=>e.unref(_)[t.fields]=n),n),m:e.p({placeholder:t.message,type:"number",modelValue:e.unref(_)[t.fields]})}:{},{n:"file"===t.type},"file"===t.type?{o:e.o((e=>{return n=e,o=t.fields,void(_.value[o]=(null==(a=null==n?void 0:n[0])?void 0:a.url)||"");var n,o,a}),n),p:"5d15bf44-7-"+o,q:e.p({"file-type":"file"})}:{},{r:n})))},{z:!e.unref(D)},e.unref(D)?{D:e.o(H)}:{A:e.p({name:"/static/images/icons/history.svg",size:48}),B:e.o((e=>z.value=!0)),C:e.o(((...t)=>e.unref(U)&&e.unref(U)(...t)))}):{},{E:e.f(e.unref(C),((n,o,a)=>({a:e.t(n.content),b:"5d15bf44-11-"+a+",5d15bf44-10",c:e.t(n.create_time),d:"5d15bf44-12-"+a+",5d15bf44-10",e:e.o((o=>(async n=>{var o;const{confirm:a}=await new Promise((t=>{e.index.showModal({title:"提示",content:"确定要删除该聊天记录吗？",success:t})}));if(a){e.index.showLoading({title:"删除中",mask:!0});try{await t.cozeAgentChatRecordClear({bot_id:w.coze_id,conversation_id:n.conversation_id||"0"}),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),null==(o=h.value)||o.reload()}catch(i){e.index.showToast({title:i||"删除失败",icon:"none",duration:3e3})}finally{e.index.hideLoading()}}})(n)),o),f:o,g:e.o((e=>(async e=>{1==y.value?(L.value=e.conversation_id,await $(),z.value=!1):2==y.value&&await t.cozeAgentChatRecord({bot_id:w.coze_id,type:2,conversation_id:e.conversation_id})})(n)),o)}))),F:e.p({name:"/static/images/icons/delete.svg",size:"24"}),G:e.sr(h,"5d15bf44-10,5d15bf44-9",{k:"pagingRef"}),H:e.o(F),I:e.o((t=>e.isRef(C)?C.value=t:null)),J:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(C)}),K:e.o((t=>e.isRef(z)?z.value=t:null)),L:e.p({title:"历史记录","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(z)}),M:e.sr(g,"5d15bf44-14",{k:"rechargePopupRef"})})}});wx.createPage(c);
