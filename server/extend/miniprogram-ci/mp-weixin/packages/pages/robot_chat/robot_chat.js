"use strict";const e=require("../../../common/vendor.js"),n=require("../../../common/assets.js"),o=require("../../../api/agent.js"),s=require("../../../stores/user.js"),r=require("../../../api/chat.js"),i=require("../../../enums/appEnums.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../enums/requestEnums.js"),require("../../../utils/request/cancel.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../utils/util.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("dragon-button")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../../components/dragon-button/dragon-button.js")+t+(()=>"../../../components/recharge-popup/recharge-popup.js"))();const t=()=>"./components/sidebar.js",a=e.defineComponent({__name:"robot_chat",setup(t){var a;const u=e.shallowRef(),l=s.useUserStore(),{userTokens:c,isLogin:d}=e.toRefs(l),v=null==(a=l.getTokenByScene(i.TokensSceneEnum.SCENE_CHAT))?void 0:a.score,p=e.ref(),m=e.reactive({id:"",name:"",logo:"",form_info:"",description:"",template_info:{},preliminary_ask:[],assistants_id:""}),f=()=>{e.index.navigateBack()},g=e=>{const{type:n,data:o}=e;n==i.KnbTypeEnum.RAG?(x.indexid=o.index_id,x.rerank_min_score=o.rerank_min_score):n==i.KnbTypeEnum.VECTOR&&(x.kb_id=o.id,x.indexid=void 0,x.rerank_min_score=void 0)},_=e.shallowRef(),h=e.ref(!1),k=e.ref(!1),j=e.ref([]),b=e.ref(""),y=e.ref([]),q=e.reactive({page_no:1,page_size:1500}),x=e.reactive({indexid:"",rerank_min_score:""}),T=e=>{y.value=e.file||[],E()};let w=null;const E=async(n,o=!1)=>{var s,i;if(!d.value)return void e.index.$u.route({url:"/pages/login/login"});if(c.value<=0)return e.index.$u.toast("算力不足，请充值！"),void(null==(s=p.value)||s.open());if(h.value)return;h.value=!0,o||j.value.push({type:1,message:n,fileLists:y.value});const t=e.reactive({type:2,loading:!0,reply:"",is_reasoning_finished:!1,reasoning_content:"",consume_tokens:{},error:""});j.value.push(t);try{await r.chatRobotSendTextStream({message:n||"",message_ext:JSON.stringify(null==(i=u.value)?void 0:i.formData),assistant_id:m.id,...x},{onstart(e){w=e,k.value=!0},onmessage(e){e.trim().split("data:").forEach(((e,n)=>{if(""!==e)try{const n=JSON.parse(e),{object:o,content:s,task_id:r,reasoning_content:i,usage:a}=n;if((s||i)&&"loading"===o&&(i?(t.is_reasoning_finished=!1,t.reasoning_content+=i):(t.is_reasoning_finished=!0,t.reply+=s)),"finished"===o)return t.loading=!1,t.consume_tokens={...a},void(b.value||(b.value=r));_.value.scrollToBottom()}catch(o){}}))},onclose(){t.loading=!1,S(),l.getUser(),setTimeout((async()=>{_.value.scrollToBottom()}),600)}})}catch(a){600004==a.errno?t.reply="用户已停止内容生成":(t.reply=a||"发生错误",e.index.$u.toast(a)),t.loading=!1,S()}e.nextTick$1((()=>{_.value.scrollToBottom()}))},C=async()=>{var n;h.value?e.index.$u.toast("当前有内容生成，请稍后再试"):null==(n=u.value)||n.open()},R=()=>{b.value?(b.value="",j.value=[],S(),E("你好",!0)):e.index.$u.toast("当前会话已经是最新的了")},S=()=>{y.value=[],h.value=!1,k.value=!1},B=()=>{null==w||w.abort(),h.value=!1,k.value=!1},L=e.computed((()=>{var e;return(null==(e=m.template_info)?void 0:e.form)||[]})),$=async()=>{try{await(async()=>{const e=await o.robotDetail({assistant_id:m.id});Object.keys(m).forEach((n=>{m[n]=e[n]}))})(),b.value&&(e.index.showLoading({title:"加载中"}),await(async()=>{try{const e=await r.getChatLog({...q,assistant_id:m.id,task_id:b.value}),n=null==e?void 0:e.map((e=>1==e.type?{...e}:{...e,consume_tokens:e.tokens_info||{}}));j.value=n}catch(e){}})(),setTimeout((()=>{var e;null==(e=_.value)||e.scrollToBottom()}),500),e.index.hideLoading()),C()}catch(n){e.index.hideLoading()}};return e.onLoad((({id:e,task_id:n})=>{m.id=e,b.value=n,$()})),(o,s)=>e.e({a:e.p({name:"/static/images/icons/back_black.svg",size:"32"}),b:e.o(f),c:e.unref(m).logo,d:e.t(e.unref(m).name),e:e.t(e.unref(m).description),f:e.p({"border-bottom":!1,"is-fixed":!1,"is-custom-back-icon":!0,background:{background:"transparent"}}),g:0==e.unref(j).length},0==e.unref(j).length?e.e({h:e.unref(m).logo},e.unref(m).logo?{i:e.unref(m).logo}:{},{j:e.t(e.unref(m).name),k:e.t(e.unref(m).description),l:e.f(e.unref(m).preliminary_ask,((n,o,s)=>e.e({a:n.value},n.value?{b:e.t(n.value),c:e.o((e=>E(n.value)),o)}:{},{d:o})))}):{},{m:e.sr(_,"5d15bf44-2",{k:"chattingRef"}),n:e.o(B),o:e.o(R),p:e.o(E),q:e.o(g),r:e.p({"is-staff":!0,"is-stop":e.unref(k),"content-list":e.unref(j),"send-disabled":e.unref(h),tokens:e.unref(v)}),s:n._imports_0,t:e.o(C),v:e.p({size:96,"y-edge":150,"x-edge":5}),w:e.sr(u,"5d15bf44-4",{k:"sidebarRef"}),x:e.o(T),y:e.p({"form-list":e.unref(L),title:e.unref(m).name}),z:e.sr(p,"5d15bf44-5",{k:"rechargePopupRef"})})}});wx.createPage(a);
