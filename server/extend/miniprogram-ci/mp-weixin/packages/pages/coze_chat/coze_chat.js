"use strict";const e=require("../../../common/vendor.js"),n=require("../../../api/agent.js"),o=require("../../../stores/user.js"),t=require("../../../enums/appEnums.js"),a=require("../../../hooks/useLockFn.js"),i=require("../../../hooks/usePolling.js"),r=require("../../../utils/util.js"),s=require("../../../hooks/useCopy.js"),u=require("../../../utils/request/cancel.js"),l=require("../../../enums/requestEnums.js"),c=require("../../../utils/file.js");if(require("../../../utils/request/index.js"),require("../../../utils/request/http.js"),require("../../../utils/auth.js"),require("../../../enums/constantEnums.js"),require("../../../utils/cache.js"),require("../../../router/index.js"),require("../../../config/index.js"),require("../../../api/user.js"),require("../../../hooks/useShareMessage.js"),require("../../../stores/navigationBarTitle.js"),require("../../../stores/app.js"),require("../../../api/app.js"),require("../../../api/chat.js"),require("../../../api/voice_chat.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-navbar")+e.resolveComponent("chat-scroll-view")+e.resolveComponent("u-input")+e.resolveComponent("file-upload")+e.resolveComponent("u-line")+e.resolveComponent("empty")+e.resolveComponent("z-paging")+e.resolveComponent("popup-bottom")+e.resolveComponent("recharge-popup"))()}Math||((()=>"../../../uni_modules/vk-uview-ui/components/u-icon/u-icon.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-navbar/u-navbar.js")+(()=>"../../../components/chat-scroll-view/chat-scroll-view.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-input/u-input.js")+(()=>"../../../components/file-upload/file-upload.js")+(()=>"../../../uni_modules/vk-uview-ui/components/u-line/u-line.js")+(()=>"../../../components/empty/empty.js")+(()=>"../../../node-modules/z-paging/components/z-paging/z-paging.js")+(()=>"../../../components/popup-bottom/popup-bottom.js")+(()=>"../../../components/recharge-popup/recharge-popup.js"))();const d=e.defineComponent({__name:"coze_chat",setup(d){var v;const p=o.useUserStore(),{userTokens:f,isLogin:m}=e.toRefs(p),g=null==(v=p.getTokenByScene(t.TokensSceneEnum.SCENE_CHAT))?void 0:v.score,h=e.ref(),y=e.shallowRef(),w=e.ref(),_=e.reactive({id:"",name:"",avatar:"",introduced:"",coze_id:"",stream:"",inputs:"",outputs:""}),k=e.ref({}),j=e.ref({}),q=e.computed((()=>1==_.stream));e.ref(!1);const b=e.computed((()=>{if(!_.inputs)return[];try{const e=JSON.parse(_.inputs);return e.forEach((e=>{k.value[e.fields]=e.value||"",j.value[e.fields]={required:Boolean(e.required),message:"file"===e.type?"请上传文件":"请输入"}})),e}catch(e){return console.error("解析表单配置失败:",e),[]}})),x=e.computed((()=>{if(!_.outputs)return{};try{return(r.isJson(_.outputs)?JSON.parse(_.outputs):[]).reduce(((e,n)=>(e[n.fields]={...n},e)),{})}catch(e){return console.error("解析输出参数失败:",e),{}}})),z=e.ref([]),C=e.ref(!1),{copy:A}=s.useCopy(),T=e.shallowRef(),R=e.ref(!1),L=e.ref(!1),E=e.ref([]),S=e.ref("");let B=null;const F=e.reactive({page_no:1,page_size:25e3}),O=async(e,o)=>{var t,a;try{const{lists:a}=await n.cozeAgentChatRecord({page_no:e,page_size:o,bot_id:_.coze_id,type:w.value});null==(t=y.value)||t.complete(a)}catch(i){null==(a=y.value)||a.complete([])}},P=()=>{e.index.navigateBack()},J=async()=>{try{const{lists:e}=await n.cozeAgentChatRecord({...F,bot_id:_.coze_id,type:w.value,conversation_id:S.value});E.value=e.map((e=>"user"===e.role?{...e,type:1,message:e.content}:{...e,type:2,reply:e.content,consume_tokens:{total_tokens:e.token_total}})),await W()}catch(o){console.error("获取聊天记录失败:",o),e.index.showToast({title:"获取聊天记录失败",icon:"none"})}},V=async n=>{var o;if(!m.value)return void e.index.$u.route({url:"/pages/login/login"});if(f.value<=1)return e.index.$u.toast("算力不足，请充值！"),void(null==(o=h.value)||o.open());if(R.value)return;E.value.push({type:1,message:n,conversation_id:S.value||""});const t=e.reactive({type:2,loading:!0,reply:"",conversation_id:S.value||"",consume_tokens:{}});E.value.push(t),R.value=!0,await W(),q.value?await $(n,t):await N(n,t)},$=async(e,o)=>{try{await n.cozeAgentChatStream({id:_.id,content:e||"",conversation_id:S.value},{onstart(e){B=e,L.value=!0},onmessage:e=>((e,n)=>{e.trim().split("data:").forEach((e=>{if(e)try{const{object:o,content:t,conversation_id:a,usage:i}=JSON.parse(e);if(t&&"loading"===o&&(n.reply+=t),"finished"===o)return n.loading=!1,n.consume_tokens={total_tokens:i.token_count},void(S.value||(S.value=a));W()}catch(o){console.error("解析流式消息失败:",o)}}))})(e,o),onclose(){o.loading=!1,p.getUser(),X(),W()}})}catch(t){D(t,o)}};let M=null;const N=async(e,o)=>{try{L.value=!0;const t={id:_.id,content:e||"",conversation_id:S.value},{conversation_id:a,id:r}=await n.cozeAgentChat(t);a&&S.value!==a&&(S.value=a);const s={id:_.id,conversation_id:S.value},{start:u,end:l}=i.usePolling((async()=>{try{const{status:e,id:t}=await n.cozeAgentChatView({chat_id:r,...s});if("completed"===e){l();const e=await n.cozeAgentChatMsgList({chat_id:t,...s});(null==e?void 0:e.length)&&e.forEach((e=>o.reply+=e.content)),o.loading=!1,X(),W()}else if("failed"===e)throw new Error("聊天失败")}catch(e){throw l(),D(e,o),W(),e}}),{});M=l,await u()}catch(t){D(t,o)}},D=(n,o)=>{o.loading=!1,o.reply=n.errno===l.RequestCodeEnum.ABORT?"用户已停止内容生成":n||"发生错误",n.errno!==l.RequestCodeEnum.ABORT&&e.index.$u.toast((null==n?void 0:n.message)||"发生错误"),o.loading=!1,X()},I=e.ref(null),G=()=>b.value.every((n=>{if(n.required){if(!k.value[n.fields])return e.index.$u.toast(`请填写${n.name}`),!1}return!0})),H=()=>{I.value=null,Object.keys(k.value).forEach((e=>{k.value[e]=""}))},{lockFn:U,isLock:K}=a.useLockFn((async()=>{if(!R.value&&G()){e.index.showLoading({title:"生成中",mask:!0});try{const o=await n.cozeWorkflowGenerate({id:_.id,...k.value});I.value=o,e.index.hideLoading(),e.index.showToast({title:"生成成功",icon:"none",duration:3e3})}catch(o){e.index.hideLoading(),e.index.showToast({title:o||"生成失败",icon:"none",duration:3e3})}}})),W=async()=>{var n;await e.nextTick$1(),null==(n=T.value)||n.scrollToBottom()},Q=()=>{S.value="",E.value=[],X()},X=()=>{R.value=!1,L.value=!1},Y=()=>{null==B||B.abort(),X(),M&&(M(),M=null),u.requestCancel.remove("/coze.cozeChat/chat"),u.requestCancel.remove("/coze.cozeChat/retrieve"),E.value.length>0&&L.value&&(E.value[E.value.length-1].loading=!1)},Z=e=>e?Array.isArray(e)?e:[e]:[],ee=async()=>{e.index.showLoading({title:"加载中"});try{await(async()=>{const e=await n.getCozeAgentDetail({id:_.id});r.setFormData(e,_)})(),S.value&&(await J(),setTimeout((()=>W()),500))}catch(o){console.error("初始化页面失败:",o)}finally{e.index.hideLoading()}};return e.onLoad((e=>{if(!e)return;const{id:n,task_id:o,type:t}=e;_.id=n,S.value=o||"",w.value=t,ee()})),(o,t)=>e.e({a:e.p({name:"/static/images/icons/back_black.svg",size:"32"}),b:e.o(P),c:e.unref(_).avatar,d:e.t(e.unref(_).name),e:e.t(e.unref(_).introduced),f:e.p({"border-bottom":!1,"is-fixed":!1,"is-custom-back-icon":!0,background:{background:"transparent"}}),g:1==e.unref(w)},1==e.unref(w)?e.e({h:0==e.unref(E).length},0==e.unref(E).length?e.e({i:e.unref(_).avatar},e.unref(_).avatar?{j:e.unref(_).avatar}:{},{k:e.t(e.unref(_).name),l:e.t(e.unref(_).description),m:e.f(e.unref(_).preliminary_ask,((n,o,t)=>e.e({a:n.value},n.value?{b:e.t(n.value),c:e.o((e=>V(n.value)),o)}:{},{d:o})))}):{},{n:e.p({name:"/static/images/icons/history.svg",size:48}),o:e.o((e=>C.value=!0)),p:e.sr(T,"04090280-2",{k:"chattingRef"}),q:e.o(Y),r:e.o(Q),s:e.o(V),t:e.p({"is-coze":!0,"is-stop":e.unref(L),"content-list":e.unref(E),"send-disabled":e.unref(R),tokens:e.unref(g)})}):{},{v:2==e.unref(w)},2==e.unref(w)?e.e({w:!e.unref(I)},e.unref(I)?{y:e.f(e.unref(I),((n,o,t)=>{var a,i,r;return{a:e.t((null==(a=e.unref(x)[o])?void 0:a.name)||"-"),b:e.t(null==(i=e.unref(x)[o])?void 0:i.type),c:e.o((o=>e.unref(A)(n)),o),d:e.f(Z(n),((n,t,a)=>{var i,r,s,u,l;return e.e(["video","image"].includes(null==(i=e.unref(x)[o])?void 0:i.type)?e.e({a:"video"==(null==(r=e.unref(x)[o])?void 0:r.type)},"video"==(null==(s=e.unref(x)[o])?void 0:s.type)?{b:n}:{},{c:"image"==(null==(u=e.unref(x)[o])?void 0:u.type)},"image"==(null==(l=e.unref(x)[o])?void 0:l.type)?{d:n,e:e.o((o=>{return t=n,void e.index.previewImage({urls:[t]});var t}),t)}:{},{f:n},n?{g:e.o((t=>{return a=n,void("video"==e.unref(x)[o].type?c.saveVideoToPhotosAlbum(a):c.saveImageToPhotosAlbum(a));var a}),t)}:{}):{h:e.t(n)},{i:t})})),e:["video","image"].includes(null==(r=e.unref(x)[o])?void 0:r.type),f:o}}))}:{x:e.f(e.unref(b),((n,o,t)=>e.e({a:e.t(n.name),b:"input"===n.type},"input"===n.type?{c:"04090280-4-"+t,d:e.o((o=>e.unref(k)[n.fields]=o),o),e:e.p({placeholder:n.message,modelValue:e.unref(k)[n.fields]})}:{},{f:"textarea"===n.type},"textarea"===n.type?{g:"04090280-5-"+t,h:e.o((o=>e.unref(k)[n.fields]=o),o),i:e.p({height:"200",maxlength:1e3,placeholder:n.message,type:"textarea",modelValue:e.unref(k)[n.fields]})}:{},{j:"number"===n.type},"number"===n.type?{k:"04090280-6-"+t,l:e.o((o=>e.unref(k)[n.fields]=o),o),m:e.p({placeholder:n.message,type:"number",modelValue:e.unref(k)[n.fields]})}:{},{n:["video","image","file"].includes(n.type)},["video","image","file"].includes(n.type)?{o:e.o((e=>{return o=e,t=n.fields,void(k.value[t]=(null==(a=null==o?void 0:o[0])?void 0:a.url)||"");var o,t,a}),o),p:"04090280-7-"+t,q:e.p({"file-type":"all"})}:{},{r:o})))},{z:!e.unref(I)},e.unref(I)?{D:e.o(H)}:{A:e.p({name:"/static/images/icons/history.svg",size:48}),B:e.o((e=>C.value=!0)),C:e.o(((...n)=>e.unref(U)&&e.unref(U)(...n)))}):{},{E:e.f(e.unref(z),((o,t,a)=>({a:e.t(o.content),b:"04090280-11-"+a+",04090280-10",c:e.t(o.create_time),d:"04090280-12-"+a+",04090280-10",e:e.o((t=>(async o=>{var t;const{confirm:a}=await new Promise((n=>{e.index.showModal({title:"提示",content:"确定要删除该聊天记录吗？",success:n})}));if(a){e.index.showLoading({title:"删除中",mask:!0});try{await n.cozeAgentChatRecordClear({bot_id:_.coze_id,conversation_id:o.conversation_id||"0"}),e.index.hideLoading(),e.index.showToast({title:"删除成功",icon:"none",duration:3e3}),null==(t=y.value)||t.reload()}catch(i){e.index.hideLoading(),e.index.showToast({title:i||"删除失败",icon:"none",duration:3e3})}}})(o)),t),f:t,g:e.o((e=>(async e=>{if(1==w.value)S.value=e.conversation_id,await J();else if(2==w.value){const{lists:o}=await n.cozeAgentChatRecord({bot_id:_.coze_id,type:2,conversation_id:e.conversation_id});o.length&&(I.value=JSON.parse(o[0].content))}C.value=!1})(o)),t)}))),F:e.p({name:"/static/images/icons/delete.svg",size:"24"}),G:e.sr(y,"04090280-10,04090280-9",{k:"pagingRef"}),H:e.o(O),I:e.o((n=>e.isRef(z)?z.value=n:null)),J:e.p({fixed:!1,"safe-area-inset-bottom":!0,modelValue:e.unref(z)}),K:e.o((n=>e.isRef(C)?C.value=n:null)),L:e.p({title:"历史记录","show-close-btn":!0,"is-disabled-touch":!0,"custom-class":"bg-_hF9FAFB_",show:e.unref(C)}),M:e.sr(h,"04090280-14",{k:"rechargePopupRef"})})}});wx.createPage(d);
